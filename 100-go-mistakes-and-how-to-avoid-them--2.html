<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="robots" content="index,follow"/><meta property="og:type" content="website"/><meta name="google-site-verification" content="_OJuJrMAK0_lxr0--eH6RZyMOn2Mg_zY1hDyBBKU8fI"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-Y4TMBBH2RZ"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', 'G-Y4TMBBH2RZ', {
                page_path: window.location.pathname,
              });
          </script><meta property="og:site_name" content="YangSoon"/><meta property="twitter:domain" content="yangsoon.github.io"/><meta name="twitter:creator" content="@yangsoonlx"/><meta name="description" content="YangSoon, Cloud Native Developer"/><meta property="og:description" content="YangSoon, Cloud Native Developer"/><meta name="twitter:description" content="YangSoon, Cloud Native Developer"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://yangsoon.github.io/api/social-image?id=f8e41082-81f4-4d47-a6f3-3489e7c3453c"/><meta property="og:image" content="https://yangsoon.github.io/api/social-image?id=f8e41082-81f4-4d47-a6f3-3489e7c3453c"/><link rel="canonical" href="https://yangsoon.github.io/100-go-mistakes-and-how-to-avoid-them--2"/><meta property="og:url" content="https://yangsoon.github.io/100-go-mistakes-and-how-to-avoid-them--2"/><meta property="twitter:url" content="https://yangsoon.github.io/100-go-mistakes-and-how-to-avoid-them--2"/><link rel="alternate" type="application/rss+xml" href="https://yangsoon.github.io/feed" title="YangSoon"/><meta property="og:title" content="100 Go Mistakes and How to Avoid Them - 2"/><meta name="twitter:title" content="100 Go Mistakes and How to Avoid Them - 2"/><title>100 Go Mistakes and How to Avoid Them - 2</title><link rel="preload" as="image" href="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F47263733-11bc-4ae7-9e1e-c3401a49c171%2FManning.100.Go.Mistakes.and.How.to.Avoid.Them.2022-1%25EF%25BC%2588%25E6%258B%2596%25E7%25A7%25BB%25E9%25A1%25B9%25E7%259B%25AE%25EF%25BC%2589.png?table=block&amp;id=f8e41082-81f4-4d47-a6f3-3489e7c3453c&amp;cache=v2"/><meta name="next-head-count" content="25"/><link rel="shortcut icon" href="/favicon.ico"/><link rel="icon" type="image/png" sizes="32x32" href="favicon.png"/><link rel="manifest" href="/manifest.json"/><link rel="preload" href="/_next/static/css/836d11bb8e359ad4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/836d11bb8e359ad4.css" data-n-g=""/><link rel="preload" href="/_next/static/css/1d993c1b8c3f1e3a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1d993c1b8c3f1e3a.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script defer="" src="/_next/static/chunks/3607272e.d338bf53926ee7c2.js"></script><script defer="" src="/_next/static/chunks/853.526a4df21aef109c.js"></script><script defer="" src="/_next/static/chunks/358.0027340467b29549.js"></script><script src="/_next/static/chunks/webpack-d0f6f9fb604748c4.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-f08b69bdcc7bbb61.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e341ab6855f9c9f4.js" defer=""></script><script src="/_next/static/chunks/446-7f8c1bd499453c43.js" defer=""></script><script src="/_next/static/chunks/642-47a19f0a55eb6073.js" defer=""></script><script src="/_next/static/chunks/pages/%5BpageId%5D-69b62fc61f7d7f72.js" defer=""></script><script src="/_next/static/0gmm17Dg8k1mKjTGxsMiT/_buildManifest.js" defer=""></script><script src="/_next/static/0gmm17Dg8k1mKjTGxsMiT/_ssgManifest.js" defer=""></script></head><body><script>
/** Inlined version of noflash.js from use-dark-mode */
;(function () {
  var storageKey = 'darkMode'
  var classNameDark = 'dark-mode'
  var classNameLight = 'light-mode'
  function setClassOnDocumentBody(darkMode) {
    document.body.classList.add(darkMode ? classNameDark : classNameLight)
    document.body.classList.remove(darkMode ? classNameLight : classNameDark)
  }
  var preferDarkQuery = '(prefers-color-scheme: dark)'
  var mql = window.matchMedia(preferDarkQuery)
  var supportsColorSchemeQuery = mql.media === preferDarkQuery
  var localStorageTheme = null
  try {
    localStorageTheme = localStorage.getItem(storageKey)
  } catch (err) {}
  var localStorageExists = localStorageTheme !== null
  if (localStorageExists) {
    localStorageTheme = JSON.parse(localStorageTheme)
  }
  // Determine the source of truth
  if (localStorageExists) {
    // source of truth from localStorage
    setClassOnDocumentBody(localStorageTheme)
  } else if (supportsColorSchemeQuery) {
    // source of truth from system
    setClassOnDocumentBody(mql.matches)
    localStorage.setItem(storageKey, mql.matches)
  } else {
    // source of truth from document.body
    var isDarkMode = document.body.classList.contains(classNameDark)
    localStorage.setItem(storageKey, JSON.stringify(isDarkMode))
  }
})();
</script><div id="__next"><div class="notion notion-app light-mode notion-block-f8e4108281f44d47a6f33489e7c3453c"><div class="notion-viewport"></div><div class="notion-frame"><header class="notion-header"><div class="notion-nav-header"><div class="breadcrumbs"><a class="breadcrumb" href="/"><div class="notion-page-icon-inline notion-page-icon-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272003%27/%3e"/></span><img alt="萨博一直跑" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="icon notion-page-icon" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRmoAAABXRUJQVlA4IF4AAADQAQCdASoQABAABUB8JbACdAERATxWoAD+0Vlxx+kOh3kDC0Z3s4OjUZzRpnTiXUiN5qtuCLGbw3Q3meKHmbJDj3X9KoWlb/kas/KasMX31nkEcPwD09TPGVsO8AAA&quot;)"/><noscript><img alt="萨博一直跑" src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F37907dd5-3c76-4966-a419-daa027a84972%2FIMG_2189.jpg?table=block&amp;id=72a66971-7cf6-42c2-a252-4439d99d8f44&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="icon notion-page-icon" loading="lazy"/></noscript></span></div><span class="title">萨博一直跑</span></a></div><div class="notion-nav-header-rhs breadcrumbs"><a href="/关于作者" class="breadcrumb button">About</a><div class="breadcrumb button styles_hidden__7gYve"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M256 48v48m0 320v48m147.08-355.08l-33.94 33.94M142.86 369.14l-33.94 33.94M464 256h-48m-320 0H48m355.08 147.08l-33.94-33.94M142.86 142.86l-33.94-33.94"></path><circle cx="256" cy="256" r="80" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32"></circle></svg></div></div></div></header><div class="notion-page-scroller"><div class="notion-page-cover-wrapper"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272508%27/%3e"/></span><img alt="100 Go Mistakes and How to Avoid Them - 2" src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F47263733-11bc-4ae7-9e1e-c3401a49c171%2FManning.100.Go.Mistakes.and.How.to.Avoid.Them.2022-1%25EF%25BC%2588%25E6%258B%2596%25E7%25A7%25BB%25E9%25A1%25B9%25E7%259B%25AE%25EF%25BC%2589.png?table=block&amp;id=f8e41082-81f4-4d47-a6f3-3489e7c3453c&amp;cache=v2" decoding="async" data-nimg="intrinsic" class="notion-page-cover" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-position:center 17.390000000000004%;background-size:cover;background-position:center 17.390000000000004%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRkoAAABXRUJQVlA4ID4AAACQAQCdASoNABAABUB8JZQAAUJYnCAA/i3sgO0Yegdb+5LvlWhw/psHDLyVDpX8zYYcjaZB/BXtD4y71SAAAA==&quot;)"/><noscript><img alt="100 Go Mistakes and How to Avoid Them - 2" src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F47263733-11bc-4ae7-9e1e-c3401a49c171%2FManning.100.Go.Mistakes.and.How.to.Avoid.Them.2022-1%25EF%25BC%2588%25E6%258B%2596%25E7%25A7%25BB%25E9%25A1%25B9%25E7%259B%25AE%25EF%25BC%2589.png?table=block&amp;id=f8e41082-81f4-4d47-a6f3-3489e7c3453c&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-position:center 17.390000000000004%" class="notion-page-cover"/></noscript></span></div><main class="notion-page notion-page-has-cover notion-page-has-icon notion-page-has-image-icon notion-full-page"><div class="notion-page-icon-hero notion-page-icon-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271159%27/%3e"/></span><img alt="100 Go Mistakes and How to Avoid Them - 2" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="notion-page-icon" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjwAAABXRUJQVlA4IDAAAACwAQCdASoQAAkABUB8JQAAT6/36IiAAP4EcU3AJPD5WZWYi6rGw+MWNhG0kKdLMAA=&quot;)"/><noscript><img alt="100 Go Mistakes and How to Avoid Them - 2" src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa22fb73f-5a7d-4fdc-8319-52ed15316e76%2Fimages.jpeg?table=block&amp;id=f8e41082-81f4-4d47-a6f3-3489e7c3453c&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="notion-page-icon" loading="lazy"/></noscript></span></div><h1 class="notion-title">100 Go Mistakes and How to Avoid Them - 2</h1><div class="notion-collection-page-properties"><div class="notion-collection-row"><div class="notion-collection-row-body"><div class="notion-collection-row-property"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M6.986 14c-1.79 0-3.582-.69-4.944-2.068-2.723-2.72-2.723-7.172 0-9.892 2.725-2.72 7.182-2.72 9.906 0A6.972 6.972 0 0114 6.996c0 1.88-.728 3.633-2.052 4.955A7.058 7.058 0 016.986 14zm3.285-6.99v1.645H5.526v-5.47h1.841v3.63h2.904v.194zm1.89-.014c0-1.379-.542-2.67-1.522-3.648-2.006-2.005-5.287-2.007-7.297-.009l-.009.009a5.168 5.168 0 000 7.295c2.01 2.007 5.297 2.007 7.306 0a5.119 5.119 0 001.521-3.647z"></path></svg><div class="notion-collection-column-title-body">Created</div></div><div class="notion-collection-row-value"><span class="notion-property notion-property-created_time">Feb 25, 2023 10:08 AM</span></div></div><div class="notion-collection-row-property"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M4 3a1 1 0 011-1h7a1 1 0 110 2H5a1 1 0 01-1-1zm0 4a1 1 0 011-1h7a1 1 0 110 2H5a1 1 0 01-1-1zm0 4a1 1 0 011-1h7a1 1 0 110 2H5a1 1 0 01-1-1zM2 4a1 1 0 110-2 1 1 0 010 2zm0 4a1 1 0 110-2 1 1 0 010 2zm0 4a1 1 0 110-2 1 1 0 010 2z"></path></svg><div class="notion-collection-column-title-body">Tags</div></div><div class="notion-collection-row-value"><span class="notion-property notion-property-multi_select"><div class="notion-property-multi_select-item notion-item-brown">golang</div></span></div></div><div class="notion-collection-row-property"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M7 4.568a.5.5 0 00-.5-.5h-6a.5.5 0 00-.5.5v1.046a.5.5 0 00.5.5h6a.5.5 0 00.5-.5V4.568zM.5 1a.5.5 0 00-.5.5v1.045a.5.5 0 00.5.5h12a.5.5 0 00.5-.5V1.5a.5.5 0 00-.5-.5H.5zM0 8.682a.5.5 0 00.5.5h11a.5.5 0 00.5-.5V7.636a.5.5 0 00-.5-.5H.5a.5.5 0 00-.5.5v1.046zm0 3.068a.5.5 0 00.5.5h9a.5.5 0 00.5-.5v-1.045a.5.5 0 00-.5-.5h-9a.5.5 0 00-.5.5v1.045z"></path></svg><div class="notion-collection-column-title-body">Text</div></div><div class="notion-collection-row-value"><span class="notion-property notion-property-text">WIP(80%)</span></div></div></div></div></div><div class="notion-page-content notion-page-content-has-aside notion-page-content-has-toc"><article class="notion-page-content-inner"><div class="notion-callout notion-gray_background_co notion-block-a85d9fed92aa4cf4ae9200751ec8ab5b"><div class="notion-page-icon-inline notion-page-icon-span"><span class="notion-page-icon" role="img" aria-label="💡">💡</span></div><div class="notion-callout-text">本文是 100 Go Mistakes读书笔记 的下篇</div></div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-7c7869cc60ca4e108583d4a5062b6ac4" data-id="7c7869cc60ca4e108583d4a5062b6ac4"><span><div id="7c7869cc60ca4e108583d4a5062b6ac4" class="notion-header-anchor"></div><a class="notion-hash-link" href="#7c7869cc60ca4e108583d4a5062b6ac4" title="关于本书"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">关于本书</span></span></h3><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-164f95cbc34d469cb85c2bc356b4e3c0" href="https://book.douban.com/subject/36084407/"><div><div class="notion-bookmark-title">100 Go Mistakes and How to Avoid Them</div><div class="notion-bookmark-description">Spot errors in your Go code you didn’t even know you were making and boost your productivity by avoi...</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><img src="https://www.notion.so/image/https%3A%2F%2Fimg1.doubanio.com%2Ffavicon.ico?table=block&amp;id=164f95cb-c34d-469c-b85c-2bc356b4e3c0&amp;cache=v2" alt="100 Go Mistakes and How to Avoid Them" loading="lazy" decoding="async"/></div><div class="notion-bookmark-link-text">https://book.douban.com/subject/36084407/</div></div></div><div class="notion-bookmark-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272507%27/%3e"/></span><img alt="100 Go Mistakes and How to Avoid Them" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRk4AAABXRUJQVlA4IEIAAACwAQCdASoNABAABUB8JZQAAcCzMdgAAP1pPb5smyxoh54e7LDGK8Yk2gEHbh/20RBmhShKjfB1bjvvEl7pU7XAAAA=&quot;)"/><noscript><img alt="100 Go Mistakes and How to Avoid Them" src="https://www.notion.so/image/https%3A%2F%2Fimg2.doubanio.com%2Fview%2Fsubject%2Fl%2Fpublic%2Fs34311243.jpg?table=block&amp;id=164f95cb-c34d-469c-b85c-2bc356b4e3c0&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a></div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-0decdc5a63f64cbca101acf83211ccff" data-id="0decdc5a63f64cbca101acf83211ccff"><span><div id="0decdc5a63f64cbca101acf83211ccff" class="notion-header-anchor"></div><a class="notion-hash-link" href="#0decdc5a63f64cbca101acf83211ccff" title="7 Error management"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">7 Error management</span></span></h3><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-76b64bafa8dd4007a565664a00046b06" data-id="76b64bafa8dd4007a565664a00046b06"><span><div id="76b64bafa8dd4007a565664a00046b06" class="notion-header-anchor"></div><a class="notion-hash-link" href="#76b64bafa8dd4007a565664a00046b06" title="7.1 #48: Panicking（什么是panic）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">7.1 #48: Panicking（什么是panic）</span></span></h4><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func main() {
  // 在defer中执行 recover 可以恢复panic，defer也会在周围出现panic的时候执行
	defer func() {
		if r := recover(); r != nil {
			fmt.Println(&quot;recover&quot;, r)
		}
	}()
	f()
}
func f() {
	fmt.Println(&quot;a&quot;)
	panic(&quot;foo&quot;)
	fmt.Println(&quot;b&quot;)
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-c94b3a792507408d8aefc2d11343c7fc" data-id="c94b3a792507408d8aefc2d11343c7fc"><span><div id="c94b3a792507408d8aefc2d11343c7fc" class="notion-header-anchor"></div><a class="notion-hash-link" href="#c94b3a792507408d8aefc2d11343c7fc" title="7.2 #49: Ignoring when to wrap an error（不明确何时包装一个error，fmt.Errorf用法）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">7.2 #49: Ignoring when to wrap an error（不明确何时包装一个error，fmt.Errorf用法）</span></span></h4><div class="notion-text notion-block-91b46093116642ecbf709fcf8d6b87ec">在如下场景你可以选择包装一下error：</div><ol start="1" class="notion-list notion-list-numbered notion-block-aa03455014d14e868475807cfc28c526"><li>你需要在错误上增加一些上下文</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-104c6b88dfb342538e2666b685beae33"><li>你需要把错误封装在另一个错误内</li></ol><div class="notion-row notion-block-b0dbcc2bd143444fa9c4fa7b2bd1466a"><div class="notion-column notion-block-a0af9c7a485d4991b55ffc99c001c7cd" style="width:calc((100% - (1 * min(32px, 4vw))) * 0.5)"><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-7b47c76007b5445891c027039f752bed"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27841%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAAAwAQCdASoQAAcABUB8JZQAA3AA/vBmGaPoMMfT+4RThezUN53k8lwNzeTsgAAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfjzjehr4j30tc0ccq5c.jpg?table=block&amp;id=7b47c760-07b5-4458-91c0-27039f752bed&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure></div><div class="notion-spacer"></div><div class="notion-column notion-block-0bbfdf78648f4f12bb15c263feb01acc" style="width:calc((100% - (1 * min(32px, 4vw))) * 0.5)"><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-29ea918e04ec45278b380076f604b0a5"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27801%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjYAAABXRUJQVlA4ICoAAACQAQCdASoQAAYABUB8JZQAApuLmvgA/usyeOnRnoxEhb3C52zBu7IA3AA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfjzrczn0j30t00bmgnc.jpg?table=block&amp;id=29ea918e-04ec-4527-8b38-0076f604b0a5&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure></div><div class="notion-spacer"></div></div><div class="notion-text notion-block-476a803598db443cb30357897ee1a5b3">GO支持如下几种包装error的方式：</div><ol start="1" class="notion-list notion-list-numbered notion-block-d063db166f75400f83978a908920b734"><li>自定义Error结构体</li><ol class="notion-list notion-list-numbered notion-block-d063db166f75400f83978a908920b734"><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">type BarError struct {
	Err error
}

func (b BarError) Error() string {
	return &quot;bar failed:&quot; + b.Err.Error()
}

func test() {
	err := bar()
	if err != nil {
		return BarError{Err: err}
	}
}</code></pre></ol></ol><ol start="2" class="notion-list notion-list-numbered notion-block-fe958b5d0a7c4d06a05a39fff22ece70"><li>使用 fmt.Errorf 方法，⚠️ %w 和 %v 有不同的执行效果</li><ol class="notion-list notion-list-numbered notion-block-fe958b5d0a7c4d06a05a39fff22ece70"><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">if err != nil {
		// 使用 %w 指令，会返回一个包装了err的错误，接收方可以从父error中获取到源error
		// 并根据判断错误是否为某一个错误类型
		// sourceErr --wrap--&gt; WrapErr(sourceErr)
    return fmt.Errorf(&quot;bar failed: %w&quot;, err)
}

if err != nil {
		// 使用 %v 指令，不会包装错误，会直接转化为另一个错误，源错误不再可用
    // sourceErr --transform--&gt; otherErr
    return fmt.Errorf(&quot;bar failed: %v&quot;, err)
}
</code></pre></ol></ol><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-5eea680d96d54622bf61fc9df8741066"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27687%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRiwAAABXRUJQVlA4ICAAAACQAQCdASoQAAUABUB8JZwAAudR6dAA/sYFJUtPYAAAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfkkxdgp1j31gw0i6tel.jpg?table=block&amp;id=5eea680d-96d5-4622-bf61-fc9df8741066&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-8e9fc5aff060464f83fb8f2954c0406e">如果保留源错误的信息，会有潜在的耦合信息，因为接收方需要直接函数实现的细节，需要知道被包装的错误是什么类型，所以没有特殊需求在使用fmt.Errorf的时候使用%v指令。</div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-3cd2c017ab3e4a788dbb855fe703e324" data-id="3cd2c017ab3e4a788dbb855fe703e324"><span><div id="3cd2c017ab3e4a788dbb855fe703e324" class="notion-header-anchor"></div><a class="notion-hash-link" href="#3cd2c017ab3e4a788dbb855fe703e324" title="7.3 #50: Checking an error type inaccurately（如何正确的判断Error类型-error.As用法）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">7.3 #50: Checking an error type inaccurately（如何正确的判断Error类型-error.As用法）</span></span></h4><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func handler(w http.ResponseWriter, r *http.Request) {
	transactionID := r.URL.Query().Get(&quot;transaction&quot;)

	amount, err := getTransactionAmount(transactionID)
	if err != nil {
		if errors.As(err, &amp;transientError{}) {
			http.Error(w, err.Error(), http.StatusServiceUnavailable)
		} else {
			http.Error(w, err.Error(), http.StatusBadRequest)
		}
		return
	}

	// Write response
	_ = amount
}

func getTransactionAmount(transactionID string) (float32, error) {
	// Check transaction ID validity

	amount, err := getTransactionAmountFromDB(transactionID)
	if err != nil {
		return 0, fmt.Errorf(&quot;failed to get transaction %s: %w&quot;,
			transactionID, err)
	}
	return amount, nil
}

func getTransactionAmountFromDB(transactionID string) (float32, error) {
	// ...
	var err error
	if err != nil {
		return 0, transientError{err: err}
	}
	// ...
	return 0, nil
}</code></pre><div class="notion-text notion-block-cc26dc03b1fd4a0c8aea2d47acc1d32e">当使用%w指令或者结构体封装的方式包装一个错误的时候，可以使用 errors.As 递归判断错误类型，errors.As函数需要传递一个目标错误类型的指针。</div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-6a42791f2d9547509eac5152c344224d" data-id="6a42791f2d9547509eac5152c344224d"><span><div id="6a42791f2d9547509eac5152c344224d" class="notion-header-anchor"></div><a class="notion-hash-link" href="#6a42791f2d9547509eac5152c344224d" title="7.4 #51: Checking an error value inaccurately（如何正确的处理Error的值-error.Is用法）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">7.4 #51: Checking an error value inaccurately（如何正确的处理Error的值-error.Is用法）</span></span></h4><div class="notion-text notion-block-cf04f3b698524eccaf8a394a75a9d1da"><b>sentinel error </b>是指定义为全局变量的错误类型。<b>命名规约是以Err开头加上类型</b>。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">import &quot;errors&quot;
var ErrFoo = errors.New(&quot;foo&quot;)</code></pre><div class="notion-text notion-block-a1743b61d7ec4a819de917c0c47a8499">这种类型的错误，有时候是程序允许存在的错误，比如查询数据库返回没有查询到结果的sql.ErrNoRows和io.Reader读取返回io.EOF.他们传递的信息客户端可以接受，并认为是正常的情况。</div><div class="notion-text notion-block-00be84709c6141e1b49ac4e652c48e70">在查询数据的场景，我们想判断错误的值是否等于sql.ErrNoRows这种<b>sentinel error，</b>使用 == 可能会出现问题，因为ErrNoRows可能已经被包装过。对于这种问题，可以直接使用 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="http://errors.Is"><b>errors.Is</b></a><b> </b>来判断，他可以帮你递归判断出正确的错误。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func main() {
	err := query()
	if err != nil {
		// if err == sql.ErrNoRows {
		if errors.Is(err, sql.ErrNoRows) {
			// ...
		} else {
			// ...
		}
	}
}

func query() error {
	return nil
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-17dbaba54db2446b89667b17d775b52b" data-id="17dbaba54db2446b89667b17d775b52b"><span><div id="17dbaba54db2446b89667b17d775b52b" class="notion-header-anchor"></div><a class="notion-hash-link" href="#17dbaba54db2446b89667b17d775b52b" title="7.5 #52: Handling an error twice（多次处理错误）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">7.5 #52: Handling an error twice（多次处理错误）</span></span></h4><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-ff246c9ee04f46619c0a3baffd9239d3"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271071%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACwAQCdASoQAAkABUB8JQAAXOudR8AAAP7tzTjaDKMHDJ3iIuQAAyBaRRsyGwAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfqoq89goj31ja0tmani.jpg?table=block&amp;id=ff246c9e-e04f-4661-9c0a-3baffd9239d3&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-d5985c13735b497c862cab8b526e92e2" data-id="d5985c13735b497c862cab8b526e92e2"><span><div id="d5985c13735b497c862cab8b526e92e2" class="notion-header-anchor"></div><a class="notion-hash-link" href="#d5985c13735b497c862cab8b526e92e2" title="7.6 #53: Not handling an error（没有处理error）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">7.6 #53: Not handling an error（没有处理error）</span></span></h4><div class="notion-text notion-block-313fa9109059498c8d595a950ed0f995">如果代码中没有处理一个函数返回的error，需要编写注释明确指明不处理error的原因</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">// At-most once delivery.
// Hence, it&#x27;s accepted to miss some of them in case of errors.
 _ = notify()</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-2f5c6e56e9e644a1815addd5a1186c76" data-id="2f5c6e56e9e644a1815addd5a1186c76"><span><div id="2f5c6e56e9e644a1815addd5a1186c76" class="notion-header-anchor"></div><a class="notion-hash-link" href="#2f5c6e56e9e644a1815addd5a1186c76" title="7.7 #54: Not handling defer errors（没有处理defer语句中的error）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">7.7 #54: Not handling defer errors（没有处理defer语句中的error）</span></span></h4><div class="notion-text notion-block-d673a08e511e40538d79ee1ff9fe4cef">defer语句经常会做一些收尾工作，关闭socket，释放锁等..,有些语句会返回错误，如果不处理这些错误就会导致错误信息丢失，造成资源泄露等问题。本节提出了一个通过给错误返回值命名，在defer的时候把错误值赋值给返回结果，向上传递错误。</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-c6b629f676c949c28d26ce643e0eb665"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27763%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAAAwAQCdASoQAAYABUB8JYwAA3AA/vBl/VgRnYjho4mzKY1AAAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfr8gkmhjj319a0hatdy.jpg?table=block&amp;id=c6b629f6-76c9-49c2-8d26-ce643e0eb665&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">// 一种解决方式是使用命名结果，把错误信息通过命名结果返回
func getBalance(db *sql.DB, clientID string) (balance float32, err error) {
	rows, err := db.Query(query, clientID)
	if err != nil {
		return 0, err
	}
	defer func() {
		closeErr := rows.Close()
		if err != nil {
			if closeErr != nil {
        // 如果db.Query语句也出现了执行错误，把close错误的信息打印出来
				log.Printf(&quot;failed to close rows: %v&quot;, err)
			}
			return
		}
		// 当只要close的时候有错误，把closeErr赋值给err传递到上一层
		err = closeErr
	}()

	// Use rows
	return 0, nil
}</code></pre><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-71c585c466b9491d9911837721721de8" data-id="71c585c466b9491d9911837721721de8"><span><div id="71c585c466b9491d9911837721721de8" class="notion-header-anchor"></div><a class="notion-hash-link" href="#71c585c466b9491d9911837721721de8" title="8 Concurrency: Foundations"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">8 Concurrency: Foundations</span></span></h3><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-c2d13cad020f4e319e377b0bfed1c883" href="https://golang.design/under-the-hood/zh-cn/part1basic/ch05sync/mem/"><div><div class="notion-bookmark-title">5.9 内存一致模型</div><div class="notion-bookmark-description">5.9 内存一致模型 读者可能注意到了，无论是在谈论 Go 的运行时还是编译器，直到目前为止我们都有意无意的 尝试去回避 Go 语言的「内存模型」这个话题。 这有非常多的原因，作为本章的收尾，也是全书对 Go 语言同步原语与同步模式的一个总结， 我们最后来详细展开内存模型这个话题，解答读者心中的疑惑。 对为什么到目前为止我们都刻意的回避有关内存模型的内容作出一个相对完整的解释。 5.9.1 内存模型的重要性 内存一致模型，或称内存模型，是一份语言用户与语言自身、语言自身与所在的操作系统平台、 所在操作系统平台与硬件平台之间的契约。它定义了并行状态下拥有确定读取和写入的时序的条件， 并回答了一个共享变量是否具有足够的同步机制来保障一个线程的写入能否发生在另一个线程的读取之前这个问题。 在一份 Go 语言的程序被写成后，将经过编译器的转换与优化、所运行操作系统或虚拟机等动态优化器的优化，以及 CPU 硬件平台对指令流的优化才最终得以被执行。这个过程意味着，对于某一个变量的读取与写入操作，可能 被这个过程中任何一个中间步骤进行调整，从而偏离程序员在程序中所指定的原有顺序。 没有内存模型的保障，就无法正确的推演程序在最终被执行时的正确性。 内存模型的策略同样有着长期影响，并且直接决定了程序的可移植性和可维护性。 例如，过强的内存模型将约束硬件和编译器优化的空间，从而严重降低程序性能上限； 已经选择了强内存模型的硬件体系结构，无法在不破坏兼容性的情况下向更弱的内存模型进行迁移， 这种兼容性破坏所带来的代价就是要求其平台上的程序重新实现其源码。 这种横跨用户、软件与硬件三大领域的主题使得内存模型的设计愿景变得异常的困难，至今仍是一个开放的研究问题。因此在讨论 Go 语言的内存模型之前，我们还需要了解现有的内存模型、历史上软硬件平台之间形成契约的经验教训。 5.9.2 强序与弱序 令同步模型为对内存访问的一组约束，这些约束指定了需要如何以及何时完成同步，则当且仅当硬件与遵循该同步模型的所有软件顺序一致时，称该同步模型对于硬件而言满足弱序（Weak Ordering）。 5.9.3 免数据竞争范式 当一个程序在特定输入上具有顺序一致的执行顺序时，且其中两个相互冲突的操作同时执行，则称其为无数据竞争（Data-Race-Free, DRF）。 5.9.4 历史实践 C++ 是一个在内存模型方面实践优秀的一个例子。 线性一致性：又称强一致性或原子一致性。它要求任何一次读操作都能读到某个数据的最近一次写的数据，并且所有线程的操作顺序与全局时钟下的顺序是一致的。  x.store(1) x.load() G1 ---------+----------------+------&gt; G2 -------------------+-------------&gt; x.store(2) 在这种情况下线程 G1, G2 对 x 的两次写操作是原子的，且 x.store(1) 是严格的发生在 x.store(2) 之前，x.store(2) 严格的发生在 x.load() 之前。 值得一提的是，线性一致性对全局时钟的要求是难以实现的，这也是人们不断研究比这个一致性更弱条件下其他一致性的算法的原因。 顺序一致性：同样要求任何一次读操作都能读到数据最近一次写入的数据，但未要求与全局时钟的顺序一致。  x.store(1) x.</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272000%27/%3e"/></span><img alt="5.9 内存一致模型" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRnwAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSD0AAAARL0AWYJocyO4IEugqIgK/FAohSXLmEE5hFR4hGPz6w3w2iOj/BPB/2HYPtOSwLIPa5mAvSdOwHUBmJj8BAFZQOCAYAAAAMAEAnQEqEAAQAAVAfCWkAANwAP7w5sAA&quot;)"/><noscript><img alt="5.9 内存一致模型" src="https://www.notion.so/image/https%3A%2F%2Fgolang.design%2Funder-the-hood%2Ffavicon.png?table=block&amp;id=c2d13cad-020f-4e31-9e37-7b0bfed1c883&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="notion-bookmark-link-text">https://golang.design/under-the-hood/zh-cn/part1basic/ch05sync/mem/</div></div></div></a></div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-d772c84a7288470fb5727ee663d840ab" data-id="d772c84a7288470fb5727ee663d840ab"><span><div id="d772c84a7288470fb5727ee663d840ab" class="notion-header-anchor"></div><a class="notion-hash-link" href="#d772c84a7288470fb5727ee663d840ab" title="8.6 #60: Misunderstanding Go contexts"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">8.6 #60: Misunderstanding Go contexts</span></span></h4><div class="notion-blank notion-block-a8d376b317f84cd9b3148ad7176d9e1b"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-c2b1bec366024ee29f324d77c553a7a5" data-id="c2b1bec366024ee29f324d77c553a7a5"><span><div id="c2b1bec366024ee29f324d77c553a7a5" class="notion-header-anchor"></div><a class="notion-hash-link" href="#c2b1bec366024ee29f324d77c553a7a5" title="9 Concurrency: Practice"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9 Concurrency: Practice</span></span></h3><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-5a466fc5c0394c7c97a9620f2d136d32" data-id="5a466fc5c0394c7c97a9620f2d136d32"><span><div id="5a466fc5c0394c7c97a9620f2d136d32" class="notion-header-anchor"></div><a class="notion-hash-link" href="#5a466fc5c0394c7c97a9620f2d136d32" title="9.1 #61: Propagating an inappropriate context（错误传递context）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.1 #61: Propagating an inappropriate context（错误传递context）</span></span></h4><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-cf7a70d4a1664ad6a1b928796d6c3d63"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27720%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRkIAAABXRUJQVlA4IDYAAADwAQCdASoQAAYABUB8JQBdgCIhCA5MkBgA/u/D+wKXNbqWDcr/ALDtIhD/DxlKxDxIjiT4AAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbibdjgitaj31q80meank.jpg?table=block&amp;id=cf7a70d4-a166-4ad6-a1b9-28796d6c3d63&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-0123f31d91754e75a1f25bd45fcfb612">为了能够异步执行写入消息队列的动作，又能继承来自request context中的值，我们可以编写自定义的context，只继承父context的值。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">type detach struct {
	ctx context.Context
}

func (d detach) Deadline() (time.Time, bool) {
	return time.Time{}, false
}

func (d detach) Done() &lt;-chan struct{} {
	return nil
}

func (d detach) Err() error {
	return nil
}

func (d detach) Value(key any) any {
	return d.ctx.Value(key)
}

func handler(w http.ResponseWriter, r *http.Request) {
	response, err := doSomeTask(r.Context(), r)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	go func() {
		err := publish(detach{ctx: r.Context()}, response)
		// Do something with err
		_ = err
	}()

	writeResponse(response)
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-9f6aff3b0c784ae2812685c866c15393" data-id="9f6aff3b0c784ae2812685c866c15393"><span><div id="9f6aff3b0c784ae2812685c866c15393" class="notion-header-anchor"></div><a class="notion-hash-link" href="#9f6aff3b0c784ae2812685c866c15393" title="9.2 #62: Starting a goroutine without knowing when to stop it（管理好协程）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.2 #62: Starting a goroutine without knowing when to stop it（管理好协程）</span></span></h4><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func main() {
	w := newWatcher()
	defer w.close()

	// Run the application
}

func newWatcher() watcher {
	w := watcher{}
	go w.watch()
	return w
}

type watcher struct { /* Some resources */
}

func (w watcher) watch() {}

func (w watcher) close() {
	// Close the resources
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-255963cd490e4c81be70d07858aaa2ee" data-id="255963cd490e4c81be70d07858aaa2ee"><span><div id="255963cd490e4c81be70d07858aaa2ee" class="notion-header-anchor"></div><a class="notion-hash-link" href="#255963cd490e4c81be70d07858aaa2ee" title="9.3 #63: Not being careful with goroutines and loop variables（在range loop中执行协程，注意不要引用range生成的变量）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.3 #63: Not being careful with goroutines and loop variables（在range loop中执行协程，注意不要引用range生成的变量）</span></span></h4><div class="notion-text notion-block-dfcc4d9861f449eb8deae93e16f9ca93">参考 <a class="notion-link" href="https://yangsoon.github.io/100-go-mistakes-and-how-to-avoid-them--1#f78ef2507ea64ebda88578bfb188720c">#30</a></div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func listing1() {
	s := []int{1, 2, 3}
	// 协程打印的结果可能会出现相同的值
	for _, i := range s {
		go func() {
			fmt.Print(i)
		}()
	}
}
// 解决方案一
func listing2() {
	s := []int{1, 2, 3}
	
	for _, i := range s {
		val := i
		go func() {
			fmt.Print(val)
		}()
	}
}
// 解决方案二
func listing3() {
	s := []int{1, 2, 3}

	for _, i := range s {
		go func(val int) {
			fmt.Print(val)
		}(i)
	}
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-cc9257701c7b4ae5823f025bd222029b" data-id="cc9257701c7b4ae5823f025bd222029b"><span><div id="cc9257701c7b4ae5823f025bd222029b" class="notion-header-anchor"></div><a class="notion-hash-link" href="#cc9257701c7b4ae5823f025bd222029b" title="9.4 #64: Expecting deterministic behavior using select and channels（错误的以为 select 的执行结果是确定的）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.4 #64: Expecting deterministic behavior using select and channels（错误的以为 select 的执行结果是确定的）</span></span></h4><ul class="notion-list notion-list-disc notion-block-fccf2654571d4d2092266509e082c70c"><li>select 中的 case 执行时机是随机的</li></ul><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-4c4b43ef4eda4ed29773699c3d1943db"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27888%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRkAAAABXRUJQVlA4IDQAAABwAQCdASoQAAcABUB8JQAAXILjAAD+78P0LX+qJKHEgMI0ar+zRjIgffCYuPUeFApoAAAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjepyykqj31ca0lg47c.jpg?table=block&amp;id=4c4b43ef-4eda-4ed2-9773-699c3d1943db&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-34f14f8a46164a189c6989de6aa6781c">解决方案可以是使用for-select嵌套：</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-ae22c659121143ce9e835a792f1a021a"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271079%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRigAAABXRUJQVlA4IBwAAAAwAQCdASoQAAkABUB8JaQAA3AA/vCTr0unFgAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjgb39klj310s0juwh4.jpg?table=block&amp;id=ae22c659-1211-43ce-9e83-5a792f1a021a&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-0adc00225b0949c593a91ba31aff7abb" data-id="0adc00225b0949c593a91ba31aff7abb"><span><div id="0adc00225b0949c593a91ba31aff7abb" class="notion-header-anchor"></div><a class="notion-hash-link" href="#0adc00225b0949c593a91ba31aff7abb" title="9.5 #65: Not using notification channels（chan struct{} 可以用于通知事件）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.5 #65: Not using notification channels（chan struct{} 可以用于通知事件）</span></span></h4><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">// struct{} 不占用内存，经常用于通知场景
chan struct{}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-1f280e09a0dd42168597b64b70fef159" data-id="1f280e09a0dd42168597b64b70fef159"><span><div id="1f280e09a0dd42168597b64b70fef159" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1f280e09a0dd42168597b64b70fef159" title="9.6 #66: Not using nil channels（利用nil的channel读写都会block的特性）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.6 #66: Not using nil channels（利用nil的channel读写都会block的特性）</span></span></h4><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-0715f0c55f794522a41f27233d9ed647"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:480px;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271225%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRkQAAABXRUJQVlA4IDgAAADQAQCdASoQAAoABUB8JZAAAudSvXUaAAD+78Nlqe7GDD+q7mOMW/2C5MYVqQTcWQBmV3rBjogAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjsatms6j310a0m8q8p.jpg?table=block&amp;id=0715f0c5-5f79-4522-a41f-27233d9ed647&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><ul class="notion-list notion-list-disc notion-block-7d4a3d12980440f6a65897353929b8e6"><li>GO对于close的channel仍然能够读取到0值，所以需要使用  <code class="notion-inline-code">v, open := &lt;-ch</code> 语法中的open来判断channel是否被close</li></ul><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-8e1c18ad763a475e89f7e6bc06005ee2"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:576px;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271547%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAABwAQCdASoQAAwABUB8JQAAXOi1gAD+78PTalf6BwRerTmRXpyaRDAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjx84ansj31bs10yaip.jpg?table=block&amp;id=8e1c18ad-763a-475e-89f7-e6bc06005ee2&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-b8eaa0a4d4354ee095514733f8163b15"><b>解决方案：通过 </b><b><code class="notion-inline-code">v, open := &lt;-ch</code></b><b> 语法判断 chan 是否被close，避免读取0值，close之后的channel置为nil，避免for循环空转</b></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-5f0c7c0c7607468f85ebd4b215228044"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:576px;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271369%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjgAAABXRUJQVlA4ICwAAACwAQCdASoQAAsABUB8JQAAXQXhlZwAAP7vvWec+Y0zLFdOWoXJvR5h4AAAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjzxzub1j31520s445i.jpg?table=block&amp;id=5f0c7c0c-7607-468f-85eb-d4b215228044&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-08e9a857ec474fdb8aa9c5bc48c869ed" data-id="08e9a857ec474fdb8aa9c5bc48c869ed"><span><div id="08e9a857ec474fdb8aa9c5bc48c869ed" class="notion-header-anchor"></div><a class="notion-hash-link" href="#08e9a857ec474fdb8aa9c5bc48c869ed" title="9.7 #67: Being puzzled about channel size（不清楚channel的大小如何设置）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.7 #67: Being puzzled about channel size（不清楚channel的大小如何设置）</span></span></h4><ul class="notion-list notion-list-disc notion-block-e8cdcd4cee404960a078eafd872eafb5"><li>无缓存的channel可以用于同步场景</li></ul><ul class="notion-list notion-list-disc notion-block-0546b16358e443c39e72b73acad85c60"><li>带有缓存的channel经常用于传递消息，控制协程数量等等</li></ul><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-f2c2e94e998a4de7a5aebcf06d550ed8" data-id="f2c2e94e998a4de7a5aebcf06d550ed8"><span><div id="f2c2e94e998a4de7a5aebcf06d550ed8" class="notion-header-anchor"></div><a class="notion-hash-link" href="#f2c2e94e998a4de7a5aebcf06d550ed8" title="9.8 #68: Forgetting about possible side effects with string formatting（字符串格式化可能会带来的并发错误）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.8 #68: Forgetting about possible side effects with string formatting（字符串格式化可能会带来的并发错误）</span></span></h4><div class="notion-text notion-block-ee5bb67f6ad14fabbb0b1a7dce24d9c2">如下例子，在 age &lt; 0 的场景下 UpdateAge 会执行到 fmt.Errorf 函数并打印结构体c，fmt.Errorf会直接调用c结构的 String 方法导致死锁。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">type Customer struct {
	mutex sync.RWMutex
	id    string
	age   int
}

func (c *Customer) UpdateAge(age int) error {
	c.mutex.Lock()
	defer c.mutex.Unlock()

	if age &lt; 0 {
		return fmt.Errorf(&quot;age should be positive for customer %v&quot;, c)
	}

	c.age = age
	return nil
}

func (c *Customer) String() string {
	c.mutex.RLock()
	defer c.mutex.RUnlock()
	return fmt.Sprintf(&quot;id %s, age %d&quot;, c.id, c.age)
}</code></pre><div class="notion-text notion-block-6cfd237816aa497193d6409a1d72e941">解决方案是缩小加锁的范围，只在对临界区的值进行修改的时候才加锁</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func (c *Customer) UpdateAge2(age int) error {
	if age &lt; 0 {
		return fmt.Errorf(&quot;age should be positive for customer %v&quot;, c)
	}

	c.mutex.Lock()
	defer c.mutex.Unlock()

	c.age = age
	return nil
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-a48e9d534a7b4ccd98c663a6fa09431b" data-id="a48e9d534a7b4ccd98c663a6fa09431b"><span><div id="a48e9d534a7b4ccd98c663a6fa09431b" class="notion-header-anchor"></div><a class="notion-hash-link" href="#a48e9d534a7b4ccd98c663a6fa09431b" title="9.9 #69: Creating data races with append（使用append函数的时候出现data race）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.9 #69: Creating data races with append（使用append函数的时候出现data race）</span></span></h4><ul class="notion-list notion-list-disc notion-block-453398a11f7d4d7fa1a2e55388f769ed"><li>注意append操作不是线程安全的</li></ul><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-afeef38e58d141e490fb9eb2c37f6023"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27919%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAACwAQCdASoQAAcABUB8JZQAAxZgjkQAAP7nrpu3K66aoH3cjtsAS8gA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjh3fld7pj31eg0n6n7d.jpg?table=block&amp;id=afeef38e-58d1-41e4-90fb-9eb2c37f6023&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-0ffe02a27a294bee80cb975ea1a74581" data-id="0ffe02a27a294bee80cb975ea1a74581"><span><div id="0ffe02a27a294bee80cb975ea1a74581" class="notion-header-anchor"></div><a class="notion-hash-link" href="#0ffe02a27a294bee80cb975ea1a74581" title="9.10 #70: Using mutexes inaccurately with slices and maps（错误的给slice和map加锁）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.10 #70: Using mutexes inaccurately with slices and maps（错误的给slice和map加锁）</span></span></h4><div class="notion-text notion-block-88f060bd7d3f4788ba4ebfbc76dab641">当有2个协程同事调用 AddBalance 和 AverageBalance，还会出现data race，因为 AverageBalance 中对 c.balances 只拷贝引用，对slice同理。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">type Cache struct {
	mu       sync.RWMutex
	balances map[string]float64
}

func (c *Cache) AddBalance(id string, balance float64) {
	c.mu.Lock()
	c.balances[id] = balance
	c.mu.Unlock()
}

func (c *Cache) AverageBalance() float64 {
	c.mu.RLock()
	balances := c.balances
	c.mu.RUnlock()

	sum := 0.
	for _, balance := range balances {
		sum += balance
	}
	return sum / float64(len(balances))
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-beeca05016534a87b16010addf066c52" data-id="beeca05016534a87b16010addf066c52"><span><div id="beeca05016534a87b16010addf066c52" class="notion-header-anchor"></div><a class="notion-hash-link" href="#beeca05016534a87b16010addf066c52" title="9.11 #71: Misusing sync.WaitGroup（错误使用 sync.WaitGroup）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.11 #71: Misusing sync.WaitGroup（错误使用 sync.WaitGroup）</span></span></h4><div class="notion-text notion-block-f77b15bb406e4855b5ef24046fc192d3">因为 for 循环创建的3个协程是异步执行，可能执行到wg.Wait的时候有2个协程已经执行成功并退出了，所以v的值可能为2</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func main() {
	wg := sync.WaitGroup{}
	var v uint64

	for i := 0; i &lt; 3; i++ {
		go func() {
			wg.Add(1)
			atomic.AddUint64(&amp;v, 1)
			wg.Done()
		}()
	}

	wg.Wait()
	fmt.Println(v)
}</code></pre><div class="notion-text notion-block-8d2479834f18442da7c4b6bbb17290c7">解决方案一</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func main() {
	wg := sync.WaitGroup{}
	var v uint64

	wg.Add(3)
	for i := 0; i &lt; 3; i++ {
		go func() {
			atomic.AddUint64(&amp;v, 1)
			wg.Done()
		}()
	}

	wg.Wait()
	fmt.Println(v)
}</code></pre><div class="notion-text notion-block-6c29ce3f4eed49b593c858df7a2a7e2b">解决方案二</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func main() {
	wg := sync.WaitGroup{}
	var v uint64

	for i := 0; i &lt; 3; i++ {
		wg.Add(1)
		go func() {
			atomic.AddUint64(&amp;v, 1)
			wg.Done()
		}()
	}

	wg.Wait()
	fmt.Println(v)
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-21c7ccf6a3364bb6bcfa675201e730b7" data-id="21c7ccf6a3364bb6bcfa675201e730b7"><span><div id="21c7ccf6a3364bb6bcfa675201e730b7" class="notion-header-anchor"></div><a class="notion-hash-link" href="#21c7ccf6a3364bb6bcfa675201e730b7" title="9.12 #72: Forgetting about sync.Cond（别忘记条件变量sync.Cond）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.12 #72: Forgetting about sync.Cond（别忘记条件变量sync.Cond）</span></span></h4><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-b2f2680997644f19a03422447742004b" href="https://geektutu.com/post/hpg-sync-cond.html"><div><div class="notion-bookmark-title">Go sync.Cond | Go 语言高性能编程 | 极客兔兔</div><div class="notion-bookmark-description">Go 语言/golang 高性能编程，Go 语言进阶教程，Go 语言高性能编程(high performance go)。sync.Cond 是一个条件锁，也被称为条件变量，常用来一写多读(一个 goroutine 通知多个在等待的 goroutines)的场景。</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272000%27/%3e"/></span><img alt="Go sync.Cond | Go 语言高性能编程 | 极客兔兔" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRmYAAABXRUJQVlA4IFoAAABwAgCdASoQABAABUB8JbACdH8AFC6wyImyc7DAAPaOm7ZuB9T9glxeiEuAabs/A/Yx58LekgPLrFy+aWU25Bqx00Pi1ZMHr4aDoxmAEN/qo7Ux6LN80bBgAAA=&quot;)"/><noscript><img alt="Go sync.Cond | Go 语言高性能编程 | 极客兔兔" src="https://www.notion.so/image/https%3A%2F%2Fgeektutu.com%2Fimg%2Ficon.png?table=block&amp;id=b2f26809-9764-4f19-a034-22447742004b&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="notion-bookmark-link-text">https://geektutu.com/post/hpg-sync-cond.html</div></div></div></a></div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func main() {
	type Donation struct {
		cond    *sync.Cond
		balance int
	}

	donation := &amp;Donation{
		cond: sync.NewCond(&amp;sync.Mutex{}),
	}

	// Listener goroutines
	f := func(goal int) {
		donation.cond.L.Lock()
		for donation.balance &lt; goal {
			donation.cond.Wait()
		}
		fmt.Printf(&quot;%d$ goal reached\n&quot;, donation.balance)
		donation.cond.L.Unlock()
	}

	go f(10)
	go f(15)

	// Updater goroutine
	for {
		time.Sleep(time.Second)
		donation.cond.L.Lock()
		donation.balance++
		donation.cond.L.Unlock()
		donation.cond.Broadcast()
	}
}</code></pre><div class="notion-text notion-block-1403eaf66acf49a0a0bf63b7110b08c8">使用Cond可以避免CPU空转的情况。</div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-05073c8f5ad7409aa74519510ffa810a" data-id="05073c8f5ad7409aa74519510ffa810a"><span><div id="05073c8f5ad7409aa74519510ffa810a" class="notion-header-anchor"></div><a class="notion-hash-link" href="#05073c8f5ad7409aa74519510ffa810a" title="9.13 #73: Not using errgroup（使用 errgroup 采集多个协程执行结果）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.13 #73: Not using errgroup（使用 errgroup 采集多个协程执行结果）</span></span></h4><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-2ae63cfd1c6e411595d88c9cdad6ed48"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27701%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRigAAABXRUJQVlA4IBwAAAAwAQCdASoQAAYABUB8JaQAA3AA/vBnJdvxRIAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjiirbgghj31f60hywhb.jpg?table=block&amp;id=2ae63cfd-1c6e-4115-95d8-8c9cdad6ed48&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-57ce497e3cf849bcb7d80b07f519d22f">使用 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="http://golang.org/x/sync/errgroup">golang.org/x/sync/errgroup</a> 采集多个协程的错误, 但是 errorgroup限制比较多，需要函数签名符合<code class="notion-inline-code">func() error {}</code> </div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-f399ca3ff7da4e33897a2bec1ce11812"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271189%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAAAwAQCdASoQAAoABUB8JZwAA3AA/vBkMLPCIt2QO3UjS1tNtwaAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjiqad262j31aq0rsaib.jpg?table=block&amp;id=f399ca3f-f7da-4e33-897a-2bec1ce11812&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-13051c2fd25940038708bd92d9da1e65">k8s 中提供了集合多种错误的功能，可以参考 k8s.io/apimachinery/pkg/util/errors/errors.go:35</div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-025990b71780448ebddbc41d3b01a39d" data-id="025990b71780448ebddbc41d3b01a39d"><span><div id="025990b71780448ebddbc41d3b01a39d" class="notion-header-anchor"></div><a class="notion-hash-link" href="#025990b71780448ebddbc41d3b01a39d" title="9.14 #74: Copying a sync type（同步类型的值不能被拷贝）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">9.14 #74: Copying a sync type（同步类型的值不能被拷贝）</span></span></h4><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-ab42b85ce154496c89b6fe46d0422f90"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:528px;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27950%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjwAAABXRUJQVlA4IDAAAACwAQCdASoQAAgABUB8JQAAXUjdZLLAAP7vxEd0wiRocXfi5fbFND1NmUxfYhGGAAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjj0adk20j31200i2q9f.jpg?table=block&amp;id=ab42b85c-e154-496c-89b6-fe46d0422f90&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-1ff65c476e0743948707313437896372">以下类型均不能被拷贝</div><ul class="notion-list notion-list-disc notion-block-848371a5c99241a29f866ef4658c51f8"><li>sync.Cond</li></ul><ul class="notion-list notion-list-disc notion-block-84ae3f8e908e4bbbbf8ae86a3da41474"><li>sync.Map</li></ul><ul class="notion-list notion-list-disc notion-block-9f4045fb444c40d3b7f82b06b9cefbca"><li>sync.Mutex</li></ul><ul class="notion-list notion-list-disc notion-block-c7621cb3721b46efbefdddfb3b44cc0b"><li>sync.RWMutex </li></ul><ul class="notion-list notion-list-disc notion-block-ef69e218a8c84af289d3ca12b0e3439f"><li>sync.Once</li></ul><ul class="notion-list notion-list-disc notion-block-cd32d9b8e8d445289e875d90015e01ed"><li>sync.Pool</li></ul><ul class="notion-list notion-list-disc notion-block-288b18834bb543fe82a99d9be770b80d"><li>sync.WaitGroup</li></ul><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-9f15a4b71af74561a178be3549245a31" data-id="9f15a4b71af74561a178be3549245a31"><span><div id="9f15a4b71af74561a178be3549245a31" class="notion-header-anchor"></div><a class="notion-hash-link" href="#9f15a4b71af74561a178be3549245a31" title="10 The standard library"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">10 The standard library</span></span></h3><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-7047667f245f469981a1116b2ea7da39" data-id="7047667f245f469981a1116b2ea7da39"><span><div id="7047667f245f469981a1116b2ea7da39" class="notion-header-anchor"></div><a class="notion-hash-link" href="#7047667f245f469981a1116b2ea7da39" title="10.1 #75: Providing a wrong time duration（记住标准库的时间单位）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">10.1 #75: Providing a wrong time duration（记住标准库的时间单位）</span></span></h4><ul class="notion-list notion-list-disc notion-block-06912f42ff0d4a189e5194e03629e89f"><li>设置时间的时候还是建议使用time.Duration类型，不要直接用数字</li></ul><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func listing1() {
	ticker := time.NewTicker(1000)
	for {
		select {
		case &lt;-ticker.C:
			fmt.Println(&quot;tick&quot;)
		}
	}
}

func listing2() {
	ticker := time.NewTicker(time.Microsecond)
	for {
		select {
		case &lt;-ticker.C:
			fmt.Println(&quot;tick&quot;)
		}
	}
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-84aab02c211440debf63aacf4441ece8" data-id="84aab02c211440debf63aacf4441ece8"><span><div id="84aab02c211440debf63aacf4441ece8" class="notion-header-anchor"></div><a class="notion-hash-link" href="#84aab02c211440debf63aacf4441ece8" title="10.2 #76: time.After and memory leaks （使用 time.After 可能会导致内存溢出）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">10.2 #76: time.After and memory leaks （使用 time.After 可能会导致内存溢出）</span></span></h4><div class="notion-text notion-block-b20ff457f8d2434781001d5580ddaff7">每次调用 <code class="notion-inline-code">time.After</code> 时使用大约200字节的内存。但是只有在指定的时间到达的时候才会GC，如果在1小时内，频繁的调用 <code class="notion-inline-code">time.After</code> 会导致内存爆炸。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func consumer1(ch &lt;-chan Event) {
	for {
		select {
		case event := &lt;-ch:
			handle(event)
		case &lt;-time.After(time.Hour):
			log.Println(&quot;warning: no messages received&quot;)
		}
	}
}

// 解决方案一
func consumer2(ch &lt;-chan Event) {
	for {
		ctx, cancel := context.WithTimeout(context.Background(), time.Hour)
		select {
		case event := &lt;-ch:
			cancel()
			handle(event)
		case &lt;-ctx.Done():
			log.Println(&quot;warning: no messages received&quot;)
		}
	}
}

// 解决方案二，创建一次 Timer 每次循环都会重置时间
func consumer3(ch &lt;-chan Event) {
	timerDuration := 1 * time.Hour
	timer := time.NewTimer(timerDuration)

	for {
		timer.Reset(timerDuration)
		select {
		case event := &lt;-ch:
			handle(event)
		case &lt;-timer.C:
			log.Println(&quot;warning: no messages received&quot;)
		}
	}
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-06e85100611245999f647b2d5a2a6756" data-id="06e85100611245999f647b2d5a2a6756"><span><div id="06e85100611245999f647b2d5a2a6756" class="notion-header-anchor"></div><a class="notion-hash-link" href="#06e85100611245999f647b2d5a2a6756" title="10.3 #77: Common JSON-handling mistakes（常见的 JSON 处理错误）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">10.3 #77: Common JSON-handling mistakes（常见的 JSON 处理错误）</span></span></h4><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-fd82c821b59041d9b6672bafa3db1cd0" href="https://zhuanlan.zhihu.com/p/53125839"><div><div class="notion-bookmark-title">go json 实践中遇到的坑</div><div class="notion-bookmark-description">在使用 go 语言开发过程中，经常需要使用到 json 包来进行 json 和 struct 的互相转换，在使用过程中，遇到了一些需要额外注意的地方，记录如下。 整数变浮点数问题假设有一个 Person 结构，其中包含 Age int64 和…</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272000%27/%3e"/></span><img alt="go json 实践中遇到的坑" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRrYAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSDgAAAARD9D/iAiwqa29yZe2RlM8ZOpZYwCUsLaJtXcc4AQT6Ijof2j0JOARpfxMNeSk/q5WBwq8WJExAlZQOCBYAAAAMAIAnQEqEAAQAAVAfCWwAnS6ABCSD7Rp2IAA/Rq9d/8IprfV7WTm9aip9ilUb3xYIZJjsRUozTXvOQ8J1LIspl6/6D5nunMzyQ0H8jfeZ9M97aFyegAAAA==&quot;)"/><noscript><img alt="go json 实践中遇到的坑" src="https://www.notion.so/image/https%3A%2F%2Fstatic.zhihu.com%2Fheifetz%2Fassets%2Fapple-touch-icon-152.81060cab.png?table=block&amp;id=fd82c821-b590-41d9-b667-2bafa3db1cd0&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="notion-bookmark-link-text">https://zhuanlan.zhihu.com/p/53125839</div></div></div><div class="notion-bookmark-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271111%27/%3e"/></span><img alt="go json 实践中遇到的坑" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjwAAABXRUJQVlA4IDAAAACwAQCdASoQAAkABUB8JaQAAt0LI1EAAP7tnv1Q2LXteOfrlWNMUsU7SJ8XcwL0AAA=&quot;)"/><noscript><img alt="go json 实践中遇到的坑" src="https://www.notion.so/image/https%3A%2F%2Fpic1.zhimg.com%2Fv2-9281b3e47858daa5e9086f0a0047d116_720w.jpg%3Fsource%3D172ae18b?table=block&amp;id=fd82c821-b590-41d9-b667-2bafa3db1cd0&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a></div><div class="notion-text notion-block-caa56b20195d42d5be4641236961ea50"><b>Unexpected behavior due to type embedding</b></div><div class="notion-text notion-block-6ac96acb1077472f8767c40e4127ef23">如果类型实现了 <code class="notion-inline-code">Marshaler</code> 接口，在调用 <code class="notion-inline-code">json.Marshal</code> 的时候，会直接调用 <code class="notion-inline-code">MarshalJSON</code> 方法。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">type Marshaler interface {
    MarshalJSON() ([]byte, error)
}</code></pre><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">// Event1 内嵌了 time.Time 类型，会自动实现 time.Time 的所有方法
// time.Time 实现了 Marshaler 接口，所以 Marshal Event1 的时候会直接调用
// time.Time 的 MarshalJSON 方法
type Event1 struct {
	ID int
	time.Time
}

func listing1() error {
	event := Event1{
		ID:   1234,
		Time: time.Now(),
	}

	b, err := json.Marshal(event)
	if err != nil {
		return err
	}
	// &quot;2021-05-18T21:15:08.381652+02:00&quot;
	fmt.Println(string(b))
	return nil
}

// 解决方案一：不使用内嵌类型，给 time.Time 定义一个成员名字 
type Event2 struct {
	ID   int
	Time time.Time
}

func listing2() error {
	event := Event2{
		ID:   1234,
		Time: time.Now(),
	}

	b, err := json.Marshal(event)
	if err != nil {
		return err
	}

	fmt.Println(string(b))
	return nil
}

type Event3 struct {
	ID int
	time.Time
}

// 解决方案二：给 Event 类型实现 MarshalJSON 方法
func (e Event3) MarshalJSON() ([]byte, error) {
	return json.Marshal(
		struct {
			ID   int
			Time time.Time
		}{
			ID:   e.ID,
			Time: e.Time,
		},
	)
}

func listing3() error {
	event := Event3{
		ID:   1234,
		Time: time.Now(),
	}

	b, err := json.Marshal(event)
	if err != nil {
		return err
	}

	fmt.Println(string(b))
	return nil
}</code></pre><div class="notion-text notion-block-76b3e79a509f42788fae4c52782e49e8"><b>JSON and the monotonic clock</b></div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-63d79e7012a2432eab71df3357377542" href="https://zhuanlan.zhihu.com/p/47754783"><div><div class="notion-bookmark-title">理解Golang的Time结构</div><div class="notion-bookmark-description">在golang中创建并打印一个时间对象，会看到如下输出 2018-10-26 14:15:50.306558969 +0800 CST m=+0.000401093前面表示的意义好理解，分别是年月日和时间时区，最后的m=+xxxx这部分代表什么呢？ Monotonic Clocks …</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272000%27/%3e"/></span><img alt="理解Golang的Time结构" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRrYAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSDgAAAARD9D/iAiwqa29yZe2RlM8ZOpZYwCUsLaJtXcc4AQT6Ijof2j0JOARpfxMNeSk/q5WBwq8WJExAlZQOCBYAAAAMAIAnQEqEAAQAAVAfCWwAnS6ABCSD7Rp2IAA/Rq9d/8IprfV7WTm9aip9ilUb3xYIZJjsRUozTXvOQ8J1LIspl6/6D5nunMzyQ0H8jfeZ9M97aFyegAAAA==&quot;)"/><noscript><img alt="理解Golang的Time结构" src="https://www.notion.so/image/https%3A%2F%2Fstatic.zhihu.com%2Fheifetz%2Fassets%2Fapple-touch-icon-152.81060cab.png?table=block&amp;id=63d79e70-12a2-432e-ab71-df3357377542&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="notion-bookmark-link-text">https://zhuanlan.zhihu.com/p/47754783</div></div></div><div class="notion-bookmark-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27808%27/%3e"/></span><img alt="理解Golang的Time结构" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAAAwAQCdASoQAAYABUB8JaQAA3AA/vBJ+7MeyZP9TBvjO/SAAAA=&quot;)"/><noscript><img alt="理解Golang的Time结构" src="https://www.notion.so/image/https%3A%2F%2Fpicx.zhimg.com%2Fv2-fae5dcfcf8827c6066d51f9b12cd9864_720w.jpg%3Fsource%3D172ae18b?table=block&amp;id=63d79e70-12a2-432e-ab71-df3357377542&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a></div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">now := time.Now()
encodeNow, _ := json.Marshal(now)

decodeNow := time.Time{}
json.Unmarshal(encodeNow, &amp;decodeNow)

fmt.Println(now)  // 2018-10-26 16:04:55.230121766 +0800 CST m=+0.000520419
fmt.Println(decodeNow)  // 2018-10-26 16:04:55.230121766 +0800 CST</code></pre><div class="notion-text notion-block-1ab793b747f24b888cfee949b9e75b22">可以看到，经过JSON转码之后，Time结构体会被表示成不带Monotonic Clock的字符串，丢失了Monotonic Clock信息，而将字符串转码回Time结构时，自然也就和转码之前的不一样了。同样的情况，也发生在数据库存储中，存储到数据库里的Time结构和从数据库取出来的也是不一样的。</div><ul class="notion-list notion-list-disc notion-block-83e828052dc94e538f3e51e440cfd9c8"><li>可以使用 Time.Equal() 对比时间是否相关，这里判断相等不会包含单调时间</li></ul><ul class="notion-list notion-list-disc notion-block-237e8057b4ac4260b71c491d34183dd0"><li>使用 Time.Truncate() 函数排除单调时钟</li><ul class="notion-list notion-list-disc notion-block-237e8057b4ac4260b71c491d34183dd0"><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-c344609fbc314c18bd1f862c52a36993"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:528px;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271271%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAAAwAQCdASoQAAoABUB8JZQAA3AA/vBNe7Pr2YZOuhfObAEVAAEwAAAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkofx9925j31040my42u.jpg?table=block&amp;id=c344609f-bc31-4c18-bd1f-862c52a36993&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure></ul></ul><div class="notion-text notion-block-1bf3fec0d8ab4d12a2f1027252ced749"><b>Map of any</b></div><div class="notion-text notion-block-59593fcb288e4cea9fe7f19c4dd41452">当把json解析到 <code class="notion-inline-code">map[string]any</code> 类型，会出现数字类型解析错误的情况</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func listing1() error {
	b := getMessage()
	var m map[string]any
	err := json.Unmarshal(b, &amp;m)
	if err != nil {
		return err
	}
	return nil
}

func getMessage() []byte {
	return nil
}

// getMessage 函数返回如下json，解析后 id 类型为 float64
// {
//   &quot;id&quot;: 32,
//   &quot;name&quot;: &quot;foo&quot;
// }</code></pre><div class="notion-text notion-block-8994b0636c974a75be86d6328532d3e3">解决方案: <b>使用 json.Decoder 来代替 json.Unmarshal 方法</b></div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">decoder := json.NewDecoder(bytes.NewReader(getMessage()))
decoder.UseNumber()
var m map[string]any
decoder.Decode(&amp;personFromJSON)</code></pre><div class="notion-text notion-block-23cbab1f00d44562acc038eb0146e4ae">这种方法首先创建了一个 jsonDecoder，然后调用了 UseNumber 方法，从文档中可以知道，使用 UseNumber 方法后，json 包会将数字转换成一个内置的 Number 类型（而不是 float64），这个 Number 类型提供了转换为 int64、float64 等多个方法。</div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-3d60e22ec8614743b0f25122fb36b1b5" data-id="3d60e22ec8614743b0f25122fb36b1b5"><span><div id="3d60e22ec8614743b0f25122fb36b1b5" class="notion-header-anchor"></div><a class="notion-hash-link" href="#3d60e22ec8614743b0f25122fb36b1b5" title="10.4 #78: Common SQL mistakes（常见的 SQL 错误）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">10.4 #78: Common SQL mistakes（常见的 SQL 错误）</span></span></h4><div class="notion-text notion-block-d92c6e0a7a31476f824ec473518b420b"><b>Forgetting that sql.Open doesn’t necessarily establish connections to a database</b></div><div class="notion-callout notion-gray_background_co notion-block-89681485b930408ba8fcc7469d8471f6"><div class="notion-page-icon-inline notion-page-icon-span"><span class="notion-page-icon" role="img" aria-label="💡">💡</span></div><div class="notion-callout-text">sql.Open 可能只是验证其参数而不创建与数据库的连接</div></div><div class="notion-text notion-block-05b5f033ec4d461daf1d7cefb91b7c53">如果我们要确保使用 sql.Open 的函数也保证底层数据库可访问，我们应该使用Ping方法：</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func listing1() error {
	db, err := sql.Open(&quot;mysql&quot;, dsn)
	if err != nil {
		return err
	}
	// ping强制建立连接，确保数据源名称有效并且数据库可访问
	if err := db.Ping(); err != nil {
		return err
	}

	_ = db
	return nil
}</code></pre><div class="notion-text notion-block-4a96c111f2e24de5b271e8953499d5ed"><b>Forgetting about connections pooling</b></div><div class="notion-text notion-block-ba4e2bf835054edd9beb13c54ae119fd">sql.Open 返回一个sql.DB结构。这个结构不表示单个数据库连接，而是表示连接池。</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-58d13e736cf24dba8424eed3c75e4218"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27547%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACwAQCdASoQAAQABUB8JaQAAu19ie/gAP7ta0kIY8QrWGYASGAAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkoxg0061j31a40cmwj2.jpg?table=block&amp;id=58d13e73-6cf2-4dba-8424-eed3c75e4218&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-0d6a2f6f077542c5b8fb7c2049a372d6"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27544%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRi4AAABXRUJQVlA4ICIAAADQAQCdASoQAAQABUB8JaQAAueGu1VMAAD+7cYA+gRAAAAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkoxuh1sij319c0ccjx3.jpg?table=block&amp;id=0d6a2f6f-0775-42c5-b8fb-7c2049a372d6&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-47dd299abfba4c69bc7efc3e48f91eef"><b>Not using prepared statements</b></div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-6ae4a9311fac44adafcc226175df6950" href="https://manjusaka.itscoder.com/posts/2020/01/05/simple-introdution-about-sql-prepared/"><div><div class="notion-bookmark-title">简单聊聊 SQL 中的 Prepared Statements</div><div class="notion-bookmark-description">好久没写文章了，新年还是得写点技术水文来保证下状态，正好最近遇到一个比较有意思的问题，就来简单聊聊一下关于 MySQL 中 Prepared Statements 吧</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271993%27/%3e"/></span><img alt="简单聊聊 SQL 中的 Prepared Statements" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRnQAAABXRUJQVlA4IGgAAADQAQCdASoQABAABUB8JbACdAdwA9g8+AD+yNW/badNZ7FtlQtPwxNagUxzJaJlceYls4PpyPEAc/wCwsSyBsY3lFTevNnrVVfsWwLY+bA7COpLsyXtHSddlbfaojguDZIq/yVh4IdgAA==&quot;)"/><noscript><img alt="简单聊聊 SQL 中的 Prepared Statements" src="https://www.notion.so/image/https%3A%2F%2Fuser-images.githubusercontent.com%2F7054676%2F56820343-2fe1b580-687e-11e9-8f6f-778df3a8eafd.png?table=block&amp;id=6ae4a931-1fac-44ad-afcc-226175df6950&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="notion-bookmark-link-text">https://manjusaka.itscoder.com/posts/2020/01/05/simple-introdution-about-sql-prepared/</div></div></div><div class="notion-bookmark-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271050%27/%3e"/></span><img alt="简单聊聊 SQL 中的 Prepared Statements" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjgAAABXRUJQVlA4ICwAAAAwAQCdASoQAAgABUB8JZQAA3AA/vCAenTKTsOBz4xgQ077BXZ+UKG97M+AAA==&quot;)"/><noscript><img alt="简单聊聊 SQL 中的 Prepared Statements" src="https://www.notion.so/image/https%3A%2F%2Fmanjusaka.blog%2Fimg%2Fog_image.png?table=block&amp;id=6ae4a931-1fac-44ad-afcc-226175df6950&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a></div><div class="notion-text notion-block-73e7182c1f92409fb1fefc6fd4155379">使用 Prepare 方法创建 <b>prepared statements </b>，提升查询性能，避免重复解析 SQL 带来的开销</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func listing1(db *sql.DB, id string) error {
	stmt, err := db.Prepare(&quot;SELECT * FROM ORDER WHERE ID = ?&quot;)
	if err != nil {
		return err
	}
	rows, err := stmt.Query(id)
	if err != nil {
		return err
	}
	_ = rows
	return nil
}</code></pre><div class="notion-text notion-block-89a58d1f960a4f8cae84dbebf0e1c1f9"><b>Mishandling null values</b></div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func listing3(db *sql.DB, id string) error {
	rows, err := db.Query(&quot;SELECT DEP, AGE FROM EMP WHERE ID = ?&quot;, id)
	if err != nil {
		return err
	}
	// Defer closing rows

	var (
		// 使用 ql.NullString 类型，可以匹配在查询遇到NULL值的情况
		department sql.NullString
		age        int
	)
	for rows.Next() {
		err := rows.Scan(&amp;department, &amp;age)
		if err != nil {
			return err
		}
		// ...
	}
	return nil
}</code></pre><div class="notion-text notion-block-d9d3392dd4314aa097e0444be8eed06a"><b>Not handling row iteration errors</b></div><div class="notion-text notion-block-f39c82b9724d425f8f0d22f2946f1e64"><code class="notion-inline-code">for rows .Next() {}</code>  循环可能会因为没有查询到值或者遇到错误退出，所以退出后要调用 <code class="notion-inline-code">rows.Err()</code> 看是否是正常退出</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func get2(ctx context.Context, db *sql.DB, id string) (string, int, error) {
	rows, err := db.QueryContext(ctx,
		&quot;SELECT DEP, AGE FROM EMP WHERE ID = ?&quot;, id)
	if err != nil {
		return &quot;&quot;, 0, err
	}
	defer func() {
		err := rows.Close()
		if err != nil {
			log.Printf(&quot;failed to close rows: %v\n&quot;, err)
		}
	}()

	var (
		department string
		age        int
	)
	for rows.Next() {
		err := rows.Scan(&amp;department, &amp;age)
		if err != nil {
			return &quot;&quot;, 0, err
		}
	}
	if err := rows.Err(); err != nil {
		return &quot;&quot;, 0, err
	}

	return department, age, nil
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-8ea8463d42a64b52b9068b92b1d06e85" data-id="8ea8463d42a64b52b9068b92b1d06e85"><span><div id="8ea8463d42a64b52b9068b92b1d06e85" class="notion-header-anchor"></div><a class="notion-hash-link" href="#8ea8463d42a64b52b9068b92b1d06e85" title="10.5 #79: Not closing transient resources（没有及时关闭临时资源）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">10.5 #79: Not closing transient resources（没有及时关闭临时资源）</span></span></h4><div class="notion-text notion-block-771fa5dfd3ac48f881872473df326cab"><b>10.5.1 HTTP body</b></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-4636c31445ee46f09344aba743d5be67"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27863%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAACQAQCdASoQAAcABUB8JYwAAudQDBAA/u/DbQ+4c6ikAPcNQAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkl8uy7mxj319c0jkwkx.jpg?table=block&amp;id=4636c314-45ee-46f0-9344-aba743d5be67&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-b35a427dd84a435fb6fefbf5bb019d80">需要注意的点：</div><ul class="notion-list notion-list-disc notion-block-0151fd1e20d1497b85713e7a4b56cba1"><li><b>如果你没有读取Respose.Body的内容，那么默认的 http transport 会直接关闭连接</b></li></ul><ul class="notion-list notion-list-disc notion-block-9bd5ec0b6a664f80901804cffc0e6c96"><li><b>如果你读取了Body的内容，下次连接可以直接复用</b></li></ul><div class="notion-text notion-block-d3a0161a12c8472fa09c53c6f950a50f">在高并发的场景下，建议你使用长连接，可以调用 <code class="notion-inline-code">io.Copy(io.Discard, resp.Body)</code> 读取Body的内容。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func (h handler) getStatusCode2(body io.Reader) (int, error) {
	resp, err := h.client.Post(h.url, &quot;application/json&quot;, body)
	if err != nil {
		return 0, err
	}

	defer func() {
		err := resp.Body.Close()
		if err != nil {
			log.Printf(&quot;failed to close response: %v\n&quot;, err)
		}
	}()

	_, _ = io.Copy(io.Discard, resp.Body)

	return resp.StatusCode, nil
}</code></pre><div class="notion-text notion-block-13254856fafd446fb75d47e0b729e908"><b>10.5.2 sql.Rows</b></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-066b4fe73b0a415594c61becca3e9d8f"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:528px;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27844%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjYAAABXRUJQVlA4ICoAAACwAQCdASoQAAcABUB8JQAAXWUGinAAAP7vxZfvfflzp+h3Z6l8MulAAAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbklkt9cxrj316s0i243s.jpg?table=block&amp;id=066b4fe7-3b0a-4155-94c6-1becca3e9d8f&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-61f30ac516024026b1f0c224de4d4a52"><b>10.5.3 os.File</b></div><div class="notion-text notion-block-2b923df55a3348dab4b15e37cbcfab79">写入操作是异步的，所以对写入的文件进行close操作，可能会遇到在buffer内的数据没有写到磁盘的错误，所以在close的时候如果遇到错误要及时上报。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func writeToFile1(filename string, content []byte) (err error) {
	f, err := os.OpenFile(filename, os.O_APPEND|os.O_WRONLY, os.ModeAppend)
	if err != nil {
		return err
	}

	defer func() {
		closeErr := f.Close()
		if err == nil {
			err = closeErr
		}
	}()

	_, err = f.Write(content)
	return
}</code></pre><div class="notion-text notion-block-5612d0cce719462e9d50a83b52a4f119">但是如果使用了Sync调用可以同步的把数据写入磁盘，所以调用Close方法的时候也可以不用在意错误，因为数据已经正常写入。</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-279fc137aee54ee8a834c528b81c1399"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:528px;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27995%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAAAwAQCdASoQAAgABUB8JQAAbgAA/vBmEoDgg4jt4ZqmrHWzKYkgAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbklrxm43yj30z60hiwj0.jpg?table=block&amp;id=279fc137-aee5-4ee8-a834-c528b81c1399&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-48e75eaa3af84213bf2fc9062c03531f" data-id="48e75eaa3af84213bf2fc9062c03531f"><span><div id="48e75eaa3af84213bf2fc9062c03531f" class="notion-header-anchor"></div><a class="notion-hash-link" href="#48e75eaa3af84213bf2fc9062c03531f" title="10.6 #80: Forgetting the return statement after replying to an HTTP request（在发送完响应后忘记及时返回http handler函数）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">10.6 #80: Forgetting the return statement after replying to an HTTP request（在发送完响应后忘记及时返回http handler函数）</span></span></h4><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func handler(w http.ResponseWriter, req *http.Request) {
	err := foo(req)
	if err != nil {
		http.Error(w, &quot;foo&quot;, http.StatusInternalServerError)
		// 记得这里就及时返回
	}

	_, _ = w.Write([]byte(&quot;all good&quot;))
	w.WriteHeader(http.StatusCreated)
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-4bb76f0f7f774120bef0c17b56343a3f" data-id="4bb76f0f7f774120bef0c17b56343a3f"><span><div id="4bb76f0f7f774120bef0c17b56343a3f" class="notion-header-anchor"></div><a class="notion-hash-link" href="#4bb76f0f7f774120bef0c17b56343a3f" title="10.7 #81: Using the default HTTP client and server（生成环境不要直接使用默认的Http客户端和服务端）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">10.7 #81: Using the default HTTP client and server（生成环境不要直接使用默认的Http客户端和服务端）</span></span></h4><div class="notion-text notion-block-10412a94a4d540d4b22a12e851e06267"><b>http.Client</b></div><div class="notion-text notion-block-8d112139cad04e6c8dabc749905eb0de">直接使用标准库的里的client和server可能会存在问题，没有完备的配置项，可能会导致生产问题，首先就是直接使用 <code class="notion-inline-code">http.Client</code> 发送请求，没有配置超时时间，这在生产环境是绝对不允许的。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">client := &amp;http.Client{}
resp, err := client.Get(&quot;https://golang.org/&quot;)</code></pre><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-da43facfe52a4d69b3bc30251ff554b7"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27613%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAACwAQCdASoQAAUABUB8JZwAAu0dYNzQAP7q3H7ds2TljmQ8AAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkn8dimu6j312g0bs42e.jpg?table=block&amp;id=da43facf-e52a-4d69-b3bc-30251ff554b7&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-27b883c35411469682057309c5e4bade"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27633%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRiwAAABXRUJQVlA4ICAAAACQAQCdASoQAAUABUB8JaQAAudZtgAA/u3GJPSKDvAAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkmqobncij31480cqgoz.jpg?table=block&amp;id=27b883c3-5411-4696-8205-7309c5e4bade&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-4ffc3109112b4796b609e9c6aac8870d">关于默认HTTP Client 还要记住他是如何处理连接的。缺省情况下，HTTP Client 会维持一个连接池。客户端在请求的时候可以重用连接(你也可以通过设置 htt<code class="notion-inline-code">http.Transport.DisableKeepAlives</code> 为 <code class="notion-inline-code">true</code> 来禁用)。</div><div class="notion-text notion-block-f29c8a17920140b4ba87ed1803138bc4">有一个额外的超时来指定空闲连接在连接池中保留多长时间：<code class="notion-inline-code">http.Transfer.IdleConnTimeout</code></div><div class="notion-text notion-block-8e0e68cd9e704f168c358a117dfd5d71">这值的默认值为90s，意味着这个连接可以在90s内都能给其他请求复用。</div><div class="notion-text notion-block-61cb57b1a9f14773b3a4643a34b3e95f"><code class="notion-inline-code">http.Transport.MaxIdleConns</code> 用于配置连接池的最大数量，这个值默认为100。其中 <code class="notion-inline-code">http.Transport.MaxIdleConnsPerHost</code> 用于限制每个host的连接池数量，默认为2，表示如果我们对同一个host触发100次请求，只用2个请求保留在连接池中，如果我们再触发100次请求，那么我们还要再重新创建98次新的连接，这个配置对请求响应的影响也极大。</div><div class="notion-callout notion-gray_background_co notion-block-bc0092335a774bd6a0c717f4941a7c3c"><div class="notion-page-icon-inline notion-page-icon-span"><span class="notion-page-icon" role="img" aria-label="💡">💡</span></div><div class="notion-callout-text">突然想到自己之前手写的压测脚本，qps一直上不去，应该就是直接裸用 http.Client的锅</div></div><div class="notion-text notion-block-75840e6c4417446690acd4cf0980164e"><b>所以我们要明确一些参数的含义，帮助我们生产上线</b></div><div class="notion-text notion-block-e6a589cab45543469fad6777b30f3137"><b>http.Server</b></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-e4708e5963994c5d91d687cfc7877e7d"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27756%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAACwAQCdASoQAAYABUB8JZwAAq9EBEnAAP7toHeO7YWSt8CObJJcgyAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkn98yhstj315g0fo78p.jpg?table=block&amp;id=e4708e59-6399-4c5d-91d6-87cfc7877e7d&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-8512923bb7db41b595022fbf95942a1f"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27368%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRi4AAABXRUJQVlA4ICIAAACQAQCdASoQAAMABUB8JYwAAujbZdAA/u/FZyjhUvprygAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkndg329oj31ag08kjwv.jpg?table=block&amp;id=8512923b-b7db-41b5-9502-2fbf95942a1f&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-be63688456af44cd9d464f35a5ee9e56">服务端同样可以保持长连接，配置长连接的最长超时时间 <code class="notion-inline-code">IdleTimeout</code> , 如果 <code class="notion-inline-code">http.Server.IdleTimeout</code>  没有配置就会和 <code class="notion-inline-code">http.Server .ReadTimeout</code> 保持一致，如果都没设置，就会在结束请求后就立马结束连接。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">s := &amp;http.Server{
    // ...
    IdleTimeout: time.Second,
}</code></pre><div class="notion-callout notion-gray_background_co notion-block-fa08f802f7694af2b8800a7cd3cb5e22"><div class="notion-page-icon-inline notion-page-icon-span"><span class="notion-page-icon" role="img" aria-label="💡">💡</span></div><div class="notion-callout-text">在生产环境，有时候为了避免服务断流，会把keep-alive给关闭</div></div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-21f335df2e594cd88d0c9fbcdbf1d503" data-id="21f335df2e594cd88d0c9fbcdbf1d503"><span><div id="21f335df2e594cd88d0c9fbcdbf1d503" class="notion-header-anchor"></div><a class="notion-hash-link" href="#21f335df2e594cd88d0c9fbcdbf1d503" title="11 Testing"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11 Testing</span></span></h3><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-9fd8ad81e4574d2e9d8e145daafd7af9" data-id="9fd8ad81e4574d2e9d8e145daafd7af9"><span><div id="9fd8ad81e4574d2e9d8e145daafd7af9" class="notion-header-anchor"></div><a class="notion-hash-link" href="#9fd8ad81e4574d2e9d8e145daafd7af9" title="11.1 #82: Not categorizing tests（没有对测试类型分类）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11.1 #82: Not categorizing tests（没有对测试类型分类）</span></span></h4><div class="notion-text notion-block-da4990c05e42460c8425cfbd41c51f6d">不同类型的测试:单元测试、集成测试、E2E测试各自的执行时间和个数都有很大差距，如下的测试金字塔显示了测试的占比，各种测试的执行时间也呈反比。这一节介绍了一些方法提醒开发者，不同类型的测试，需要明确区分，并且最好独立执行，可以提升开发效率。</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-4f9c6c063ad646b19907c5f09f199062"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:384px;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271175%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjgAAABXRUJQVlA4ICwAAACQAQCdASoQAAkABUB8JaQAAp0JGAAA/vHgwiu0daRTMfWD5vUiX/I3EAAAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbluxpm2fqj30la0ci0uc.jpg?table=block&amp;id=4f9c6c06-3ad6-46b1-9907-c5f09f199062&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><ul class="notion-list notion-list-disc notion-block-5595aec89bdc4ee6aad8885ffa50909a"><li>使用 <code class="notion-inline-code">go:build</code> tag来给测试归类,用法可参考：</li><ul class="notion-list notion-list-disc notion-block-5595aec89bdc4ee6aad8885ffa50909a"><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-7c2ce0a4ab7f46c69dc507a43ab425cd" href="https://clivern.com/separate-test-cases-in-golang-with-build-tags/"><div><div class="notion-bookmark-title">Separate Test Cases in Golang With Build Tags | Clivern</div><div class="notion-bookmark-description">A build tag or a build constraint as described in the build package documentation, is a line comment that begins // +build that lists the conditions under which a file should be included in the package. You can provide build constraints for one file. The tags can then be passed to the go build command,</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272000%27/%3e"/></span><img alt="Separate Test Cases in Golang With Build Tags | Clivern" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRowAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSE4AAAARL0AkQJrjENqsRkTQ3YBpJMmq5r3/A2DPnj17vPyDufs5RPR/AvjtR7O+xMwLK+BTJ9yqhU6FECkHPCIzwCKSq0LEK94T826tLrQiZ5lWUDggGAAAADABAJ0BKhAAEAAFQHwlpAADcAD+8ObAAA==&quot;)"/><noscript><img alt="Separate Test Cases in Golang With Build Tags | Clivern" src="https://www.notion.so/image/https%3A%2F%2Fclivern.com%2Fwp-content%2Fuploads%2F2015%2F08%2Fcropped-icon-192x192.png?table=block&amp;id=7c2ce0a4-ab7f-46c6-9dc5-07a43ab425cd&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="notion-bookmark-link-text">https://clivern.com/separate-test-cases-in-golang-with-build-tags/</div></div></div><div class="notion-bookmark-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271333%27/%3e"/></span><img alt="Separate Test Cases in Golang With Build Tags | Clivern" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRlYAAABXRUJQVlA4IEoAAAAwAgCdASoQAAsABUB8JYwCdAELV1gytlScUAD+L3yNFFJK3QMfzIXxImbHNlYsmb3z0De5drFR5gRYEdd6wk7xRsW9J1UeiH8IAA==&quot;)"/><noscript><img alt="Separate Test Cases in Golang With Build Tags | Clivern" src="https://www.notion.so/image/https%3A%2F%2Fclivern.com%2Fwp-content%2Fuploads%2F2021%2F01%2F0_YZIFWK0uy9s_BWVW.jpeg?table=block&amp;id=7c2ce0a4-ab7f-46c6-9dc5-07a43ab425cd&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a></div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">//go:build integration
// +build integration

package db

import (
	&quot;os&quot;
	&quot;testing&quot;
)

func TestInsert1(t *testing.T) {
	// ...
}</code></pre></ul></ul><ul class="notion-list notion-list-disc notion-block-27701362dbb74acab5a6c08b830ac4b6"><li>使用环境变量分类</li><ul class="notion-list notion-list-disc notion-block-27701362dbb74acab5a6c08b830ac4b6"><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func TestInsert2(t *testing.T) {
	if os.Getenv(&quot;INTEGRATION&quot;) != &quot;true&quot; {
		t.Skip(&quot;skipping integration test&quot;)
	}

	// ...</code></pre></ul></ul><ul class="notion-list notion-list-disc notion-block-ff80f41e11804fc39ea246b3880651a8"><li>Short mode，执行go test的时候加上 <code class="notion-inline-code">-short</code> 选项，可以选择性的执行耗时短的测试</li><ul class="notion-list notion-list-disc notion-block-ff80f41e11804fc39ea246b3880651a8"><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func TestLongRunning(t *testing.T) {
	if testing.Short() {
		t.Skip(&quot;skipping long-running test&quot;)
	}
	// ...
}

// % go test -short -v .
// === RUN   TestLongRunning
//     foo_test.go:9: skipping long-running test
// --- SKIP: TestLongRunning (0.00s)
// PASS
// ok      foo  0.174s</code></pre></ul></ul><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-ac4220707e3247cfab962dfb26036066" data-id="ac4220707e3247cfab962dfb26036066"><span><div id="ac4220707e3247cfab962dfb26036066" class="notion-header-anchor"></div><a class="notion-hash-link" href="#ac4220707e3247cfab962dfb26036066" title="11.2 #83: Not enabling the -race flag（没开启 -race flag来检验并发冲突）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11.2 #83: Not enabling the -race flag（没开启 -race flag来检验并发冲突）</span></span></h4><div class="notion-text notion-block-1c099fc57ce84ff4a33b85d4a00473ac">开启 -race 之后性能和内存占用都有影响，所以生产环境不建议开启（废话。。）</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-bash">go test -race ./...</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-b1fc957f0112444a941c4953a128b292" data-id="b1fc957f0112444a941c4953a128b292"><span><div id="b1fc957f0112444a941c4953a128b292" class="notion-header-anchor"></div><a class="notion-hash-link" href="#b1fc957f0112444a941c4953a128b292" title="11.3 #84: Not using test execution modes（没有使用test执行模式：并行 or shuffle ）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11.3 #84: Not using test execution modes（没有使用test执行模式：并行 or shuffle ）</span></span></h4><ul class="notion-list notion-list-disc notion-block-25e1958f8fbe4705a749c9d5055a6e48"><li>The parallel flag 开启并行模式执行测试</li><ul class="notion-list notion-list-disc notion-block-25e1958f8fbe4705a749c9d5055a6e48"><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-bash">// 并行执行测试，并行最大个数 16
go test -parallel 16 .</code></pre></ul></ul><ul class="notion-list notion-list-disc notion-block-facda99f78f148b99538695bc10c8e6f"><li>The -shuffle flag 开启 shuffle 模式执行测试</li><ul class="notion-list notion-list-disc notion-block-facda99f78f148b99538695bc10c8e6f"><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-bash">go test -shuffle=on -v</code></pre><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-f4223d0c99c044abb38f09d099a91481"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27560%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRj4AAABXRUJQVlA4IDIAAACwAQCdASoQAAQABUB8JbAAAudJ3/oAAP7tSe6PsUkHzDrlym84Xf/2t61e2aNPoAAAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblvq2ildqj31dm0dw493.jpg?table=block&amp;id=f4223d0c-99c0-44ab-b38f-09d099a91481&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure></ul></ul><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-f0e5bc4a1fcd48cfa95c96774bfa9512" data-id="f0e5bc4a1fcd48cfa95c96774bfa9512"><span><div id="f0e5bc4a1fcd48cfa95c96774bfa9512" class="notion-header-anchor"></div><a class="notion-hash-link" href="#f0e5bc4a1fcd48cfa95c96774bfa9512" title="11.4 #85: Not using table-driven tests（使用 table-driven 的模式编写测试）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11.4 #85: Not using table-driven tests（使用 table-driven 的模式编写测试）</span></span></h4><div class="notion-text notion-block-c99860f7ff3643caba6d71d6387b2da5">略</div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-f0c02b1b69a84a9e992dd891d242108a" href="https://dave.cheney.net/2019/05/07/prefer-table-driven-tests"><div><div class="notion-bookmark-title">Prefer table driven tests</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><img src="https://www.notion.so/image/https%3A%2F%2Fdave.cheney.net%2Ffavicon.ico?table=block&amp;id=f0c02b1b-69a8-4a9e-992d-d891d242108a&amp;cache=v2" alt="Prefer table driven tests" loading="lazy" decoding="async"/></div><div class="notion-bookmark-link-text">https://dave.cheney.net/2019/05/07/prefer-table-driven-tests</div></div></div></a></div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-8255a91293f34348a9022ae62bbf3b4d" data-id="8255a91293f34348a9022ae62bbf3b4d"><span><div id="8255a91293f34348a9022ae62bbf3b4d" class="notion-header-anchor"></div><a class="notion-hash-link" href="#8255a91293f34348a9022ae62bbf3b4d" title="11.5 #86: Sleeping in unit tests（在测试代码中包含sleep逻辑，导致出现flaky测试）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11.5 #86: Sleeping in unit tests（在测试代码中包含sleep逻辑，导致出现flaky测试）</span></span></h4><div class="notion-text notion-block-adba6ae716284d8e853654ddc26c38f2">依赖等待一段时间直到特定的逻辑执行完成的方式会因为时间设置问题导致出现不稳定的测试，这种情况，可以通过指定多次重试或者使用同步的方法来避免直接调用 time.sleep 来等待。</div><div class="notion-text notion-block-e38daf6b978a425fa1fece0a16cff87b">可以使用 testify 或者 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="http://onsi.github.io/gomega/">Gomega</a> 中的 Eventually 方法</div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-cce3764c04e848b7bea8074f2dda6274" href="https://stackoverflow.com/questions/30427013/testing-for-asynchronous-results-without-sleep-in-go/30427356#30427356"><div><div class="notion-bookmark-title">Testing for asynchronous results without sleep in Go</div><div class="notion-bookmark-description">I have quite a few components in my code that have persistent go-routines that listen for events to trigger actions. Most of the time, there is no reason (outside of testing) for them to send back a</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272000%27/%3e"/></span><img alt="Testing for asynchronous results without sleep in Go" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRrQAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSEUAAAARL6AmABI2RxRucBsRgfaLYBRJtpMucJDuP94DGIj+deEgov/p1wDCNYFWdrDeJ7iPGUJ+ICzHmdDyWQ60NS0nwve+1Q8AVlA4IEgAAAAwAgCdASoQABAABUB8JbACdDiAN5DBkIL5YAD8Qinke/q889yo9g035WPfLcd8dxHCK0oPnIUG9M+Qbtcz9Bp+/l+qbyEAAAA=&quot;)"/><noscript><img alt="Testing for asynchronous results without sleep in Go" src="https://www.notion.so/image/https%3A%2F%2Fcdn.sstatic.net%2FSites%2Fstackoverflow%2FImg%2Fapple-touch-icon.png%3Fv%3Dc78bd457575a?table=block&amp;id=cce3764c-04e8-48b7-bea8-074f2dda6274&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="notion-bookmark-link-text">https://stackoverflow.com/questions/30427013/testing-for-asynchronous-results-without-sleep-in-go/30427356#30427356</div></div></div><div class="notion-bookmark-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272000%27/%3e"/></span><img alt="Testing for asynchronous results without sleep in Go" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRrIAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSEgAAAARL6CgbRs2VTbt/omIwHPCwCiSJEV59F8wsHvwRwUk4PwrOgcR/U+/RiB8DVjnAeT7BNfdQZluKPE4E9bpmA+seUwHyvs8ix9WUDggRAAAAFACAJ0BKhAAEAAFQHwlsAJ0VAC7K943/9AO4AD+3yf6HtzpRo2x8s6Ijl+4c5jqg90ZvZ+chd1b/WRwhQSWZRRufAAA&quot;)"/><noscript><img alt="Testing for asynchronous results without sleep in Go" src="https://www.notion.so/image/https%3A%2F%2Fcdn.sstatic.net%2FSites%2Fstackoverflow%2FImg%2Fapple-touch-icon%402.png%3Fv%3D73d79a89bded?table=block&amp;id=cce3764c-04e8-48b7-bea8-074f2dda6274&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a></div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-ac1f48b704104f19982cd1ec93fb8a3b" data-id="ac1f48b704104f19982cd1ec93fb8a3b"><span><div id="ac1f48b704104f19982cd1ec93fb8a3b" class="notion-header-anchor"></div><a class="notion-hash-link" href="#ac1f48b704104f19982cd1ec93fb8a3b" title="11.6 #87: Not dealing with the time API efficiently（没有正确的处理时间问题）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11.6 #87: Not dealing with the time API efficiently（没有正确的处理时间问题）</span></span></h4><div class="notion-text notion-block-d8765efc65764658ae4b46d86438a11d">一些函数处理逻辑和超时相关的，如果在编写测试的时候依赖实时的时间，但测试可能没有立即执行，导致代码没有按照期望的行为运行。比如下面的例子，想要过滤掉超时的事件，如果代码执行到 <code class="notion-inline-code">cache.GetAll()</code> 的时候耗费了一些时间，原本希望缓存2个事件，却一个也没缓存。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func TestCache_TrimOlderThan(t *testing.T) {
	events := []Event{
		{Timestamp: time.Now().Add(-20 * time.Millisecond)},
		{Timestamp: time.Now().Add(-10 * time.Millisecond)},
		{Timestamp: time.Now().Add(10 * time.Millisecond)},
	}
	cache := &amp;Cache{}
	cache.Add(events)
	cache.TrimOlderThan(15 * time.Millisecond)
	got := cache.GetAll()
	expected := 2
	if len(got) != expected {
		t.Fatalf(&quot;expected %d, got %d&quot;, expected, len(got))
	}
}</code></pre><div class="notion-text notion-block-e79cc7c2f7054d5e897a2c468659cb24">这类测试可以使用确切的时间来代替实时获取时间</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func TestCache_TrimOlderThan(t *testing.T) {
	events := []Event{
		{Timestamp: parseTime(t, &quot;2020-01-01T12:00:00.04Z&quot;)},
		{Timestamp: parseTime(t, &quot;2020-01-01T12:00:00.05Z&quot;)},
		{Timestamp: parseTime(t, &quot;2020-01-01T12:00:00.06Z&quot;)},
	}
	cache := &amp;Cache{now: func() time.Time {
		return parseTime(t, &quot;2020-01-01T12:00:00.06Z&quot;)
	}}
	cache.Add(events)
	cache.TrimOlderThan(15 * time.Millisecond)
	// ...
}</code></pre><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-3f92e134c58d4101be2dbb7a042ae323" data-id="3f92e134c58d4101be2dbb7a042ae323"><span><div id="3f92e134c58d4101be2dbb7a042ae323" class="notion-header-anchor"></div><a class="notion-hash-link" href="#3f92e134c58d4101be2dbb7a042ae323" title="11.7 #88: Not using testing utility packages（没有使用内置的工具包，比如httptest、iotest）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11.7 #88: Not using testing utility packages（没有使用内置的工具包，比如httptest、iotest）</span></span></h4><div class="notion-text notion-block-9a094856c66e46ef8b42c1ad28a3a326">略，此处就不讲解包的使用了，知道在mock http 和 io 操作的时候可以使用这2个内置的工具包</div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-062c653a7cf24566adae21c3284b6d10" href="https://pkg.go.dev/net/http/httptest"><div><div class="notion-bookmark-title">httptest package - net/http/httptest - Go Packages</div><div class="notion-bookmark-description">Package httptest provides utilities for HTTP testing.</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><img src="https://www.notion.so/image/https%3A%2F%2Fpkg.go.dev%2Fstatic%2Fshared%2Ficon%2Ffavicon.ico?table=block&amp;id=062c653a-7cf2-4566-adae-21c3284b6d10&amp;cache=v2" alt="httptest package - net/http/httptest - Go Packages" loading="lazy" decoding="async"/></div><div class="notion-bookmark-link-text">https://pkg.go.dev/net/http/httptest</div></div></div></a></div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-94fabb0b2f874667bd0cf9a1335b8cfd" href="https://pkg.go.dev/testing/iotest"><div><div class="notion-bookmark-title">iotest package - testing/iotest - Go Packages</div><div class="notion-bookmark-description">Package iotest implements Readers and Writers useful mainly for testing.</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><img src="https://www.notion.so/image/https%3A%2F%2Fpkg.go.dev%2Fstatic%2Fshared%2Ficon%2Ffavicon.ico?table=block&amp;id=94fabb0b-2f87-4667-bd0c-f9a1335b8cfd&amp;cache=v2" alt="iotest package - testing/iotest - Go Packages" loading="lazy" decoding="async"/></div><div class="notion-bookmark-link-text">https://pkg.go.dev/testing/iotest</div></div></div></a></div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-01c16695373d468998291b555d88b5a6" data-id="01c16695373d468998291b555d88b5a6"><span><div id="01c16695373d468998291b555d88b5a6" class="notion-header-anchor"></div><a class="notion-hash-link" href="#01c16695373d468998291b555d88b5a6" title="11.8 #89: Writing inaccurate benchmarks（编写了不正确的BencMark）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11.8 #89: Writing inaccurate benchmarks（编写了不正确的BencMark）</span></span></h4><div class="notion-text notion-block-edb2e964834f455ca5daa681964d3837"><b>Not resetting or pausing the timer</b></div><div class="notion-text notion-block-07c9aeccd54d49859cc4b1e405c910c7">在具体测量某一段函数性能时，一些SetUp操作可能比较耗时会影响测量结果。调用 <code class="notion-inline-code">ResetTimer</code> 函数可以重置一些Bench数据。</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-12bebafb235b46749df647d0b23513a2"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27445%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRi4AAABXRUJQVlA4ICIAAACwAQCdASoQAAQABUB8JZQAAxalyJIAAP7tlqSwWHkoB8AA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblqycs54hj31e80b6jwa.jpg?table=block&amp;id=12bebafb-235b-4674-9df6-47d0b23513a2&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-46c07baebe174303a964f97e63e11629">每次迭代都会有一些耗时动作，可以调用 <code class="notion-inline-code">b.StopTimer()</code> 和 <code class="notion-inline-code">b.StartTimer()</code> 暂停和启动BenchMark计量</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-627c31e9b71f454fae78baaf59be7610"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27507%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAACwAQCdASoQAAQABUB8JZwAAxf+5/AAAP7g2t0+6ErGXJzIAAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblr850zbgj31eo0cutdw.jpg?table=block&amp;id=627c31e9-b71f-454f-ae78-baaf59be7610&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-a94784bac29c4f0291728d5d5983125b"><b>Making wrong assumptions about micro-benchmarks</b></div><div class="notion-text notion-block-20049e496daf492ca3d8f4efa351cac1">在一些做一些 <b>micro-benchmark </b>的时候，如果不多次进行基准测试很容易就得出错误的结论</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func BenchmarkAtomicStoreInt32(b *testing.B) {
	var v int32
	for i := 0; i &lt; b.N; i++ {
		atomic.StoreInt32(&amp;v, 1)
	}
}

func BenchmarkAtomicStoreInt64(b *testing.B) {
	var v int64
	for i := 0; i &lt; b.N; i++ {
		atomic.StoreInt64(&amp;v, 1)
	}
}</code></pre><div class="notion-text notion-block-71b567f9ae6f401db49508d5e24da45e">下图是执行2次BenchMark的结果</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-4cd81bb070de43d99f26ba622d87c876"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27773%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRi4AAABXRUJQVlA4ICIAAACwAQCdASoQAAYABUB8JaQAAvd3BJgAAP7n+oluAtCWgAAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblrwgav5vj317k0gun42.jpg?table=block&amp;id=4cd81bb0-70de-43d9-9f26-ba622d87c876&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-2794e26474a54ddca60d966f4759a13e">解决方案：对于 <b>micro-benchmark 需要</b>进行多次 BenchMark，可以利用 <code class="notion-inline-code">benchstat</code> 统计BenchMark的结果进行均值计算。</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-05189425d70a44eb98793306bbac3a35"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27844%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAADQAQCdASoQAAcABUB8JaQAAscEGeYwAAD+7W8wXFrk+aQL7p73UwAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbls3gwljrj317u0iitgl.jpg?table=block&amp;id=05189425-d70a-44eb-9879-3306bbac3a35&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-370d04b8b5b24a04a6fb9d104da5d9dd"><b>Not being careful about compiler optimizations</b></div><div class="notion-text notion-block-86e3641d395b40458060ff5a493f70fc">golang的内联优化会导致我们的测试函数被优化，执行结果不符合我们的预期（效果更好）</div><a target="_blank" rel="noopener noreferrer" href="https://github.com/golang/go/issues/14813" class="notion-external notion-external-block notion-row notion-block-a502b2c5d0f449a4827d5aa64c073a20"><div class="notion-external-image"><svg viewBox="0 0 260 260"><g><path d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z" fill="#161614"></path></g></svg></div><div class="notion-external-description"><div class="notion-external-title">cmd/compile: SSA compiler removes code in benchmarks</div><div class="notion-external-subtitle"><span>Updated <!-- -->Oct 25, 2019</span></div></div></a><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-9f62f9c4b27142e2ae4fa263d1b8b03a" href="https://dave.cheney.net/2013/06/30/how-to-write-benchmarks-in-go"><div><div class="notion-bookmark-title">How to write benchmarks in Go</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><img src="https://www.notion.so/image/https%3A%2F%2Fdave.cheney.net%2Ffavicon.ico?table=block&amp;id=9f62f9c4-b271-42e2-ae4f-a263d1b8b03a&amp;cache=v2" alt="How to write benchmarks in Go" loading="lazy" decoding="async"/></div><div class="notion-bookmark-link-text">https://dave.cheney.net/2013/06/30/how-to-write-benchmarks-in-go</div></div></div></a></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-324e446f532f4d5fb9daf5570808bfe6"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271049%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRj4AAABXRUJQVlA4IDIAAADQAQCdASoQAAgABUB8JaQAAusfKtacAAD+6GCOkJkmC7wIE2VOwmkJ/HUlj/HGzAAAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblshj22g8j31ci0pg7cf.jpg?table=block&amp;id=324e446f-532f-4d5f-b9da-f5570808bfe6&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-callout notion-gray_background_co notion-block-58dcb76708ae456d8ec62e0a780cbdd1"><div class="notion-page-icon-inline notion-page-icon-span"><span class="notion-page-icon" role="img" aria-label="💡">💡</span></div><div class="notion-callout-text">给<code class="notion-inline-code">go test</code>增加<code class="notion-inline-code">-gcflags=&quot;-m&quot;</code>参数，<code class="notion-inline-code">-m</code>表示打印编译器做出的优化决定。可以看到是否做了内联优化，如果有<code class="notion-inline-code"> inlining call to xxx 函数</code> 的字样就是做了优化</div></div><ul class="notion-list notion-list-disc notion-block-431e2f718aa34fd3bf50fa1b5518b116"><li>执行<code class="notion-inline-code">go test</code>的时候，增加<code class="notion-inline-code">-gcfloags=&quot;-l&quot;</code>参数，<code class="notion-inline-code">-l</code>表示禁用编译器的内联优化。</li></ul><ul class="notion-list notion-list-disc notion-block-cf7bca78d4074c2d899eb3aeeb1cb3f4"><li>使用<code class="notion-inline-code">//go:noinline </code>编译器指令(compiler directive)，编译器在编译时会识别到这个指令，不做内联优化。</li><ul class="notion-list notion-list-disc notion-block-cf7bca78d4074c2d899eb3aeeb1cb3f4"><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">//go:noinline
func add(a int, b int) int {
 return a + b
}</code></pre></ul></ul><div class="notion-text notion-block-7921d39cd03642fba75c8da1646cc1be"><b>Being fooled by the observer effect</b></div><div class="notion-text notion-block-a6337376285241b3b3ba2c936b3b134a">在物理学中，观测者效应是观测行为对被观测系统的扰动。这种影响也可以在基准测试中看到，并可能导致对结果的错误假设。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">// 我们想实现一个接收int64元素矩阵的函数。这个矩阵有固定数量的512列，我们想计算前八列的总和
func calculateSum512(s [][512]int64) int64 {
	var sum int64
	for i := 0; i &lt; len(s); i++ {
		for j := 0; j &lt; 8; j++ {
			sum += s[i][j]
		}
	}
	return sum
}
// 为了优化，我们还想确定更改列数是否有影响，因此我们还实现了第二个包含513列的函数。
func calculateSum513(s [][513]int64) int64 {
	var sum int64
	for i := 0; i &lt; len(s); i++ {
		for j := 0; j &lt; 8; j++ {
			sum += s[i][j]
		}
	}
	return sum
}</code></pre><div class="notion-text notion-block-2eb92afcc6c94788a89bc33a8059f80f">BenchMark后的结果很出乎意料，513*513矩阵的计算更加高效，原因和CPU Cache命中有很高的关系。</div><div class="notion-text notion-block-d9c2fabe79fe4ca191909f78713d8e46"><b>因为BenchMark事先创建了一个矩阵并重复计算，再加上缓存命中的影响更加加重了测试差距，解决方案就是每次迭代都创建新的矩阵</b></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-184963b1116a4ee6b602a503001fd3a7"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271205%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjYAAABXRUJQVlA4ICoAAACQAQCdASoQAAoABUB8JaQAAudZN8AA/u/OaqpXS5QaYf6i/20dUUymAAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblu0ivr0oj31dc0tqtjc.jpg?table=block&amp;id=184963b1-116a-4ee6-b602-a503001fd3a7&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-3f8a1d9cdf1e41e88c5198e4c22cd7c8">关于 513*513矩阵的计算更加高效 的原理可以参考 <b>#91 Not understanding CPU caches</b></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-70d29465bf724dd1b4fd5a8d0428788b"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27970%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAADQAQCdASoQAAgABUB8JZwAAudkbzxmAAD+7c1iH5Jjc9BDAAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblu30b7w2j31580k0grq.jpg?table=block&amp;id=70d29465-bf72-4dd1-b4fd-5a8d0428788b&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-76f0661175734d228199e4f63998bf09" data-id="76f0661175734d228199e4f63998bf09"><span><div id="76f0661175734d228199e4f63998bf09" class="notion-header-anchor"></div><a class="notion-hash-link" href="#76f0661175734d228199e4f63998bf09" title="11.9 #90: Not exploring all the Go testing features（没有利用 Go testing的特性）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">11.9 #90: Not exploring all the Go testing features（没有利用 Go testing的特性）</span></span></h4><ul class="notion-list notion-list-disc notion-block-0c142a314082444d806619c3375d698a"><li>使用 <code class="notion-inline-code">coverprofile</code> flag 查看代码覆盖率</li><ul class="notion-list notion-list-disc notion-block-0c142a314082444d806619c3375d698a"><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-bash">// 获得测试覆盖率文件
go test -coverprofile=coverage.out ./...

// 可视化展示覆盖率
go tool cover -html=coverage.out</code></pre></ul></ul><ul class="notion-list notion-list-disc notion-block-678b750df0824b28a37ec22518645f15"><li>把测试文件可以放在<code class="notion-inline-code">_test</code>包中, 测试文件可以放在不同的包中</li><ul class="notion-list notion-list-disc notion-block-678b750df0824b28a37ec22518645f15"><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">package counter

import &quot;sync/atomic&quot;

var count uint64

func Inc() uint64 {
	atomic.AddUint64(&amp;count, 1)
	return count
}</code></pre><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">package counter_test

import (
	&quot;testing&quot;

	counter &quot;myapp/counter&quot;
)

func TestCount(t *testing.T) {
	if counter.Inc() != 1 {
		t.Errorf(&quot;expected 1&quot;)
	}
}</code></pre></ul></ul><ul class="notion-list notion-list-disc notion-block-f10a3d2871ca42c690d907435feb699c"><li>Setup and teardown 搭建和卸载环境</li><ul class="notion-list notion-list-disc notion-block-f10a3d2871ca42c690d907435feb699c"><div class="notion-text notion-block-1c10a0407f544a6f9b72bfa11b8ec8fb">调用 <code class="notion-inline-code">t.Cleanup</code> 注册一个闭包函数做清理工作，可以在测试结束后被调用来清理环境。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func TestMySQLIntegration(t *testing.T) {
	// ...
	db := createConnection(t, &quot;tcp(localhost:3306)/db&quot;)
	// ...
}

func createConnection(t *testing.T, dsn string) *sql.DB {
	db, err := sql.Open(&quot;mysql&quot;, dsn)
	if err != nil {
		t.FailNow()
	}
	t.Cleanup(
		func() {
			_ = db.Close()
		})
	return db
}</code></pre></ul></ul><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-f468d2d212764e8986a2e859709b53f8" data-id="f468d2d212764e8986a2e859709b53f8"><span><div id="f468d2d212764e8986a2e859709b53f8" class="notion-header-anchor"></div><a class="notion-hash-link" href="#f468d2d212764e8986a2e859709b53f8" title="Optimizations"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Optimizations</span></span></h3><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-30b00cf625b5478fb673a57cc8c78750" data-id="30b00cf625b5478fb673a57cc8c78750"><span><div id="30b00cf625b5478fb673a57cc8c78750" class="notion-header-anchor"></div><a class="notion-hash-link" href="#30b00cf625b5478fb673a57cc8c78750" title="12.1 #91: Not understanding CPU caches（利用缓存加速代码执行速度）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">12.1 #91: Not understanding CPU caches（利用缓存加速代码执行速度）</span></span></h4><div class="notion-text notion-block-d2579c2330314256a718a5a977d25701">关于CPU Cache部分不属于GO专属的知识，这里就不细讲了</div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-8db18d1b4045415da05e23841d8135ae" href="https://zhuanlan.zhihu.com/p/31875174"><div><div class="notion-bookmark-title">细说Cache-L1/L2/L3/TLB</div><div class="notion-bookmark-description">本来打算今天把Cache写透的，结果今天陪娃出去玩了两次，先虎头蛇尾了，放出来，有时间再补。补了我会通知的~~。大家别忘了关注我的专栏。 概述cache是一种又小又快的存储器。它存在的意义是弥合Memory与CPU之间的…</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272000%27/%3e"/></span><img alt="细说Cache-L1/L2/L3/TLB" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRrYAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSDgAAAARD9D/iAiwqa29yZe2RlM8ZOpZYwCUsLaJtXcc4AQT6Ijof2j0JOARpfxMNeSk/q5WBwq8WJExAlZQOCBYAAAAMAIAnQEqEAAQAAVAfCWwAnS6ABCSD7Rp2IAA/Rq9d/8IprfV7WTm9aip9ilUb3xYIZJjsRUozTXvOQ8J1LIspl6/6D5nunMzyQ0H8jfeZ9M97aFyegAAAA==&quot;)"/><noscript><img alt="细说Cache-L1/L2/L3/TLB" src="https://www.notion.so/image/https%3A%2F%2Fstatic.zhihu.com%2Fheifetz%2Fassets%2Fapple-touch-icon-152.81060cab.png?table=block&amp;id=8db18d1b-4045-415d-a05e-23841d8135ae&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="notion-bookmark-link-text">https://zhuanlan.zhihu.com/p/31875174</div></div></div><div class="notion-bookmark-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27924%27/%3e"/></span><img alt="细说Cache-L1/L2/L3/TLB" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAACwAQCdASoQAAcABUB8JZQAAqsHVRAAAP7fhaOWgJ57eTXZAAA=&quot;)"/><noscript><img alt="细说Cache-L1/L2/L3/TLB" src="https://www.notion.so/image/https%3A%2F%2Fpic1.zhimg.com%2Fv2-b044ecf48648f83743602ddf9ae4a7ac_r.jpg%3Fsource%3D172ae18b?table=block&amp;id=8db18d1b-4045-415d-a05e-23841d8135ae&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a></div><div class="notion-callout notion-gray_background_co notion-block-bf34ed9e0ce94bd48f798b0333f96eb3"><div class="notion-page-icon-inline notion-page-icon-span"><span class="notion-page-icon" role="img" aria-label="💡">💡</span></div><div class="notion-callout-text">cache line 是固定大小的连续内存段，通常为64字节（8个int64变量）。</div></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-5887a6f573364f78a90cfa06a1dece39"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27902%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAABwAQCdASoQAAcABUB8JZ2HgAGIAAD+8E4TH1KOAa9t3bA1kAAAAA==&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbmwsvsyz0j31py0ryk4x.jpg?table=block&amp;id=5887a6f5-7336-4f78-a90c-fa06a1dece39&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-e06adf5c4a18448ab55558af9361e565"><b>Slice of structs vs. struct of slices</b></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-13a2819cc50542e2a6f076baf680f14d"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%27938%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAAAwAQCdASoQAAgABUB8JZwAA3AA/vB+uXCjcusQ6TyL/pUJRfrOAAAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbmwzxix54j31so0ucjz7.jpg?table=block&amp;id=13a2819c-c505-42e2-a6f0-76baf680f14d&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-69ba59eb07364d968daebd4ff106afb4"><b>Cache placement policy（关于#89出现问题的解释）</b></div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">// 我们想实现一个接收int64元素矩阵的函数。这个矩阵有固定数量的512列，我们想计算前八列的总和
func calculateSum512(s [][512]int64) int64 {
	var sum int64
	for i := 0; i &lt; len(s); i++ {
		for j := 0; j &lt; 8; j++ {
			sum += s[i][j]
		}
	}
	return sum
}
// 为了优化，我们还想确定更改列数是否有影响，因此我们还实现了第二个包含513列的函数。
func calculateSum513(s [][513]int64) int64 {
	var sum int64
	for i := 0; i &lt; len(s); i++ {
		for j := 0; j &lt; 8; j++ {
			sum += s[i][j]
		}
	}
	return sum
}</code></pre><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-c3872ea39c1a480988081354fb352bc5" href="https://zhuanlan.zhihu.com/p/31859105"><div><div class="notion-bookmark-title">Cache是怎么组织和工作的？</div><div class="notion-bookmark-description">我的习惯是想到哪里，写到哪里，只管挖坑不管填，近期更是工作繁忙，没有更新Cache部分的内容，实在抱歉。承蒙很多朋友催稿，由此可见Cache的关注度还是不错的，今天带来Cache的第二篇内容。我们经常能够看到2-way…</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%272000%27/%3e"/></span><img alt="Cache是怎么组织和工作的？" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRrYAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSDgAAAARD9D/iAiwqa29yZe2RlM8ZOpZYwCUsLaJtXcc4AQT6Ijof2j0JOARpfxMNeSk/q5WBwq8WJExAlZQOCBYAAAAMAIAnQEqEAAQAAVAfCWwAnS6ABCSD7Rp2IAA/Rq9d/8IprfV7WTm9aip9ilUb3xYIZJjsRUozTXvOQ8J1LIspl6/6D5nunMzyQ0H8jfeZ9M97aFyegAAAA==&quot;)"/><noscript><img alt="Cache是怎么组织和工作的？" src="https://www.notion.so/image/https%3A%2F%2Fstatic.zhihu.com%2Fheifetz%2Fassets%2Fapple-touch-icon-152.81060cab.png?table=block&amp;id=c3872ea3-9c1a-4809-8808-1354fb352bc5&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="notion-bookmark-link-text">https://zhuanlan.zhihu.com/p/31859105</div></div></div><div class="notion-bookmark-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271125%27/%3e"/></span><img alt="Cache是怎么组织和工作的？" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRm4AAABXRUJQVlA4IGIAAADwAQCdASoQAAkABUB8JbACdADp/qHRQIAA4dxzwYUI31zmLkPO23tJCU8j9Wd+A5wxU0GaWBbAUQtGQ0DcJnLzUG1FbP7o7wr3hXv5lgSYSl+92q3m4ztSwArH8WcPzCAAAA==&quot;)"/><noscript><img alt="Cache是怎么组织和工作的？" src="https://www.notion.so/image/https%3A%2F%2Fpica.zhimg.com%2Fv2-864713c7a8ec958b0293e9feb3238e66_720w.jpg%3Fsource%3D172ae18b?table=block&amp;id=c3872ea3-9c1a-4809-8808-1354fb352bc5&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-9a83c73f8ad34c35be7e4b95119a1761"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271495%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRkgAAABXRUJQVlA4IDwAAADQAQCdASoQAAwABUB8JZgAAuQDY9d6AAD+7d2UH3XbJIWPO70dX1er3GJB7G1Oi1PIA0U2gCZXvipwAAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbn2inqfv5j31aw0z2gz1.jpg?table=block&amp;id=9a83c73f-8ad3-4c35-be7e-4b95119a1761&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-67fadee9964444918975d6d2c4ab2077"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271365%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAADQAQCdASoQAAsABUB8JZwAAxZhLTwcQAD+6yZupTEB4CUSQI59T7v+4Y4oAAAA&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbn2n9bbttj31g00zi7jf.jpg?table=block&amp;id=67fadee9-9644-4491-8975-d6d2c4ab2077&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-68c4358655c54a5f8ec3541af7c441da"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271313%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRkgAAABXRUJQVlA4IDwAAADQAQCdASoQAAsABUB8JaQAAp0jh5V2gAD+64SQ92av0QstgwYYWUgCTp926jDXItfARSLd5/TFNlZ0AAA=&quot;)"/><noscript><img alt="notion image" src="https://www.notion.so/image/http%3A%2F%2Ftva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbn2qwfee0j31he0z2e0o.jpg?table=block&amp;id=68c43586-55c5-4a5f-8ec3-541af7c441da&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-955b6f8883454e9aa4f43ba6a458b132">现在回到真实场景，L1D的大小为32KB，一行Cache line大小为64byte，这样就有512(32KB/64byte)行Cache line，按照8路组相连的规则，会被分为64(512行/8)组。</div><div class="notion-text notion-block-1a7b3b4e84504694a2115abcb93e2d74">1000*512的int64矩阵内存也按照Cache Line大小划分，因为一行Cache line大小为64byte，一行可以包含8(64byte/8)个元素，512个元素需要64(512/8)行Cache Line大小的内存。</div><div class="notion-text notion-block-9aa9a7e63aba45b5a1159b82fd3bdfb4">可以算出矩阵一行的内存块正好被分到L1D的64个组中，这样迭代完第一行之后，后续的行数都会分别被缓存到对应的组里，当迭代次数超过8次后就会出现缓存冲突的问题，然后就会一直导致Cache Miss。</div></article><aside class="notion-aside"><div class="notion-aside-table-of-contents"><div class="notion-aside-table-of-contents-header">Table of Contents</div><nav class="notion-table-of-contents"><a href="#7c7869cc60ca4e108583d4a5062b6ac4" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">关于本书</span></a><a href="#0decdc5a63f64cbca101acf83211ccff" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">7 Error management</span></a><a href="#76b64bafa8dd4007a565664a00046b06" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">7.1 #48: Panicking（什么是panic）</span></a><a href="#c94b3a792507408d8aefc2d11343c7fc" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">7.2 #49: Ignoring when to wrap an error（不明确何时包装一个error，fmt.Errorf用法）</span></a><a href="#3cd2c017ab3e4a788dbb855fe703e324" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">7.3 #50: Checking an error type inaccurately（如何正确的判断Error类型-error.As用法）</span></a><a href="#6a42791f2d9547509eac5152c344224d" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">7.4 #51: Checking an error value inaccurately（如何正确的处理Error的值-error.Is用法）</span></a><a href="#17dbaba54db2446b89667b17d775b52b" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">7.5 #52: Handling an error twice（多次处理错误）</span></a><a href="#d5985c13735b497c862cab8b526e92e2" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">7.6 #53: Not handling an error（没有处理error）</span></a><a href="#2f5c6e56e9e644a1815addd5a1186c76" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">7.7 #54: Not handling defer errors（没有处理defer语句中的error）</span></a><a href="#71c585c466b9491d9911837721721de8" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">8 Concurrency: Foundations</span></a><a href="#d772c84a7288470fb5727ee663d840ab" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">8.6 #60: Misunderstanding Go contexts</span></a><a href="#c2b1bec366024ee29f324d77c553a7a5" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">9 Concurrency: Practice</span></a><a href="#5a466fc5c0394c7c97a9620f2d136d32" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.1 #61: Propagating an inappropriate context（错误传递context）</span></a><a href="#9f6aff3b0c784ae2812685c866c15393" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.2 #62: Starting a goroutine without knowing when to stop it（管理好协程）</span></a><a href="#255963cd490e4c81be70d07858aaa2ee" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.3 #63: Not being careful with goroutines and loop variables（在range loop中执行协程，注意不要引用range生成的变量）</span></a><a href="#cc9257701c7b4ae5823f025bd222029b" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.4 #64: Expecting deterministic behavior using select and channels（错误的以为 select 的执行结果是确定的）</span></a><a href="#0adc00225b0949c593a91ba31aff7abb" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.5 #65: Not using notification channels（chan struct{} 可以用于通知事件）</span></a><a href="#1f280e09a0dd42168597b64b70fef159" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.6 #66: Not using nil channels（利用nil的channel读写都会block的特性）</span></a><a href="#08e9a857ec474fdb8aa9c5bc48c869ed" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.7 #67: Being puzzled about channel size（不清楚channel的大小如何设置）</span></a><a href="#f2c2e94e998a4de7a5aebcf06d550ed8" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.8 #68: Forgetting about possible side effects with string formatting（字符串格式化可能会带来的并发错误）</span></a><a href="#a48e9d534a7b4ccd98c663a6fa09431b" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.9 #69: Creating data races with append（使用append函数的时候出现data race）</span></a><a href="#0ffe02a27a294bee80cb975ea1a74581" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.10 #70: Using mutexes inaccurately with slices and maps（错误的给slice和map加锁）</span></a><a href="#beeca05016534a87b16010addf066c52" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.11 #71: Misusing sync.WaitGroup（错误使用 sync.WaitGroup）</span></a><a href="#21c7ccf6a3364bb6bcfa675201e730b7" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.12 #72: Forgetting about sync.Cond（别忘记条件变量sync.Cond）</span></a><a href="#05073c8f5ad7409aa74519510ffa810a" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.13 #73: Not using errgroup（使用 errgroup 采集多个协程执行结果）</span></a><a href="#025990b71780448ebddbc41d3b01a39d" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">9.14 #74: Copying a sync type（同步类型的值不能被拷贝）</span></a><a href="#9f15a4b71af74561a178be3549245a31" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">10 The standard library</span></a><a href="#7047667f245f469981a1116b2ea7da39" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">10.1 #75: Providing a wrong time duration（记住标准库的时间单位）</span></a><a href="#84aab02c211440debf63aacf4441ece8" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">10.2 #76: time.After and memory leaks （使用 time.After 可能会导致内存溢出）</span></a><a href="#06e85100611245999f647b2d5a2a6756" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">10.3 #77: Common JSON-handling mistakes（常见的 JSON 处理错误）</span></a><a href="#3d60e22ec8614743b0f25122fb36b1b5" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">10.4 #78: Common SQL mistakes（常见的 SQL 错误）</span></a><a href="#8ea8463d42a64b52b9068b92b1d06e85" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">10.5 #79: Not closing transient resources（没有及时关闭临时资源）</span></a><a href="#48e75eaa3af84213bf2fc9062c03531f" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">10.6 #80: Forgetting the return statement after replying to an HTTP request（在发送完响应后忘记及时返回http handler函数）</span></a><a href="#4bb76f0f7f774120bef0c17b56343a3f" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">10.7 #81: Using the default HTTP client and server（生成环境不要直接使用默认的Http客户端和服务端）</span></a><a href="#21f335df2e594cd88d0c9fbcdbf1d503" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">11 Testing</span></a><a href="#9fd8ad81e4574d2e9d8e145daafd7af9" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">11.1 #82: Not categorizing tests（没有对测试类型分类）</span></a><a href="#ac4220707e3247cfab962dfb26036066" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">11.2 #83: Not enabling the -race flag（没开启 -race flag来检验并发冲突）</span></a><a href="#b1fc957f0112444a941c4953a128b292" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">11.3 #84: Not using test execution modes（没有使用test执行模式：并行 or shuffle ）</span></a><a href="#f0e5bc4a1fcd48cfa95c96774bfa9512" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">11.4 #85: Not using table-driven tests（使用 table-driven 的模式编写测试）</span></a><a href="#8255a91293f34348a9022ae62bbf3b4d" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">11.5 #86: Sleeping in unit tests（在测试代码中包含sleep逻辑，导致出现flaky测试）</span></a><a href="#ac1f48b704104f19982cd1ec93fb8a3b" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">11.6 #87: Not dealing with the time API efficiently（没有正确的处理时间问题）</span></a><a href="#3f92e134c58d4101be2dbb7a042ae323" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">11.7 #88: Not using testing utility packages（没有使用内置的工具包，比如httptest、iotest）</span></a><a href="#01c16695373d468998291b555d88b5a6" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">11.8 #89: Writing inaccurate benchmarks（编写了不正确的BencMark）</span></a><a href="#76f0661175734d228199e4f63998bf09" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">11.9 #90: Not exploring all the Go testing features（没有利用 Go testing的特性）</span></a><a href="#f468d2d212764e8986a2e859709b53f8" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">Optimizations</span></a><a href="#30b00cf625b5478fb673a57cc8c78750" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">12.1 #91: Not understanding CPU caches（利用缓存加速代码执行速度）</span></a></nav></div></aside></div><div class="styles_comments__YEupF"><div><p>Loading Comments...</p></div></div></main><footer class="styles_footer__RBpyk"><div class="styles_copyright__nhL_k">Copyright 2022 <!-- -->yangsoon</div><div class="styles_settings__GyEhi"></div><div class="styles_social__ptL3p"><a class="styles_github__0JN7a" href="https://yangsoon.github.io" title="YangSoon @yangsoon.github.io" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 3.293l6 6V13.5a1.5 1.5 0 01-1.5 1.5h-9A1.5 1.5 0 012 13.5V9.293l6-6zm5-.793V6l-2-2V2.5a.5.5 0 01.5-.5h1a.5.5 0 01.5.5z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M7.293 1.5a1 1 0 011.414 0l6.647 6.646a.5.5 0 01-.708.708L8 2.207 1.354 8.854a.5.5 0 11-.708-.708L7.293 1.5z" clip-rule="evenodd"></path></svg></a><a class="styles_github__0JN7a" href="https://github.com/yangsoon" title="GitHub @yangsoon" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a class="styles_zhihu__Z7IC7" href="https://zhihu.com/people/yangsoon" title="Zhihu @yangsoon" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13H170.54zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82v170.31zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62v.01zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2l19.23 14.43zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78l.03-.01z"></path></svg></a><a class="styles_twitter__3YoqL" href="https://twitter.com/yangsoonlx" title="Twitter @yangsoonlx" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></div></footer></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"site":{"domain":"yangsoon.github.io","name":"YangSoon","rootNotionPageId":"72a669717cf642c2a2524439d99d8f44","rootNotionSpaceId":null,"description":"YangSoon, Cloud Native Developer"},"recordMap":{"block":{"f8e41082-81f4-4d47-a6f3-3489e7c3453c":{"role":"reader","value":{"id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","version":1469,"type":"page","properties":{"Zr\u003cq":[["golang"]],"z`pV":[["WIP(80%)"]],"title":[["100 Go Mistakes and How to Avoid Them - 2"]]},"content":["a85d9fed-92aa-4cf4-ae92-00751ec8ab5b","7c7869cc-60ca-4e10-8583-d4a5062b6ac4","164f95cb-c34d-469c-b85c-2bc356b4e3c0","0decdc5a-63f6-4cbc-a101-acf83211ccff","76b64baf-a8dd-4007-a565-664a00046b06","db506446-b2b1-4506-ad5e-c86683194e91","c94b3a79-2507-408d-8aef-c2d11343c7fc","91b46093-1166-42ec-bf70-9fcf8d6b87ec","aa034550-14d1-4e86-8475-807cfc28c526","104c6b88-dfb3-4253-8e26-66b685beae33","b0dbcc2b-d143-444f-a9c4-fa7b2bd1466a","476a8035-98db-443c-b303-57897ee1a5b3","d063db16-6f75-400f-8397-8a908920b734","fe958b5d-0a7c-4d06-a05a-39fff22ece70","5eea680d-96d5-4622-bf61-fc9df8741066","8e9fc5af-f060-464f-83fb-8f2954c0406e","3cd2c017-ab3e-4a78-8dbb-855fe703e324","92fe02f6-abe8-4191-b122-9174b3a93017","cc26dc03-b1fd-4a0c-8aea-2d47acc1d32e","6a42791f-2d95-4750-9eac-5152c344224d","cf04f3b6-9852-4ecc-af8a-394a75a9d1da","e331508f-44af-4e24-88ca-94e3be618be7","a1743b61-d7ec-4a81-9de9-17c0c47a8499","00be8470-9c61-41e1-b49a-c4e652c48e70","a8ae21ec-bb85-4c71-af75-fab84fc7b7dd","17dbaba5-4db2-446b-8966-7b17d775b52b","ff246c9e-e04f-4661-9c0a-3baffd9239d3","d5985c13-735b-497c-862c-ab8b526e92e2","313fa910-9059-498c-8d59-5a950ed0f995","57f95bce-c9bb-4270-a8dd-92a40ef3a1a3","2f5c6e56-e9e6-44a1-815a-ddd5a1186c76","d673a08e-511e-4053-8d79-ee1ff9fe4cef","c6b629f6-76c9-49c2-8d26-ce643e0eb665","e56a2dd0-827d-4a93-a846-c995966af5e2","71c585c4-66b9-491d-9911-837721721de8","c2d13cad-020f-4e31-9e37-7b0bfed1c883","d772c84a-7288-470f-b572-7ee663d840ab","a8d376b3-17f8-4cd9-b314-8ad7176d9e1b","c2b1bec3-6602-4ee2-9f32-4d77c553a7a5","5a466fc5-c039-4c7c-97a9-620f2d136d32","cf7a70d4-a166-4ad6-a1b9-28796d6c3d63","0123f31d-9175-4e75-a1f2-5bd45fcfb612","3dd7eaf0-156f-4c6a-bdcd-3a55c5fbcb3a","9f6aff3b-0c78-4ae2-8126-85c866c15393","205795a0-9ae6-4bb9-b9b4-84402296fb54","255963cd-490e-4c81-be70-d07858aaa2ee","dfcc4d98-61f4-49eb-8dea-e93e16f9ca93","c1fd97d9-c1ee-4dd1-9332-36d5595b086c","cc925770-1c7b-4ae5-823f-025bd222029b","fccf2654-571d-4d20-9226-6509e082c70c","4c4b43ef-4eda-4ed2-9773-699c3d1943db","34f14f8a-4616-4a18-9c69-89de6aa6781c","ae22c659-1211-43ce-9e83-5a792f1a021a","0adc0022-5b09-49c5-93a9-1ba31aff7abb","9dded198-efb5-4a1e-bcd0-b9b75f8ec55b","1f280e09-a0dd-4216-8597-b64b70fef159","0715f0c5-5f79-4522-a41f-27233d9ed647","7d4a3d12-9804-40f6-a658-97353929b8e6","8e1c18ad-763a-475e-89f7-e6bc06005ee2","b8eaa0a4-d435-4ee0-9551-4733f8163b15","5f0c7c0c-7607-468f-85eb-d4b215228044","08e9a857-ec47-4fdb-8aa9-c5bc48c869ed","e8cdcd4c-ee40-4960-a078-eafd872eafb5","0546b163-58e4-43c3-9e72-b73acad85c60","f2c2e94e-998a-4de7-a5ae-bcf06d550ed8","ee5bb67f-6ad1-4fab-bb0b-1a7dce24d9c2","f3ffd82d-32aa-4f02-a213-4433dc49ac47","6cfd2378-16aa-4971-93d6-409a1d72e941","05126ba2-4ec4-4fc7-95da-075532c368a1","a48e9d53-4a7b-4ccd-98c6-63a6fa09431b","453398a1-1f7d-4d7f-a1a2-e55388f769ed","afeef38e-58d1-41e4-90fb-9eb2c37f6023","0ffe02a2-7a29-4bee-80cb-975ea1a74581","88f060bd-7d3f-4788-ba4e-bfbc76dab641","f02802f2-ac92-45b2-9e34-8249cc28f83c","beeca050-1653-4a87-b160-10addf066c52","f77b15bb-406e-4855-b5ef-24046fc192d3","96d2f9c4-34eb-4e34-bb63-49498741c591","8d247983-4f18-442d-a7c4-b6bbb17290c7","1246aa68-9cc7-4a6e-a08c-52954f88c4ff","6c29ce3f-4eed-49b5-93c8-58df7a2a7e2b","cd5ee62f-517b-47ff-9a8c-8225dda1402b","21c7ccf6-a336-4bb6-bcfa-675201e730b7","b2f26809-9764-4f19-a034-22447742004b","27550b2d-9cb9-4723-ab32-e19460bbdaf3","1403eaf6-6acf-49a0-a0bf-63b7110b08c8","05073c8f-5ad7-409a-a745-19510ffa810a","2ae63cfd-1c6e-4115-95d8-8c9cdad6ed48","57ce497e-3cf8-49bc-b7d8-0b07f519d22f","f399ca3f-f7da-4e33-897a-2bec1ce11812","13051c2f-d259-4003-8708-bd92d9da1e65","025990b7-1780-448e-bddb-c41d3b01a39d","ab42b85c-e154-496c-89b6-fe46d0422f90","1ff65c47-6e07-4394-8707-313437896372","848371a5-c992-41a2-9f86-6ef4658c51f8","84ae3f8e-908e-4bbb-bf8a-e86a3da41474","9f4045fb-444c-40d3-b7f8-2b06b9cefbca","c7621cb3-721b-46ef-befd-ddfb3b44cc0b","ef69e218-a8c8-4af2-89d3-ca12b0e3439f","cd32d9b8-e8d4-4528-9e87-5d90015e01ed","288b1883-4bb5-43fe-82a9-9d9be770b80d","9f15a4b7-1af7-4561-a178-be3549245a31","7047667f-245f-4699-81a1-116b2ea7da39","06912f42-ff0d-4a18-9e51-94e03629e89f","842f3802-89ed-42ee-8da5-c3dbed8595d0","84aab02c-2114-40de-bf63-aacf4441ece8","b20ff457-f8d2-4347-8100-1d5580ddaff7","bf473240-1a67-4da5-9cb7-94dd3268251a","06e85100-6112-4599-9f64-7b2d5a2a6756","fd82c821-b590-41d9-b667-2bafa3db1cd0","caa56b20-195d-42d5-be46-41236961ea50","6ac96acb-1077-472f-8767-c40e4127ef23","69323788-37f1-4eaf-a9fe-1f4cc6d07612","5d20410d-a2b5-4985-89f0-fabd1fe4c41f","76b3e79a-509f-4278-8fae-4c52782e49e8","63d79e70-12a2-432e-ab71-df3357377542","5eb1d5cd-c1e5-43c5-b30e-cb6801de0f82","1ab793b7-47f2-4b88-8cfe-e949b9e75b22","83e82805-2dc9-4e53-8f3e-51e440cfd9c8","237e8057-b4ac-4260-b71c-491d34183dd0","1bf3fec0-d8ab-4d12-a2f1-027252ced749","59593fcb-288e-4cea-9fe7-f19c4dd41452","e627e05c-94e5-4f31-b9e6-0f02d3d98925","8994b063-6c97-4a75-be86-d6328532d3e3","2253ef49-7c5e-4350-ad44-df3c54253062","23cbab1f-00d4-4562-acc0-38eb0146e4ae","3d60e22e-c861-4743-b0f2-5122fb36b1b5","d92c6e0a-7a31-476f-824e-c473518b420b","89681485-b930-408b-a8fc-c7469d8471f6","05b5f033-ec4d-461d-af1d-7cefb91b7c53","8fc4ebe2-98d1-4cff-b42c-ca0dc1c4abe1","4a96c111-f2e2-4de5-b271-e8953499d5ed","ba4e2bf8-3505-4edd-9beb-13c54ae119fd","58d13e73-6cf2-4dba-8424-eed3c75e4218","0d6a2f6f-0775-42c5-b8fb-7c2049a372d6","47dd299a-bfba-4c69-bc7e-fc3e48f91eef","6ae4a931-1fac-44ad-afcc-226175df6950","73e7182c-1f92-409f-b1fe-fc6fd4155379","785be981-30e9-4f40-bdd4-2f382c460fff","89a58d1f-960a-4f8c-ae84-dbebf0e1c1f9","cf2f40df-00ce-4774-a384-985d1a8a1bfa","d9d3392d-d431-4aa0-97e0-444be8eed06a","f39c82b9-724d-425f-8f0d-22f2946f1e64","1dbafafd-0f92-413e-b75e-dacadb91f58c","8ea8463d-42a6-4b52-b906-8b92b1d06e85","771fa5df-d3ac-48f8-8187-2473df326cab","4636c314-45ee-46f0-9344-aba743d5be67","b35a427d-d84a-435f-b6fe-fbf5bb019d80","0151fd1e-20d1-497b-8571-3e7a4b56cba1","9bd5ec0b-6a66-4f80-9018-04cffc0e6c96","d3a0161a-12c8-472f-a09c-53c6f950a50f","18d2307d-4cca-4345-b9d7-dc1507096c15","13254856-fafd-446f-b75d-47e0b729e908","066b4fe7-3b0a-4155-94c6-1becca3e9d8f","61f30ac5-1602-4026-b1f0-c224de4d4a52","2b923df5-5a33-48da-b4b1-5e37cbcfab79","fd7f0e16-0b04-4e69-ab74-53f4cbc81541","5612d0cc-e719-462e-9d50-a83b52a4f119","279fc137-aee5-4ee8-a834-c528b81c1399","48e75eaa-3af8-4213-bf2f-c9062c03531f","55294b84-b02f-4788-87b5-80619a243f7b","4bb76f0f-7f77-4120-bef0-c17b56343a3f","10412a94-a4d5-40d4-b22a-12e851e06267","8d112139-cad0-4e6c-8dab-c749905eb0de","8c257446-183c-4091-85fb-a01bbbb2c102","da43facf-e52a-4d69-b3bc-30251ff554b7","27b883c3-5411-4696-8205-7309c5e4bade","4ffc3109-112b-4796-b609-e9c6aac8870d","f29c8a17-9201-40b4-ba87-ed1803138bc4","8e0e68cd-9e70-4f16-8c35-8a117dfd5d71","61cb57b1-a9f1-4773-b3a4-643a34b3e95f","bc009233-5a77-4bd6-a0c7-17f4941a7c3c","75840e6c-4417-4466-90ac-d4cf0980164e","e6a589ca-b455-4346-9fad-6777b30f3137","e4708e59-6399-4c5d-91d6-87cfc7877e7d","8512923b-b7db-41b5-9502-2fbf95942a1f","be636884-56af-44cd-9d46-4f35a5ee9e56","a74de5e0-84f9-43b6-94a0-c63e4023ae6e","fa08f802-f769-4af2-b880-0a7cd3cb5e22","21f335df-2e59-4cd8-8d0c-9fbcdbf1d503","9fd8ad81-e457-4d2e-9d8e-145daafd7af9","da4990c0-5e42-460c-8425-cfbd41c51f6d","4f9c6c06-3ad6-46b1-9907-c5f09f199062","5595aec8-9bdc-4ee6-aad8-885ffa50909a","27701362-dbb7-4aca-b5a6-c08b830ac4b6","ff80f41e-1180-4fc3-9ea2-46b3880651a8","ac422070-7e32-47cf-ab96-2dfb26036066","1c099fc5-7ce8-4ff4-a33b-85d4a00473ac","9500e573-009a-4727-bd77-1d8f230dc675","b1fc957f-0112-444a-941c-4953a128b292","25e1958f-8fbe-4705-a749-c9d5055a6e48","facda99f-78f1-48b9-9538-695bc10c8e6f","f0e5bc4a-1fcd-48cf-a95c-96774bfa9512","c99860f7-ff36-43ca-ba6d-71d6387b2da5","f0c02b1b-69a8-4a9e-992d-d891d242108a","8255a912-93f3-4348-a902-2ae62bbf3b4d","adba6ae7-1628-4d8e-8536-54ddc26c38f2","e38daf6b-978a-425f-a1fe-ce0a16cff87b","cce3764c-04e8-48b7-bea8-074f2dda6274","ac1f48b7-0410-4f19-982c-d1ec93fb8a3b","d8765efc-6576-4658-ae4b-46d86438a11d","f8fa26f3-5bba-4d5e-8ead-24c19ed51f7d","e79cc7c2-f705-4d5e-897a-2c468659cb24","549f1688-5f62-4c63-b029-235a01196960","3f92e134-c58d-4101-be2d-bb7a042ae323","9a094856-c66e-46ef-8b42-c1ad28a3a326","062c653a-7cf2-4566-adae-21c3284b6d10","94fabb0b-2f87-4667-bd0c-f9a1335b8cfd","01c16695-373d-4689-9829-1b555d88b5a6","edb2e964-834f-455c-a5da-a681964d3837","07c9aecc-d54d-4985-9cc4-b1e405c910c7","12bebafb-235b-4674-9df6-47d0b23513a2","46c07bae-be17-4303-a964-f97e63e11629","627c31e9-b71f-454f-ae78-baaf59be7610","a94784ba-c29c-4f02-9172-8d5d5983125b","20049e49-6daf-492c-a3d8-f4efa351cac1","fe0a1f1a-403d-44db-beae-e99e2ab82ab3","71b567f9-ae6f-401d-b495-08d5e24da45e","4cd81bb0-70de-43d9-9f26-ba622d87c876","2794e264-74a5-4ddc-a60d-966f4759a13e","05189425-d70a-44eb-9879-3306bbac3a35","370d04b8-b5b2-4a04-a6fb-9d104da5d9dd","86e3641d-395b-4045-8060-ff5a493f70fc","a502b2c5-d0f4-49a4-827d-5aa64c073a20","9f62f9c4-b271-42e2-ae4f-a263d1b8b03a","324e446f-532f-4d5f-b9da-f5570808bfe6","58dcb767-08ae-456d-8ec6-2e0a780cbdd1","431e2f71-8aa3-4fd3-bf50-fa1b5518b116","cf7bca78-d407-4c2d-899e-b3aeeb1cb3f4","7921d39c-d036-42fb-a75c-8da1646cc1be","a6337376-2852-41b3-b3ba-2c936b3b134a","7a08a2b9-bf7d-46a4-bf7f-bdb430fafdd7","2eb92afc-c6c9-4788-a89b-c33a8059f80f","d9c2fabe-79fe-4ca1-9190-9f78713d8e46","184963b1-116a-4ee6-b602-a503001fd3a7","3f8a1d9c-df1e-41e8-8c51-98e4c22cd7c8","70d29465-bf72-4dd1-b4fd-5a8d0428788b","76f06611-7573-4d22-8199-e4f63998bf09","0c142a31-4082-444d-8066-19c3375d698a","678b750d-f082-4b28-a37e-c22518645f15","f10a3d28-71ca-42c6-90d9-07435feb699c","f468d2d2-1276-4e89-86a2-e859709b53f8","30b00cf6-25b5-478f-b673-a57cc8c78750","d2579c23-3031-4256-a718-a5a977d25701","8db18d1b-4045-415d-a05e-23841d8135ae","bf34ed9e-0ce9-4bd4-8f79-8b0333f96eb3","5887a6f5-7336-4f78-a90c-fa06a1dece39","e06adf5c-4a18-448a-b555-58af9361e565","13a2819c-c505-42e2-a6f0-76baf680f14d","69ba59eb-0736-4d96-8dae-bd4ff106afb4","736571b5-9ea4-4a7a-ae53-2641434d60f7","c3872ea3-9c1a-4809-8808-1354fb352bc5","9a83c73f-8ad3-4c35-be7e-4b95119a1761","67fadee9-9644-4491-8975-d6d2c4ab2077","68c43586-55c5-4a5f-8ec3-541af7c441da","955b6f88-8345-4e9a-a4f4-3ba6a458b132","1a7b3b4e-8450-4694-a211-5abcb93e2d74","9aa9a7e6-3aba-45b5-a115-9b82fd3bdfb4","7debbf4c-1e34-4ec7-bd19-708e9846d09f"],"format":{"page_icon":"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a22fb73f-5a7d-4fdc-8319-52ed15316e76/images.jpeg","page_cover":"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/47263733-11bc-4ae7-9e1e-c3401a49c171/Manning.100.Go.Mistakes.and.How.to.Avoid.Them.2022-1%EF%BC%88%E6%8B%96%E7%A7%BB%E9%A1%B9%E7%9B%AE%EF%BC%89.png","copied_from_pointer":{"id":"db80f497-e22c-4bff-bdcb-0ac06b5c4528","table":"block","spaceId":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"},"page_cover_position":0.8261},"created_time":1677290925684,"last_edited_time":1677856984295,"parent_id":"89829c97-9e4b-43b0-b37c-457a3da9ad96","parent_table":"collection","alive":true,"copied_from":"db80f497-e22c-4bff-bdcb-0ac06b5c4528","file_ids":["47263733-11bc-4ae7-9e1e-c3401a49c171","425f0231-9af0-4f62-a9f7-f9f567cfe460","a22fb73f-5a7d-4fdc-8319-52ed15316e76"],"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e7596c25-bafa-4ece-94b6-e7973c7a2ab3":{"role":"reader","value":{"id":"e7596c25-bafa-4ece-94b6-e7973c7a2ab3","version":49,"type":"collection_view","view_ids":["11f62eb2-ba92-4ffd-91b4-c964b8cedfeb"],"collection_id":"89829c97-9e4b-43b0-b37c-457a3da9ad96","format":{"collection_pointer":{"id":"89829c97-9e4b-43b0-b37c-457a3da9ad96","table":"collection","spaceId":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"},"copied_from_pointer":{"id":"4176c3f0-95d8-4ac1-9df1-7f705120857b","table":"block","spaceId":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"created_time":1667525160616,"last_edited_time":1677290922625,"parent_id":"72a66971-7cf6-42c2-a252-4439d99d8f44","parent_table":"block","alive":true,"copied_from":"4176c3f0-95d8-4ac1-9df1-7f705120857b","created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"72a66971-7cf6-42c2-a252-4439d99d8f44":{"role":"reader","value":{"id":"72a66971-7cf6-42c2-a252-4439d99d8f44","version":769,"type":"page","properties":{"title":[["萨博一直跑"]]},"content":["23b11c7c-8146-4639-912c-14406e078331","416b3867-4b4b-4ac0-bc8e-196792a57c07","fec36412-bc7e-4ec3-972d-b67b1ddd20f8","8b4d1555-cb50-45a3-a875-87242a4548bb","4176c3f0-95d8-4ac1-9df1-7f705120857b","1118fa3e-20b3-488c-976d-3346081fde80","e7596c25-bafa-4ece-94b6-e7973c7a2ab3","20cd31e6-ea32-4c1b-b7ef-c70749c2f4cb","ab7c7afa-73c5-4b21-9759-89a9dee4d7e8","82aad922-cb77-4452-81bf-56f4e8e5a408"],"format":{"page_icon":"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/37907dd5-3c76-4966-a419-daa027a84972/IMG_2189.jpg","page_full_width":false,"page_small_text":false,"copied_from_pointer":{"id":"bd32b787-e471-49f3-8941-174a9c6846b6","table":"block","spaceId":"bb9288f4-efb5-417f-bf44-1a79fa04feb1"}},"permissions":[{"role":"editor","type":"user_permission","user_id":"d1805983-7869-451d-bf8b-64135a5d4ee7"},{"role":"reader","type":"public_permission","added_timestamp":1660963691744,"allow_duplicate":false}],"created_time":1660961589760,"last_edited_time":1677681498416,"parent_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6","parent_table":"space","alive":true,"copied_from":"bd32b787-e471-49f3-8941-174a9c6846b6","file_ids":["63e89fe9-f5cd-4414-be0e-53d91aa54fc3","37907dd5-3c76-4966-a419-daa027a84972"],"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a85d9fed-92aa-4cf4-ae92-00751ec8ab5b":{"role":"reader","value":{"id":"a85d9fed-92aa-4cf4-ae92-00751ec8ab5b","version":34,"type":"callout","properties":{"title":[["本文是 100 Go Mistakes读书笔记 的下篇"]]},"format":{"page_icon":"💡","block_color":"gray_background"},"created_time":1677291093556,"last_edited_time":1677396896301,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7c7869cc-60ca-4e10-8583-d4a5062b6ac4":{"role":"reader","value":{"id":"7c7869cc-60ca-4e10-8583-d4a5062b6ac4","version":36,"type":"sub_header","properties":{"title":[["关于本书"]]},"created_time":1677396013332,"last_edited_time":1677396018423,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"164f95cb-c34d-469c-b85c-2bc356b4e3c0":{"role":"reader","value":{"id":"164f95cb-c34d-469c-b85c-2bc356b4e3c0","version":10,"type":"bookmark","properties":{"link":[["https://book.douban.com/subject/36084407/"]],"title":[["100 Go Mistakes and How to Avoid Them"]],"description":[["Spot errors in your Go code you didn’t even know you were making and boost your productivity by avoi..."]]},"format":{"bookmark_icon":"https://img1.doubanio.com/favicon.ico","bookmark_cover":"https://img2.doubanio.com/view/subject/l/public/s34311243.jpg"},"created_time":1677396001021,"last_edited_time":1677396001024,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0decdc5a-63f6-4cbc-a101-acf83211ccff":{"role":"reader","value":{"id":"0decdc5a-63f6-4cbc-a101-acf83211ccff","version":29,"type":"sub_header","properties":{"title":[["7 Error management"]]},"created_time":1677291024848,"last_edited_time":1677291039984,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"76b64baf-a8dd-4007-a565-664a00046b06":{"role":"reader","value":{"id":"76b64baf-a8dd-4007-a565-664a00046b06","version":45,"type":"sub_sub_header","properties":{"title":[["7.1 #48: Panicking（什么是panic）"]]},"created_time":1677292203010,"last_edited_time":1677294732692,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"db506446-b2b1-4506-ad5e-c86683194e91":{"role":"reader","value":{"id":"db506446-b2b1-4506-ad5e-c86683194e91","version":333,"type":"code","properties":{"title":[["func main() {\n  // 在defer中执行 recover 可以恢复panic，defer也会在周围出现panic的时候执行\n\tdefer func() {\n\t\tif r := recover(); r != nil {\n\t\t\tfmt.Println(\"recover\", r)\n\t\t}\n\t}()\n\tf()\n}\nfunc f() {\n\tfmt.Println(\"a\")\n\tpanic(\"foo\")\n\tfmt.Println(\"b\")\n}"]],"language":[["Go"]]},"created_time":1677292570881,"last_edited_time":1677292814251,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c94b3a79-2507-408d-8aef-c2d11343c7fc":{"role":"reader","value":{"id":"c94b3a79-2507-408d-8aef-c2d11343c7fc","version":167,"type":"sub_sub_header","properties":{"title":[["7.2 #49: Ignoring when to wrap an error（不明确何时包装一个error，fmt.Errorf用法）"]]},"created_time":1677293210806,"last_edited_time":1677299316602,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"91b46093-1166-42ec-bf70-9fcf8d6b87ec":{"role":"reader","value":{"id":"91b46093-1166-42ec-bf70-9fcf8d6b87ec","version":168,"type":"text","properties":{"title":[["在如下场景你可以选择包装一下error："]]},"created_time":1677293269422,"last_edited_time":1677294355241,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"aa034550-14d1-4e86-8475-807cfc28c526":{"role":"reader","value":{"id":"aa034550-14d1-4e86-8475-807cfc28c526","version":265,"type":"numbered_list","properties":{"title":[["你需要在错误上增加一些上下文"]]},"created_time":1677293957481,"last_edited_time":1677293981449,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"104c6b88-dfb3-4253-8e26-66b685beae33":{"role":"reader","value":{"id":"104c6b88-dfb3-4253-8e26-66b685beae33","version":248,"type":"numbered_list","properties":{"title":[["你需要把错误封装在另一个错误内"]]},"created_time":1677293981774,"last_edited_time":1677294353841,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b0dbcc2b-d143-444f-a9c4-fa7b2bd1466a":{"role":"reader","value":{"id":"b0dbcc2b-d143-444f-a9c4-fa7b2bd1466a","version":7,"type":"column_list","content":["a0af9c7a-485d-4991-b55f-fc99c001c7cd","0bbfdf78-648f-4f12-bb15-c263feb01acc"],"created_time":1677294255341,"last_edited_time":1677294255345,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a0af9c7a-485d-4991-b55f-fc99c001c7cd":{"role":"reader","value":{"id":"a0af9c7a-485d-4991-b55f-fc99c001c7cd","version":7,"type":"column","content":["7b47c760-07b5-4458-91c0-27039f752bed"],"format":{"column_ratio":0.5},"created_time":1677294255341,"last_edited_time":1677294255345,"parent_id":"b0dbcc2b-d143-444f-a9c4-fa7b2bd1466a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0bbfdf78-648f-4f12-bb15-c263feb01acc":{"role":"reader","value":{"id":"0bbfdf78-648f-4f12-bb15-c263feb01acc","version":6,"type":"column","content":["29ea918e-04ec-4527-8b38-0076f604b0a5"],"format":{"column_ratio":0.5},"created_time":1677294255343,"last_edited_time":1677294255345,"parent_id":"b0dbcc2b-d143-444f-a9c4-fa7b2bd1466a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7b47c760-07b5-4458-91c0-27039f752bed":{"role":"reader","value":{"id":"7b47c760-07b5-4458-91c0-27039f752bed","version":14,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbfjzjehr4j30tc0ccq5c.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbfjzjehr4j30tc0ccq5c.jpg"},"created_time":1677294203420,"last_edited_time":1677294255345,"parent_id":"a0af9c7a-485d-4991-b55f-fc99c001c7cd","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"29ea918e-04ec-4527-8b38-0076f604b0a5":{"role":"reader","value":{"id":"29ea918e-04ec-4527-8b38-0076f604b0a5","version":15,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbfjzrczn0j30t00bmgnc.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbfjzrczn0j30t00bmgnc.jpg"},"created_time":1677294216319,"last_edited_time":1677294255345,"parent_id":"0bbfdf78-648f-4f12-bb15-c263feb01acc","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"476a8035-98db-443c-b303-57897ee1a5b3":{"role":"reader","value":{"id":"476a8035-98db-443c-b303-57897ee1a5b3","version":185,"type":"text","properties":{"title":[["GO支持如下几种包装error的方式："]]},"created_time":1677294259429,"last_edited_time":1677294520912,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d063db16-6f75-400f-8397-8a908920b734":{"role":"reader","value":{"id":"d063db16-6f75-400f-8397-8a908920b734","version":83,"type":"numbered_list","properties":{"title":[["自定义Error结构体"]]},"content":["220667b1-4edb-473c-a0d5-920c5a702a1b"],"created_time":1677294521443,"last_edited_time":1677294715630,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"220667b1-4edb-473c-a0d5-920c5a702a1b":{"role":"reader","value":{"id":"220667b1-4edb-473c-a0d5-920c5a702a1b","version":74,"type":"code","properties":{"title":[["type BarError struct {\n\tErr error\n}\n\nfunc (b BarError) Error() string {\n\treturn \"bar failed:\" + b.Err.Error()\n}\n\nfunc test() {\n\terr := bar()\n\tif err != nil {\n\t\treturn BarError{Err: err}\n\t}\n}"]],"language":[["Go"]]},"created_time":1677294587323,"last_edited_time":1677294624021,"parent_id":"d063db16-6f75-400f-8397-8a908920b734","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"fe958b5d-0a7c-4d06-a05a-39fff22ece70":{"role":"reader","value":{"id":"fe958b5d-0a7c-4d06-a05a-39fff22ece70","version":191,"type":"numbered_list","properties":{"title":[["使用 fmt.Errorf 方法，⚠️ %w 和 %v 有不同的执行效果"]]},"content":["4f3b56c1-9172-45de-92a6-9830d93e06fc"],"created_time":1677294714721,"last_edited_time":1677295436285,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4f3b56c1-9172-45de-92a6-9830d93e06fc":{"role":"reader","value":{"id":"4f3b56c1-9172-45de-92a6-9830d93e06fc","version":1178,"type":"code","properties":{"title":[["if err != nil {\n\t\t// 使用 %w 指令，会返回一个包装了err的错误，接收方可以从父error中获取到源error\n\t\t// 并根据判断错误是否为某一个错误类型\n\t\t// sourceErr --wrap--\u003e WrapErr(sourceErr)\n    return fmt.Errorf(\"bar failed: %w\", err)\n}\n\nif err != nil {\n\t\t// 使用 %v 指令，不会包装错误，会直接转化为另一个错误，源错误不再可用\n    // sourceErr --transform--\u003e otherErr\n    return fmt.Errorf(\"bar failed: %v\", err)\n}\n"]],"language":[["Go"]]},"created_time":1677294755363,"last_edited_time":1677295051738,"parent_id":"fe958b5d-0a7c-4d06-a05a-39fff22ece70","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5eea680d-96d5-4622-bf61-fc9df8741066":{"role":"reader","value":{"id":"5eea680d-96d5-4622-bf61-fc9df8741066","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbfkkxdgp1j31gw0i6tel.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbfkkxdgp1j31gw0i6tel.jpg"},"created_time":1677295438230,"last_edited_time":1677295440903,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8e9fc5af-f060-464f-83fb-8f2954c0406e":{"role":"reader","value":{"id":"8e9fc5af-f060-464f-83fb-8f2954c0406e","version":686,"type":"text","properties":{"title":[["如果保留源错误的信息，会有潜在的耦合信息，因为接收方需要直接函数实现的细节，需要知道被包装的错误是什么类型，所以没有特殊需求在使用fmt.Errorf的时候使用%v指令。"]]},"created_time":1677295447353,"last_edited_time":1677295639610,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3cd2c017-ab3e-4a78-8dbb-855fe703e324":{"role":"reader","value":{"id":"3cd2c017-ab3e-4a78-8dbb-855fe703e324","version":187,"type":"sub_sub_header","properties":{"title":[["7.3 #50: Checking an error type inaccurately（如何正确的判断Error类型-error.As用法）"]]},"created_time":1677295625002,"last_edited_time":1677299300560,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"92fe02f6-abe8-4191-b122-9174b3a93017":{"role":"reader","value":{"id":"92fe02f6-abe8-4191-b122-9174b3a93017","version":34,"type":"code","properties":{"title":[["func handler(w http.ResponseWriter, r *http.Request) {\n\ttransactionID := r.URL.Query().Get(\"transaction\")\n\n\tamount, err := getTransactionAmount(transactionID)\n\tif err != nil {\n\t\tif errors.As(err, \u0026transientError{}) {\n\t\t\thttp.Error(w, err.Error(), http.StatusServiceUnavailable)\n\t\t} else {\n\t\t\thttp.Error(w, err.Error(), http.StatusBadRequest)\n\t\t}\n\t\treturn\n\t}\n\n\t// Write response\n\t_ = amount\n}\n\nfunc getTransactionAmount(transactionID string) (float32, error) {\n\t// Check transaction ID validity\n\n\tamount, err := getTransactionAmountFromDB(transactionID)\n\tif err != nil {\n\t\treturn 0, fmt.Errorf(\"failed to get transaction %s: %w\",\n\t\t\ttransactionID, err)\n\t}\n\treturn amount, nil\n}\n\nfunc getTransactionAmountFromDB(transactionID string) (float32, error) {\n\t// ...\n\tvar err error\n\tif err != nil {\n\t\treturn 0, transientError{err: err}\n\t}\n\t// ...\n\treturn 0, nil\n}"]],"language":[["Go"]]},"created_time":1677298025270,"last_edited_time":1677298065539,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cc26dc03-b1fd-4a0c-8aea-2d47acc1d32e":{"role":"reader","value":{"id":"cc26dc03-b1fd-4a0c-8aea-2d47acc1d32e","version":473,"type":"text","properties":{"title":[["当使用%w指令或者结构体封装的方式包装一个错误的时候，可以使用 errors.As 递归判断错误类型，errors.As函数需要传递一个目标错误类型的指针。"]]},"created_time":1677295637489,"last_edited_time":1677298204646,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"6a42791f-2d95-4750-9eac-5152c344224d":{"role":"reader","value":{"id":"6a42791f-2d95-4750-9eac-5152c344224d","version":239,"type":"sub_sub_header","properties":{"title":[["7.4 #51: Checking an error value inaccurately（如何正确的处理Error的值-error.Is用法）"]]},"format":{"copied_from_pointer":{"id":"3cd2c017-ab3e-4a78-8dbb-855fe703e324","table":"block","spaceId":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"created_time":1677298199263,"last_edited_time":1677299292543,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"copied_from":"3cd2c017-ab3e-4a78-8dbb-855fe703e324","created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cf04f3b6-9852-4ecc-af8a-394a75a9d1da":{"role":"reader","value":{"id":"cf04f3b6-9852-4ecc-af8a-394a75a9d1da","version":182,"type":"text","properties":{"title":[["sentinel error ",[["b"]]],["是指定义为全局变量的错误类型。"],["命名规约是以Err开头加上类型",[["b"]]],["。"]]},"created_time":1677298251378,"last_edited_time":1677298525470,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e331508f-44af-4e24-88ca-94e3be618be7":{"role":"reader","value":{"id":"e331508f-44af-4e24-88ca-94e3be618be7","version":7,"type":"code","properties":{"title":[["import \"errors\"\nvar ErrFoo = errors.New(\"foo\")"]],"language":[["Go"]]},"created_time":1677298442204,"last_edited_time":1677298442535,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a1743b61-d7ec-4a81-9de9-17c0c47a8499":{"role":"reader","value":{"id":"a1743b61-d7ec-4a81-9de9-17c0c47a8499","version":813,"type":"text","properties":{"title":[["这种类型的错误，有时候是程序允许存在的错误，比如查询数据库返回没有查询到结果的sql.ErrNoRows和io.Reader读取返回io.EOF.他们传递的信息客户端可以接受，并认为是正常的情况。"]]},"created_time":1677298398268,"last_edited_time":1677298853588,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"00be8470-9c61-41e1-b49a-c4e652c48e70":{"role":"reader","value":{"id":"00be8470-9c61-41e1-b49a-c4e652c48e70","version":641,"type":"text","properties":{"title":[["在查询数据的场景，我们想判断错误的值是否等于sql.ErrNoRows这种"],["sentinel error，",[["b"]]],["使用 == 可能会出现问题，因为ErrNoRows可能已经被包装过。对于这种问题，可以直接使用 "],["errors.Is",[["b"],["a","http://errors.Is"]]],[" ",[["b"]]],["来判断，他可以帮你递归判断出正确的错误。"]]},"created_time":1677299145007,"last_edited_time":1677299283955,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a8ae21ec-bb85-4c71-af75-fab84fc7b7dd":{"role":"reader","value":{"id":"a8ae21ec-bb85-4c71-af75-fab84fc7b7dd","version":64,"type":"code","properties":{"title":[["func main() {\n\terr := query()\n\tif err != nil {\n\t\t// if err == sql.ErrNoRows {\n\t\tif errors.Is(err, sql.ErrNoRows) {\n\t\t\t// ...\n\t\t} else {\n\t\t\t// ...\n\t\t}\n\t}\n}\n\nfunc query() error {\n\treturn nil\n}"]],"language":[["Go"]]},"created_time":1677299093575,"last_edited_time":1677299142421,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"17dbaba5-4db2-446b-8966-7b17d775b52b":{"role":"reader","value":{"id":"17dbaba5-4db2-446b-8966-7b17d775b52b","version":128,"type":"sub_sub_header","properties":{"title":[["7.5 #52: Handling an error twice（多次处理错误）"]]},"created_time":1677307531800,"last_edited_time":1677308154505,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ff246c9e-e04f-4661-9c0a-3baffd9239d3":{"role":"reader","value":{"id":"ff246c9e-e04f-4661-9c0a-3baffd9239d3","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbfqoq89goj31ja0tmani.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbfqoq89goj31ja0tmani.jpg"},"created_time":1677308112085,"last_edited_time":1677308114911,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d5985c13-735b-497c-862c-ab8b526e92e2":{"role":"reader","value":{"id":"d5985c13-735b-497c-862c-ab8b526e92e2","version":51,"type":"sub_sub_header","properties":{"title":[["7.6 #53: Not handling an error（没有处理error）"]]},"created_time":1677308130897,"last_edited_time":1677308429032,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"313fa910-9059-498c-8d59-5a950ed0f995":{"role":"reader","value":{"id":"313fa910-9059-498c-8d59-5a950ed0f995","version":298,"type":"text","properties":{"title":[["如果代码中没有处理一个函数返回的error，需要编写注释明确指明不处理error的原因"]]},"created_time":1677308430132,"last_edited_time":1677308457699,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"57f95bce-c9bb-4270-a8dd-92a40ef3a1a3":{"role":"reader","value":{"id":"57f95bce-c9bb-4270-a8dd-92a40ef3a1a3","version":9,"type":"code","properties":{"title":[["// At-most once delivery.\n// Hence, it's accepted to miss some of them in case of errors.\n _ = notify()"]],"language":[["Go"]]},"created_time":1677308799865,"last_edited_time":1677308806084,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2f5c6e56-e9e6-44a1-815a-ddd5a1186c76":{"role":"reader","value":{"id":"2f5c6e56-e9e6-44a1-815a-ddd5a1186c76","version":154,"type":"sub_sub_header","properties":{"title":[["7.7 #54: Not handling defer errors（没有处理defer语句中的error）"]]},"created_time":1677308477042,"last_edited_time":1677308676033,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d673a08e-511e-4053-8d79-ee1ff9fe4cef":{"role":"reader","value":{"id":"d673a08e-511e-4053-8d79-ee1ff9fe4cef","version":923,"type":"text","properties":{"title":[["defer语句经常会做一些收尾工作，关闭socket，释放锁等..,有些语句会返回错误，如果不处理这些错误就会导致错误信息丢失，造成资源泄露等问题。本节提出了一个通过给错误返回值命名，在defer的时候把错误值赋值给返回结果，向上传递错误。"]]},"created_time":1677309507905,"last_edited_time":1677309618103,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c6b629f6-76c9-49c2-8d26-ce643e0eb665":{"role":"reader","value":{"id":"c6b629f6-76c9-49c2-8d26-ce643e0eb665","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbfr8gkmhjj319a0hatdy.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbfr8gkmhjj319a0hatdy.jpg"},"created_time":1677309250974,"last_edited_time":1677309254348,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e56a2dd0-827d-4a93-a846-c995966af5e2":{"role":"reader","value":{"id":"e56a2dd0-827d-4a93-a846-c995966af5e2","version":771,"type":"code","properties":{"title":[["// 一种解决方式是使用命名结果，把错误信息通过命名结果返回\nfunc getBalance(db *sql.DB, clientID string) (balance float32, err error) {\n\trows, err := db.Query(query, clientID)\n\tif err != nil {\n\t\treturn 0, err\n\t}\n\tdefer func() {\n\t\tcloseErr := rows.Close()\n\t\tif err != nil {\n\t\t\tif closeErr != nil {\n        // 如果db.Query语句也出现了执行错误，把close错误的信息打印出来\n\t\t\t\tlog.Printf(\"failed to close rows: %v\", err)\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\t// 当只要close的时候有错误，把closeErr赋值给err传递到上一层\n\t\terr = closeErr\n\t}()\n\n\t// Use rows\n\treturn 0, nil\n}"]],"language":[["Go"]]},"created_time":1677309378674,"last_edited_time":1677309503274,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"71c585c4-66b9-491d-9911-837721721de8":{"role":"reader","value":{"id":"71c585c4-66b9-491d-9911-837721721de8","version":13,"type":"sub_header","properties":{"title":[["8 Concurrency: Foundations"]]},"created_time":1677460048529,"last_edited_time":1677462029011,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c2d13cad-020f-4e31-9e37-7b0bfed1c883":{"role":"reader","value":{"id":"c2d13cad-020f-4e31-9e37-7b0bfed1c883","version":12,"type":"bookmark","properties":{"link":[["https://golang.design/under-the-hood/zh-cn/part1basic/ch05sync/mem/"]],"title":[["5.9 内存一致模型"]],"description":[["5.9 内存一致模型 读者可能注意到了，无论是在谈论 Go 的运行时还是编译器，直到目前为止我们都有意无意的 尝试去回避 Go 语言的「内存模型」这个话题。 这有非常多的原因，作为本章的收尾，也是全书对 Go 语言同步原语与同步模式的一个总结， 我们最后来详细展开内存模型这个话题，解答读者心中的疑惑。 对为什么到目前为止我们都刻意的回避有关内存模型的内容作出一个相对完整的解释。 5.9.1 内存模型的重要性 内存一致模型，或称内存模型，是一份语言用户与语言自身、语言自身与所在的操作系统平台、 所在操作系统平台与硬件平台之间的契约。它定义了并行状态下拥有确定读取和写入的时序的条件， 并回答了一个共享变量是否具有足够的同步机制来保障一个线程的写入能否发生在另一个线程的读取之前这个问题。 在一份 Go 语言的程序被写成后，将经过编译器的转换与优化、所运行操作系统或虚拟机等动态优化器的优化，以及 CPU 硬件平台对指令流的优化才最终得以被执行。这个过程意味着，对于某一个变量的读取与写入操作，可能 被这个过程中任何一个中间步骤进行调整，从而偏离程序员在程序中所指定的原有顺序。 没有内存模型的保障，就无法正确的推演程序在最终被执行时的正确性。 内存模型的策略同样有着长期影响，并且直接决定了程序的可移植性和可维护性。 例如，过强的内存模型将约束硬件和编译器优化的空间，从而严重降低程序性能上限； 已经选择了强内存模型的硬件体系结构，无法在不破坏兼容性的情况下向更弱的内存模型进行迁移， 这种兼容性破坏所带来的代价就是要求其平台上的程序重新实现其源码。 这种横跨用户、软件与硬件三大领域的主题使得内存模型的设计愿景变得异常的困难，至今仍是一个开放的研究问题。因此在讨论 Go 语言的内存模型之前，我们还需要了解现有的内存模型、历史上软硬件平台之间形成契约的经验教训。 5.9.2 强序与弱序 令同步模型为对内存访问的一组约束，这些约束指定了需要如何以及何时完成同步，则当且仅当硬件与遵循该同步模型的所有软件顺序一致时，称该同步模型对于硬件而言满足弱序（Weak Ordering）。 5.9.3 免数据竞争范式 当一个程序在特定输入上具有顺序一致的执行顺序时，且其中两个相互冲突的操作同时执行，则称其为无数据竞争（Data-Race-Free, DRF）。 5.9.4 历史实践 C++ 是一个在内存模型方面实践优秀的一个例子。 线性一致性：又称强一致性或原子一致性。它要求任何一次读操作都能读到某个数据的最近一次写的数据，并且所有线程的操作顺序与全局时钟下的顺序是一致的。  x.store(1) x.load() G1 ---------+----------------+------\u003e G2 -------------------+-------------\u003e x.store(2) 在这种情况下线程 G1, G2 对 x 的两次写操作是原子的，且 x.store(1) 是严格的发生在 x.store(2) 之前，x.store(2) 严格的发生在 x.load() 之前。 值得一提的是，线性一致性对全局时钟的要求是难以实现的，这也是人们不断研究比这个一致性更弱条件下其他一致性的算法的原因。 顺序一致性：同样要求任何一次读操作都能读到数据最近一次写入的数据，但未要求与全局时钟的顺序一致。  x.store(1) x."]]},"format":{"bookmark_icon":"https://golang.design/under-the-hood/favicon.png"},"created_time":1677460051027,"last_edited_time":1677460054240,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d772c84a-7288-470f-b572-7ee663d840ab":{"role":"reader","value":{"id":"d772c84a-7288-470f-b572-7ee663d840ab","version":17,"type":"sub_sub_header","properties":{"title":[["8.6 #60: Misunderstanding Go contexts"]]},"created_time":1677497058349,"last_edited_time":1677497065420,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a8d376b3-17f8-4cd9-b314-8ad7176d9e1b":{"role":"reader","value":{"id":"a8d376b3-17f8-4cd9-b314-8ad7176d9e1b","version":7,"type":"text","created_time":1677497065831,"last_edited_time":1677499088017,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c2b1bec3-6602-4ee2-9f32-4d77c553a7a5":{"role":"reader","value":{"id":"c2b1bec3-6602-4ee2-9f32-4d77c553a7a5","version":9,"type":"sub_header","properties":{"title":[["9 Concurrency: Practice"]]},"created_time":1677499091555,"last_edited_time":1677594501926,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5a466fc5-c039-4c7c-97a9-620f2d136d32":{"role":"reader","value":{"id":"5a466fc5-c039-4c7c-97a9-620f2d136d32","version":77,"type":"sub_sub_header","properties":{"title":[["9.1 #61: Propagating an inappropriate context（错误传递context）"]]},"created_time":1677499100819,"last_edited_time":1677500544072,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cf7a70d4-a166-4ad6-a1b9-28796d6c3d63":{"role":"reader","value":{"id":"cf7a70d4-a166-4ad6-a1b9-28796d6c3d63","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbibdjgitaj31q80meank.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbibdjgitaj31q80meank.jpg"},"created_time":1677500531533,"last_edited_time":1677500534213,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0123f31d-9175-4e75-a1f2-5bd45fcfb612":{"role":"reader","value":{"id":"0123f31d-9175-4e75-a1f2-5bd45fcfb612","version":651,"type":"text","properties":{"title":[["为了能够异步执行写入消息队列的动作，又能继承来自request context中的值，我们可以编写自定义的context，只继承父context的值。"]]},"created_time":1677500545956,"last_edited_time":1677500738419,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3dd7eaf0-156f-4c6a-bdcd-3a55c5fbcb3a":{"role":"reader","value":{"id":"3dd7eaf0-156f-4c6a-bdcd-3a55c5fbcb3a","version":15,"type":"code","properties":{"title":[["type detach struct {\n\tctx context.Context\n}\n\nfunc (d detach) Deadline() (time.Time, bool) {\n\treturn time.Time{}, false\n}\n\nfunc (d detach) Done() \u003c-chan struct{} {\n\treturn nil\n}\n\nfunc (d detach) Err() error {\n\treturn nil\n}\n\nfunc (d detach) Value(key any) any {\n\treturn d.ctx.Value(key)\n}\n\nfunc handler(w http.ResponseWriter, r *http.Request) {\n\tresponse, err := doSomeTask(r.Context(), r)\n\tif err != nil {\n\t\thttp.Error(w, err.Error(), http.StatusInternalServerError)\n\t\treturn\n\t}\n\n\tgo func() {\n\t\terr := publish(detach{ctx: r.Context()}, response)\n\t\t// Do something with err\n\t\t_ = err\n\t}()\n\n\twriteResponse(response)\n}"]],"language":[["Go"]]},"created_time":1677500839790,"last_edited_time":1677500855280,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9f6aff3b-0c78-4ae2-8126-85c866c15393":{"role":"reader","value":{"id":"9f6aff3b-0c78-4ae2-8126-85c866c15393","version":122,"type":"sub_sub_header","properties":{"title":[["9.2 #62: Starting a goroutine without knowing when to stop it（管理好协程）"]]},"created_time":1677504183112,"last_edited_time":1677584499350,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"205795a0-9ae6-4bb9-b9b4-84402296fb54":{"role":"reader","value":{"id":"205795a0-9ae6-4bb9-b9b4-84402296fb54","version":7,"type":"code","properties":{"title":[["func main() {\n\tw := newWatcher()\n\tdefer w.close()\n\n\t// Run the application\n}\n\nfunc newWatcher() watcher {\n\tw := watcher{}\n\tgo w.watch()\n\treturn w\n}\n\ntype watcher struct { /* Some resources */\n}\n\nfunc (w watcher) watch() {}\n\nfunc (w watcher) close() {\n\t// Close the resources\n}"]],"language":[["Go"]]},"created_time":1677505028826,"last_edited_time":1677505029303,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"255963cd-490e-4c81-be70-d07858aaa2ee":{"role":"reader","value":{"id":"255963cd-490e-4c81-be70-d07858aaa2ee","version":309,"type":"sub_sub_header","properties":{"title":[["9.3 #63: Not being careful with goroutines and loop variables（在range loop中执行协程，注意不要引用range生成的变量）"]]},"created_time":1677591205610,"last_edited_time":1677591266570,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"dfcc4d98-61f4-49eb-8dea-e93e16f9ca93":{"role":"reader","value":{"id":"dfcc4d98-61f4-49eb-8dea-e93e16f9ca93","version":58,"type":"text","properties":{"title":[["参考 "],["#30",[["a","https://yangsoon.github.io/100-go-mistakes-and-how-to-avoid-them--1#f78ef2507ea64ebda88578bfb188720c"]]]]},"created_time":1677591460957,"last_edited_time":1677591488995,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c1fd97d9-c1ee-4dd1-9332-36d5595b086c":{"role":"reader","value":{"id":"c1fd97d9-c1ee-4dd1-9332-36d5595b086c","version":316,"type":"code","properties":{"title":[["func listing1() {\n\ts := []int{1, 2, 3}\n\t// 协程打印的结果可能会出现相同的值\n\tfor _, i := range s {\n\t\tgo func() {\n\t\t\tfmt.Print(i)\n\t\t}()\n\t}\n}\n// 解决方案一\nfunc listing2() {\n\ts := []int{1, 2, 3}\n\t\n\tfor _, i := range s {\n\t\tval := i\n\t\tgo func() {\n\t\t\tfmt.Print(val)\n\t\t}()\n\t}\n}\n// 解决方案二\nfunc listing3() {\n\ts := []int{1, 2, 3}\n\n\tfor _, i := range s {\n\t\tgo func(val int) {\n\t\t\tfmt.Print(val)\n\t\t}(i)\n\t}\n}"]],"language":[["Go"]]},"created_time":1677591299358,"last_edited_time":1677591360248,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cc925770-1c7b-4ae5-823f-025bd222029b":{"role":"reader","value":{"id":"cc925770-1c7b-4ae5-823f-025bd222029b","version":125,"type":"sub_sub_header","properties":{"title":[["9.4 #64: Expecting deterministic behavior using select and channels（错误的以为 select 的执行结果是确定的）"]]},"created_time":1677591368970,"last_edited_time":1677591504407,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"fccf2654-571d-4d20-9226-6509e082c70c":{"role":"reader","value":{"id":"fccf2654-571d-4d20-9226-6509e082c70c","version":160,"type":"bulleted_list","properties":{"title":[["select 中的 case 执行时机是随机的"]]},"created_time":1677591967665,"last_edited_time":1677591986597,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4c4b43ef-4eda-4ed2-9773-699c3d1943db":{"role":"reader","value":{"id":"4c4b43ef-4eda-4ed2-9773-699c3d1943db","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbjjepyykqj31ca0lg47c.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbjjepyykqj31ca0lg47c.jpg"},"created_time":1677591938850,"last_edited_time":1677591941495,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"34f14f8a-4616-4a18-9c69-89de6aa6781c":{"role":"reader","value":{"id":"34f14f8a-4616-4a18-9c69-89de6aa6781c","version":110,"type":"text","properties":{"title":[["解决方案可以是使用for-select嵌套："]]},"created_time":1677591988917,"last_edited_time":1677592058492,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ae22c659-1211-43ce-9e83-5a792f1a021a":{"role":"reader","value":{"id":"ae22c659-1211-43ce-9e83-5a792f1a021a","version":15,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbjjgb39klj310s0juwh4.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbjjgb39klj310s0juwh4.jpg"},"created_time":1677592042520,"last_edited_time":1677592777461,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0adc0022-5b09-49c5-93a9-1ba31aff7abb":{"role":"reader","value":{"id":"0adc0022-5b09-49c5-93a9-1ba31aff7abb","version":315,"type":"sub_sub_header","properties":{"title":[["9.5 #65: Not using notification channels（chan struct{} 可以用于通知事件）"]]},"created_time":1677593408024,"last_edited_time":1677593491928,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9dded198-efb5-4a1e-bcd0-b9b75f8ec55b":{"role":"reader","value":{"id":"9dded198-efb5-4a1e-bcd0-b9b75f8ec55b","version":149,"type":"code","properties":{"title":[["// struct{} 不占用内存，经常用于通知场景\nchan struct{}"]],"language":[["Go"]]},"created_time":1677593513327,"last_edited_time":1677593542196,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1f280e09-a0dd-4216-8597-b64b70fef159":{"role":"reader","value":{"id":"1f280e09-a0dd-4216-8597-b64b70fef159","version":4,"type":"sub_sub_header","properties":{"title":[["9.6 #66: Not using nil channels（利用nil的channel读写都会block的特性）"]]},"created_time":1677592067975,"last_edited_time":1677593400350,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0715f0c5-5f79-4522-a41f-27233d9ed647":{"role":"reader","value":{"id":"0715f0c5-5f79-4522-a41f-27233d9ed647","version":12,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbjjsatms6j310a0m8q8p.jpg"]]},"format":{"block_width":480,"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbjjsatms6j310a0m8q8p.jpg","block_full_width":false,"block_page_width":false},"created_time":1677592780340,"last_edited_time":1677592805253,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7d4a3d12-9804-40f6-a658-97353929b8e6":{"role":"reader","value":{"id":"7d4a3d12-9804-40f6-a658-97353929b8e6","version":331,"type":"bulleted_list","properties":{"title":[["GO对于close的channel仍然能够读取到0值，所以需要使用  "],["v, open := \u003c-ch",[["c"]]],[" 语法中的open来判断channel是否被close"]]},"created_time":1677592815786,"last_edited_time":1677592880629,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8e1c18ad-763a-475e-89f7-e6bc06005ee2":{"role":"reader","value":{"id":"8e1c18ad-763a-475e-89f7-e6bc06005ee2","version":14,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbjjx84ansj31bs10yaip.jpg"]]},"format":{"block_width":576,"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbjjx84ansj31bs10yaip.jpg","block_full_width":false,"block_page_width":false},"created_time":1677593004442,"last_edited_time":1677593289174,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b8eaa0a4-d435-4ee0-9551-4733f8163b15":{"role":"reader","value":{"id":"b8eaa0a4-d435-4ee0-9551-4733f8163b15","version":433,"type":"text","properties":{"title":[["解决方案：通过 ",[["b"]]],["v, open := \u003c-ch",[["c"],["b"]]],[" 语法判断 chan 是否被close，避免读取0值，close之后的channel置为nil，避免for循环空转",[["b"]]]]},"created_time":1677593187323,"last_edited_time":1677593265394,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5f0c7c0c-7607-468f-85eb-d4b215228044":{"role":"reader","value":{"id":"5f0c7c0c-7607-468f-85eb-d4b215228044","version":12,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbjjzxzub1j31520s445i.jpg"]]},"format":{"block_width":576,"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbjjzxzub1j31520s445i.jpg","block_full_width":false,"block_page_width":false},"created_time":1677593161482,"last_edited_time":1677593282277,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"08e9a857-ec47-4fdb-8aa9-c5bc48c869ed":{"role":"reader","value":{"id":"08e9a857-ec47-4fdb-8aa9-c5bc48c869ed","version":118,"type":"sub_sub_header","properties":{"title":[["9.7 #67: Being puzzled about channel size（不清楚channel的大小如何设置）"]]},"created_time":1677593315976,"last_edited_time":1677593355635,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e8cdcd4c-ee40-4960-a078-eafd872eafb5":{"role":"reader","value":{"id":"e8cdcd4c-ee40-4960-a078-eafd872eafb5","version":156,"type":"bulleted_list","properties":{"title":[["无缓存的channel可以用于同步场景"]]},"created_time":1677593597796,"last_edited_time":1677593615906,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0546b163-58e4-43c3-9e72-b73acad85c60":{"role":"reader","value":{"id":"0546b163-58e4-43c3-9e72-b73acad85c60","version":189,"type":"bulleted_list","properties":{"title":[["带有缓存的channel经常用于传递消息，控制协程数量等等"]]},"created_time":1677593616538,"last_edited_time":1677593654862,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f2c2e94e-998a-4de7-a5ae-bcf06d550ed8":{"role":"reader","value":{"id":"f2c2e94e-998a-4de7-a5ae-bcf06d550ed8","version":4,"type":"sub_sub_header","properties":{"title":[["9.8 #68: Forgetting about possible side effects with string formatting（字符串格式化可能会带来的并发错误）"]]},"created_time":1677585738834,"last_edited_time":1677593312480,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ee5bb67f-6ad1-4fab-bb0b-1a7dce24d9c2":{"role":"reader","value":{"id":"ee5bb67f-6ad1-4fab-bb0b-1a7dce24d9c2","version":514,"type":"text","properties":{"title":[["如下例子，在 age \u003c 0 的场景下 UpdateAge 会执行到 fmt.Errorf 函数并打印结构体c，fmt.Errorf会直接调用c结构的 String 方法导致死锁。"]]},"created_time":1677585930924,"last_edited_time":1677586052704,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f3ffd82d-32aa-4f02-a213-4433dc49ac47":{"role":"reader","value":{"id":"f3ffd82d-32aa-4f02-a213-4433dc49ac47","version":17,"type":"code","properties":{"title":[["type Customer struct {\n\tmutex sync.RWMutex\n\tid    string\n\tage   int\n}\n\nfunc (c *Customer) UpdateAge(age int) error {\n\tc.mutex.Lock()\n\tdefer c.mutex.Unlock()\n\n\tif age \u003c 0 {\n\t\treturn fmt.Errorf(\"age should be positive for customer %v\", c)\n\t}\n\n\tc.age = age\n\treturn nil\n}\n\nfunc (c *Customer) String() string {\n\tc.mutex.RLock()\n\tdefer c.mutex.RUnlock()\n\treturn fmt.Sprintf(\"id %s, age %d\", c.id, c.age)\n}"]],"language":[["Go"]]},"created_time":1677585899992,"last_edited_time":1677585921387,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"6cfd2378-16aa-4971-93d6-409a1d72e941":{"role":"reader","value":{"id":"6cfd2378-16aa-4971-93d6-409a1d72e941","version":332,"type":"text","properties":{"title":[["解决方案是缩小加锁的范围，只在对临界区的值进行修改的时候才加锁"]]},"created_time":1677586219769,"last_edited_time":1677586256695,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"05126ba2-4ec4-4fc7-95da-075532c368a1":{"role":"reader","value":{"id":"05126ba2-4ec4-4fc7-95da-075532c368a1","version":7,"type":"code","properties":{"title":[["func (c *Customer) UpdateAge2(age int) error {\n\tif age \u003c 0 {\n\t\treturn fmt.Errorf(\"age should be positive for customer %v\", c)\n\t}\n\n\tc.mutex.Lock()\n\tdefer c.mutex.Unlock()\n\n\tc.age = age\n\treturn nil\n}"]],"language":[["Go"]]},"created_time":1677586264761,"last_edited_time":1677586277297,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a48e9d53-4a7b-4ccd-98c6-63a6fa09431b":{"role":"reader","value":{"id":"a48e9d53-4a7b-4ccd-98c6-63a6fa09431b","version":108,"type":"sub_sub_header","properties":{"title":[["9.9 #69: Creating data races with append（使用append函数的时候出现data race）"]]},"created_time":1677586289212,"last_edited_time":1677587250117,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"453398a1-1f7d-4d7f-a1a2-e55388f769ed":{"role":"reader","value":{"id":"453398a1-1f7d-4d7f-a1a2-e55388f769ed","version":113,"type":"bulleted_list","properties":{"title":[["注意append操作不是线程安全的"]]},"created_time":1677587217908,"last_edited_time":1677587234617,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"afeef38e-58d1-41e4-90fb-9eb2c37f6023":{"role":"reader","value":{"id":"afeef38e-58d1-41e4-90fb-9eb2c37f6023","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbjh3fld7pj31eg0n6n7d.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbjh3fld7pj31eg0n6n7d.jpg"},"created_time":1677587135650,"last_edited_time":1677587146764,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0ffe02a2-7a29-4bee-80cb-975ea1a74581":{"role":"reader","value":{"id":"0ffe02a2-7a29-4bee-80cb-975ea1a74581","version":143,"type":"sub_sub_header","properties":{"title":[["9.10 #70: Using mutexes inaccurately with slices and maps（错误的给slice和map加锁）"]]},"created_time":1677587292072,"last_edited_time":1677588457576,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"88f060bd-7d3f-4788-ba4e-bfbc76dab641":{"role":"reader","value":{"id":"88f060bd-7d3f-4788-ba4e-bfbc76dab641","version":379,"type":"text","properties":{"title":[["当有2个协程同事调用 AddBalance 和 AverageBalance，还会出现data race，因为 AverageBalance 中对 c.balances 只拷贝引用，对slice同理。"]]},"created_time":1677588471645,"last_edited_time":1677588664006,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f02802f2-ac92-45b2-9e34-8249cc28f83c":{"role":"reader","value":{"id":"f02802f2-ac92-45b2-9e34-8249cc28f83c","version":9,"type":"code","properties":{"title":[["type Cache struct {\n\tmu       sync.RWMutex\n\tbalances map[string]float64\n}\n\nfunc (c *Cache) AddBalance(id string, balance float64) {\n\tc.mu.Lock()\n\tc.balances[id] = balance\n\tc.mu.Unlock()\n}\n\nfunc (c *Cache) AverageBalance() float64 {\n\tc.mu.RLock()\n\tbalances := c.balances\n\tc.mu.RUnlock()\n\n\tsum := 0.\n\tfor _, balance := range balances {\n\t\tsum += balance\n\t}\n\treturn sum / float64(len(balances))\n}"]],"language":[["Go"]]},"created_time":1677588429369,"last_edited_time":1677588484729,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"beeca050-1653-4a87-b160-10addf066c52":{"role":"reader","value":{"id":"beeca050-1653-4a87-b160-10addf066c52","version":73,"type":"sub_sub_header","properties":{"title":[["9.11 #71: Misusing sync.WaitGroup（错误使用 sync.WaitGroup）"]]},"created_time":1677588675323,"last_edited_time":1677588691782,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f77b15bb-406e-4855-b5ef-24046fc192d3":{"role":"reader","value":{"id":"f77b15bb-406e-4855-b5ef-24046fc192d3","version":481,"type":"text","properties":{"title":[["因为 for 循环创建的3个协程是异步执行，可能执行到wg.Wait的时候有2个协程已经执行成功并退出了，所以v的值可能为2"]]},"created_time":1677588837747,"last_edited_time":1677588903263,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"96d2f9c4-34eb-4e34-bb63-49498741c591":{"role":"reader","value":{"id":"96d2f9c4-34eb-4e34-bb63-49498741c591","version":16,"type":"code","properties":{"title":[["func main() {\n\twg := sync.WaitGroup{}\n\tvar v uint64\n\n\tfor i := 0; i \u003c 3; i++ {\n\t\tgo func() {\n\t\t\twg.Add(1)\n\t\t\tatomic.AddUint64(\u0026v, 1)\n\t\t\twg.Done()\n\t\t}()\n\t}\n\n\twg.Wait()\n\tfmt.Println(v)\n}"]],"language":[["Go"]]},"created_time":1677588834994,"last_edited_time":1677588841705,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8d247983-4f18-442d-a7c4-b6bbb17290c7":{"role":"reader","value":{"id":"8d247983-4f18-442d-a7c4-b6bbb17290c7","version":76,"type":"text","properties":{"title":[["解决方案一"]]},"created_time":1677588917705,"last_edited_time":1677588941291,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1246aa68-9cc7-4a6e-a08c-52954f88c4ff":{"role":"reader","value":{"id":"1246aa68-9cc7-4a6e-a08c-52954f88c4ff","version":16,"type":"code","properties":{"title":[["func main() {\n\twg := sync.WaitGroup{}\n\tvar v uint64\n\n\twg.Add(3)\n\tfor i := 0; i \u003c 3; i++ {\n\t\tgo func() {\n\t\t\tatomic.AddUint64(\u0026v, 1)\n\t\t\twg.Done()\n\t\t}()\n\t}\n\n\twg.Wait()\n\tfmt.Println(v)\n}"]],"language":[["Go"]]},"created_time":1677588927865,"last_edited_time":1677588931024,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"6c29ce3f-4eed-49b5-93c8-58df7a2a7e2b":{"role":"reader","value":{"id":"6c29ce3f-4eed-49b5-93c8-58df7a2a7e2b","version":37,"type":"text","properties":{"title":[["解决方案二"]]},"created_time":1677588942483,"last_edited_time":1677588945454,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cd5ee62f-517b-47ff-9a8c-8225dda1402b":{"role":"reader","value":{"id":"cd5ee62f-517b-47ff-9a8c-8225dda1402b","version":16,"type":"code","properties":{"title":[["func main() {\n\twg := sync.WaitGroup{}\n\tvar v uint64\n\n\tfor i := 0; i \u003c 3; i++ {\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tatomic.AddUint64(\u0026v, 1)\n\t\t\twg.Done()\n\t\t}()\n\t}\n\n\twg.Wait()\n\tfmt.Println(v)\n}"]],"language":[["Go"]]},"created_time":1677588950128,"last_edited_time":1677588954446,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"21c7ccf6-a336-4bb6-bcfa-675201e730b7":{"role":"reader","value":{"id":"21c7ccf6-a336-4bb6-bcfa-675201e730b7","version":156,"type":"sub_sub_header","properties":{"title":[["9.12 #72: Forgetting about sync.Cond（别忘记条件变量sync.Cond）"]]},"created_time":1677588963802,"last_edited_time":1677589298529,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b2f26809-9764-4f19-a034-22447742004b":{"role":"reader","value":{"id":"b2f26809-9764-4f19-a034-22447742004b","version":12,"type":"bookmark","properties":{"link":[["https://geektutu.com/post/hpg-sync-cond.html"]],"title":[["Go sync.Cond | Go 语言高性能编程 | 极客兔兔"]],"description":[["Go 语言/golang 高性能编程，Go 语言进阶教程，Go 语言高性能编程(high performance go)。sync.Cond 是一个条件锁，也被称为条件变量，常用来一写多读(一个 goroutine 通知多个在等待的 goroutines)的场景。"]]},"format":{"bookmark_icon":"https://geektutu.com/img/icon.png"},"created_time":1677589948088,"last_edited_time":1677589951099,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"27550b2d-9cb9-4723-ab32-e19460bbdaf3":{"role":"reader","value":{"id":"27550b2d-9cb9-4723-ab32-e19460bbdaf3","version":18,"type":"code","properties":{"title":[["func main() {\n\ttype Donation struct {\n\t\tcond    *sync.Cond\n\t\tbalance int\n\t}\n\n\tdonation := \u0026Donation{\n\t\tcond: sync.NewCond(\u0026sync.Mutex{}),\n\t}\n\n\t// Listener goroutines\n\tf := func(goal int) {\n\t\tdonation.cond.L.Lock()\n\t\tfor donation.balance \u003c goal {\n\t\t\tdonation.cond.Wait()\n\t\t}\n\t\tfmt.Printf(\"%d$ goal reached\\n\", donation.balance)\n\t\tdonation.cond.L.Unlock()\n\t}\n\n\tgo f(10)\n\tgo f(15)\n\n\t// Updater goroutine\n\tfor {\n\t\ttime.Sleep(time.Second)\n\t\tdonation.cond.L.Lock()\n\t\tdonation.balance++\n\t\tdonation.cond.L.Unlock()\n\t\tdonation.cond.Broadcast()\n\t}\n}"]],"language":[["Go"]]},"created_time":1677589635249,"last_edited_time":1677589766952,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1403eaf6-6acf-49a0-a0bf-63b7110b08c8":{"role":"reader","value":{"id":"1403eaf6-6acf-49a0-a0bf-63b7110b08c8","version":105,"type":"text","properties":{"title":[["使用Cond可以避免CPU空转的情况。"]]},"created_time":1677589733364,"last_edited_time":1677589996924,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"05073c8f-5ad7-409a-a745-19510ffa810a":{"role":"reader","value":{"id":"05073c8f-5ad7-409a-a745-19510ffa810a","version":143,"type":"sub_sub_header","properties":{"title":[["9.13 #73: Not using errgroup（使用 errgroup 采集多个协程执行结果）"]]},"created_time":1677590004183,"last_edited_time":1677590120396,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2ae63cfd-1c6e-4115-95d8-8c9cdad6ed48":{"role":"reader","value":{"id":"2ae63cfd-1c6e-4115-95d8-8c9cdad6ed48","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbjiirbgghj31f60hywhb.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbjiirbgghj31f60hywhb.jpg"},"created_time":1677590095233,"last_edited_time":1677590098427,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"57ce497e-3cf8-49bc-b7d8-0b07f519d22f":{"role":"reader","value":{"id":"57ce497e-3cf8-49bc-b7d8-0b07f519d22f","version":375,"type":"text","properties":{"title":[["使用 "],["golang.org/x/sync/errgroup",[["a","http://golang.org/x/sync/errgroup"]]],[" 采集多个协程的错误, 但是 errorgroup限制比较多，需要函数签名符合"],["func() error {}",[["c"]]],[" "]]},"created_time":1677590258919,"last_edited_time":1677590862217,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f399ca3f-f7da-4e33-897a-2bec1ce11812":{"role":"reader","value":{"id":"f399ca3f-f7da-4e33-897a-2bec1ce11812","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbjiqad262j31aq0rsaib.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbjiqad262j31aq0rsaib.jpg"},"created_time":1677590528818,"last_edited_time":1677590531589,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"13051c2f-d259-4003-8708-bd92d9da1e65":{"role":"reader","value":{"id":"13051c2f-d259-4003-8708-bd92d9da1e65","version":15,"type":"text","properties":{"title":[["k8s 中提供了集合多种错误的功能，可以参考 k8s.io/apimachinery/pkg/util/errors/errors.go:35"]]},"created_time":1677590863928,"last_edited_time":1677590864462,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"025990b7-1780-448e-bddb-c41d3b01a39d":{"role":"reader","value":{"id":"025990b7-1780-448e-bddb-c41d3b01a39d","version":133,"type":"sub_sub_header","properties":{"title":[["9.14 #74: Copying a sync type（同步类型的值不能被拷贝）"]]},"created_time":1677590673494,"last_edited_time":1677591145654,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ab42b85c-e154-496c-89b6-fe46d0422f90":{"role":"reader","value":{"id":"ab42b85c-e154-496c-89b6-fe46d0422f90","version":12,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbjj0adk20j31200i2q9f.jpg"]]},"format":{"block_width":528,"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbjj0adk20j31200i2q9f.jpg","block_full_width":false,"block_page_width":false},"created_time":1677591105009,"last_edited_time":1677591118548,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1ff65c47-6e07-4394-8707-313437896372":{"role":"reader","value":{"id":"1ff65c47-6e07-4394-8707-313437896372","version":109,"type":"text","properties":{"title":[["以下类型均不能被拷贝"]]},"created_time":1677595497160,"last_edited_time":1677595530487,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"848371a5-c992-41a2-9f86-6ef4658c51f8":{"role":"reader","value":{"id":"848371a5-c992-41a2-9f86-6ef4658c51f8","version":42,"type":"bulleted_list","properties":{"title":[["sync.Cond"]]},"created_time":1677595447352,"last_edited_time":1677595499175,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"84ae3f8e-908e-4bbb-bf8a-e86a3da41474":{"role":"reader","value":{"id":"84ae3f8e-908e-4bbb-bf8a-e86a3da41474","version":10,"type":"bulleted_list","properties":{"title":[["sync.Map"]]},"created_time":1677595499172,"last_edited_time":1677595500890,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9f4045fb-444c-40d3-b7f8-2b06b9cefbca":{"role":"reader","value":{"id":"9f4045fb-444c-40d3-b7f8-2b06b9cefbca","version":10,"type":"bulleted_list","properties":{"title":[["sync.Mutex"]]},"created_time":1677595500889,"last_edited_time":1677595502117,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c7621cb3-721b-46ef-befd-ddfb3b44cc0b":{"role":"reader","value":{"id":"c7621cb3-721b-46ef-befd-ddfb3b44cc0b","version":5,"type":"bulleted_list","properties":{"title":[["sync.RWMutex "]]},"created_time":1677595502114,"last_edited_time":1677595502117,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ef69e218-a8c8-4af2-89d3-ca12b0e3439f":{"role":"reader","value":{"id":"ef69e218-a8c8-4af2-89d3-ca12b0e3439f","version":16,"type":"bulleted_list","properties":{"title":[["sync.Once"]]},"created_time":1677595482924,"last_edited_time":1677595504284,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cd32d9b8-e8d4-4528-9e87-5d90015e01ed":{"role":"reader","value":{"id":"cd32d9b8-e8d4-4528-9e87-5d90015e01ed","version":10,"type":"bulleted_list","properties":{"title":[["sync.Pool"]]},"created_time":1677595504281,"last_edited_time":1677595505587,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"288b1883-4bb5-43fe-82a9-9d9be770b80d":{"role":"reader","value":{"id":"288b1883-4bb5-43fe-82a9-9d9be770b80d","version":5,"type":"bulleted_list","properties":{"title":[["sync.WaitGroup"]]},"created_time":1677595505584,"last_edited_time":1677595505587,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9f15a4b7-1af7-4561-a178-be3549245a31":{"role":"reader","value":{"id":"9f15a4b7-1af7-4561-a178-be3549245a31","version":15,"type":"sub_header","properties":{"title":[["10 The standard library"]]},"created_time":1677632531416,"last_edited_time":1677632545936,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7047667f-245f-4699-81a1-116b2ea7da39":{"role":"reader","value":{"id":"7047667f-245f-4699-81a1-116b2ea7da39","version":142,"type":"sub_sub_header","properties":{"title":[["10.1 #75: Providing a wrong time duration（记住标准库的时间单位）"]]},"created_time":1677675294836,"last_edited_time":1677675354396,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"06912f42-ff0d-4a18-9e51-94e03629e89f":{"role":"reader","value":{"id":"06912f42-ff0d-4a18-9e51-94e03629e89f","version":206,"type":"bulleted_list","properties":{"title":[["设置时间的时候还是建议使用time.Duration类型，不要直接用数字"]]},"created_time":1677675360602,"last_edited_time":1677675442050,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"842f3802-89ed-42ee-8da5-c3dbed8595d0":{"role":"reader","value":{"id":"842f3802-89ed-42ee-8da5-c3dbed8595d0","version":12,"type":"code","properties":{"title":[["func listing1() {\n\tticker := time.NewTicker(1000)\n\tfor {\n\t\tselect {\n\t\tcase \u003c-ticker.C:\n\t\t\tfmt.Println(\"tick\")\n\t\t}\n\t}\n}\n\nfunc listing2() {\n\tticker := time.NewTicker(time.Microsecond)\n\tfor {\n\t\tselect {\n\t\tcase \u003c-ticker.C:\n\t\t\tfmt.Println(\"tick\")\n\t\t}\n\t}\n}"]],"language":[["Go"]]},"created_time":1677675326580,"last_edited_time":1677675352359,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"84aab02c-2114-40de-bf63-aacf4441ece8":{"role":"reader","value":{"id":"84aab02c-2114-40de-bf63-aacf4441ece8","version":126,"type":"sub_sub_header","properties":{"title":[["10.2 #76: time.After and memory leaks （使用 time.After 可能会导致内存溢出）"]]},"created_time":1677675471480,"last_edited_time":1677675490688,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b20ff457-f8d2-4347-8100-1d5580ddaff7":{"role":"reader","value":{"id":"b20ff457-f8d2-4347-8100-1d5580ddaff7","version":413,"type":"text","properties":{"title":[["每次调用 "],["time.After",[["c"]]],[" 时使用大约200字节的内存。但是只有在指定的时间到达的时候才会GC，如果在1小时内，频繁的调用 "],["time.After",[["c"]]],[" 会导致内存爆炸。"]]},"created_time":1677675522953,"last_edited_time":1677675660216,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"bf473240-1a67-4da5-9cb7-94dd3268251a":{"role":"reader","value":{"id":"bf473240-1a67-4da5-9cb7-94dd3268251a","version":301,"type":"code","properties":{"title":[["func consumer1(ch \u003c-chan Event) {\n\tfor {\n\t\tselect {\n\t\tcase event := \u003c-ch:\n\t\t\thandle(event)\n\t\tcase \u003c-time.After(time.Hour):\n\t\t\tlog.Println(\"warning: no messages received\")\n\t\t}\n\t}\n}\n\n// 解决方案一\nfunc consumer2(ch \u003c-chan Event) {\n\tfor {\n\t\tctx, cancel := context.WithTimeout(context.Background(), time.Hour)\n\t\tselect {\n\t\tcase event := \u003c-ch:\n\t\t\tcancel()\n\t\t\thandle(event)\n\t\tcase \u003c-ctx.Done():\n\t\t\tlog.Println(\"warning: no messages received\")\n\t\t}\n\t}\n}\n\n// 解决方案二，创建一次 Timer 每次循环都会重置时间\nfunc consumer3(ch \u003c-chan Event) {\n\ttimerDuration := 1 * time.Hour\n\ttimer := time.NewTimer(timerDuration)\n\n\tfor {\n\t\ttimer.Reset(timerDuration)\n\t\tselect {\n\t\tcase event := \u003c-ch:\n\t\t\thandle(event)\n\t\tcase \u003c-timer.C:\n\t\t\tlog.Println(\"warning: no messages received\")\n\t\t}\n\t}\n}"]],"language":[["Go"]]},"created_time":1677675520414,"last_edited_time":1677675733521,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"06e85100-6112-4599-9f64-7b2d5a2a6756":{"role":"reader","value":{"id":"06e85100-6112-4599-9f64-7b2d5a2a6756","version":85,"type":"sub_sub_header","properties":{"title":[["10.3 #77: Common JSON-handling mistakes（常见的 JSON 处理错误）"]]},"created_time":1677632560750,"last_edited_time":1677675986910,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"fd82c821-b590-41d9-b667-2bafa3db1cd0":{"role":"reader","value":{"id":"fd82c821-b590-41d9-b667-2bafa3db1cd0","version":12,"type":"bookmark","properties":{"link":[["https://zhuanlan.zhihu.com/p/53125839"]],"title":[["go json 实践中遇到的坑"]],"description":[["在使用 go 语言开发过程中，经常需要使用到 json 包来进行 json 和 struct 的互相转换，在使用过程中，遇到了一些需要额外注意的地方，记录如下。 整数变浮点数问题假设有一个 Person 结构，其中包含 Age int64 和…"]]},"format":{"bookmark_icon":"https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.81060cab.png","bookmark_cover":"https://pic1.zhimg.com/v2-9281b3e47858daa5e9086f0a0047d116_720w.jpg?source=172ae18b"},"created_time":1677677267662,"last_edited_time":1677677270669,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"caa56b20-195d-42d5-be46-41236961ea50":{"role":"reader","value":{"id":"caa56b20-195d-42d5-be46-41236961ea50","version":21,"type":"text","properties":{"title":[["Unexpected behavior due to type embedding",[["b"]]]]},"created_time":1677675745133,"last_edited_time":1677675767236,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"6ac96acb-1077-472f-8767-c40e4127ef23":{"role":"reader","value":{"id":"6ac96acb-1077-472f-8767-c40e4127ef23","version":224,"type":"text","properties":{"title":[["如果类型实现了 "],["Marshaler",[["c"]]],[" 接口，在调用 "],["json.Marshal",[["c"]]],[" 的时候，会直接调用 "],["MarshalJSON",[["c"]]],[" 方法。"]]},"created_time":1677675910559,"last_edited_time":1677675969885,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"69323788-37f1-4eaf-a9fe-1f4cc6d07612":{"role":"reader","value":{"id":"69323788-37f1-4eaf-a9fe-1f4cc6d07612","version":11,"type":"code","properties":{"title":[["type Marshaler interface {\n    MarshalJSON() ([]byte, error)\n}"]],"language":[["Go"]]},"created_time":1677675908333,"last_edited_time":1677675941358,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5d20410d-a2b5-4985-89f0-fabd1fe4c41f":{"role":"reader","value":{"id":"5d20410d-a2b5-4985-89f0-fabd1fe4c41f","version":782,"type":"code","properties":{"title":[["// Event1 内嵌了 time.Time 类型，会自动实现 time.Time 的所有方法\n// time.Time 实现了 Marshaler 接口，所以 Marshal Event1 的时候会直接调用\n// time.Time 的 MarshalJSON 方法\ntype Event1 struct {\n\tID int\n\ttime.Time\n}\n\nfunc listing1() error {\n\tevent := Event1{\n\t\tID:   1234,\n\t\tTime: time.Now(),\n\t}\n\n\tb, err := json.Marshal(event)\n\tif err != nil {\n\t\treturn err\n\t}\n\t// \"2021-05-18T21:15:08.381652+02:00\"\n\tfmt.Println(string(b))\n\treturn nil\n}\n\n// 解决方案一：不使用内嵌类型，给 time.Time 定义一个成员名字 \ntype Event2 struct {\n\tID   int\n\tTime time.Time\n}\n\nfunc listing2() error {\n\tevent := Event2{\n\t\tID:   1234,\n\t\tTime: time.Now(),\n\t}\n\n\tb, err := json.Marshal(event)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfmt.Println(string(b))\n\treturn nil\n}\n\ntype Event3 struct {\n\tID int\n\ttime.Time\n}\n\n// 解决方案二：给 Event 类型实现 MarshalJSON 方法\nfunc (e Event3) MarshalJSON() ([]byte, error) {\n\treturn json.Marshal(\n\t\tstruct {\n\t\t\tID   int\n\t\t\tTime time.Time\n\t\t}{\n\t\t\tID:   e.ID,\n\t\t\tTime: e.Time,\n\t\t},\n\t)\n}\n\nfunc listing3() error {\n\tevent := Event3{\n\t\tID:   1234,\n\t\tTime: time.Now(),\n\t}\n\n\tb, err := json.Marshal(event)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfmt.Println(string(b))\n\treturn nil\n}"]],"language":[["Go"]]},"created_time":1677675798878,"last_edited_time":1677676124097,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"76b3e79a-509f-4278-8fae-4c52782e49e8":{"role":"reader","value":{"id":"76b3e79a-509f-4278-8fae-4c52782e49e8","version":26,"type":"text","properties":{"title":[["JSON and the monotonic clock",[["b"]]]]},"created_time":1677676139651,"last_edited_time":1677676144965,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"63d79e70-12a2-432e-ab71-df3357377542":{"role":"reader","value":{"id":"63d79e70-12a2-432e-ab71-df3357377542","version":12,"type":"bookmark","properties":{"link":[["https://zhuanlan.zhihu.com/p/47754783"]],"title":[["理解Golang的Time结构"]],"description":[["在golang中创建并打印一个时间对象，会看到如下输出 2018-10-26 14:15:50.306558969 +0800 CST m=+0.000401093前面表示的意义好理解，分别是年月日和时间时区，最后的m=+xxxx这部分代表什么呢？ Monotonic Clocks …"]]},"format":{"bookmark_icon":"https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.81060cab.png","bookmark_cover":"https://picx.zhimg.com/v2-fae5dcfcf8827c6066d51f9b12cd9864_720w.jpg?source=172ae18b"},"created_time":1677676358634,"last_edited_time":1677676361644,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5eb1d5cd-c1e5-43c5-b30e-cb6801de0f82":{"role":"reader","value":{"id":"5eb1d5cd-c1e5-43c5-b30e-cb6801de0f82","version":7,"type":"code","properties":{"title":[["now := time.Now()\nencodeNow, _ := json.Marshal(now)\n\ndecodeNow := time.Time{}\njson.Unmarshal(encodeNow, \u0026decodeNow)\n\nfmt.Println(now)  // 2018-10-26 16:04:55.230121766 +0800 CST m=+0.000520419\nfmt.Println(decodeNow)  // 2018-10-26 16:04:55.230121766 +0800 CST"]],"language":[["Go"]]},"created_time":1677676813238,"last_edited_time":1677676813511,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1ab793b7-47f2-4b88-8cfe-e949b9e75b22":{"role":"reader","value":{"id":"1ab793b7-47f2-4b88-8cfe-e949b9e75b22","version":8,"type":"text","properties":{"title":[["可以看到，经过JSON转码之后，Time结构体会被表示成不带Monotonic Clock的字符串，丢失了Monotonic Clock信息，而将字符串转码回Time结构时，自然也就和转码之前的不一样了。同样的情况，也发生在数据库存储中，存储到数据库里的Time结构和从数据库取出来的也是不一样的。"]]},"created_time":1677676818556,"last_edited_time":1677676847585,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"83e82805-2dc9-4e53-8f3e-51e440cfd9c8":{"role":"reader","value":{"id":"83e82805-2dc9-4e53-8f3e-51e440cfd9c8","version":250,"type":"bulleted_list","properties":{"title":[["可以使用 Time.Equal() 对比时间是否相关，这里判断相等不会包含单调时间"]]},"created_time":1677676901820,"last_edited_time":1677676974977,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"237e8057-b4ac-4260-b71c-491d34183dd0":{"role":"reader","value":{"id":"237e8057-b4ac-4260-b71c-491d34183dd0","version":179,"type":"bulleted_list","properties":{"title":[["使用 Time.Truncate() 函数排除单调时钟"]]},"content":["c344609f-bc31-4c18-bd1f-862c52a36993"],"created_time":1677676979030,"last_edited_time":1677677168206,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1bf3fec0-d8ab-4d12-a2f1-027252ced749":{"role":"reader","value":{"id":"1bf3fec0-d8ab-4d12-a2f1-027252ced749","version":28,"type":"text","properties":{"title":[["Map of any",[["b"]]]]},"created_time":1677677222396,"last_edited_time":1677677325300,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"59593fcb-288e-4cea-9fe7-f19c4dd41452":{"role":"reader","value":{"id":"59593fcb-288e-4cea-9fe7-f19c4dd41452","version":313,"type":"text","properties":{"title":[["当把json解析到 "],["map[string]any",[["c"]]],[" 类型，会出现数字类型解析错误的情况"]]},"created_time":1677677327714,"last_edited_time":1677677492819,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e627e05c-94e5-4f31-b9e6-0f02d3d98925":{"role":"reader","value":{"id":"e627e05c-94e5-4f31-b9e6-0f02d3d98925","version":272,"type":"code","properties":{"title":[["func listing1() error {\n\tb := getMessage()\n\tvar m map[string]any\n\terr := json.Unmarshal(b, \u0026m)\n\tif err != nil {\n\t\treturn err\n\t}\n\treturn nil\n}\n\nfunc getMessage() []byte {\n\treturn nil\n}\n\n// getMessage 函数返回如下json，解析后 id 类型为 float64\n// {\n//   \"id\": 32,\n//   \"name\": \"foo\"\n// }"]],"language":[["Go"]]},"created_time":1677677297244,"last_edited_time":1677677556572,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8994b063-6c97-4a75-be86-d6328532d3e3":{"role":"reader","value":{"id":"8994b063-6c97-4a75-be86-d6328532d3e3","version":72,"type":"text","properties":{"title":[["解决方案: "],["使用 json.Decoder 来代替 json.Unmarshal 方法",[["b"]]]]},"created_time":1677677500164,"last_edited_time":1677677779603,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2253ef49-7c5e-4350-ad44-df3c54253062":{"role":"reader","value":{"id":"2253ef49-7c5e-4350-ad44-df3c54253062","version":14,"type":"code","properties":{"title":[["decoder := json.NewDecoder(bytes.NewReader(getMessage()))\ndecoder.UseNumber()\nvar m map[string]any\ndecoder.Decode(\u0026personFromJSON)"]],"language":[["Go"]]},"created_time":1677677565681,"last_edited_time":1677677659624,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"23cbab1f-00d4-4562-acc0-38eb0146e4ae":{"role":"reader","value":{"id":"23cbab1f-00d4-4562-acc0-38eb0146e4ae","version":8,"type":"text","properties":{"title":[["这种方法首先创建了一个 jsonDecoder，然后调用了 UseNumber 方法，从文档中可以知道，使用 UseNumber 方法后，json 包会将数字转换成一个内置的 Number 类型（而不是 float64），这个 Number 类型提供了转换为 int64、float64 等多个方法。"]]},"created_time":1677677672468,"last_edited_time":1677677673040,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3d60e22e-c861-4743-b0f2-5122fb36b1b5":{"role":"reader","value":{"id":"3d60e22e-c861-4743-b0f2-5122fb36b1b5","version":55,"type":"sub_sub_header","properties":{"title":[["10.4 #78: Common SQL mistakes（常见的 SQL 错误）"]]},"created_time":1677632720408,"last_edited_time":1677677796774,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d92c6e0a-7a31-476f-824e-c473518b420b":{"role":"reader","value":{"id":"d92c6e0a-7a31-476f-824e-c473518b420b","version":13,"type":"text","properties":{"title":[["Forgetting that sql.Open doesn’t necessarily establish connections to a database",[["b"]]]]},"created_time":1677677808114,"last_edited_time":1677677829320,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"89681485-b930-408b-a8fc-c7469d8471f6":{"role":"reader","value":{"id":"89681485-b930-408b-a8fc-c7469d8471f6","version":43,"type":"callout","properties":{"title":[["sql.Open 可能只是验证其参数而不创建与数据库的连接"]]},"format":{"page_icon":"💡","block_color":"gray_background"},"created_time":1677677830741,"last_edited_time":1677677932165,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"05b5f033-ec4d-461d-af1d-7cefb91b7c53":{"role":"reader","value":{"id":"05b5f033-ec4d-461d-af1d-7cefb91b7c53","version":144,"type":"text","properties":{"title":[["如果我们要确保使用 sql.Open 的函数也保证底层数据库可访问，我们应该使用Ping方法："]]},"created_time":1677677934693,"last_edited_time":1677678005941,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8fc4ebe2-98d1-4cff-b42c-ca0dc1c4abe1":{"role":"reader","value":{"id":"8fc4ebe2-98d1-4cff-b42c-ca0dc1c4abe1","version":21,"type":"code","properties":{"title":[["func listing1() error {\n\tdb, err := sql.Open(\"mysql\", dsn)\n\tif err != nil {\n\t\treturn err\n\t}\n\t// ping强制建立连接，确保数据源名称有效并且数据库可访问\n\tif err := db.Ping(); err != nil {\n\t\treturn err\n\t}\n\n\t_ = db\n\treturn nil\n}"]],"language":[["Go"]]},"created_time":1677677959355,"last_edited_time":1677678037118,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4a96c111-f2e2-4de5-b271-e8953499d5ed":{"role":"reader","value":{"id":"4a96c111-f2e2-4de5-b271-e8953499d5ed","version":10,"type":"text","properties":{"title":[["Forgetting about connections pooling",[["b"]]]]},"created_time":1677678054495,"last_edited_time":1677678059242,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ba4e2bf8-3505-4edd-9beb-13c54ae119fd":{"role":"reader","value":{"id":"ba4e2bf8-3505-4edd-9beb-13c54ae119fd","version":9,"type":"text","properties":{"title":[["sql.Open 返回一个sql.DB结构。这个结构不表示单个数据库连接，而是表示连接池。"]]},"created_time":1677678060257,"last_edited_time":1677678107492,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"58d13e73-6cf2-4dba-8424-eed3c75e4218":{"role":"reader","value":{"id":"58d13e73-6cf2-4dba-8424-eed3c75e4218","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbkoxg0061j31a40cmwj2.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbkoxg0061j31a40cmwj2.jpg"},"created_time":1677678131166,"last_edited_time":1677678133684,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0d6a2f6f-0775-42c5-b8fb-7c2049a372d6":{"role":"reader","value":{"id":"0d6a2f6f-0775-42c5-b8fb-7c2049a372d6","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbkoxuh1sij319c0ccjx3.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbkoxuh1sij319c0ccjx3.jpg"},"created_time":1677678153843,"last_edited_time":1677678156147,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"47dd299a-bfba-4c69-bc7e-fc3e48f91eef":{"role":"reader","value":{"id":"47dd299a-bfba-4c69-bc7e-fc3e48f91eef","version":10,"type":"text","properties":{"title":[["Not using prepared statements",[["b"]]]]},"created_time":1677678167099,"last_edited_time":1677678172427,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"6ae4a931-1fac-44ad-afcc-226175df6950":{"role":"reader","value":{"id":"6ae4a931-1fac-44ad-afcc-226175df6950","version":12,"type":"bookmark","properties":{"link":[["https://manjusaka.itscoder.com/posts/2020/01/05/simple-introdution-about-sql-prepared/"]],"title":[["简单聊聊 SQL 中的 Prepared Statements"]],"description":[["好久没写文章了，新年还是得写点技术水文来保证下状态，正好最近遇到一个比较有意思的问题，就来简单聊聊一下关于 MySQL 中 Prepared Statements 吧"]]},"format":{"bookmark_icon":"https://user-images.githubusercontent.com/7054676/56820343-2fe1b580-687e-11e9-8f6f-778df3a8eafd.png","bookmark_cover":"https://manjusaka.blog/img/og_image.png"},"created_time":1677678570794,"last_edited_time":1677678573802,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"73e7182c-1f92-409f-b1fe-fc6fd4155379":{"role":"reader","value":{"id":"73e7182c-1f92-409f-b1fe-fc6fd4155379","version":125,"type":"text","properties":{"title":[["使用 Prepare 方法创建 "],["prepared statements ",[["b"]]],["，提升查询性能，避免重复解析 SQL 带来的开销"]]},"created_time":1677678173495,"last_edited_time":1677678942950,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"785be981-30e9-4f40-bdd4-2f382c460fff":{"role":"reader","value":{"id":"785be981-30e9-4f40-bdd4-2f382c460fff","version":7,"type":"code","properties":{"title":[["func listing1(db *sql.DB, id string) error {\n\tstmt, err := db.Prepare(\"SELECT * FROM ORDER WHERE ID = ?\")\n\tif err != nil {\n\t\treturn err\n\t}\n\trows, err := stmt.Query(id)\n\tif err != nil {\n\t\treturn err\n\t}\n\t_ = rows\n\treturn nil\n}"]],"language":[["Go"]]},"created_time":1677678660891,"last_edited_time":1677678661176,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"89a58d1f-960a-4f8c-ae84-dbebf0e1c1f9":{"role":"reader","value":{"id":"89a58d1f-960a-4f8c-ae84-dbebf0e1c1f9","version":4,"type":"text","properties":{"title":[["Mishandling null values",[["b"]]]]},"created_time":1677678173495,"last_edited_time":1677678666138,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cf2f40df-00ce-4774-a384-985d1a8a1bfa":{"role":"reader","value":{"id":"cf2f40df-00ce-4774-a384-985d1a8a1bfa","version":248,"type":"code","properties":{"title":[["func listing3(db *sql.DB, id string) error {\n\trows, err := db.Query(\"SELECT DEP, AGE FROM EMP WHERE ID = ?\", id)\n\tif err != nil {\n\t\treturn err\n\t}\n\t// Defer closing rows\n\n\tvar (\n\t\t// 使用 ql.NullString 类型，可以匹配在查询遇到NULL值的情况\n\t\tdepartment sql.NullString\n\t\tage        int\n\t)\n\tfor rows.Next() {\n\t\terr := rows.Scan(\u0026department, \u0026age)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\t// ...\n\t}\n\treturn nil\n}"]],"language":[["Go"]]},"created_time":1677679113081,"last_edited_time":1677679186529,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d9d3392d-d431-4aa0-97e0-444be8eed06a":{"role":"reader","value":{"id":"d9d3392d-d431-4aa0-97e0-444be8eed06a","version":9,"type":"text","properties":{"title":[["Not handling row iteration errors",[["b"]]]]},"created_time":1677678252096,"last_edited_time":1677678259652,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f39c82b9-724d-425f-8f0d-22f2946f1e64":{"role":"reader","value":{"id":"f39c82b9-724d-425f-8f0d-22f2946f1e64","version":389,"type":"text","properties":{"title":[["for rows .Next() {}",[["c"]]],["  循环可能会因为没有查询到值或者遇到错误退出，所以退出后要调用 "],["rows.Err()",[["c"]]],[" 看是否是正常退出"]]},"created_time":1677679348395,"last_edited_time":1677679423667,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1dbafafd-0f92-413e-b75e-dacadb91f58c":{"role":"reader","value":{"id":"1dbafafd-0f92-413e-b75e-dacadb91f58c","version":7,"type":"code","properties":{"title":[["func get2(ctx context.Context, db *sql.DB, id string) (string, int, error) {\n\trows, err := db.QueryContext(ctx,\n\t\t\"SELECT DEP, AGE FROM EMP WHERE ID = ?\", id)\n\tif err != nil {\n\t\treturn \"\", 0, err\n\t}\n\tdefer func() {\n\t\terr := rows.Close()\n\t\tif err != nil {\n\t\t\tlog.Printf(\"failed to close rows: %v\\n\", err)\n\t\t}\n\t}()\n\n\tvar (\n\t\tdepartment string\n\t\tage        int\n\t)\n\tfor rows.Next() {\n\t\terr := rows.Scan(\u0026department, \u0026age)\n\t\tif err != nil {\n\t\t\treturn \"\", 0, err\n\t\t}\n\t}\n\tif err := rows.Err(); err != nil {\n\t\treturn \"\", 0, err\n\t}\n\n\treturn department, age, nil\n}"]],"language":[["Go"]]},"created_time":1677679336524,"last_edited_time":1677679336906,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8ea8463d-42a6-4b52-b906-8b92b1d06e85":{"role":"reader","value":{"id":"8ea8463d-42a6-4b52-b906-8b92b1d06e85","version":4,"type":"sub_sub_header","properties":{"title":[["10.5 #79: Not closing transient resources（没有及时关闭临时资源）"]]},"created_time":1677669470283,"last_edited_time":1677678167099,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"771fa5df-d3ac-48f8-8187-2473df326cab":{"role":"reader","value":{"id":"771fa5df-d3ac-48f8-8187-2473df326cab","version":8,"type":"text","properties":{"title":[["10.5.1 HTTP body",[["b"]]]]},"created_time":1677669910104,"last_edited_time":1677669915631,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4636c314-45ee-46f0-9344-aba743d5be67":{"role":"reader","value":{"id":"4636c314-45ee-46f0-9344-aba743d5be67","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbkl8uy7mxj319c0jkwkx.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbkl8uy7mxj319c0jkwkx.jpg"},"created_time":1677670485752,"last_edited_time":1677670488645,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b35a427d-d84a-435f-b6fe-fbf5bb019d80":{"role":"reader","value":{"id":"b35a427d-d84a-435f-b6fe-fbf5bb019d80","version":58,"type":"text","properties":{"title":[["需要注意的点："]]},"created_time":1677669483716,"last_edited_time":1677670536785,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0151fd1e-20d1-497b-8571-3e7a4b56cba1":{"role":"reader","value":{"id":"0151fd1e-20d1-497b-8571-3e7a4b56cba1","version":322,"type":"bulleted_list","properties":{"title":[["如果你没有读取Respose.Body的内容，那么默认的 http transport 会直接关闭连接",[["b"]]]]},"created_time":1677670540546,"last_edited_time":1677671710505,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9bd5ec0b-6a66-4f80-9018-04cffc0e6c96":{"role":"reader","value":{"id":"9bd5ec0b-6a66-4f80-9018-04cffc0e6c96","version":195,"type":"bulleted_list","properties":{"title":[["如果你读取了Body的内容，下次连接可以直接复用",[["b"]]]]},"created_time":1677670600619,"last_edited_time":1677671714282,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d3a0161a-12c8-472f-a09c-53c6f950a50f":{"role":"reader","value":{"id":"d3a0161a-12c8-472f-a09c-53c6f950a50f","version":427,"type":"text","properties":{"title":[["在高并发的场景下，建议你使用长连接，可以调用 "],["io.Copy(io.Discard, resp.Body)",[["c"]]],[" 读取Body的内容。"]]},"created_time":1677670968858,"last_edited_time":1677671731665,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"18d2307d-4cca-4345-b9d7-dc1507096c15":{"role":"reader","value":{"id":"18d2307d-4cca-4345-b9d7-dc1507096c15","version":7,"type":"code","properties":{"title":[["func (h handler) getStatusCode2(body io.Reader) (int, error) {\n\tresp, err := h.client.Post(h.url, \"application/json\", body)\n\tif err != nil {\n\t\treturn 0, err\n\t}\n\n\tdefer func() {\n\t\terr := resp.Body.Close()\n\t\tif err != nil {\n\t\t\tlog.Printf(\"failed to close response: %v\\n\", err)\n\t\t}\n\t}()\n\n\t_, _ = io.Copy(io.Discard, resp.Body)\n\n\treturn resp.StatusCode, nil\n}"]],"language":[["Go"]]},"created_time":1677670964749,"last_edited_time":1677670965210,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"13254856-fafd-446f-b75d-47e0b729e908":{"role":"reader","value":{"id":"13254856-fafd-446f-b75d-47e0b729e908","version":8,"type":"text","properties":{"title":[["10.5.2 sql.Rows",[["b"]]]]},"created_time":1677671048551,"last_edited_time":1677671052052,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"066b4fe7-3b0a-4155-94c6-1becca3e9d8f":{"role":"reader","value":{"id":"066b4fe7-3b0a-4155-94c6-1becca3e9d8f","version":12,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbklkt9cxrj316s0i243s.jpg"]]},"format":{"block_width":528,"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbklkt9cxrj316s0i243s.jpg","block_full_width":false,"block_page_width":false},"created_time":1677671174195,"last_edited_time":1677671683302,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"61f30ac5-1602-4026-b1f0-c224de4d4a52":{"role":"reader","value":{"id":"61f30ac5-1602-4026-b1f0-c224de4d4a52","version":8,"type":"text","properties":{"title":[["10.5.3 os.File",[["b"]]]]},"created_time":1677671174731,"last_edited_time":1677671185507,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2b923df5-5a33-48da-b4b1-5e37cbcfab79":{"role":"reader","value":{"id":"2b923df5-5a33-48da-b4b1-5e37cbcfab79","version":599,"type":"text","properties":{"title":[["写入操作是异步的，所以对写入的文件进行close操作，可能会遇到在buffer内的数据没有写到磁盘的错误，所以在close的时候如果遇到错误要及时上报。"]]},"created_time":1677671842665,"last_edited_time":1677672124139,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"fd7f0e16-0b04-4e69-ab74-53f4cbc81541":{"role":"reader","value":{"id":"fd7f0e16-0b04-4e69-ab74-53f4cbc81541","version":7,"type":"code","properties":{"title":[["func writeToFile1(filename string, content []byte) (err error) {\n\tf, err := os.OpenFile(filename, os.O_APPEND|os.O_WRONLY, os.ModeAppend)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tdefer func() {\n\t\tcloseErr := f.Close()\n\t\tif err == nil {\n\t\t\terr = closeErr\n\t\t}\n\t}()\n\n\t_, err = f.Write(content)\n\treturn\n}"]],"language":[["Go"]]},"created_time":1677671915857,"last_edited_time":1677671916296,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5612d0cc-e719-462e-9d50-a83b52a4f119":{"role":"reader","value":{"id":"5612d0cc-e719-462e-9d50-a83b52a4f119","version":600,"type":"text","properties":{"title":[["但是如果使用了Sync调用可以同步的把数据写入磁盘，所以调用Close方法的时候也可以不用在意错误，因为数据已经正常写入。"]]},"created_time":1677671676285,"last_edited_time":1677672157554,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"279fc137-aee5-4ee8-a834-c528b81c1399":{"role":"reader","value":{"id":"279fc137-aee5-4ee8-a834-c528b81c1399","version":12,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbklrxm43yj30z60hiwj0.jpg"]]},"format":{"block_width":528,"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbklrxm43yj30z60hiwj0.jpg","block_full_width":false,"block_page_width":false},"created_time":1677671585745,"last_edited_time":1677671678600,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"48e75eaa-3af8-4213-bf2f-c9062c03531f":{"role":"reader","value":{"id":"48e75eaa-3af8-4213-bf2f-c9062c03531f","version":216,"type":"sub_sub_header","properties":{"title":[["10.6 #80: Forgetting the return statement after replying to an HTTP request（在发送完响应后忘记及时返回http handler函数）"]]},"created_time":1677672165619,"last_edited_time":1677673067315,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"55294b84-b02f-4788-87b5-80619a243f7b":{"role":"reader","value":{"id":"55294b84-b02f-4788-87b5-80619a243f7b","version":123,"type":"code","properties":{"title":[["func handler(w http.ResponseWriter, req *http.Request) {\n\terr := foo(req)\n\tif err != nil {\n\t\thttp.Error(w, \"foo\", http.StatusInternalServerError)\n\t\t// 记得这里就及时返回\n\t}\n\n\t_, _ = w.Write([]byte(\"all good\"))\n\tw.WriteHeader(http.StatusCreated)\n}"]],"language":[["Go"]]},"created_time":1677673108909,"last_edited_time":1677673133970,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4bb76f0f-7f77-4120-bef0-c17b56343a3f":{"role":"reader","value":{"id":"4bb76f0f-7f77-4120-bef0-c17b56343a3f","version":263,"type":"sub_sub_header","properties":{"title":[["10.7 #81: Using the default HTTP client and server（生成环境不要直接使用默认的Http客户端和服务端）"]]},"created_time":1677673142896,"last_edited_time":1677722177727,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"10412a94-a4d5-40d4-b22a-12e851e06267":{"role":"reader","value":{"id":"10412a94-a4d5-40d4-b22a-12e851e06267","version":61,"type":"text","properties":{"title":[["http.Client",[["b"]]]]},"created_time":1677674392973,"last_edited_time":1677674405508,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8d112139-cad0-4e6c-8dab-c749905eb0de":{"role":"reader","value":{"id":"8d112139-cad0-4e6c-8dab-c749905eb0de","version":724,"type":"text","properties":{"title":[["直接使用标准库的里的client和server可能会存在问题，没有完备的配置项，可能会导致生产问题，首先就是直接使用 "],["http.Client",[["c"]]],[" 发送请求，没有配置超时时间，这在生产环境是绝对不允许的。"]]},"created_time":1677673172471,"last_edited_time":1677673569117,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8c257446-183c-4091-85fb-a01bbbb2c102":{"role":"reader","value":{"id":"8c257446-183c-4091-85fb-a01bbbb2c102","version":7,"type":"code","properties":{"title":[["client := \u0026http.Client{}\nresp, err := client.Get(\"https://golang.org/\")"]],"language":[["Go"]]},"created_time":1677673502531,"last_edited_time":1677673502882,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"da43facf-e52a-4d69-b3bc-30251ff554b7":{"role":"reader","value":{"id":"da43facf-e52a-4d69-b3bc-30251ff554b7","version":14,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbkn8dimu6j312g0bs42e.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbkn8dimu6j312g0bs42e.jpg"},"created_time":1677673469852,"last_edited_time":1677674612727,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"27b883c3-5411-4696-8205-7309c5e4bade":{"role":"reader","value":{"id":"27b883c3-5411-4696-8205-7309c5e4bade","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbkmqobncij31480cqgoz.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbkmqobncij31480cqgoz.jpg"},"created_time":1677673588471,"last_edited_time":1677673590548,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4ffc3109-112b-4796-b609-e9c6aac8870d":{"role":"reader","value":{"id":"4ffc3109-112b-4796-b609-e9c6aac8870d","version":286,"type":"text","properties":{"title":[["关于默认HTTP Client 还要记住他是如何处理连接的。缺省情况下，HTTP Client 会维持一个连接池。客户端在请求的时候可以重用连接(你也可以通过设置 htt"],["http.Transport.DisableKeepAlives",[["c"]]],[" 为 "],["true",[["c"]]],[" 来禁用)。"]]},"created_time":1677673589002,"last_edited_time":1677673882879,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f29c8a17-9201-40b4-ba87-ed1803138bc4":{"role":"reader","value":{"id":"f29c8a17-9201-40b4-ba87-ed1803138bc4","version":57,"type":"text","properties":{"title":[["有一个额外的超时来指定空闲连接在连接池中保留多长时间："],["http.Transfer.IdleConnTimeout",[["c"]]]]},"created_time":1677673885542,"last_edited_time":1677673934710,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8e0e68cd-9e70-4f16-8c35-8a117dfd5d71":{"role":"reader","value":{"id":"8e0e68cd-9e70-4f16-8c35-8a117dfd5d71","version":259,"type":"text","properties":{"title":[["这值的默认值为90s，意味着这个连接可以在90s内都能给其他请求复用。"]]},"created_time":1677673726712,"last_edited_time":1677674012215,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"61cb57b1-a9f1-4773-b3a4-643a34b3e95f":{"role":"reader","value":{"id":"61cb57b1-a9f1-4773-b3a4-643a34b3e95f","version":1092,"type":"text","properties":{"title":[["http.Transport.MaxIdleConns",[["c"]]],[" 用于配置连接池的最大数量，这个值默认为100。其中 "],["http.Transport.MaxIdleConnsPerHost",[["c"]]],[" 用于限制每个host的连接池数量，默认为2，表示如果我们对同一个host触发100次请求，只用2个请求保留在连接池中，如果我们再触发100次请求，那么我们还要再重新创建98次新的连接，这个配置对请求响应的影响也极大。"]]},"created_time":1677674012916,"last_edited_time":1677674277374,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"bc009233-5a77-4bd6-a0c7-17f4941a7c3c":{"role":"reader","value":{"id":"bc009233-5a77-4bd6-a0c7-17f4941a7c3c","version":330,"type":"callout","properties":{"title":[["突然想到自己之前手写的压测脚本，qps一直上不去，应该就是直接裸用 http.Client的锅"]]},"format":{"page_icon":"💡","block_color":"gray_background"},"created_time":1677674342074,"last_edited_time":1677674385133,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"75840e6c-4417-4466-90ac-d4cf0980164e":{"role":"reader","value":{"id":"75840e6c-4417-4466-90ac-d4cf0980164e","version":183,"type":"text","properties":{"title":[["所以我们要明确一些参数的含义，帮助我们生产上线",[["b"]]]]},"created_time":1677674278003,"last_edited_time":1677674329326,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e6a589ca-b455-4346-9fad-6777b30f3137":{"role":"reader","value":{"id":"e6a589ca-b455-4346-9fad-6777b30f3137","version":27,"type":"text","properties":{"title":[["http.Server",[["b"]]]]},"created_time":1677674386870,"last_edited_time":1677674413789,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e4708e59-6399-4c5d-91d6-87cfc7877e7d":{"role":"reader","value":{"id":"e4708e59-6399-4c5d-91d6-87cfc7877e7d","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbkn98yhstj315g0fo78p.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbkn98yhstj315g0fo78p.jpg"},"created_time":1677674659605,"last_edited_time":1677674662310,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8512923b-b7db-41b5-9502-2fbf95942a1f":{"role":"reader","value":{"id":"8512923b-b7db-41b5-9502-2fbf95942a1f","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbkndg329oj31ag08kjwv.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbkndg329oj31ag08kjwv.jpg"},"created_time":1677674901555,"last_edited_time":1677674912882,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"be636884-56af-44cd-9d46-4f35a5ee9e56":{"role":"reader","value":{"id":"be636884-56af-44cd-9d46-4f35a5ee9e56","version":618,"type":"text","properties":{"title":[["服务端同样可以保持长连接，配置长连接的最长超时时间 "],["IdleTimeout",[["c"]]],[" , 如果 "],["http.Server.IdleTimeout",[["c"]]],["  没有配置就会和 "],["http.Server .ReadTimeout",[["c"]]],[" 保持一致，如果都没设置，就会在结束请求后就立马结束连接。"]]},"created_time":1677674901886,"last_edited_time":1677675174811,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a74de5e0-84f9-43b6-94a0-c63e4023ae6e":{"role":"reader","value":{"id":"a74de5e0-84f9-43b6-94a0-c63e4023ae6e","version":7,"type":"code","properties":{"title":[["s := \u0026http.Server{\n    // ...\n    IdleTimeout: time.Second,\n}"]],"language":[["Go"]]},"created_time":1677675050903,"last_edited_time":1677675051201,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"fa08f802-f769-4af2-b880-0a7cd3cb5e22":{"role":"reader","value":{"id":"fa08f802-f769-4af2-b880-0a7cd3cb5e22","version":265,"type":"callout","properties":{"title":[["在生产环境，有时候为了避免服务断流，会把keep-alive给关闭"]]},"format":{"page_icon":"💡","block_color":"gray_background"},"created_time":1677675194502,"last_edited_time":1677675222604,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"21f335df-2e59-4cd8-8d0c-9fbcdbf1d503":{"role":"reader","value":{"id":"21f335df-2e59-4cd8-8d0c-9fbcdbf1d503","version":11,"type":"sub_header","properties":{"title":[["11 Testing"]]},"created_time":1677679565941,"last_edited_time":1677679573114,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9fd8ad81-e457-4d2e-9d8e-145daafd7af9":{"role":"reader","value":{"id":"9fd8ad81-e457-4d2e-9d8e-145daafd7af9","version":74,"type":"sub_sub_header","properties":{"title":[["11.1 #82: Not categorizing tests（没有对测试类型分类）"]]},"created_time":1677679624997,"last_edited_time":1677765209356,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"da4990c0-5e42-460c-8425-cfbd41c51f6d":{"role":"reader","value":{"id":"da4990c0-5e42-460c-8425-cfbd41c51f6d","version":855,"type":"text","properties":{"title":[["不同类型的测试:单元测试、集成测试、E2E测试各自的执行时间和个数都有很大差距，如下的测试金字塔显示了测试的占比，各种测试的执行时间也呈反比。这一节介绍了一些方法提醒开发者，不同类型的测试，需要明确区分，并且最好独立执行，可以提升开发效率。"]]},"created_time":1677765364422,"last_edited_time":1677765570557,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4f9c6c06-3ad6-46b1-9907-c5f09f199062":{"role":"reader","value":{"id":"4f9c6c06-3ad6-46b1-9907-c5f09f199062","version":12,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbluxpm2fqj30la0ci0uc.jpg"]]},"format":{"block_width":384,"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbluxpm2fqj30la0ci0uc.jpg","block_full_width":false,"block_page_width":false},"created_time":1677765349336,"last_edited_time":1677765361086,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5595aec8-9bdc-4ee6-aad8-885ffa50909a":{"role":"reader","value":{"id":"5595aec8-9bdc-4ee6-aad8-885ffa50909a","version":203,"type":"bulleted_list","properties":{"title":[["使用 "],["go:build",[["c"]]],[" tag来给测试归类,用法可参考："]]},"content":["7c2ce0a4-ab7f-46c6-9dc5-07a43ab425cd","18c9eccc-9da6-42f6-8ec8-e88c65be7a5e"],"created_time":1677765577011,"last_edited_time":1677765994623,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"27701362-dbb7-4aca-b5a6-c08b830ac4b6":{"role":"reader","value":{"id":"27701362-dbb7-4aca-b5a6-c08b830ac4b6","version":99,"type":"bulleted_list","properties":{"title":[["使用环境变量分类"]]},"content":["18666ce9-f011-454d-9338-067ff8b091af"],"created_time":1677765799988,"last_edited_time":1677765811796,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ff80f41e-1180-4fc3-9ea2-46b3880651a8":{"role":"reader","value":{"id":"ff80f41e-1180-4fc3-9ea2-46b3880651a8","version":299,"type":"bulleted_list","properties":{"title":[["Short mode，执行go test的时候加上 "],["-short",[["c"]]],[" 选项，可以选择性的执行耗时短的测试"]]},"content":["c06a6433-6f93-4703-ba8b-247a1e863581"],"created_time":1677766070989,"last_edited_time":1677766337274,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ac422070-7e32-47cf-ab96-2dfb26036066":{"role":"reader","value":{"id":"ac422070-7e32-47cf-ab96-2dfb26036066","version":169,"type":"sub_sub_header","properties":{"title":[["11.2 #83: Not enabling the -race flag（没开启 -race flag来检验并发冲突）"]]},"created_time":1677766347539,"last_edited_time":1677766379279,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1c099fc5-7ce8-4ff4-a33b-85d4a00473ac":{"role":"reader","value":{"id":"1c099fc5-7ce8-4ff4-a33b-85d4a00473ac","version":294,"type":"text","properties":{"title":[["开启 -race 之后性能和内存占用都有影响，所以生产环境不建议开启（废话。。）"]]},"created_time":1677766380251,"last_edited_time":1677766433370,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9500e573-009a-4727-bd77-1d8f230dc675":{"role":"reader","value":{"id":"9500e573-009a-4727-bd77-1d8f230dc675","version":9,"type":"code","properties":{"title":[["go test -race ./..."]],"language":[["Bash"]]},"created_time":1677766466762,"last_edited_time":1677766470337,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b1fc957f-0112-444a-941c-4953a128b292":{"role":"reader","value":{"id":"b1fc957f-0112-444a-941c-4953a128b292","version":204,"type":"sub_sub_header","properties":{"title":[["11.3 #84: Not using test execution modes（没有使用test执行模式：并行 or shuffle ）"]]},"created_time":1677766485263,"last_edited_time":1677766655825,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"25e1958f-8fbe-4705-a749-c9d5055a6e48":{"role":"reader","value":{"id":"25e1958f-8fbe-4705-a749-c9d5055a6e48","version":82,"type":"bulleted_list","properties":{"title":[["The parallel flag 开启并行模式执行测试"]]},"content":["261965ec-5673-446b-af34-e55af690c950"],"created_time":1677766663177,"last_edited_time":1677766725882,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"facda99f-78f1-48b9-9538-695bc10c8e6f":{"role":"reader","value":{"id":"facda99f-78f1-48b9-9538-695bc10c8e6f","version":104,"type":"bulleted_list","properties":{"title":[["The -shuffle flag 开启 shuffle 模式执行测试"]]},"content":["2168ff07-0f1c-4631-8be1-5e0845466c7d","f4223d0c-99c0-44ab-b38f-09d099a91481"],"created_time":1677766672585,"last_edited_time":1677766977803,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f0e5bc4a-1fcd-48cf-a95c-96774bfa9512":{"role":"reader","value":{"id":"f0e5bc4a-1fcd-48cf-a95c-96774bfa9512","version":97,"type":"sub_sub_header","properties":{"title":[["11.4 #85: Not using table-driven tests（使用 table-driven 的模式编写测试）"]]},"created_time":1677766995689,"last_edited_time":1677767020862,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c99860f7-ff36-43ca-ba6d-71d6387b2da5":{"role":"reader","value":{"id":"c99860f7-ff36-43ca-ba6d-71d6387b2da5","version":18,"type":"text","properties":{"title":[["略"]]},"created_time":1677767090033,"last_edited_time":1677767094393,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f0c02b1b-69a8-4a9e-992d-d891d242108a":{"role":"reader","value":{"id":"f0c02b1b-69a8-4a9e-992d-d891d242108a","version":12,"type":"bookmark","properties":{"link":[["https://dave.cheney.net/2019/05/07/prefer-table-driven-tests"]],"title":[["Prefer table driven tests"]]},"format":{"bookmark_icon":"https://dave.cheney.net/favicon.ico"},"created_time":1677767069306,"last_edited_time":1677767072316,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8255a912-93f3-4348-a902-2ae62bbf3b4d":{"role":"reader","value":{"id":"8255a912-93f3-4348-a902-2ae62bbf3b4d","version":233,"type":"sub_sub_header","properties":{"title":[["11.5 #86: Sleeping in unit tests（在测试代码中包含sleep逻辑，导致出现flaky测试）"]]},"created_time":1677767114617,"last_edited_time":1677767328268,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"adba6ae7-1628-4d8e-8536-54ddc26c38f2":{"role":"reader","value":{"id":"adba6ae7-1628-4d8e-8536-54ddc26c38f2","version":770,"type":"text","properties":{"title":[["依赖等待一段时间直到特定的逻辑执行完成的方式会因为时间设置问题导致出现不稳定的测试，这种情况，可以通过指定多次重试或者使用同步的方法来避免直接调用 time.sleep 来等待。"]]},"created_time":1677767148385,"last_edited_time":1677767313172,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e38daf6b-978a-425f-a1fe-ce0a16cff87b":{"role":"reader","value":{"id":"e38daf6b-978a-425f-a1fe-ce0a16cff87b","version":150,"type":"text","properties":{"title":[["可以使用 testify 或者 "],["Gomega",[["a","http://onsi.github.io/gomega/"]]],[" 中的 Eventually 方法"]]},"created_time":1677767456347,"last_edited_time":1677767502714,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cce3764c-04e8-48b7-bea8-074f2dda6274":{"role":"reader","value":{"id":"cce3764c-04e8-48b7-bea8-074f2dda6274","version":11,"type":"bookmark","properties":{"link":[["https://stackoverflow.com/questions/30427013/testing-for-asynchronous-results-without-sleep-in-go/30427356#30427356"]],"title":[["Testing for asynchronous results without sleep in Go"]],"description":[["I have quite a few components in my code that have persistent go-routines that listen for events to trigger actions. Most of the time, there is no reason (outside of testing) for them to send back a"]]},"format":{"bookmark_icon":"https://cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon.png?v=c78bd457575a","bookmark_cover":"https://cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png?v=73d79a89bded"},"created_time":1677767454571,"last_edited_time":1677767457578,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ac1f48b7-0410-4f19-982c-d1ec93fb8a3b":{"role":"reader","value":{"id":"ac1f48b7-0410-4f19-982c-d1ec93fb8a3b","version":99,"type":"sub_sub_header","properties":{"title":[["11.6 #87: Not dealing with the time API efficiently（没有正确的处理时间问题）"]]},"created_time":1677767332883,"last_edited_time":1677767524889,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d8765efc-6576-4658-ae4b-46d86438a11d":{"role":"reader","value":{"id":"d8765efc-6576-4658-ae4b-46d86438a11d","version":1131,"type":"text","properties":{"title":[["一些函数处理逻辑和超时相关的，如果在编写测试的时候依赖实时的时间，但测试可能没有立即执行，导致代码没有按照期望的行为运行。比如下面的例子，想要过滤掉超时的事件，如果代码执行到 "],["cache.GetAll()",[["c"]]],[" 的时候耗费了一些时间，原本希望缓存2个事件，却一个也没缓存。"]]},"created_time":1677767599399,"last_edited_time":1677767859030,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f8fa26f3-5bba-4d5e-8ead-24c19ed51f7d":{"role":"reader","value":{"id":"f8fa26f3-5bba-4d5e-8ead-24c19ed51f7d","version":9,"type":"code","properties":{"title":[["func TestCache_TrimOlderThan(t *testing.T) {\n\tevents := []Event{\n\t\t{Timestamp: time.Now().Add(-20 * time.Millisecond)},\n\t\t{Timestamp: time.Now().Add(-10 * time.Millisecond)},\n\t\t{Timestamp: time.Now().Add(10 * time.Millisecond)},\n\t}\n\tcache := \u0026Cache{}\n\tcache.Add(events)\n\tcache.TrimOlderThan(15 * time.Millisecond)\n\tgot := cache.GetAll()\n\texpected := 2\n\tif len(got) != expected {\n\t\tt.Fatalf(\"expected %d, got %d\", expected, len(got))\n\t}\n}"]],"language":[["Go"]]},"created_time":1677767568764,"last_edited_time":1677767573543,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e79cc7c2-f705-4d5e-897a-2c468659cb24":{"role":"reader","value":{"id":"e79cc7c2-f705-4d5e-897a-2c468659cb24","version":244,"type":"text","properties":{"title":[["这类测试可以使用确切的时间来代替实时获取时间"]]},"created_time":1677767578503,"last_edited_time":1677767919182,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"549f1688-5f62-4c63-b029-235a01196960":{"role":"reader","value":{"id":"549f1688-5f62-4c63-b029-235a01196960","version":7,"type":"code","properties":{"title":[["func TestCache_TrimOlderThan(t *testing.T) {\n\tevents := []Event{\n\t\t{Timestamp: parseTime(t, \"2020-01-01T12:00:00.04Z\")},\n\t\t{Timestamp: parseTime(t, \"2020-01-01T12:00:00.05Z\")},\n\t\t{Timestamp: parseTime(t, \"2020-01-01T12:00:00.06Z\")},\n\t}\n\tcache := \u0026Cache{now: func() time.Time {\n\t\treturn parseTime(t, \"2020-01-01T12:00:00.06Z\")\n\t}}\n\tcache.Add(events)\n\tcache.TrimOlderThan(15 * time.Millisecond)\n\t// ...\n}"]],"language":[["Go"]]},"created_time":1677767597148,"last_edited_time":1677767597452,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3f92e134-c58d-4101-be2d-bb7a042ae323":{"role":"reader","value":{"id":"3f92e134-c58d-4101-be2d-bb7a042ae323","version":174,"type":"sub_sub_header","properties":{"title":[["11.7 #88: Not using testing utility packages（没有使用内置的工具包，比如httptest、iotest）"]]},"created_time":1677767939377,"last_edited_time":1677768003828,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9a094856-c66e-46ef-8b42-c1ad28a3a326":{"role":"reader","value":{"id":"9a094856-c66e-46ef-8b42-c1ad28a3a326","version":320,"type":"text","properties":{"title":[["略，此处就不讲解包的使用了，知道在mock http 和 io 操作的时候可以使用这2个内置的工具包"]]},"created_time":1677768084214,"last_edited_time":1677768120247,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"062c653a-7cf2-4566-adae-21c3284b6d10":{"role":"reader","value":{"id":"062c653a-7cf2-4566-adae-21c3284b6d10","version":11,"type":"bookmark","properties":{"link":[["https://pkg.go.dev/net/http/httptest"]],"title":[["httptest package - net/http/httptest - Go Packages"]],"description":[["Package httptest provides utilities for HTTP testing."]]},"format":{"bookmark_icon":"https://pkg.go.dev/static/shared/icon/favicon.ico"},"created_time":1677768035940,"last_edited_time":1677768038979,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"94fabb0b-2f87-4667-bd0c-f9a1335b8cfd":{"role":"reader","value":{"id":"94fabb0b-2f87-4667-bd0c-f9a1335b8cfd","version":12,"type":"bookmark","properties":{"link":[["https://pkg.go.dev/testing/iotest"]],"title":[["iotest package - testing/iotest - Go Packages"]],"description":[["Package iotest implements Readers and Writers useful mainly for testing."]]},"format":{"bookmark_icon":"https://pkg.go.dev/static/shared/icon/favicon.ico"},"created_time":1677768082363,"last_edited_time":1677768085372,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"01c16695-373d-4689-9829-1b555d88b5a6":{"role":"reader","value":{"id":"01c16695-373d-4689-9829-1b555d88b5a6","version":4,"type":"sub_sub_header","properties":{"title":[["11.8 #89: Writing inaccurate benchmarks（编写了不正确的BencMark）"]]},"created_time":1677755226797,"last_edited_time":1677768078280,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"edb2e964-834f-455c-a5da-a681964d3837":{"role":"reader","value":{"id":"edb2e964-834f-455c-a5da-a681964d3837","version":9,"type":"text","properties":{"title":[["Not resetting or pausing the timer",[["b"]]]]},"created_time":1677757715462,"last_edited_time":1677757719478,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"07c9aecc-d54d-4985-9cc4-b1e405c910c7":{"role":"reader","value":{"id":"07c9aecc-d54d-4985-9cc4-b1e405c910c7","version":396,"type":"text","properties":{"title":[["在具体测量某一段函数性能时，一些SetUp操作可能比较耗时会影响测量结果。调用 "],["ResetTimer",[["c"]]],[" 函数可以重置一些Bench数据。"]]},"created_time":1677757409264,"last_edited_time":1677757499980,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"12bebafb-235b-4674-9df6-47d0b23513a2":{"role":"reader","value":{"id":"12bebafb-235b-4674-9df6-47d0b23513a2","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hblqycs54hj31e80b6jwa.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hblqycs54hj31e80b6jwa.jpg"},"created_time":1677757071856,"last_edited_time":1677757075519,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"46c07bae-be17-4303-a964-f97e63e11629":{"role":"reader","value":{"id":"46c07bae-be17-4303-a964-f97e63e11629","version":231,"type":"text","properties":{"title":[["每次迭代都会有一些耗时动作，可以调用 "],["b.StopTimer()",[["c"]]],[" 和 "],["b.StartTimer()",[["c"]]],[" 暂停和启动BenchMark计量"]]},"created_time":1677757634567,"last_edited_time":1677757723668,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"627c31e9-b71f-454f-ae78-baaf59be7610":{"role":"reader","value":{"id":"627c31e9-b71f-454f-ae78-baaf59be7610","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hblr850zbgj31eo0cutdw.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hblr850zbgj31eo0cutdw.jpg"},"created_time":1677757633226,"last_edited_time":1677757639868,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a94784ba-c29c-4f02-9172-8d5d5983125b":{"role":"reader","value":{"id":"a94784ba-c29c-4f02-9172-8d5d5983125b","version":7,"type":"text","properties":{"title":[["Making wrong assumptions about micro-benchmarks",[["b"]]]]},"created_time":1677757669667,"last_edited_time":1677757735425,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"20049e49-6daf-492c-a3d8-f4efa351cac1":{"role":"reader","value":{"id":"20049e49-6daf-492c-a3d8-f4efa351cac1","version":286,"type":"text","properties":{"title":[["在一些做一些 "],["micro-benchmark ",[["b"]]],["的时候，如果不多次进行基准测试很容易就得出错误的结论"]]},"created_time":1677759040073,"last_edited_time":1677759104077,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"fe0a1f1a-403d-44db-beae-e99e2ab82ab3":{"role":"reader","value":{"id":"fe0a1f1a-403d-44db-beae-e99e2ab82ab3","version":7,"type":"code","properties":{"title":[["func BenchmarkAtomicStoreInt32(b *testing.B) {\n\tvar v int32\n\tfor i := 0; i \u003c b.N; i++ {\n\t\tatomic.StoreInt32(\u0026v, 1)\n\t}\n}\n\nfunc BenchmarkAtomicStoreInt64(b *testing.B) {\n\tvar v int64\n\tfor i := 0; i \u003c b.N; i++ {\n\t\tatomic.StoreInt64(\u0026v, 1)\n\t}\n}"]],"language":[["Go"]]},"created_time":1677758910378,"last_edited_time":1677758910784,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"71b567f9-ae6f-401d-b495-08d5e24da45e":{"role":"reader","value":{"id":"71b567f9-ae6f-401d-b495-08d5e24da45e","version":97,"type":"text","properties":{"title":[["下图是执行2次BenchMark的结果"]]},"created_time":1677759112279,"last_edited_time":1677759135128,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4cd81bb0-70de-43d9-9f26-ba622d87c876":{"role":"reader","value":{"id":"4cd81bb0-70de-43d9-9f26-ba622d87c876","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hblrwgav5vj317k0gun42.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hblrwgav5vj317k0gun42.jpg"},"created_time":1677759111668,"last_edited_time":1677759114632,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2794e264-74a5-4ddc-a60d-966f4759a13e":{"role":"reader","value":{"id":"2794e264-74a5-4ddc-a60d-966f4759a13e","version":312,"type":"text","properties":{"title":[["解决方案：对于 "],["micro-benchmark 需要",[["b"]]],["进行多次 BenchMark，可以利用 "],["benchstat",[["c"]]],[" 统计BenchMark的结果进行均值计算。"]]},"created_time":1677759135978,"last_edited_time":1677759273737,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"05189425-d70a-44eb-9879-3306bbac3a35":{"role":"reader","value":{"id":"05189425-d70a-44eb-9879-3306bbac3a35","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbls3gwljrj317u0iitgl.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbls3gwljrj317u0iitgl.jpg"},"created_time":1677759441199,"last_edited_time":1677759443240,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"370d04b8-b5b2-4a04-a6fb-9d104da5d9dd":{"role":"reader","value":{"id":"370d04b8-b5b2-4a04-a6fb-9d104da5d9dd","version":8,"type":"text","properties":{"title":[["Not being careful about compiler optimizations",[["b"]]]]},"created_time":1677759453570,"last_edited_time":1677759456620,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"86e3641d-395b-4045-8060-ff5a493f70fc":{"role":"reader","value":{"id":"86e3641d-395b-4045-8060-ff5a493f70fc","version":293,"type":"text","properties":{"title":[["golang的内联优化会导致我们的测试函数被优化，执行结果不符合我们的预期（效果更好）"]]},"created_time":1677759970540,"last_edited_time":1677760000839,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a502b2c5-d0f4-49a4-827d-5aa64c073a20":{"role":"reader","value":{"id":"a502b2c5-d0f4-49a4-827d-5aa64c073a20","version":13,"type":"external_object_instance","format":{"uri":"https://github.com/golang/go/issues/14813","stale":false,"bot_id":"efde49d0-e017-4d2f-a301-c28f0da86161","domain":"github.com","attributes":[{"id":"title","name":"Title","type":"inline","format":{"type":"title","section":"title"},"values":["cmd/compile: SSA compiler removes code in benchmarks"]},{"id":"state","name":"State","type":"relation","values":["github:issue_state/closed"]},{"id":"number","name":"Issue Number","type":"inline","values":["#14813"]},{"id":"created_at","name":"Created At","type":"inline","format":{"type":"created_time"},"values":[{"type":"datetime","time_zone":"UTC","start_date":"2016-03-14","start_time":"08:08"}]},{"id":"updated_at","name":"Updated At","type":"inline","format":{"type":"last_edited_time"},"values":[{"type":"datetime","time_zone":"UTC","start_date":"2019-10-25","start_time":"17:13"}]},{"id":"user","name":"Related Github Creator","type":"relation","values":["https://github.com/ainar-g"]},{"id":"user_as_people","name":"Creator","type":"person","values":["https://github.com/ainar-g"]},{"id":"closed_at","name":"Closed At","type":"inline","values":[{"type":"datetime","time_zone":"UTC","start_date":"2016-03-14","start_time":"08:17"}]},{"id":"description","name":"Description","type":"inline","values":["Go version: \\`go version devel +2dcbbbd Mon Mar 14 05:13:47 2016 +0000 linux/amd64\\` Go env: \\`\\`\\` GOARCH=\"amd64\" GOHOSTARCH=\"amd64\" GOHOSTOS=\"linux\" GOOS=\"linux\" \\`\\`\\` This code is a simple benchmark of Hamming weight algorithms: http://play.golang.org/p/kOid3lX9Yz In Go 1.6 running \\`go test popcnt\\_test.go -bench .\\` gives the result: \\`\\`\\` testing: warning: no tests to run PASS BenchmarkPopcnt-4 50000000 27.1 ns/op BenchmarkPopcnt2-4 1000000000 2.90 ns/op ok command-line-arguments 4.567s \\`\\`\\` But on tip with SSA turned on it's \\`\\`\\` testing: warning: no tests to run BenchmarkPopcnt-4 100000000 24.0 ns/op BenchmarkPopcnt2-4 2000000000 0.41 ns/op PASS ok command-line-arguments 3.286s \\`\\`\\` Running with \\`-gcflags \"-S\"\\` confirms that the tip version completely removes the call to popcnt2\\. If I add \\`//go:noinline\\` before popcnt2 definition, it works fine (although slower than 1.6 because it doesn't inline): \\`\\`\\` testing: warning: no tests to run BenchmarkPopcnt-4 50000000 22.9 ns/op BenchmarkPopcnt2-4 300000000 4.42 ns/op PASS ok command-line-arguments 2.946s \\`\\`\\` Same goes for running with \\`-gcflags \"-ssa=0\"\\`, the call isn't removed."]}],"original_url":"https://github.com/golang/go/issues/14813","external_object_id":"57ab4e41-185d-444b-87f9-8501366d2e98","related_external_object_uris_to_instance_ids":{"github:issue_state/closed":"934db1b0-4c5f-42f0-a0b2-92e681e04ca4","https://github.com/ainar-g":"697048b9-38fd-4273-ab5a-6da75e432a72"}},"created_time":1677759924126,"last_edited_time":1677804982748,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"bot","last_edited_by_id":"efde49d0-e017-4d2f-a301-c28f0da86161","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9f62f9c4-b271-42e2-ae4f-a263d1b8b03a":{"role":"reader","value":{"id":"9f62f9c4-b271-42e2-ae4f-a263d1b8b03a","version":12,"type":"bookmark","properties":{"link":[["https://dave.cheney.net/2013/06/30/how-to-write-benchmarks-in-go"]],"title":[["How to write benchmarks in Go"]]},"format":{"bookmark_icon":"https://dave.cheney.net/favicon.ico"},"created_time":1677759966479,"last_edited_time":1677759969487,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"324e446f-532f-4d5f-b9da-f5570808bfe6":{"role":"reader","value":{"id":"324e446f-532f-4d5f-b9da-f5570808bfe6","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hblshj22g8j31ci0pg7cf.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hblshj22g8j31ci0pg7cf.jpg"},"created_time":1677760251930,"last_edited_time":1677760254965,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"58dcb767-08ae-456d-8ec6-2e0a780cbdd1":{"role":"reader","value":{"id":"58dcb767-08ae-456d-8ec6-2e0a780cbdd1","version":316,"type":"callout","properties":{"title":[["给"],["go test",[["c"]]],["增加"],["-gcflags=\"-m\"",[["c"]]],["参数，"],["-m",[["c"]]],["表示打印编译器做出的优化决定。可以看到是否做了内联优化，如果有"],[" inlining call to xxx 函数",[["c"]]],[" 的字样就是做了优化"]]},"format":{"page_icon":"💡","block_color":"gray_background"},"created_time":1677760289450,"last_edited_time":1677760351344,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"431e2f71-8aa3-4fd3-bf50-fa1b5518b116":{"role":"reader","value":{"id":"431e2f71-8aa3-4fd3-bf50-fa1b5518b116","version":11,"type":"bulleted_list","properties":{"title":[["执行"],["go test",[["c"]]],["的时候，增加"],["-gcfloags=\"-l\"",[["c"]]],["参数，"],["-l",[["c"]]],["表示禁用编译器的内联优化。"]]},"created_time":1677760380722,"last_edited_time":1677760388899,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cf7bca78-d407-4c2d-899e-b3aeeb1cb3f4":{"role":"reader","value":{"id":"cf7bca78-d407-4c2d-899e-b3aeeb1cb3f4","version":20,"type":"bulleted_list","properties":{"title":[["使用"],["//go:noinline ",[["c"]]],["编译器指令(compiler directive)，编译器在编译时会识别到这个指令，不做内联优化。"]]},"content":["010df427-32d2-4c01-bbcc-e9e2f0b55d2d"],"created_time":1677760401496,"last_edited_time":1677760424540,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7921d39c-d036-42fb-a75c-8da1646cc1be":{"role":"reader","value":{"id":"7921d39c-d036-42fb-a75c-8da1646cc1be","version":10,"type":"text","properties":{"title":[["Being fooled by the observer effect",[["b"]]]]},"created_time":1677760413710,"last_edited_time":1677760428465,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a6337376-2852-41b3-b3ba-2c936b3b134a":{"role":"reader","value":{"id":"a6337376-2852-41b3-b3ba-2c936b3b134a","version":8,"type":"text","properties":{"title":[["在物理学中，观测者效应是观测行为对被观测系统的扰动。这种影响也可以在基准测试中看到，并可能导致对结果的错误假设。"]]},"created_time":1677760428744,"last_edited_time":1677762139769,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7a08a2b9-bf7d-46a4-bf7f-bdb430fafdd7":{"role":"reader","value":{"id":"7a08a2b9-bf7d-46a4-bf7f-bdb430fafdd7","version":42,"type":"code","properties":{"title":[["// 我们想实现一个接收int64元素矩阵的函数。这个矩阵有固定数量的512列，我们想计算前八列的总和\nfunc calculateSum512(s [][512]int64) int64 {\n\tvar sum int64\n\tfor i := 0; i \u003c len(s); i++ {\n\t\tfor j := 0; j \u003c 8; j++ {\n\t\t\tsum += s[i][j]\n\t\t}\n\t}\n\treturn sum\n}\n// 为了优化，我们还想确定更改列数是否有影响，因此我们还实现了第二个包含513列的函数。\nfunc calculateSum513(s [][513]int64) int64 {\n\tvar sum int64\n\tfor i := 0; i \u003c len(s); i++ {\n\t\tfor j := 0; j \u003c 8; j++ {\n\t\t\tsum += s[i][j]\n\t\t}\n\t}\n\treturn sum\n}"]],"language":[["Go"]]},"created_time":1677762007596,"last_edited_time":1677762124460,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2eb92afc-c6c9-4788-a89b-c33a8059f80f":{"role":"reader","value":{"id":"2eb92afc-c6c9-4788-a89b-c33a8059f80f","version":375,"type":"text","properties":{"title":[["BenchMark后的结果很出乎意料，513*513矩阵的计算更加高效，原因和CPU Cache命中有很高的关系。"]]},"created_time":1677763140340,"last_edited_time":1677763215214,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d9c2fabe-79fe-4ca1-9190-9f78713d8e46":{"role":"reader","value":{"id":"d9c2fabe-79fe-4ca1-9190-9f78713d8e46","version":519,"type":"text","properties":{"title":[["因为BenchMark事先创建了一个矩阵并重复计算，再加上缓存命中的影响更加加重了测试差距，解决方案就是每次迭代都创建新的矩阵",[["b"]]]]},"created_time":1677763236455,"last_edited_time":1677844995626,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"184963b1-116a-4ee6-b602-a503001fd3a7":{"role":"reader","value":{"id":"184963b1-116a-4ee6-b602-a503001fd3a7","version":13,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hblu0ivr0oj31dc0tqtjc.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hblu0ivr0oj31dc0tqtjc.jpg"},"created_time":1677763423457,"last_edited_time":1677763453793,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3f8a1d9c-df1e-41e8-8c51-98e4c22cd7c8":{"role":"reader","value":{"id":"3f8a1d9c-df1e-41e8-8c51-98e4c22cd7c8","version":175,"type":"text","properties":{"title":[["关于 513*513矩阵的计算更加高效 的原理可以参考 "],["#91 Not understanding CPU caches",[["b"]]]]},"created_time":1677763216620,"last_edited_time":1677844666459,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"70d29465-bf72-4dd1-b4fd-5a8d0428788b":{"role":"reader","value":{"id":"70d29465-bf72-4dd1-b4fd-5a8d0428788b","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hblu30b7w2j31580k0grq.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hblu30b7w2j31580k0grq.jpg"},"created_time":1677763565753,"last_edited_time":1677763567991,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"76f06611-7573-4d22-8199-e4f63998bf09":{"role":"reader","value":{"id":"76f06611-7573-4d22-8199-e4f63998bf09","version":134,"type":"sub_sub_header","properties":{"title":[["11.9 #90: Not exploring all the Go testing features（没有利用 Go testing的特性）"]]},"created_time":1677763574391,"last_edited_time":1677764231425,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0c142a31-4082-444d-8066-19c3375d698a":{"role":"reader","value":{"id":"0c142a31-4082-444d-8066-19c3375d698a","version":79,"type":"bulleted_list","properties":{"title":[["使用 "],["coverprofile",[["c"]]],[" flag 查看代码覆盖率"]]},"content":["dc6458a6-89c5-410a-af4b-3e0f56450ecf"],"created_time":1677764298325,"last_edited_time":1677764357871,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"678b750d-f082-4b28-a37e-c22518645f15":{"role":"reader","value":{"id":"678b750d-f082-4b28-a37e-c22518645f15","version":193,"type":"bulleted_list","properties":{"title":[["把测试文件可以放在"],["_test",[["c"]]],["包中, 测试文件可以放在不同的包中"]]},"content":["c948a666-4c3a-4c1a-8e9d-367833b111bf","d7039932-cb0c-4e6a-bde1-6d5c2d4f5ccc"],"created_time":1677764419829,"last_edited_time":1677764700245,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f10a3d28-71ca-42c6-90d9-07435feb699c":{"role":"reader","value":{"id":"f10a3d28-71ca-42c6-90d9-07435feb699c","version":94,"type":"bulleted_list","properties":{"title":[["Setup and teardown 搭建和卸载环境"]]},"content":["1c10a040-7f54-4a6f-9b72-bfa11b8ec8fb","b9afc4da-dd29-4872-a0f5-29d6233e7b1f"],"created_time":1677764703723,"last_edited_time":1677842945817,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f468d2d2-1276-4e89-86a2-e859709b53f8":{"role":"reader","value":{"id":"f468d2d2-1276-4e89-86a2-e859709b53f8","version":13,"type":"sub_header","properties":{"title":[["Optimizations"]]},"created_time":1677842929023,"last_edited_time":1677842950014,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"30b00cf6-25b5-478f-b673-a57cc8c78750":{"role":"reader","value":{"id":"30b00cf6-25b5-478f-b673-a57cc8c78750","version":97,"type":"sub_sub_header","properties":{"title":[["12.1 #91: Not understanding CPU caches（利用缓存加速代码执行速度）"]]},"created_time":1677842953351,"last_edited_time":1677843382002,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d2579c23-3031-4256-a718-a5a977d25701":{"role":"reader","value":{"id":"d2579c23-3031-4256-a718-a5a977d25701","version":203,"type":"text","properties":{"title":[["关于CPU Cache部分不属于GO专属的知识，这里就不细讲了"]]},"created_time":1677843406758,"last_edited_time":1677843436437,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8db18d1b-4045-415d-a05e-23841d8135ae":{"role":"reader","value":{"id":"8db18d1b-4045-415d-a05e-23841d8135ae","version":10,"type":"bookmark","properties":{"link":[["https://zhuanlan.zhihu.com/p/31875174"]],"title":[["细说Cache-L1/L2/L3/TLB"]],"description":[["本来打算今天把Cache写透的，结果今天陪娃出去玩了两次，先虎头蛇尾了，放出来，有时间再补。补了我会通知的~~。大家别忘了关注我的专栏。 概述cache是一种又小又快的存储器。它存在的意义是弥合Memory与CPU之间的…"]]},"format":{"bookmark_icon":"https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.81060cab.png","bookmark_cover":"https://pic1.zhimg.com/v2-b044ecf48648f83743602ddf9ae4a7ac_r.jpg?source=172ae18b"},"created_time":1677843359168,"last_edited_time":1677843359176,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"bf34ed9e-0ce9-4bd4-8f79-8b0333f96eb3":{"role":"reader","value":{"id":"bf34ed9e-0ce9-4bd4-8f79-8b0333f96eb3","version":12,"type":"callout","properties":{"title":[["cache line 是固定大小的连续内存段，通常为64字节（8个int64变量）。"]]},"format":{"page_icon":"💡","block_color":"gray_background"},"created_time":1677843665654,"last_edited_time":1677843673840,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5887a6f5-7336-4f78-a90c-fa06a1dece39":{"role":"reader","value":{"id":"5887a6f5-7336-4f78-a90c-fa06a1dece39","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbmwsvsyz0j31py0ryk4x.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbmwsvsyz0j31py0ryk4x.jpg"},"created_time":1677843951843,"last_edited_time":1677843959145,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e06adf5c-4a18-448a-b555-58af9361e565":{"role":"reader","value":{"id":"e06adf5c-4a18-448a-b555-58af9361e565","version":10,"type":"text","properties":{"title":[["Slice of structs vs. struct of slices",[["b"]]]]},"created_time":1677844364464,"last_edited_time":1677844387402,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"13a2819c-c505-42e2-a6f0-76baf680f14d":{"role":"reader","value":{"id":"13a2819c-c505-42e2-a6f0-76baf680f14d","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbmwzxix54j31so0ucjz7.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbmwzxix54j31so0ucjz7.jpg"},"created_time":1677844353603,"last_edited_time":1677844355872,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"69ba59eb-0736-4d96-8dae-bd4ff106afb4":{"role":"reader","value":{"id":"69ba59eb-0736-4d96-8dae-bd4ff106afb4","version":110,"type":"text","properties":{"title":[["Cache placement policy（关于#89出现问题的解释）",[["b"]]]]},"created_time":1677844406601,"last_edited_time":1677845014144,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"736571b5-9ea4-4a7a-ae53-2641434d60f7":{"role":"reader","value":{"id":"736571b5-9ea4-4a7a-ae53-2641434d60f7","version":12,"type":"code","properties":{"title":[["// 我们想实现一个接收int64元素矩阵的函数。这个矩阵有固定数量的512列，我们想计算前八列的总和\nfunc calculateSum512(s [][512]int64) int64 {\n\tvar sum int64\n\tfor i := 0; i \u003c len(s); i++ {\n\t\tfor j := 0; j \u003c 8; j++ {\n\t\t\tsum += s[i][j]\n\t\t}\n\t}\n\treturn sum\n}\n// 为了优化，我们还想确定更改列数是否有影响，因此我们还实现了第二个包含513列的函数。\nfunc calculateSum513(s [][513]int64) int64 {\n\tvar sum int64\n\tfor i := 0; i \u003c len(s); i++ {\n\t\tfor j := 0; j \u003c 8; j++ {\n\t\t\tsum += s[i][j]\n\t\t}\n\t}\n\treturn sum\n}"]],"language":[["Go"]]},"created_time":1677844924816,"last_edited_time":1677844938800,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c3872ea3-9c1a-4809-8808-1354fb352bc5":{"role":"reader","value":{"id":"c3872ea3-9c1a-4809-8808-1354fb352bc5","version":15,"type":"bookmark","properties":{"link":[["https://zhuanlan.zhihu.com/p/31859105"]],"title":[["Cache是怎么组织和工作的？"]],"description":[["我的习惯是想到哪里，写到哪里，只管挖坑不管填，近期更是工作繁忙，没有更新Cache部分的内容，实在抱歉。承蒙很多朋友催稿，由此可见Cache的关注度还是不错的，今天带来Cache的第二篇内容。我们经常能够看到2-way…"]]},"format":{"bookmark_icon":"https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.81060cab.png","bookmark_cover":"https://pica.zhimg.com/v2-864713c7a8ec958b0293e9feb3238e66_720w.jpg?source=172ae18b"},"created_time":1677856348135,"last_edited_time":1677856352147,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9a83c73f-8ad3-4c35-be7e-4b95119a1761":{"role":"reader","value":{"id":"9a83c73f-8ad3-4c35-be7e-4b95119a1761","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbn2inqfv5j31aw0z2gz1.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbn2inqfv5j31aw0z2gz1.jpg"},"created_time":1677855813932,"last_edited_time":1677855816394,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"67fadee9-9644-4491-8975-d6d2c4ab2077":{"role":"reader","value":{"id":"67fadee9-9644-4491-8975-d6d2c4ab2077","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbn2n9bbttj31g00zi7jf.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbn2n9bbttj31g00zi7jf.jpg"},"created_time":1677856085303,"last_edited_time":1677856087834,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"68c43586-55c5-4a5f-8ec3-541af7c441da":{"role":"reader","value":{"id":"68c43586-55c5-4a5f-8ec3-541af7c441da","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbn2qwfee0j31he0z2e0o.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbn2qwfee0j31he0z2e0o.jpg"},"created_time":1677856286109,"last_edited_time":1677856288377,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"955b6f88-8345-4e9a-a4f4-3ba6a458b132":{"role":"reader","value":{"id":"955b6f88-8345-4e9a-a4f4-3ba6a458b132","version":718,"type":"text","properties":{"title":[["现在回到真实场景，L1D的大小为32KB，一行Cache line大小为64byte，这样就有512(32KB/64byte)行Cache line，按照8路组相连的规则，会被分为64(512行/8)组。"]]},"created_time":1677856389988,"last_edited_time":1677856647491,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1a7b3b4e-8450-4694-a211-5abcb93e2d74":{"role":"reader","value":{"id":"1a7b3b4e-8450-4694-a211-5abcb93e2d74","version":555,"type":"text","properties":{"title":[["1000*512的int64矩阵内存也按照Cache Line大小划分，因为一行Cache line大小为64byte，一行可以包含8(64byte/8)个元素，512个元素需要64(512/8)行Cache Line大小的内存。"]]},"created_time":1677856675436,"last_edited_time":1677856848717,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9aa9a7e6-3aba-45b5-a115-9b82fd3bdfb4":{"role":"reader","value":{"id":"9aa9a7e6-3aba-45b5-a115-9b82fd3bdfb4","version":723,"type":"text","properties":{"title":[["可以算出矩阵一行的内存块正好被分到L1D的64个组中，这样迭代完第一行之后，后续的行数都会分别被缓存到对应的组里，当迭代次数超过8次后就会出现缓存冲突的问题，然后就会一直导致Cache Miss。"]]},"created_time":1677856849034,"last_edited_time":1677856986987,"parent_id":"f8e41082-81f4-4d47-a6f3-3489e7c3453c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7debbf4c-1e34-4ec7-bd19-708e9846d09f":{"role":"none"},"c344609f-bc31-4c18-bd1f-862c52a36993":{"role":"reader","value":{"id":"c344609f-bc31-4c18-bd1f-862c52a36993","version":12,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hbkofx9925j31040my42u.jpg"]]},"format":{"block_width":528,"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hbkofx9925j31040my42u.jpg","block_full_width":false,"block_page_width":false},"created_time":1677677138141,"last_edited_time":1677677173288,"parent_id":"237e8057-b4ac-4260-b71c-491d34183dd0","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7c2ce0a4-ab7f-46c6-9dc5-07a43ab425cd":{"role":"reader","value":{"id":"7c2ce0a4-ab7f-46c6-9dc5-07a43ab425cd","version":10,"type":"bookmark","properties":{"link":[["https://clivern.com/separate-test-cases-in-golang-with-build-tags/"]],"title":[["Separate Test Cases in Golang With Build Tags | Clivern"]],"description":[["A build tag or a build constraint as described in the build package documentation, is a line comment that begins // +build that lists the conditions under which a file should be included in the package. You can provide build constraints for one file. The tags can then be passed to the go build command,"]]},"format":{"bookmark_icon":"https://clivern.com/wp-content/uploads/2015/08/cropped-icon-192x192.png","bookmark_cover":"https://clivern.com/wp-content/uploads/2021/01/0_YZIFWK0uy9s_BWVW.jpeg"},"created_time":1677765981195,"last_edited_time":1677765981201,"parent_id":"5595aec8-9bdc-4ee6-aad8-885ffa50909a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"18c9eccc-9da6-42f6-8ec8-e88c65be7a5e":{"role":"reader","value":{"id":"18c9eccc-9da6-42f6-8ec8-e88c65be7a5e","version":19,"type":"code","properties":{"title":[["//go:build integration\n// +build integration\n\npackage db\n\nimport (\n\t\"os\"\n\t\"testing\"\n)\n\nfunc TestInsert1(t *testing.T) {\n\t// ...\n}"]],"language":[["Go"]]},"created_time":1677765770282,"last_edited_time":1677765978514,"parent_id":"5595aec8-9bdc-4ee6-aad8-885ffa50909a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"18666ce9-f011-454d-9338-067ff8b091af":{"role":"reader","value":{"id":"18666ce9-f011-454d-9338-067ff8b091af","version":12,"type":"code","properties":{"title":[["func TestInsert2(t *testing.T) {\n\tif os.Getenv(\"INTEGRATION\") != \"true\" {\n\t\tt.Skip(\"skipping integration test\")\n\t}\n\n\t// ..."]],"language":[["Go"]]},"created_time":1677765811794,"last_edited_time":1677766063820,"parent_id":"27701362-dbb7-4aca-b5a6-c08b830ac4b6","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c06a6433-6f93-4703-ba8b-247a1e863581":{"role":"reader","value":{"id":"c06a6433-6f93-4703-ba8b-247a1e863581","version":64,"type":"code","properties":{"title":[["func TestLongRunning(t *testing.T) {\n\tif testing.Short() {\n\t\tt.Skip(\"skipping long-running test\")\n\t}\n\t// ...\n}\n\n// % go test -short -v .\n// === RUN   TestLongRunning\n//     foo_test.go:9: skipping long-running test\n// --- SKIP: TestLongRunning (0.00s)\n// PASS\n// ok      foo  0.174s"]],"language":[["Go"]]},"created_time":1677766144689,"last_edited_time":1677766337274,"parent_id":"ff80f41e-1180-4fc3-9ea2-46b3880651a8","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"261965ec-5673-446b-af34-e55af690c950":{"role":"reader","value":{"id":"261965ec-5673-446b-af34-e55af690c950","version":222,"type":"code","properties":{"title":[["// 并行执行测试，并行最大个数 16\ngo test -parallel 16 ."]],"language":[["Bash"]]},"created_time":1677766548776,"last_edited_time":1677766669048,"parent_id":"25e1958f-8fbe-4705-a749-c9d5055a6e48","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2168ff07-0f1c-4631-8be1-5e0845466c7d":{"role":"reader","value":{"id":"2168ff07-0f1c-4631-8be1-5e0845466c7d","version":7,"type":"code","properties":{"title":[["go test -shuffle=on -v"]],"language":[["Bash"]]},"created_time":1677766710691,"last_edited_time":1677766711004,"parent_id":"facda99f-78f1-48b9-9538-695bc10c8e6f","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f4223d0c-99c0-44ab-b38f-09d099a91481":{"role":"reader","value":{"id":"f4223d0c-99c0-44ab-b38f-09d099a91481","version":10,"type":"image","properties":{"source":[["http://tva1.sinaimg.cn/large/006r0i4lly1hblvq2ildqj31dm0dw493.jpg"]]},"format":{"display_source":"http://tva1.sinaimg.cn/large/006r0i4lly1hblvq2ildqj31dm0dw493.jpg"},"created_time":1677766977800,"last_edited_time":1677766980308,"parent_id":"facda99f-78f1-48b9-9538-695bc10c8e6f","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"010df427-32d2-4c01-bbcc-e9e2f0b55d2d":{"role":"reader","value":{"id":"010df427-32d2-4c01-bbcc-e9e2f0b55d2d","version":7,"type":"code","properties":{"title":[["//go:noinline\nfunc add(a int, b int) int {\n return a + b\n}"]],"language":[["Go"]]},"created_time":1677760408947,"last_edited_time":1677760412774,"parent_id":"cf7bca78-d407-4c2d-899e-b3aeeb1cb3f4","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"dc6458a6-89c5-410a-af4b-3e0f56450ecf":{"role":"reader","value":{"id":"dc6458a6-89c5-410a-af4b-3e0f56450ecf","version":181,"type":"code","properties":{"title":[["// 获得测试覆盖率文件\ngo test -coverprofile=coverage.out ./...\n\n// 可视化展示覆盖率\ngo tool cover -html=coverage.out"]],"language":[["Bash"]]},"created_time":1677764357870,"last_edited_time":1677764407844,"parent_id":"0c142a31-4082-444d-8066-19c3375d698a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c948a666-4c3a-4c1a-8e9d-367833b111bf":{"role":"reader","value":{"id":"c948a666-4c3a-4c1a-8e9d-367833b111bf","version":12,"type":"code","properties":{"title":[["package counter\n\nimport \"sync/atomic\"\n\nvar count uint64\n\nfunc Inc() uint64 {\n\tatomic.AddUint64(\u0026count, 1)\n\treturn count\n}"]],"language":[["Go"]]},"created_time":1677764601940,"last_edited_time":1677764637849,"parent_id":"678b750d-f082-4b28-a37e-c22518645f15","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d7039932-cb0c-4e6a-bde1-6d5c2d4f5ccc":{"role":"reader","value":{"id":"d7039932-cb0c-4e6a-bde1-6d5c2d4f5ccc","version":22,"type":"code","properties":{"title":[["package counter_test\n\nimport (\n\t\"testing\"\n\n\tcounter \"myapp/counter\"\n)\n\nfunc TestCount(t *testing.T) {\n\tif counter.Inc() != 1 {\n\t\tt.Errorf(\"expected 1\")\n\t}\n}"]],"language":[["Go"]]},"created_time":1677764642324,"last_edited_time":1677764679102,"parent_id":"678b750d-f082-4b28-a37e-c22518645f15","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1c10a040-7f54-4a6f-9b72-bfa11b8ec8fb":{"role":"reader","value":{"id":"1c10a040-7f54-4a6f-9b72-bfa11b8ec8fb","version":290,"type":"text","properties":{"title":[["调用 "],["t.Cleanup",[["c"]]],[" 注册一个闭包函数做清理工作，可以在测试结束后被调用来清理环境。"]]},"created_time":1677765002095,"last_edited_time":1677765142184,"parent_id":"f10a3d28-71ca-42c6-90d9-07435feb699c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b9afc4da-dd29-4872-a0f5-29d6233e7b1f":{"role":"reader","value":{"id":"b9afc4da-dd29-4872-a0f5-29d6233e7b1f","version":41,"type":"code","properties":{"title":[["func TestMySQLIntegration(t *testing.T) {\n\t// ...\n\tdb := createConnection(t, \"tcp(localhost:3306)/db\")\n\t// ...\n}\n\nfunc createConnection(t *testing.T, dsn string) *sql.DB {\n\tdb, err := sql.Open(\"mysql\", dsn)\n\tif err != nil {\n\t\tt.FailNow()\n\t}\n\tt.Cleanup(\n\t\tfunc() {\n\t\t\t_ = db.Close()\n\t\t})\n\treturn db\n}"]],"language":[["Go"]]},"created_time":1677764992074,"last_edited_time":1677842946320,"parent_id":"f10a3d28-71ca-42c6-90d9-07435feb699c","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"dd2baae1-8900-4073-854b-bdde392d5b36":{"role":"reader","value":{"id":"dd2baae1-8900-4073-854b-bdde392d5b36","version":192,"type":"page","properties":{"title":[["关于作者"]]},"content":["1d759e84-b1ff-4bae-857e-e2fd95fa9b45","e34dbc42-98d0-4e1d-ad9e-dc6631aa7273","349b10bd-90c8-4db1-afc9-e590d9c60671","5b00c702-1eba-43ce-b04c-4747ed7c04b1","308d038c-dc47-440c-866d-5f06ca7e16fe","4b1a8f14-180e-421d-8af6-8a40a14b8d12","ef634a33-80f6-48d8-bcd4-054e0ec68337","3c187b42-de80-4359-b13b-5c778a6f49a6","274ad047-a46e-4187-b438-129e6cfd5cc8","ade9b3ae-520f-4752-87d4-52a41bb1d875","770dde4e-b74e-4848-8b48-8b1ce3c111ea","2ca1f27b-da43-46f8-b8c0-ef3e05e583d9"],"format":{"page_icon":"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/020bfbea-dbb3-44dd-b5aa-5048fb71462f/IMG_2189.jpg","page_cover":"/images/page-cover/gradients_8.png","page_cover_position":0.3},"permissions":[{"role":"editor","type":"user_permission","user_id":"d1805983-7869-451d-bf8b-64135a5d4ee7"},{"role":"reader","type":"public_permission","added_timestamp":1666532032810}],"created_time":1666531980000,"last_edited_time":1677768743041,"parent_id":"314bb437-f8b5-44ca-a749-b2b1413baa58","parent_table":"block","alive":true,"file_ids":["5349e794-a695-40dd-8bb5-4ea012d8b3f0","0dba7a3b-a420-477f-a184-076421f71ce6","020bfbea-dbb3-44dd-b5aa-5048fb71462f"],"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"314bb437-f8b5-44ca-a749-b2b1413baa58":{"role":"reader","value":{"id":"314bb437-f8b5-44ca-a749-b2b1413baa58","version":5,"type":"column","content":["dd2baae1-8900-4073-854b-bdde392d5b36"],"format":{"column_ratio":0.5},"created_time":1666625040000,"last_edited_time":1666625040000,"parent_id":"82aad922-cb77-4452-81bf-56f4e8e5a408","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"82aad922-cb77-4452-81bf-56f4e8e5a408":{"role":"reader","value":{"id":"82aad922-cb77-4452-81bf-56f4e8e5a408","version":5,"type":"column_list","content":["314bb437-f8b5-44ca-a749-b2b1413baa58","c7c8db4e-2a84-4461-9042-c0ccd0c86b7a"],"created_time":1666625040000,"last_edited_time":1666625040000,"parent_id":"72a66971-7cf6-42c2-a252-4439d99d8f44","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1d759e84-b1ff-4bae-857e-e2fd95fa9b45":{"role":"reader","value":{"id":"1d759e84-b1ff-4bae-857e-e2fd95fa9b45","version":39,"type":"sub_header","properties":{"title":[["About Me"]]},"created_time":1677585426899,"last_edited_time":1677585433015,"parent_id":"dd2baae1-8900-4073-854b-bdde392d5b36","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}}},"collection":{"89829c97-9e4b-43b0-b37c-457a3da9ad96":{"role":"reader","value":{"id":"89829c97-9e4b-43b0-b37c-457a3da9ad96","version":50,"name":[["读书笔记"]],"schema":{"Zr\u003cq":{"name":"Tags","type":"multi_select","options":[{"id":"24b84736-a103-42ac-9240-4822e0f65e43","color":"brown","value":"golang"}]},"vRhJ":{"name":"Created","type":"created_time"},"z`pV":{"name":"Text","type":"text"},"title":{"name":"Name","type":"title"}},"icon":"/icons/book_gray.svg","format":{"copied_from_pointer":{"id":"802f1041-8e8c-4dfb-9a7e-828adc379fe9","table":"collection","spaceId":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"},"collection_page_properties":[{"visible":true,"property":"vRhJ"},{"visible":true,"property":"Zr\u003cq"}]},"parent_id":"e7596c25-bafa-4ece-94b6-e7973c7a2ab3","parent_table":"block","alive":true,"file_ids":["bc7d6ffa-a7ed-4623-9b4b-760071f91143","53747170-d36e-41e1-b2b7-bc3fe775c828","2f5c27c6-3d03-4a36-9426-254d118d3831","43cb5540-5d53-449b-83bd-609b24688d0b","982ec7e7-aebe-4e08-b2be-22f8f4fe0275","85f9e952-304a-46a7-99e1-0b8806f8fa2e","76a743a7-2ac6-426f-810b-87b2b7091d16"],"copied_from":"802f1041-8e8c-4dfb-9a7e-828adc379fe9","migrated":true,"space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}}},"collection_view":{"11f62eb2-ba92-4ffd-91b4-c964b8cedfeb":{"role":"reader","value":{"id":"11f62eb2-ba92-4ffd-91b4-c964b8cedfeb","version":7,"type":"gallery","name":"Blog","format":{"gallery_cover":{"type":"page_cover"},"collection_pointer":{"id":"89829c97-9e4b-43b0-b37c-457a3da9ad96","table":"collection","spaceId":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"},"gallery_properties":[{"visible":true,"property":"title"},{"visible":true,"property":"vRhJ"},{"visible":true,"property":"Zr\u003cq"},{"visible":true,"property":"z`pV"}],"collection_peek_mode":"full_page","gallery_cover_aspect":"cover"},"parent_id":"e7596c25-bafa-4ece-94b6-e7973c7a2ab3","parent_table":"block","alive":true,"page_sort":["6838510a-0002-4284-b31b-f6587ab3eae0","d3ecd552-789f-452c-8753-2f0226325f65","a8bd2ec9-1288-4669-9940-ad46c5539100","3397e27f-0e8a-49b8-89ae-67d10e3d94fa","db80f497-e22c-4bff-bdcb-0ac06b5c4528","f8e41082-81f4-4d47-a6f3-3489e7c3453c","e04337ab-49dd-4dfe-80b2-0330e8da5e06"],"query2":{"aggregations":[{"aggregator":"count"}]},"space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}}},"notion_user":{},"collection_query":{},"signed_urls":{"f8e41082-81f4-4d47-a6f3-3489e7c3453c":"https://s3.us-west-2.amazonaws.com/secure.notion-static.com/47263733-11bc-4ae7-9e1e-c3401a49c171/Manning.100.Go.Mistakes.and.How.to.Avoid.Them.2022-1%EF%BC%88%E6%8B%96%E7%A7%BB%E9%A1%B9%E7%9B%AE%EF%BC%89.png?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Content-Sha256=UNSIGNED-PAYLOAD\u0026X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20230303%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20230303T152350Z\u0026X-Amz-Expires=86400\u0026X-Amz-Signature=8be65ca89f51dc6b84482d3fab29fec252e1ead81325ffca07542b629e8a3e1c\u0026X-Amz-SignedHeaders=host\u0026x-id=GetObject"},"preview_images":{"notion.so/image/s3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F47263733-11bc-4ae7-9e1e-c3401a49c171%2FManning.100.Go.Mistakes.and.How.to.Avoid.Them.2022-1%EF%BC%88%E6%8B%96%E7%A7%BB%E9%A1%B9%E7%9B%AE%EF%BC%89.png":{"originalWidth":2000,"originalHeight":2508,"dataURIBase64":"data:image/webp;base64,UklGRkoAAABXRUJQVlA4ID4AAACQAQCdASoNABAABUB8JZQAAUJYnCAA/i3sgO0Yegdb+5LvlWhw/psHDLyVDpX8zYYcjaZB/BXtD4y71SAAAA=="},"notion.so/image/s3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa22fb73f-5a7d-4fdc-8319-52ed15316e76%2Fimages.jpeg":{"originalWidth":2000,"originalHeight":1159,"dataURIBase64":"data:image/webp;base64,UklGRjwAAABXRUJQVlA4IDAAAACwAQCdASoQAAkABUB8JQAAT6/36IiAAP4EcU3AJPD5WZWYi6rGw+MWNhG0kKdLMAA="},"notion.so/image/s3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F37907dd5-3c76-4966-a419-daa027a84972%2FIMG_2189.jpg":{"originalWidth":2000,"originalHeight":2003,"dataURIBase64":"data:image/webp;base64,UklGRmoAAABXRUJQVlA4IF4AAADQAQCdASoQABAABUB8JbACdAERATxWoAD+0Vlxx+kOh3kDC0Z3s4OjUZzRpnTiXUiN5qtuCLGbw3Q3meKHmbJDj3X9KoWlb/kas/KasMX31nkEcPwD09TPGVsO8AAA"},"notion.so/image/img2.doubanio.com%2Fview%2Fsubject%2Fl%2Fpublic%2Fs34311243.jpg":{"originalWidth":2000,"originalHeight":2507,"dataURIBase64":"data:image/webp;base64,UklGRk4AAABXRUJQVlA4IEIAAACwAQCdASoNABAABUB8JZQAAcCzMdgAAP1pPb5smyxoh54e7LDGK8Yk2gEHbh/20RBmhShKjfB1bjvvEl7pU7XAAAA="},"notion.so/image/img1.doubanio.com%2Ffavicon.ico":null,"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfjzjehr4j30tc0ccq5c.jpg":{"originalWidth":2000,"originalHeight":841,"dataURIBase64":"data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAAAwAQCdASoQAAcABUB8JZQAA3AA/vBmGaPoMMfT+4RThezUN53k8lwNzeTsgAAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfjzrczn0j30t00bmgnc.jpg":{"originalWidth":2000,"originalHeight":801,"dataURIBase64":"data:image/webp;base64,UklGRjYAAABXRUJQVlA4ICoAAACQAQCdASoQAAYABUB8JZQAApuLmvgA/usyeOnRnoxEhb3C52zBu7IA3AA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfkkxdgp1j31gw0i6tel.jpg":{"originalWidth":2000,"originalHeight":687,"dataURIBase64":"data:image/webp;base64,UklGRiwAAABXRUJQVlA4ICAAAACQAQCdASoQAAUABUB8JZwAAudR6dAA/sYFJUtPYAAAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfqoq89goj31ja0tmani.jpg":{"originalWidth":2000,"originalHeight":1071,"dataURIBase64":"data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACwAQCdASoQAAkABUB8JQAAXOudR8AAAP7tzTjaDKMHDJ3iIuQAAyBaRRsyGwAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbfr8gkmhjj319a0hatdy.jpg":{"originalWidth":2000,"originalHeight":763,"dataURIBase64":"data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAAAwAQCdASoQAAYABUB8JYwAA3AA/vBl/VgRnYjho4mzKY1AAAA="},"notion.so/image/golang.design%2Funder-the-hood%2Ffavicon.png":{"originalWidth":2000,"originalHeight":2000,"dataURIBase64":"data:image/webp;base64,UklGRnwAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSD0AAAARL0AWYJocyO4IEugqIgK/FAohSXLmEE5hFR4hGPz6w3w2iOj/BPB/2HYPtOSwLIPa5mAvSdOwHUBmJj8BAFZQOCAYAAAAMAEAnQEqEAAQAAVAfCWkAANwAP7w5sAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbibdjgitaj31q80meank.jpg":{"originalWidth":2000,"originalHeight":720,"dataURIBase64":"data:image/webp;base64,UklGRkIAAABXRUJQVlA4IDYAAADwAQCdASoQAAYABUB8JQBdgCIhCA5MkBgA/u/D+wKXNbqWDcr/ALDtIhD/DxlKxDxIjiT4AAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjepyykqj31ca0lg47c.jpg":{"originalWidth":2000,"originalHeight":888,"dataURIBase64":"data:image/webp;base64,UklGRkAAAABXRUJQVlA4IDQAAABwAQCdASoQAAcABUB8JQAAXILjAAD+78P0LX+qJKHEgMI0ar+zRjIgffCYuPUeFApoAAAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjgb39klj310s0juwh4.jpg":{"originalWidth":2000,"originalHeight":1079,"dataURIBase64":"data:image/webp;base64,UklGRigAAABXRUJQVlA4IBwAAAAwAQCdASoQAAkABUB8JaQAA3AA/vCTr0unFgAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjsatms6j310a0m8q8p.jpg":{"originalWidth":2000,"originalHeight":1225,"dataURIBase64":"data:image/webp;base64,UklGRkQAAABXRUJQVlA4IDgAAADQAQCdASoQAAoABUB8JZAAAudSvXUaAAD+78Nlqe7GDD+q7mOMW/2C5MYVqQTcWQBmV3rBjogAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjx84ansj31bs10yaip.jpg":{"originalWidth":2000,"originalHeight":1547,"dataURIBase64":"data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAABwAQCdASoQAAwABUB8JQAAXOi1gAD+78PTalf6BwRerTmRXpyaRDAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjjzxzub1j31520s445i.jpg":{"originalWidth":2000,"originalHeight":1369,"dataURIBase64":"data:image/webp;base64,UklGRjgAAABXRUJQVlA4ICwAAACwAQCdASoQAAsABUB8JQAAXQXhlZwAAP7vvWec+Y0zLFdOWoXJvR5h4AAAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjh3fld7pj31eg0n6n7d.jpg":{"originalWidth":2000,"originalHeight":919,"dataURIBase64":"data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAACwAQCdASoQAAcABUB8JZQAAxZgjkQAAP7nrpu3K66aoH3cjtsAS8gA"},"notion.so/image/geektutu.com%2Fimg%2Ficon.png":{"originalWidth":2000,"originalHeight":2000,"dataURIBase64":"data:image/webp;base64,UklGRmYAAABXRUJQVlA4IFoAAABwAgCdASoQABAABUB8JbACdH8AFC6wyImyc7DAAPaOm7ZuB9T9glxeiEuAabs/A/Yx58LekgPLrFy+aWU25Bqx00Pi1ZMHr4aDoxmAEN/qo7Ux6LN80bBgAAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjiirbgghj31f60hywhb.jpg":{"originalWidth":2000,"originalHeight":701,"dataURIBase64":"data:image/webp;base64,UklGRigAAABXRUJQVlA4IBwAAAAwAQCdASoQAAYABUB8JaQAA3AA/vBnJdvxRIAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjiqad262j31aq0rsaib.jpg":{"originalWidth":2000,"originalHeight":1189,"dataURIBase64":"data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAAAwAQCdASoQAAoABUB8JZwAA3AA/vBkMLPCIt2QO3UjS1tNtwaAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbjj0adk20j31200i2q9f.jpg":{"originalWidth":2000,"originalHeight":950,"dataURIBase64":"data:image/webp;base64,UklGRjwAAABXRUJQVlA4IDAAAACwAQCdASoQAAgABUB8JQAAXUjdZLLAAP7vxEd0wiRocXfi5fbFND1NmUxfYhGGAAA="},"notion.so/image/pic1.zhimg.com%2Fv2-9281b3e47858daa5e9086f0a0047d116_720w.jpg":{"originalWidth":2000,"originalHeight":1111,"dataURIBase64":"data:image/webp;base64,UklGRjwAAABXRUJQVlA4IDAAAACwAQCdASoQAAkABUB8JaQAAt0LI1EAAP7tnv1Q2LXteOfrlWNMUsU7SJ8XcwL0AAA="},"notion.so/image/static.zhihu.com%2Fheifetz%2Fassets%2Fapple-touch-icon-152.81060cab.png":{"originalWidth":2000,"originalHeight":2000,"dataURIBase64":"data:image/webp;base64,UklGRrYAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSDgAAAARD9D/iAiwqa29yZe2RlM8ZOpZYwCUsLaJtXcc4AQT6Ijof2j0JOARpfxMNeSk/q5WBwq8WJExAlZQOCBYAAAAMAIAnQEqEAAQAAVAfCWwAnS6ABCSD7Rp2IAA/Rq9d/8IprfV7WTm9aip9ilUb3xYIZJjsRUozTXvOQ8J1LIspl6/6D5nunMzyQ0H8jfeZ9M97aFyegAAAA=="},"notion.so/image/picx.zhimg.com%2Fv2-fae5dcfcf8827c6066d51f9b12cd9864_720w.jpg":{"originalWidth":2000,"originalHeight":808,"dataURIBase64":"data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAAAwAQCdASoQAAYABUB8JaQAA3AA/vBJ+7MeyZP9TBvjO/SAAAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkoxg0061j31a40cmwj2.jpg":{"originalWidth":2000,"originalHeight":547,"dataURIBase64":"data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACwAQCdASoQAAQABUB8JaQAAu19ie/gAP7ta0kIY8QrWGYASGAAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkoxuh1sij319c0ccjx3.jpg":{"originalWidth":2000,"originalHeight":544,"dataURIBase64":"data:image/webp;base64,UklGRi4AAABXRUJQVlA4ICIAAADQAQCdASoQAAQABUB8JaQAAueGu1VMAAD+7cYA+gRAAAAA"},"notion.so/image/manjusaka.blog%2Fimg%2Fog_image.png":{"originalWidth":2000,"originalHeight":1050,"dataURIBase64":"data:image/webp;base64,UklGRjgAAABXRUJQVlA4ICwAAAAwAQCdASoQAAgABUB8JZQAA3AA/vCAenTKTsOBz4xgQ077BXZ+UKG97M+AAA=="},"notion.so/image/user-images.githubusercontent.com%2F7054676%2F56820343-2fe1b580-687e-11e9-8f6f-778df3a8eafd.png":{"originalWidth":2000,"originalHeight":1993,"dataURIBase64":"data:image/webp;base64,UklGRnQAAABXRUJQVlA4IGgAAADQAQCdASoQABAABUB8JbACdAdwA9g8+AD+yNW/badNZ7FtlQtPwxNagUxzJaJlceYls4PpyPEAc/wCwsSyBsY3lFTevNnrVVfsWwLY+bA7COpLsyXtHSddlbfaojguDZIq/yVh4IdgAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkl8uy7mxj319c0jkwkx.jpg":{"originalWidth":2000,"originalHeight":863,"dataURIBase64":"data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAACQAQCdASoQAAcABUB8JYwAAudQDBAA/u/DbQ+4c6ikAPcNQAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbklkt9cxrj316s0i243s.jpg":{"originalWidth":2000,"originalHeight":844,"dataURIBase64":"data:image/webp;base64,UklGRjYAAABXRUJQVlA4ICoAAACwAQCdASoQAAcABUB8JQAAXWUGinAAAP7vxZfvfflzp+h3Z6l8MulAAAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbklrxm43yj30z60hiwj0.jpg":{"originalWidth":2000,"originalHeight":995,"dataURIBase64":"data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAAAwAQCdASoQAAgABUB8JQAAbgAA/vBmEoDgg4jt4ZqmrHWzKYkgAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkn8dimu6j312g0bs42e.jpg":{"originalWidth":2000,"originalHeight":613,"dataURIBase64":"data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAACwAQCdASoQAAUABUB8JZwAAu0dYNzQAP7q3H7ds2TljmQ8AAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkmqobncij31480cqgoz.jpg":{"originalWidth":2000,"originalHeight":633,"dataURIBase64":"data:image/webp;base64,UklGRiwAAABXRUJQVlA4ICAAAACQAQCdASoQAAUABUB8JaQAAudZtgAA/u3GJPSKDvAAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkn98yhstj315g0fo78p.jpg":{"originalWidth":2000,"originalHeight":756,"dataURIBase64":"data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAACwAQCdASoQAAYABUB8JZwAAq9EBEnAAP7toHeO7YWSt8CObJJcgyAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkndg329oj31ag08kjwv.jpg":{"originalWidth":2000,"originalHeight":368,"dataURIBase64":"data:image/webp;base64,UklGRi4AAABXRUJQVlA4ICIAAACQAQCdASoQAAMABUB8JYwAAujbZdAA/u/FZyjhUvprygAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbluxpm2fqj30la0ci0uc.jpg":{"originalWidth":2000,"originalHeight":1175,"dataURIBase64":"data:image/webp;base64,UklGRjgAAABXRUJQVlA4ICwAAACQAQCdASoQAAkABUB8JaQAAp0JGAAA/vHgwiu0daRTMfWD5vUiX/I3EAAAAA=="},"notion.so/image/dave.cheney.net%2Ffavicon.ico":null,"notion.so/image/cdn.sstatic.net%2FSites%2Fstackoverflow%2FImg%2Fapple-touch-icon%402.png":{"originalWidth":2000,"originalHeight":2000,"dataURIBase64":"data:image/webp;base64,UklGRrIAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSEgAAAARL6CgbRs2VTbt/omIwHPCwCiSJEV59F8wsHvwRwUk4PwrOgcR/U+/RiB8DVjnAeT7BNfdQZluKPE4E9bpmA+seUwHyvs8ix9WUDggRAAAAFACAJ0BKhAAEAAFQHwlsAJ0VAC7K943/9AO4AD+3yf6HtzpRo2x8s6Ijl+4c5jqg90ZvZ+chd1b/WRwhQSWZRRufAAA"},"notion.so/image/cdn.sstatic.net%2FSites%2Fstackoverflow%2FImg%2Fapple-touch-icon.png":{"originalWidth":2000,"originalHeight":2000,"dataURIBase64":"data:image/webp;base64,UklGRrQAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSEUAAAARL6AmABI2RxRucBsRgfaLYBRJtpMucJDuP94DGIj+deEgov/p1wDCNYFWdrDeJ7iPGUJ+ICzHmdDyWQ60NS0nwve+1Q8AVlA4IEgAAAAwAgCdASoQABAABUB8JbACdDiAN5DBkIL5YAD8Qinke/q889yo9g035WPfLcd8dxHCK0oPnIUG9M+Qbtcz9Bp+/l+qbyEAAAA="},"notion.so/image/pkg.go.dev%2Fstatic%2Fshared%2Ficon%2Ffavicon.ico":null,"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblqycs54hj31e80b6jwa.jpg":{"originalWidth":2000,"originalHeight":445,"dataURIBase64":"data:image/webp;base64,UklGRi4AAABXRUJQVlA4ICIAAACwAQCdASoQAAQABUB8JZQAAxalyJIAAP7tlqSwWHkoB8AA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblr850zbgj31eo0cutdw.jpg":{"originalWidth":2000,"originalHeight":507,"dataURIBase64":"data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAACwAQCdASoQAAQABUB8JZwAAxf+5/AAAP7g2t0+6ErGXJzIAAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblrwgav5vj317k0gun42.jpg":{"originalWidth":2000,"originalHeight":773,"dataURIBase64":"data:image/webp;base64,UklGRi4AAABXRUJQVlA4ICIAAACwAQCdASoQAAYABUB8JaQAAvd3BJgAAP7n+oluAtCWgAAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbls3gwljrj317u0iitgl.jpg":{"originalWidth":2000,"originalHeight":844,"dataURIBase64":"data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAADQAQCdASoQAAcABUB8JaQAAscEGeYwAAD+7W8wXFrk+aQL7p73UwAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblshj22g8j31ci0pg7cf.jpg":{"originalWidth":2000,"originalHeight":1049,"dataURIBase64":"data:image/webp;base64,UklGRj4AAABXRUJQVlA4IDIAAADQAQCdASoQAAgABUB8JaQAAusfKtacAAD+6GCOkJkmC7wIE2VOwmkJ/HUlj/HGzAAAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblu0ivr0oj31dc0tqtjc.jpg":{"originalWidth":2000,"originalHeight":1205,"dataURIBase64":"data:image/webp;base64,UklGRjYAAABXRUJQVlA4ICoAAACQAQCdASoQAAoABUB8JaQAAudZN8AA/u/OaqpXS5QaYf6i/20dUUymAAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblu30b7w2j31580k0grq.jpg":{"originalWidth":2000,"originalHeight":970,"dataURIBase64":"data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAADQAQCdASoQAAgABUB8JZwAAudkbzxmAAD+7c1iH5Jjc9BDAAA="},"notion.so/image/pic1.zhimg.com%2Fv2-b044ecf48648f83743602ddf9ae4a7ac_r.jpg":{"originalWidth":2000,"originalHeight":924,"dataURIBase64":"data:image/webp;base64,UklGRjAAAABXRUJQVlA4ICQAAACwAQCdASoQAAcABUB8JZQAAqsHVRAAAP7fhaOWgJ57eTXZAAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbmwsvsyz0j31py0ryk4x.jpg":{"originalWidth":2000,"originalHeight":902,"dataURIBase64":"data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAABwAQCdASoQAAcABUB8JZ2HgAGIAAD+8E4TH1KOAa9t3bA1kAAAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbmwzxix54j31so0ucjz7.jpg":{"originalWidth":2000,"originalHeight":938,"dataURIBase64":"data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAAAwAQCdASoQAAgABUB8JZwAA3AA/vB+uXCjcusQ6TyL/pUJRfrOAAAA"},"notion.so/image/pica.zhimg.com%2Fv2-864713c7a8ec958b0293e9feb3238e66_720w.jpg":{"originalWidth":2000,"originalHeight":1125,"dataURIBase64":"data:image/webp;base64,UklGRm4AAABXRUJQVlA4IGIAAADwAQCdASoQAAkABUB8JbACdADp/qHRQIAA4dxzwYUI31zmLkPO23tJCU8j9Wd+A5wxU0GaWBbAUQtGQ0DcJnLzUG1FbP7o7wr3hXv5lgSYSl+92q3m4ztSwArH8WcPzCAAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbn2inqfv5j31aw0z2gz1.jpg":{"originalWidth":2000,"originalHeight":1495,"dataURIBase64":"data:image/webp;base64,UklGRkgAAABXRUJQVlA4IDwAAADQAQCdASoQAAwABUB8JZgAAuQDY9d6AAD+7d2UH3XbJIWPO70dX1er3GJB7G1Oi1PIA0U2gCZXvipwAAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbn2n9bbttj31g00zi7jf.jpg":{"originalWidth":2000,"originalHeight":1365,"dataURIBase64":"data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAADQAQCdASoQAAsABUB8JZwAAxZhLTwcQAD+6yZupTEB4CUSQI59T7v+4Y4oAAAA"},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbn2qwfee0j31he0z2e0o.jpg":{"originalWidth":2000,"originalHeight":1313,"dataURIBase64":"data:image/webp;base64,UklGRkgAAABXRUJQVlA4IDwAAADQAQCdASoQAAsABUB8JaQAAp0jh5V2gAD+64SQ92av0QstgwYYWUgCTp926jDXItfARSLd5/TFNlZ0AAA="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hbkofx9925j31040my42u.jpg":{"originalWidth":2000,"originalHeight":1271,"dataURIBase64":"data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAAAwAQCdASoQAAoABUB8JZQAA3AA/vBNe7Pr2YZOuhfObAEVAAEwAAAA"},"notion.so/image/clivern.com%2Fwp-content%2Fuploads%2F2021%2F01%2F0_YZIFWK0uy9s_BWVW.jpeg":{"originalWidth":2000,"originalHeight":1333,"dataURIBase64":"data:image/webp;base64,UklGRlYAAABXRUJQVlA4IEoAAAAwAgCdASoQAAsABUB8JYwCdAELV1gytlScUAD+L3yNFFJK3QMfzIXxImbHNlYsmb3z0De5drFR5gRYEdd6wk7xRsW9J1UeiH8IAA=="},"notion.so/image/clivern.com%2Fwp-content%2Fuploads%2F2015%2F08%2Fcropped-icon-192x192.png":{"originalWidth":2000,"originalHeight":2000,"dataURIBase64":"data:image/webp;base64,UklGRowAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSE4AAAARL0AkQJrjENqsRkTQ3YBpJMmq5r3/A2DPnj17vPyDufs5RPR/AvjtR7O+xMwLK+BTJ9yqhU6FECkHPCIzwCKSq0LEK94T826tLrQiZ5lWUDggGAAAADABAJ0BKhAAEAAFQHwlpAADcAD+8ObAAA=="},"notion.so/image/tva1.sinaimg.cn%2Flarge%2F006r0i4lly1hblvq2ildqj31dm0dw493.jpg":{"originalWidth":2000,"originalHeight":560,"dataURIBase64":"data:image/webp;base64,UklGRj4AAABXRUJQVlA4IDIAAACwAQCdASoQAAQABUB8JbAAAudJ3/oAAP7tSe6PsUkHzDrlym84Xf/2t61e2aNPoAAAAA=="},"notion.so/image/notion.so%2Fimages%2Fpage-cover%2Fgradients_8.png":{"originalWidth":2000,"originalHeight":2000,"dataURIBase64":"data:image/webp;base64,UklGRjwAAABXRUJQVlA4IDAAAAAQAgCdASoQABAABUB8JbACdAD0rs0LxfQAAN2Q17E9Qv7sg8pZvQfdquRRRGrAAAA="},"notion.so/image/s3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F020bfbea-dbb3-44dd-b5aa-5048fb71462f%2FIMG_2189.jpg":{"originalWidth":2000,"originalHeight":2003,"dataURIBase64":"data:image/webp;base64,UklGRmoAAABXRUJQVlA4IF4AAADQAQCdASoQABAABUB8JbACdAERATxWoAD+0Vlxx+kOh3kDC0Z3s4OjUZzRpnTiXUiN5qtuCLGbw3Q3meKHmbJDj3X9KoWlb/kas/KasMX31nkEcPwD09TPGVsO8AAA"}}},"pageId":"f8e41082-81f4-4d47-a6f3-3489e7c3453c"},"__N_SSG":true},"page":"/[pageId]","query":{"pageId":"100-go-mistakes-and-how-to-avoid-them--2"},"buildId":"0gmm17Dg8k1mKjTGxsMiT","isFallback":false,"dynamicIds":[635,3358],"gsp":true,"scriptLoader":[]}</script></body></html>