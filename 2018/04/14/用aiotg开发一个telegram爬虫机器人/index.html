<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 基于aiotg创建一个telegram爬虫机器人 · yangsoon</title><meta name="description" content="基于aiotg创建一个telegram爬虫机器人 - yangs"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://yangsoon.github.io/atom.xml" title="yangsoon"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yangsoon" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://www.zhihu.com/people/song-yang-91-69/activities" target="_blank" class="nav-list-link">ZHIHU</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">基于aiotg创建一个telegram爬虫机器人</h1><div class="post-info">2018年4月14日</div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="http://stepan.xyz/aiotg/index.html" target="_blank" rel="noopener">aiotg</a> 可以通过异步调用telegram api的方式来构建bot，因为决定开发一个爬虫功能的bot，所以网络请求阻塞是比较严重的性能障碍。而asyncio的异步非阻塞特性能够完美的解决这一问题。这篇文章在记录如何使用aiotg进行telegram开发的同时，也会说明一些aiohttp的使用方法,这里是<a href="https://github.com/yangsoon/funny-bot" target="_blank" rel="noopener">项目源码</a>。</p>
<p><a href="https://t.me/fpicturebot" target="_blank" rel="noopener">https://t.me/fpicturebot</a> 点击链接可以体验一下这个bot的功能。</p>
<div class="tip"><br>如果读者之前对telegram的bot没有了解，可以查看这篇<a href="/2017/11/21/telegram-bots-for-developers/">写给开发者的telegram-bots介绍文档</a><br></div>

<a id="more"></a>
<h2 id="aiotg简单教程"><a href="#aiotg简单教程" class="headerlink" title="aiotg简单教程"></a>aiotg简单教程</h2><h4 id="1-一个最简单的bot"><a href="#1-一个最简单的bot" class="headerlink" title="1.一个最简单的bot"></a>1.一个最简单的bot</h4><div class="tip"><br>你可以先学习如何<a href="/2017/11/21/telegram-bots-for-developers/#newbot">新建</a>一个机器人<br></div>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> aiotg <span class="keyword">import</span> Bot, Chat</span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">    <span class="string">"api_token"</span>: <span class="string">"***********"</span>,</span><br><span class="line">    <span class="string">"proxy"</span>: <span class="string">"http://127.0.0.1:8118"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bot = Bot(**config)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bot.command(r"/echo (.+)")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo</span><span class="params">(chat: Chat, match)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> chat.reply(match.group(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">bot.run()</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1fqi7geixaqj31og1aowpx.jpg" alt="运行结果"></p>
<p>上面是一个简单的回复机器人，当你使用指令 <code>/echo</code>+内容时，机器人会自动回复给你发送的内容。这里要注意一点，在我这里没有采用使用  <code>pipenv</code>  ( <code>pip</code> ) 安装aiotg的方法，因为pip平台上安装的是master分支的包，aiotg通过使用aiohttp来调用telegram bot api，在创建一个bot的时候没有提供<code>proxy</code>选项为aiohttp设置代理，在本地开发的时候会因为国内网络抽搐出现网络连接错误，所以在这里我使用了aiotg的proxy分支，直接从github上下载的代码。在创建Bot对象的时候加入proxy选项就能使用本地代理来进行开发调试了。</p>
<div class="tip"><br>后来我在aiotg telegram群里建议作者将proxy合并到主分支，后来作者表示他也有这样的想法，同时他也吐槽了一下俄罗斯的网络也有很多审查和限制，现在在aiotg里已经没有proxy分支了，在aiotg-0.9.9版本中提供proxy选项，所以大家可以继续使用pipenv下载aiotg包。<br></div>

<h4 id="2-aiotg异步特性"><a href="#2-aiotg异步特性" class="headerlink" title="2.aiotg异步特性"></a>2.aiotg异步特性</h4><p>既然用到aiotg来开发就是看中了他的异步特性，下面就列出一个简单的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> aiotg <span class="keyword">import</span> Bot, Chat</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'token.conf'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    token = json.loads(f.read())</span><br><span class="line"></span><br><span class="line">bot = Bot(**token)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bot.command("/fetch")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">async_fecth</span><span class="params">(chat: Chat, match)</span>:</span></span><br><span class="line">    url = <span class="string">"http://www.gamersky.com/ent/111/"</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> sesssion:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> sesssion.get(url) <span class="keyword">as</span> resp:</span><br><span class="line">            info = <span class="string">' version: &#123;&#125;\n status :&#123;&#125;\n method: &#123;&#125;\n url: &#123;&#125;\n'</span>.format(</span><br><span class="line">                resp.version, resp.status, resp.method, resp.url)</span><br><span class="line">            <span class="keyword">await</span> chat.send_text(info)</span><br><span class="line"></span><br><span class="line">bot.run(debug=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1fqi8fxvvdjj31og1aona6.jpg" alt="运行结果"></p>
<h4 id="3-自定义键盘"><a href="#3-自定义键盘" class="headerlink" title="3. 自定义键盘"></a><a id="keyboards" style="color: black">3. 自定义键盘</a></h4><p>关于<a href="https://core.telegram.org/bots#keyboards" target="_blank" rel="noopener">自定义键盘</a>的内容可以点击链接查看官方解释，<a href="/2017/11/21/telegram-bots-for-developers/#keyboards">这里</a>是简单的中文描述。</p>
<p><code>category.json</code><br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"dynamic"</span>,</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"动态图"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"http://www.gamersky.com/ent/111/"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"oops"</span>,</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"囧图"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"http://www.gamersky.com/ent/147/"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"beauty"</span>,</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"福利图"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"http://tag.gamersky.com/news/66.html"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"easy-moment"</span>,</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"轻松一刻"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"http://www.gamersky.com/ent/20503/"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"trivia"</span>,</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"冷知识"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"http://www.gamersky.com/ent/198/"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"cold-tucao"</span>,</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"冷吐槽"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"http://www.gamersky.com/ent/20108/"</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p><code>main.py</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> aiotg <span class="keyword">import</span> Bot, Chat</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'token.json'</span>) <span class="keyword">as</span> t, open(<span class="string">'category.json'</span>) <span class="keyword">as</span> c:</span><br><span class="line">    token = json.loads(t.read())</span><br><span class="line">    category = json.loads(c.read())</span><br><span class="line"></span><br><span class="line">bot = Bot(**token)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bot.command("/reply")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">resply</span><span class="params">(chat: Chat, match)</span>:</span></span><br><span class="line">    kb = [[item[<span class="string">'title'</span>]] <span class="keyword">for</span> item <span class="keyword">in</span> category]</span><br><span class="line">    keyboard = &#123;</span><br><span class="line">        <span class="string">"keyboard"</span>: kb,</span><br><span class="line">        <span class="string">"resize_keyboard"</span>: <span class="keyword">True</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> chat.send_text(text=<span class="string">"看看你的键盘"</span>, reply_markup=json.dumps(keyboard))</span><br><span class="line"></span><br><span class="line">bot.run(debug=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure></p>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1fqnftc74voj31og1aoqh4.jpg" alt=""></p>
<p>只需要在调用chat的发送消息函数中，指定 <code>reply_markup</code> 参数，你就能个性化的设定用户键盘， <code>reply_markup</code> 参数需要一个json对象，官方指定为<a href="https://core.telegram.org/bots/api#replykeyboardmarkup" target="_blank" rel="noopener">ReplyKeyboardMarkup</a>类型，其中<code>keyboard</code>需要传递一个<a href="https://core.telegram.org/bots/api#keyboardbutton" target="_blank" rel="noopener">KeyboardButton</a>的数组。</p>
<p>每个keyboard的成员代表着键盘中的行，你可以通过修改每行中KeyboardButton的个数来排列你的键盘，比如我们让键盘每行显示两个KeyboardButton，如下所示</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bot.command("/reply")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">reply</span><span class="params">(chat: Chat, match)</span>:</span></span><br><span class="line">    <span class="comment"># kb = [[item['title']] for item in category]</span></span><br><span class="line">    kb, row = [], <span class="number">-1</span></span><br><span class="line">    <span class="keyword">for</span> idx, item <span class="keyword">in</span> enumerate(category):</span><br><span class="line">        <span class="keyword">if</span> idx % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            kb.append([])</span><br><span class="line">            row += <span class="number">1</span></span><br><span class="line">        kb[row].append(item[<span class="string">'title'</span>])</span><br><span class="line">    keyboard = &#123;</span><br><span class="line">        <span class="string">"keyboard"</span>: kb,</span><br><span class="line">        <span class="string">"resize_keyboard"</span>: <span class="keyword">True</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> chat.send_text(text=<span class="string">"看看你的键盘"</span>, reply_markup=json.dumps(keyboard))</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1fqng7pn535j31og1aok5k.jpg" alt=""></p>
<h4 id="4-内联键盘和消息更新"><a href="#4-内联键盘和消息更新" class="headerlink" title="4. 内联键盘和消息更新"></a><a id="inlinekeyboards" style="color: black">4. 内联键盘和消息更新</a></h4><p><a href="/2017/11/21/telegram-bots-for-developers/#inlinekeyboards">内联键盘</a>的意思就是附着在消息上的键盘，内联键盘由内联按钮组成，每个按钮会附带一个回调数据，每次点击按钮之后会有对应的回调函数处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bot.command("/inline")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">inlinekeyboard</span><span class="params">(chat: Chat, match)</span>:</span></span><br><span class="line"></span><br><span class="line">    inlinekeyboardmarkup = &#123;</span><br><span class="line">            <span class="string">'type'</span>: <span class="string">'InlineKeyboardMarkup'</span>,</span><br><span class="line">            <span class="string">'inline_keyboard'</span>: [</span><br><span class="line">                [&#123;<span class="string">'type'</span>: <span class="string">'InlineKeyboardButton'</span>,</span><br><span class="line">                  <span class="string">'text'</span>: <span class="string">'上一页'</span>,</span><br><span class="line">                  <span class="string">'callback_data'</span>: <span class="string">'page-pre'</span>&#125;,</span><br><span class="line">                 &#123;<span class="string">'type'</span>: <span class="string">'InlineKeyboardButton'</span>,</span><br><span class="line">                  <span class="string">'text'</span>: <span class="string">'下一页'</span>,</span><br><span class="line">                  <span class="string">'callback_data'</span>: <span class="string">'page-next'</span>&#125;]</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> chat.send_text(<span class="string">'请翻页'</span>, reply_markup=json.dumps(inlinekeyboardmarkup))</span><br><span class="line"></span><br><span class="line"><span class="meta">@bot.callback(r'page-(\w+)')</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">buttonclick</span><span class="params">(chat, cq, match)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> chat.send_text(<span class="string">'You clicked &#123;&#125;'</span>.format(match.group(<span class="number">1</span>)))</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1fr5jc7vs09j31se1dwk79.jpg" alt=""></p>
<p>有时候我们想修改之前已经发送过的消息内容，例如当用户点击了内联键盘，而键盘的功能是进行翻页更新消息的内容。这时候我们可以使用 <code>editMessageText</code> 功能。例如点击上面内联键盘中的上一页按钮，你可以看到消息的内容被更改了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bot.callback(r'page-(\w+)')</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">buttonclick</span><span class="params">(chat, cq, match)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> chat.edit_text(message_id=chat.message[<span class="string">'message_id'</span>], text=<span class="string">"消息被修改了"</span>)</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1fr69270omhj31se1dwh0s.jpg" alt=""></p>
<h4 id="5-内联请求模式"><a href="#5-内联请求模式" class="headerlink" title="5.内联请求模式"></a><a id="inlinemode" style="color: black">5.内联请求模式</a></h4><p><a href="/2017/11/21/telegram-bots-for-developers/#inlinemode">内联请求模式</a>感觉更适合在群组中使用，在讨论组中输入<code>@botname</code> + 特定指令，输入框的上方就会显示查询内容，你可以返回给用户文章类型、图片类型或者其他类型的查询信息。<a href="https://core.telegram.org/bots/api#inline-mode" target="_blank" rel="noopener">官网</a>有更详细的内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bot.inline</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">inlinemode</span><span class="params">(iq)</span>:</span></span><br><span class="line">    results = [&#123;</span><br><span class="line">            <span class="string">'type'</span>: <span class="string">'article'</span>,</span><br><span class="line">            <span class="string">'id'</span>: str(index),</span><br><span class="line">            <span class="string">'title'</span>: article[<span class="string">'title'</span>],</span><br><span class="line">            <span class="string">'input_message_content'</span>: &#123; <span class="string">'message_text'</span>: article[<span class="string">'title'</span>]&#125;,</span><br><span class="line">            <span class="string">'description'</span>: <span class="string">f"这里是<span class="subst">&#123;article[<span class="string">'title'</span>]&#125;</span>"</span></span><br><span class="line">        &#125; <span class="keyword">for</span> index, article <span class="keyword">in</span> enumerate(category)]</span><br><span class="line">    <span class="keyword">await</span> iq.answer(results)</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1fr7au03whbj30jz0zkabu.jpg" style="width: 350px; height: 630px"></p>
<p>我们设定当用户输入内联指令时，bot返回可以选择的图片种类，返回结果的类型是article类型，官方还提供了语音，图片，gif，视频，音频。表情等类型，你可以根据自己的需要进行选择。</p>
<h2 id="爬虫机器人功能实现"><a href="#爬虫机器人功能实现" class="headerlink" title="爬虫机器人功能实现"></a>爬虫机器人功能实现</h2><p>我使用aiotg编写的机器人是用来抓取来自<a href="http://www.gamersky.com/" target="_blank" rel="noopener">游民星空</a>的图片。</p>
<h4 id="1-爬虫功能"><a href="#1-爬虫功能" class="headerlink" title="1. 爬虫功能"></a>1. 爬虫功能</h4><p>爬虫功能的实现是用aiohttp发送web请求，使用beautifulsoup进行html解析，核心代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aioget</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> aiohttp.request(<span class="string">'GET'</span>, url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter_img</span><span class="params">(tag)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> tag.name != <span class="string">'p'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> tag.attrs[<span class="string">'align'</span>] == <span class="string">'center'</span>:</span><br><span class="line">            <span class="keyword">for</span> child <span class="keyword">in</span> tag.contents:</span><br><span class="line">                <span class="keyword">if</span> child.name == <span class="string">'img'</span> <span class="keyword">or</span> child.name == <span class="string">'a'</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">except</span> KeyError:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'style'</span> <span class="keyword">in</span> tag.attrs:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch_img</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aioget(url) <span class="keyword">as</span> resp:</span><br><span class="line">        resp_text = <span class="keyword">await</span> resp.text()</span><br><span class="line">        content = BeautifulSoup(resp_text, <span class="string">"lxml"</span>)</span><br><span class="line">        imgs = content.find(class_=<span class="string">"Mid2L_con"</span>).findAll(filter_img)</span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> img <span class="keyword">in</span> imgs:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                results.append(&#123;</span><br><span class="line">                    <span class="string">'src'</span>:  img.find(<span class="string">'img'</span>).attrs[<span class="string">'src'</span>],</span><br><span class="line">                    <span class="string">'desc'</span>: <span class="string">'\n'</span>.join(list(img.stripped_strings))</span><br><span class="line">                &#125;)</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>
<p>我将aiohttp的get请求稍微包装了一下，简洁一些。html中元素的提取就不在赘述，就是找找html中的规律</p>
<h4 id="2-指令功能"><a href="#2-指令功能" class="headerlink" title="2. 指令功能"></a>2. 指令功能</h4><p>指令功能实现需要使用aiotg.bot.command装饰器进行命令注册，下面列出 <code>/start</code>的功能实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bot.command(r"/start")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">list_category</span><span class="params">(chat: Chat, match)</span>:</span></span><br><span class="line">    kb, row = [], <span class="number">-1</span></span><br><span class="line">    <span class="keyword">for</span> idx, item <span class="keyword">in</span> enumerate(category[<span class="string">"name"</span>]):</span><br><span class="line">        <span class="keyword">if</span> idx % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            kb.append([])</span><br><span class="line">            row += <span class="number">1</span></span><br><span class="line">        kb[row].append(item)</span><br><span class="line">    keyboard = &#123;</span><br><span class="line">        <span class="string">"keyboard"</span>: kb,</span><br><span class="line">        <span class="string">"resize_keyboard"</span>: <span class="keyword">True</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> chat.send_text(text=<span class="string">"请选择你喜欢的图片类型"</span>, reply_markup=json.dumps(keyboard))</span><br></pre></td></tr></table></figure>
<p>关于自定义键盘部分在上文中已经讲过，读者可以自己编码实现</p>
<h4 id="3-callback功能"><a href="#3-callback功能" class="headerlink" title="3. callback功能"></a>3. callback功能</h4><p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1frff8guj7cj31se1dwnlk.jpg" alt=""></p>
<p>读者可以看到在消息上附有页面切换按钮，每个按钮会带着一个callbackdata，当点击按钮会调用相应的callback函数进行处理，这里点击下一页时会进行翻页。</p>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1frffbgtx1qj31se1dw7so.jpg" alt=""></p>
<p>看页面更新了，关于更新页面的实现在上面也讲到了如何进行消息更新。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bot.callback(r"page-(?P&lt;name&gt;\w+)-(?P&lt;page&gt;\d+)")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">change_lists</span><span class="params">(chat: Chat, cq, match)</span>:</span></span><br><span class="line">    req_name = match.group(<span class="string">'name'</span>)</span><br><span class="line">    page = match.group(<span class="string">'page'</span>)</span><br><span class="line">    url = category[req_name]</span><br><span class="line">    text, markup = <span class="keyword">await</span> format_message(req_name, url, page)</span><br><span class="line">    <span class="keyword">await</span> chat.edit_text(message_id=chat.message[<span class="string">'message_id'</span>], text=text, markup=markup)</span><br></pre></td></tr></table></figure>
<p>也是使用装饰器进行回调函数注册，使用<code>chat.edit_text</code>进行消息更新。</p>
<p>callback功能也用在了图片的更新。点击下一页更新图片。</p>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1frffhu9b97j31se1dw7wh.jpg" alt=""></p>
<h4 id="4-内联请求模式功能"><a href="#4-内联请求模式功能" class="headerlink" title="4.内联请求模式功能"></a>4.内联请求模式功能</h4><p>当用户在输入框中输入<code>@botusername+指令</code>时，会在输入框上显示查询内容。</p>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1frffjspbwzj31se1dw4qp.jpg" alt=""></p>
<p>当没有指令时，会显示一些能够查看的图片类型。</p>
<p><img src="http://ww1.sinaimg.cn/large/006r0i4lgy1frffjjn3cfj31se1dw4qp.jpg" alt=""></p>
<p>当输入对应类型汉字的前几个字时，bot会匹配你想看的图片列表，并罗列出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bot.inline(r"([\u4e00-\u9fa5]+)")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">inline_name</span><span class="params">(iq, match)</span>:</span></span><br><span class="line">    req = match.group(<span class="number">1</span>)</span><br><span class="line">    req_name = match_category(req.strip(), category[<span class="string">'name'</span>])</span><br><span class="line">    ptype = <span class="string">'G'</span> <span class="keyword">if</span> req_name == <span class="string">"dynamic"</span> <span class="keyword">else</span> <span class="string">'P'</span></span><br><span class="line">    <span class="keyword">if</span> req_name <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    results, _ = <span class="keyword">await</span> fetch_lists(category[req_name])</span><br><span class="line">    c_results = [&#123;</span><br><span class="line">            <span class="string">'type'</span>: <span class="string">'article'</span>,</span><br><span class="line">            <span class="string">'id'</span>: str(index),</span><br><span class="line">            <span class="string">'title'</span>: item[<span class="string">'title'</span>],</span><br><span class="line">            <span class="string">'input_message_content'</span>: &#123;</span><br><span class="line">                <span class="string">'message_text'</span>: <span class="string">'/'</span> + ptype + item[<span class="string">'date'</span>] + <span class="string">'_'</span> + item[<span class="string">'key'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'description'</span>: item[<span class="string">'desc'</span>]</span><br><span class="line">        &#125; <span class="keyword">for</span> index, item <span class="keyword">in</span> enumerate(results)]</span><br><span class="line">    <span class="keyword">await</span> iq.answer(c_results)</span><br></pre></td></tr></table></figure>
<h4 id="redis缓存"><a href="#redis缓存" class="headerlink" title="redis缓存"></a>redis缓存</h4><p>当发送给用户图片时，telegram会返回一个和图片对应的file_id, 当再次发送相同的图片时，只需要在调用send_photo时，将photo参数赋值为file_id即可，所以每次使用爬虫进行抓取图片时，将图片的fild_id存在redis中，用户请求图片时，如果图片之前已经抓取过，这时候只要从redis中取出file_id，再调用send_photo即可。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>之前一直说要保证每周都要写文章，可是发现自己的毕设是一个大坑，连续的写了一个多月，github上的commit都绿了一片，但是不能光把精力都放在毕设上，还是要抽空学学别的东西，比如，英语是吧，唉。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/16/线性代数/" class="prev">上一篇</a><a href="/2018/04/07/Python-Tricks/" class="next">下一篇</a></div><div id="container"></div><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
    id: 'Sat Apr 14 2018 13:41:01 GMT+0800',
    owner: 'yangsoon',
    repo: 'yangsoon.github.io',
    oauth: {
        client_id: 'c6e81705ee274d631d1d',
        client_secret: 'd2366443245bc5528fc5a73af235d9e23d14e33a',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2015 - 2018 <a href="https://yangsoon.github.io">yangs</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script type="text/x-mathjax-config">MathJax.Hub.Config({
tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});</script><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-117274875-1",'auto');ga('send','pageview');</script></body></html>