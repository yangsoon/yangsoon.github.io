<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="robots" content="index,follow"/><meta property="og:type" content="website"/><meta property="og:site_name" content="YangSoon"/><meta property="twitter:domain" content="yangsoon.github.io"/><meta name="twitter:creator" content="@yangsoonlx"/><meta name="description" content="YangSoon, Cloud Native Developer"/><meta property="og:description" content="YangSoon, Cloud Native Developer"/><meta name="twitter:description" content="YangSoon, Cloud Native Developer"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://yangsoon.github.io/api/social-image?id=b80b3335-c73f-4e47-a39b-3021b4dc650a"/><meta property="og:image" content="https://yangsoon.github.io/api/social-image?id=b80b3335-c73f-4e47-a39b-3021b4dc650a"/><link rel="canonical" href="https://yangsoon.github.io/openkruise-source-reading"/><meta property="og:url" content="https://yangsoon.github.io/openkruise-source-reading"/><meta property="twitter:url" content="https://yangsoon.github.io/openkruise-source-reading"/><link rel="alternate" type="application/rss+xml" href="https://yangsoon.github.io/feed" title="YangSoon"/><meta property="og:title" content="OpenKruise Source Reading"/><meta name="twitter:title" content="OpenKruise Source Reading"/><title>OpenKruise Source Reading</title><meta name="next-head-count" content="21"/><link rel="shortcut icon" href="/favicon.ico"/><link rel="icon" type="image/png" sizes="32x32" href="favicon.png"/><link rel="manifest" href="/manifest.json"/><link rel="preload" href="/_next/static/css/836d11bb8e359ad4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/836d11bb8e359ad4.css" data-n-g=""/><link rel="preload" href="/_next/static/css/2b86574bdeb08777.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2b86574bdeb08777.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script defer="" src="/_next/static/chunks/358.0027340467b29549.js"></script><script src="/_next/static/chunks/webpack-a6dcf48a0f041c92.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-f08b69bdcc7bbb61.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8e82bd9eaafa452a.js" defer=""></script><script src="/_next/static/chunks/391-7e14203f5a9c2431.js" defer=""></script><script src="/_next/static/chunks/642-0bcb6e9f6f395ab6.js" defer=""></script><script src="/_next/static/chunks/pages/%5BpageId%5D-20d41f8a977eeca1.js" defer=""></script><script src="/_next/static/PSg0Acersh2oVT5QAnXcP/_buildManifest.js" defer=""></script><script src="/_next/static/PSg0Acersh2oVT5QAnXcP/_ssgManifest.js" defer=""></script></head><body><script>
/** Inlined version of noflash.js from use-dark-mode */
;(function () {
  var storageKey = 'darkMode'
  var classNameDark = 'dark-mode'
  var classNameLight = 'light-mode'
  function setClassOnDocumentBody(darkMode) {
    document.body.classList.add(darkMode ? classNameDark : classNameLight)
    document.body.classList.remove(darkMode ? classNameLight : classNameDark)
  }
  var preferDarkQuery = '(prefers-color-scheme: dark)'
  var mql = window.matchMedia(preferDarkQuery)
  var supportsColorSchemeQuery = mql.media === preferDarkQuery
  var localStorageTheme = null
  try {
    localStorageTheme = localStorage.getItem(storageKey)
  } catch (err) {}
  var localStorageExists = localStorageTheme !== null
  if (localStorageExists) {
    localStorageTheme = JSON.parse(localStorageTheme)
  }
  // Determine the source of truth
  if (localStorageExists) {
    // source of truth from localStorage
    setClassOnDocumentBody(localStorageTheme)
  } else if (supportsColorSchemeQuery) {
    // source of truth from system
    setClassOnDocumentBody(mql.matches)
    localStorage.setItem(storageKey, mql.matches)
  } else {
    // source of truth from document.body
    var isDarkMode = document.body.classList.contains(classNameDark)
    localStorage.setItem(storageKey, JSON.stringify(isDarkMode))
  }
})();
</script><div id="__next"><div class="notion notion-app light-mode notion-block-b80b3335c73f4e47a39b3021b4dc650a"><div class="notion-viewport"></div><div class="notion-frame"><header class="notion-header"><div class="notion-nav-header"><div class="breadcrumbs"><a class="breadcrumb" href="/"><div class="notion-page-icon-inline notion-page-icon-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27688%27%20height=%27689%27/%3e"/></span><img alt="yangsoon ‘s blog" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="icon notion-page-icon" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRmoAAABXRUJQVlA4IF4AAABQAgCdASoQABAABUB8JbACdH8AF6kqWZq7wgAA/tFZccfpD5SaLC06Ab1xNlhuQgaC2peDlG2wJ+PIWe8AtNjEYYN+9hybVKfEbmvVGYOWRzw8xmakIGSWE0zkkYAA&quot;)"/><noscript><img alt="yangsoon ‘s blog" src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F37907dd5-3c76-4966-a419-daa027a84972%2FIMG_2189.jpg?table=block&amp;id=72a66971-7cf6-42c2-a252-4439d99d8f44&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="icon notion-page-icon" loading="lazy"/></noscript></span></div><span class="title">yangsoon ‘s blog</span></a></div><div class="notion-nav-header-rhs breadcrumbs"><a href="/about" class="breadcrumb button">About</a><div class="breadcrumb button styles_hidden__7gYve"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M256 48v48m0 320v48m147.08-355.08l-33.94 33.94M142.86 369.14l-33.94 33.94M464 256h-48m-320 0H48m355.08 147.08l-33.94-33.94M142.86 142.86l-33.94-33.94"></path><circle cx="256" cy="256" r="80" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32"></circle></svg></div><div role="button" class="breadcrumb button notion-search-button"><svg class="notion-icon searchIcon" viewBox="0 0 17 17"><path d="M6.78027 13.6729C8.24805 13.6729 9.60156 13.1982 10.709 12.4072L14.875 16.5732C15.0684 16.7666 15.3232 16.8633 15.5957 16.8633C16.167 16.8633 16.5713 16.4238 16.5713 15.8613C16.5713 15.5977 16.4834 15.3516 16.29 15.1582L12.1504 11.0098C13.0205 9.86719 13.5391 8.45215 13.5391 6.91406C13.5391 3.19629 10.498 0.155273 6.78027 0.155273C3.0625 0.155273 0.0214844 3.19629 0.0214844 6.91406C0.0214844 10.6318 3.0625 13.6729 6.78027 13.6729ZM6.78027 12.2139C3.87988 12.2139 1.48047 9.81445 1.48047 6.91406C1.48047 4.01367 3.87988 1.61426 6.78027 1.61426C9.68066 1.61426 12.0801 4.01367 12.0801 6.91406C12.0801 9.81445 9.68066 12.2139 6.78027 12.2139Z"></path></svg></div></div></div></header><div class="notion-page-scroller"><main class="notion-page notion-page-no-cover notion-page-has-icon notion-page-has-image-icon notion-full-page notion-small-text"><div class="notion-page-icon-hero notion-page-icon-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27540%27%20height=%27540%27/%3e"/></span><img alt="OpenKruise Source Reading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="notion-page-icon" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRmwAAABXRUJQVlA4IGAAAACQAgCdASoQABAABUB8JbACdH8G6AmloEmfqCZIgAD+8eBipjr5mEcjW+17mJYB4C2JhfbmT0VAymPlGqjuZc7moQ/ip8B0lm34TDmRkQt84+ZlH9PWuZY5HwcXlkU9AAA=&quot;)"/><noscript><img alt="OpenKruise Source Reading" src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F24a9e733-94b5-42f3-82f7-fbdb0d6f78df%2Fopenkruise-logo-bg.jpeg?table=block&amp;id=b80b3335-c73f-4e47-a39b-3021b4dc650a&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="notion-page-icon" loading="lazy"/></noscript></span></div><h1 class="notion-title">OpenKruise Source Reading</h1><div class="notion-page-content notion-page-content-has-aside notion-page-content-has-toc"><article class="notion-page-content-inner"><div class="notion-text notion-block-818d2d4ac5fa4c449d8803aca9d0525d">OpenKruise 是一个基于 Kubernetes 的扩展套件，主要聚焦于云原生应用的自动化，比如部署、发布、运维以及可用性保护<em>。</em>OpenKruise提供了大量的增强版本的工作负载，不仅支持类似 k8s 原生工作负载的基础功能，还提供了原地升级、可配置扩缩容/发布测试等。</div><div class="notion-text notion-block-3cee56248b264f58a4d1cb7ee481bdaa">OpenKruise 由阿里云开源，已经在阿里内部经过了大量的生产实践检验，个人认为是阿里云开源的一个非常技术硬核的项目，对于想学习编写控制器的同学来说可以学到更贴近”云原生”的写法。还能学到控制器在大规模k8s下性能优化的小技巧。</div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-5694cca3b1b645b188e8d4de80521381" data-id="5694cca3b1b645b188e8d4de80521381"><span><div id="5694cca3b1b645b188e8d4de80521381" class="notion-header-anchor"></div><a class="notion-hash-link" href="#5694cca3b1b645b188e8d4de80521381" title="CloneSet Controller "><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">CloneSet Controller </span></span></h2><div class="notion-text notion-block-2a6e276d26ee48c783710e8249d02020"><code class="notion-inline-code">CloneSet</code> 控制器提供了高效管理无状态应用的能力，它可以对标原生的 <code class="notion-inline-code">Deployment</code>
，但 <code class="notion-inline-code">CloneSet</code> 提供了很多增强功能：</div><ol start="1" class="notion-list notion-list-numbered notion-block-57db10fc65c944608cf6d79962bbe302"><li>更加强大的扩缩容能力</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-f79e6f2bf2b64948acc2b233fad665dc"><li>更多可配置化的升级策略</li></ol><ol start="3" class="notion-list notion-list-numbered notion-block-65e179e40023413e9c60f4dcc27c5904"><li>配合外部组件管理 Pod 的生命周期</li></ol><div class="notion-text notion-block-deb7dcd302af442a9d0d6af3ff24e44a">想要了解 <code class="notion-inline-code">CloneSet</code> 的更多用法可以参考官方文档：</div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-10574ef4bcf34abe883ba73f529e8035" href="https://openkruise.io/zh/docs/user-manuals/cloneset"><div><div class="notion-bookmark-title">CloneSet | OpenKruise</div><div class="notion-bookmark-description">CloneSet 控制器提供了高效管理无状态应用的能力，它可以对标原生的 Deployment，但 CloneSet 提供了很多增强功能。 按照 Kruise 的 命名规范，CloneSet 是一个直接管理 Pod 的 Set 类型 workload。 一个简单的 CloneSet yaml 文件如下： CloneSet 允许用户配置 PVC 模板 volumeClaimTemplates，用来给每个 Pod 生成独享的 PVC，这是 Deployment 所不支持的。 如果用户没有指定这个模板，CloneSet 会创建不带 PVC 的 Pod。 一些注意点： 每个被自动创建的 PVC 会有一个 ownerReference 指向 CloneSet，因此 CloneSet 被删除时，它创建的所有 Pod 和 PVC 都会被删除。 每个被 CloneSet 创建的</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><img src="https://www.notion.so/image/https%3A%2F%2Fopenkruise.io%2Fzh%2Fimg%2Fopenkruise.ico?table=block&amp;id=10574ef4-bcf3-4abe-883b-a73f529e8035&amp;cache=v2" alt="CloneSet | OpenKruise" loading="lazy" decoding="async"/></div><div class="notion-bookmark-link-text">https://openkruise.io/zh/docs/user-manuals/cloneset</div></div></div><div class="notion-bookmark-image"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272000%27%20height=%271376%27/%3e"/></span><img alt="CloneSet | OpenKruise" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRk4AAABXRUJQVlA4IEIAAACQAQCdASoQAAsABUB8JYgAAp04DAAA/useL8JM95pKwiEWPr8xm0fvVLPraEeRDQpExREcG2G7LRqBvgeZSGYAAAA=&quot;)"/><noscript><img alt="CloneSet | OpenKruise" src="https://www.notion.so/image/https%3A%2F%2Fopenkruise.io%2Fzh%2Fassets%2Fimages%2Fcloneset-lifecycle-b97d746b37527b0cb23eab4fcc7cef39.png?table=block&amp;id=10574ef4-bcf3-4abe-883b-a73f529e8035&amp;cache=v2" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a></div><div class="notion-text notion-block-58a9b00d42b8447997fead7d8a1522d7">本节从多个发布场景出发配合 <code class="notion-inline-code">CloneSet Controller</code> 源码来帮你梳理控制器的执行流程和逻辑。控制器的执行入口在: <code class="notion-inline-code">pkg/controller/cloneset/cloneset_controller.go#doReconcile</code>。</div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-50b5c20c889e4f67bdb8209ee0ff09af" data-id="50b5c20c889e4f67bdb8209ee0ff09af"><span><div id="50b5c20c889e4f67bdb8209ee0ff09af" class="notion-header-anchor"></div><a class="notion-hash-link" href="#50b5c20c889e4f67bdb8209ee0ff09af" title="初始版本发布"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">初始版本发布</span></span></h3><div class="notion-text notion-block-2726ba8dce86434ea2e03c0037390496">该场景是企业发布服务的第一个版本，在这个场景下 CloneSet 控制器的执行流程和步骤都比较简单。首先，我们在自己的k8s集群中安装好 OpenKruise，具体安装方式请参考<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://openkruise.io/zh/docs/installation/">官方文档 </a>。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-yaml">apiVersion: apps.kruise.io/v1alpha1
kind: CloneSet
metadata:
  labels:
    app: sample
  name: sample
spec:
  replicas: 5
  selector:
    matchLabels:
      app: sample
  template:
    metadata:
      labels:
        app: sample
    spec:
      containers:
      - name: nginx
        image: nginx:1.22-alpine</code></pre><div class="notion-text notion-block-b2ec5577bc4f4a739577f771fb80fde2">复制上面的 CloneSet 对象并创建到集群中。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-bash">➜  pbpaste | kubectl apply -f -
cloneset.apps.kruise.io/sample created
➜  kubectl get cloneset
NAME     DESIRED   UPDATED   UPDATED_READY   READY   TOTAL   AGE
sample   5                                                   18s</code></pre><h4 class="notion-h notion-h3 notion-h-indent-2 notion-block-ced9d1e67ffd495db13808c14fb74cb8" data-id="ced9d1e67ffd495db13808c14fb74cb8"><span><div id="ced9d1e67ffd495db13808c14fb74cb8" class="notion-header-anchor"></div><a class="notion-hash-link" href="#ced9d1e67ffd495db13808c14fb74cb8" title="首次协调：创建实例"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">首次协调：创建实例</span></span></h4><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-5c34e7565f4743b0940f6ba3cff73f27"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%273392%27%20height=%271898%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRsAAAABXRUJQVlA4WAoAAAAQAAAADwAACAAAQUxQSFEAAAARL6CQbQQ4NKH7EC4igi8TWMW2EydBQRb4b1kUZOogVQDPvxlERPSfYJKm2o6R0LBwetIuMmu3XgiYf81Kvbsqs3bbQGPr/QDr7dd9QIwNrAMAVlA4IEgAAACwAQCdASoQAAkABUB8JaACdAD5URQAAP636O8ND+RDj7l8nBaidBIBRTyJOP6tdmcbw3oOuxZR7dD5oULRcx/EATwXHN/AAAA=&quot;)"/><noscript><img alt="notion image" src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/25951791-eca4-44e6-bb8d-a3d35df0e1cc/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&amp;X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20221023%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20221023T152543Z&amp;X-Amz-Expires=86400&amp;X-Amz-Signature=a59df04ddaec09329641313d993f33d8f52cd3d63c3c77c524c01244531cddfe&amp;X-Amz-SignedHeaders=host&amp;x-id=GetObject" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-cce9ff9b03c946e4ac004d240e40f297">1.<b>获取待处理的 </b><code class="notion-inline-code">CloneSet</code><b> 对象</b>：控制器 list&amp;watch k8s集群中 <code class="notion-inline-code">CloneSet</code> 资源的变化，当监听到有新的 CloneSet 创建出来，CloneSet Controller 开始执行 <code class="notion-inline-code">doReconcile</code> 函数中的逻辑。控制器，首先会使用 Client 获取到要处理的 CloneSet 对象。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">instance := &amp;appsv1alpha1.CloneSet{}
err := r.Get(context.TODO(), request.NamespacedName, instance)</code></pre><div class="notion-text notion-block-4ac0543a37ff407e868624c55e756f6f">2.<b>初始化 </b><code class="notion-inline-code">Control</code><b> 对象</b>： <code class="notion-inline-code">Control</code><b> </b>是抽象出的一个通用的接口，可以看到这个接口实现一些计算Revision、扩缩容、Pod 更新相关的操作。不过这里创建出的 <code class="notion-inline-code">Control</code> 对象，貌似用处不大，在其他执行函数中，会经常见到这个对象被创建出来，基本上是需要就创建。</div><div class="notion-text notion-block-4cd7e02a6a9f456fa169017683a273ee">3.<b>获取 </b><code class="notion-inline-code">CloneSet</code><b> 所管控的资源</b>：控制器获取所有 <code class="notion-inline-code">CloneSet</code> 管控活跃的 Pod 和 PVC。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">// list all active Pods and PVCs belongs to cs
filteredPods, filteredPVCs, err := r.getOwnedResource(instance)</code></pre><div class="notion-text notion-block-8f02f0258c43470ea6f8bb1745436328">这里活跃的 Pod 是指：没有被删除的，并且 <code class="notion-inline-code">Pod.Status.Phase</code> 不处于 <code class="notion-inline-code">Succeeded</code> 和 <code class="notion-inline-code">Failed</code> 状态的Pod集合；活跃的 PVC 是指没有被删除的 PVC 集合。</div><div class="notion-text notion-block-9a1b4cb0cbf64da1a54de7aa8716e320">4.<b>过滤有多个管控 Owner 的 </b><code class="notion-inline-code">Pod</code>：这一步会过滤掉不满足 CloneSet selector 筛选条件和一些有多个Owner的Pod，同时会释放掉CloneSet对这些有多个Owner的Pod的管理权限。</div><div class="notion-text notion-block-2c3d086905e54c2096f605ad13698bbc">5.<b>获取 </b><code class="notion-inline-code">CloneSet</code><b> 当前的 </b>Revision<b> 和 计算待更新的下个版本的 </b>Revision：当前场景比较简单，<code class="notion-inline-code">CloneSet</code> 没有历史版本，只负责创建存储当前 <code class="notion-inline-code">CloneSet</code> 快照信息的 <code class="notion-inline-code">ControlllerRevision</code>即可。这里会使用第2步创建的 Control 对象生成 Revision模板存储到<code class="notion-inline-code">ControlllerRevision</code> 对象的 Data 字段中， <code class="notion-inline-code">ControlllerRevision</code> 的名字由Data的Hash值生成。最终返回的 currentRevision 和 updateRevision 均指向这个 <code class="notion-inline-code">ControlllerRevision</code> 对象。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func (c *commonControl) SetRevisionTemplate(revisionSpec map[string]interface{}, 
	template map[string]interface{}) {
	revisionSpec[&quot;template&quot;] = template
	template[&quot;$patch&quot;] = &quot;replace&quot;
}</code></pre><div class="notion-text notion-block-804be9670edc4df1abd951f7ecaf62e0">其中，SetRevisionTemplate 函数会给 <code class="notion-inline-code">cloneSet.Spec.Template</code> 字段新增一个 <code class="notion-inline-code">$patch:replace</code> 键值对。后面我们会提到为什么要新增这个字段，最后生成的 <code class="notion-inline-code">ControllerRevision</code> 对象如下：</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-yaml">apiVersion: apps/v1
kind: ControllerRevision
metadata:
  labels:
    app: sample
    controller.kubernetes.io/hash: 66bf7df478
  name: sample-66bf7df478
  ownerReferences:
  - apiVersion: apps.kruise.io/v1alpha1
    kind: CloneSet
    name: sample
data:
  spec:
    template:
      $patch: replace
      metadata:
        creationTimestamp: null
        labels:
          app: sample
      spec:
        containers:
        - image: nginx:1.22-alpine
          name: nginx
          resources: {}
revision: 1</code></pre><blockquote class="notion-quote notion-block-b1d7ccf8e12f46a8acae54f690aaeee1"><div>ControllerRevision 实现了状态数据的不可变快照，APIServer 将拒绝所有尝试改变 data 字段的请求。 但是，可以删除 ControllerRevisions。  DaemonSet 和 StatefulSet 控制器都使用它来进行更新和回滚。</div></blockquote><div class="notion-text notion-block-460e0e17fbdc408abe8d36b64c0550a1">6.<b>创建</b> <code class="notion-inline-code">Pods</code> ：在 <b>初始版本发布 </b>场景下 <code class="notion-inline-code">r.syncCloneSet</code> 的操作会比较简单，在涉及版本升级的场景时，我们再详细分析这部分。这里涉及的操作有：先计算需要扩容的个数这里就等于<code class="notion-inline-code">Spec.Replicas</code>,在真正把初始版本的 Pod 创建到集群前，会把扩容创建的Pod信息记录到 <code class="notion-inline-code">realScaleExpectations</code> 对象中，后调用 <code class="notion-inline-code">DoItSlowly</code> 方法分批并发创建 Pod，如果创建Pod失败，会把创建失败的 Pod 从 <code class="notion-inline-code">realScaleExpectations</code> 对象中移除。<code class="notion-inline-code">realScaleExpectations</code> 是用来解决 Indexer 同步延迟导致控制器可能会扩容出错误个数Pod 的问题，详细的讲解在 <a class="notion-link" href="https://yangsoon.github.io/openkruise-source-reading#cbbf420bff974d8891231a2a4c69bdae">Tricks</a> 部分，感兴趣可以跳转到这一节阅读。</div><div class="notion-text notion-block-d5024c24c59a4934a1eb1088b35a905d">简单解释一下, 控制器获取 k8s资源数据是直接访问本地缓存(Indexer)，但是 Indexer的数据同步因为网络等问题会出现延迟的情况，导致在第三步获取管控资源（Pod、PVC）的时候会出现不一致的问题，容易导致控制器后续处理的时候会创建出多余的 Pod，为了解决这个问题就加入了一个临时缓存，如上图所示，当Informar监听到Pod创建的事件就会调用 <code class="notion-inline-code">ObserveScale</code> 函数把之前记录的Pod信息去掉。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">// pkg/controller/cloneset/cloneset_controller.go:#add
// add adds a new Controller to mgr with r as the reconcile.Reconciler
func add(mgr manager.Manager, r reconcile.Reconciler) error {
	...
	// Watch for changes to Pod
	err = c.Watch(&amp;source.Kind{Type: &amp;v1.Pod{}}, &amp;podEventHandler{Reader: mgr.GetCache()})
	if err != nil {
		return err
	}
	...
}

// pkg/controller/cloneset/cloneset_event_handler.go:#Create
func (e *podEventHandler) Create(evt event.CreateEvent, q workqueue.RateLimitingInterface) {
	...
	// If it has a ControllerRef, that&#x27;s all that matters.
	if controllerRef := metav1.GetControllerOf(pod); controllerRef != nil {
		req := resolveControllerRef(pod.Namespace, controllerRef)
		if req == nil {
			return
		}
		klog.V(4).Infof(&quot;Pod %s/%s created, owner: %s&quot;, pod.Namespace, pod.Name, req.Name)
		clonesetutils.ScaleExpectations.ObserveScale(req.String(), expectations.Create, pod.Name)
		q.Add(*req)
		return
	}
	...
}</code></pre><div class="notion-text notion-block-80c65c81cec24733b8efe4a87f56586e">在控制器每次协调的时候，会调用<code class="notion-inline-code">SatisfiedExpectations</code> 来判断是不是读到了脏数据，如果数据没有及时更新就直接返回把事件重新入队，直到数据更新。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">// If scaling expectations have not satisfied yet, just skip this reconcile.
if scaleSatisfied, unsatisfiedDuration, scaleDirtyPods := clonesetutils.ScaleExpectations.SatisfiedExpectations(request.String()); !scaleSatisfied {
	if unsatisfiedDuration &gt;= expectations.ExpectationTimeout {
		klog.Warningf(&quot;Expectation unsatisfied overtime for %v, scaleDirtyPods=%v, overtime=%v&quot;, request.String(), scaleDirtyPods, unsatisfiedDuration)
		return reconcile.Result{}, nil
	}
	klog.V(4).Infof(&quot;Not satisfied scale for %v, scaleDirtyPods=%v&quot;, request.String(), scaleDirtyPods)
	return reconcile.Result{RequeueAfter: expectations.ExpectationTimeout - unsatisfiedDuration}, nil
}</code></pre><div class="notion-text notion-block-04fe8283b9714e06968b1447b0895402">7.<b>更新</b><code class="notion-inline-code">CloneSet Status</code> ：第一次协调，仅仅记录少量的信息到 <code class="notion-inline-code">Status</code>字段中，等到控制器获取到 Pod 状态更新的事件之后的后续协调会继续更新 Status 字段。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-yaml">status:
  availableReplicas: 0
  collisionCount: 0
  currentRevision: sample-66bf7df478
  expectedUpdatedReplicas: 5
  labelSelector: app=sample
  observedGeneration: 1
  readyReplicas: 0
  replicas: 0
  updateRevision: sample-66bf7df478
  updatedReadyReplicas: 0
  updatedReplicas: 0</code></pre><div class="notion-text notion-block-ed71575c5e86484ea68b36dddef95faa">8<b>.执行一些垃圾回收的操作</b>: 这一步会清理一些历史 <code class="notion-inline-code">ControlllerRevison</code> 对象，减轻 etcd负担。</div><h4 class="notion-h notion-h3 notion-h-indent-2 notion-block-a1f006e45eb54329a1847ea0527a2d17" data-id="a1f006e45eb54329a1847ea0527a2d17"><span><div id="a1f006e45eb54329a1847ea0527a2d17" class="notion-header-anchor"></div><a class="notion-hash-link" href="#a1f006e45eb54329a1847ea0527a2d17" title="后续协调：状态更新"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">后续协调：状态更新</span></span></h4><div class="notion-text notion-block-8e50fabb37634dc7abcee151a4bd62ac">从函数 <code class="notion-inline-code">pkg/controller/cloneset/cloneset_controller.go#add</code> ，可以看到控制器会监听所有 CloneSet、Pod和PVC资源的变化，当CloneSet创建出的Pod资源状态更新的时候，都会触发控制器继续协调更新实例状态。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-go">func add(mgr manager.Manager, r reconcile.Reconciler) error {
	...
	// Watch for changes to CloneSet
	err = c.Watch(&amp;source.Kind{Type: &amp;appsv1alpha1.CloneSet{}}, &amp;handler.EnqueueRequestForObject{}, predicate.Funcs{
		UpdateFunc: func(e event.UpdateEvent) bool {
			oldCS := e.ObjectOld.(*appsv1alpha1.CloneSet)
			newCS := e.ObjectNew.(*appsv1alpha1.CloneSet)
			if *oldCS.Spec.Replicas != *newCS.Spec.Replicas {
				klog.V(4).Infof(&quot;Observed updated replicas for CloneSet: %s/%s, %d-&gt;%d&quot;,
					newCS.Namespace, newCS.Name, *oldCS.Spec.Replicas, *newCS.Spec.Replicas)
			}
			return true
		},
	})
	if err != nil {
		return err
	}

	// Watch for changes to Pod
	err = c.Watch(&amp;source.Kind{Type: &amp;v1.Pod{}}, &amp;podEventHandler{Reader: mgr.GetCache()})
	if err != nil {
		return err
	}

	// Watch for changes to PVC, just ensure cache updated
	err = c.Watch(&amp;source.Kind{Type: &amp;v1.PersistentVolumeClaim{}}, &amp;pvcEventHandler{})
	if err != nil {
		return err
	}

	return nil
}</code></pre><div class="notion-text notion-block-1b343edb2a734b99b15dec809ba049e5">每次协调的执行逻辑和首次协调的执行流程大致相似，主要的处理逻辑在函数<code class="notion-inline-code">pkg/controller/cloneset/cloneset_status.go#calculateStatus</code> 中。</div><div class="notion-text notion-block-69bc48ca162d4664a56c9a579286f806">我们主要看下 <code class="notion-inline-code">Status</code> 字段中和 Replicas 相关数值的计算。</div><div class="notion-text notion-block-9837a3f743744a51a7966f06e34bf80a">1.符合<code class="notion-inline-code">ReadyReplicas</code> 条件的 Pod 需要满足  <code class="notion-inline-code">InPlaceUpdateReady</code><em> </em>和 <code class="notion-inline-code">PodReady</code> 这2个 Condition 的状态为 <code class="notion-inline-code">True</code> ,并且 <code class="notion-inline-code">Pod</code> 的 <code class="notion-inline-code">Phase</code> 处于 <code class="notion-inline-code">Running</code> 状态。</div><div class="notion-text notion-block-b5d8bf0e135e492daa20e2a6edfc2f2a">2.<code class="notion-inline-code">AvailableReplicas</code> 的要求比 <code class="notion-inline-code">ReadyReplicas</code> 更严格一些，除了满足 <code class="notion-inline-code">ReadyReplicas</code> 的条件，还需要 Pod 的生命周期状态为 <code class="notion-inline-code">Normal</code> (<code class="notion-inline-code">CloneSet</code>生命周期相关的内容会在后面介绍)。除此之外，Pod 的 Condition 转变到 <code class="notion-inline-code">PodReady</code> 的时间要超过在 <code class="notion-inline-code">CloneSet</code> 中设置的 <code class="notion-inline-code">minReadSeconds</code> 。</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-690d4883c57247f182ae7f1cc277d375"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271422%27%20height=%27678%27/%3e"/></span><img alt="notion image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(&quot;data:image/webp;base64,UklGRpQAAABXRUJQVlA4WAoAAAAQAAAADwAABgAAQUxQSDYAAAARL0AmbZuslrJ736wsIoK6BwratpF2H4AyOBXBSSVwJMqfzL0MIvo/AQDSkGS7Ti/bH5K5SwJWUDggOAAAAPABAJ0BKhAABwAFQHwloALsAR+TP+R8gAD+1QtnRDOd3CzMAl7tguoP3dJc87AWEHpMJjFAhAAA&quot;)"/><noscript><img alt="notion image" src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/fd9e6893-05b1-4c0f-8e96-043193f57138/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&amp;X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20221023%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20221023T152543Z&amp;X-Amz-Expires=86400&amp;X-Amz-Signature=05dfb1a06d5baa829f1cfb5fbc9afba8b31fde16069ccd8afe4f04642dcc6743&amp;X-Amz-SignedHeaders=host&amp;x-id=GetObject" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></figure><div class="notion-text notion-block-c92f996268174fc398db224eb7965ba7">3.<code class="notion-inline-code">UpdatedReplicas</code> 等于处于最新版本的 Pod 。</div><div class="notion-text notion-block-febd1775c6264ba5b9e8b0db1624205c">4.<code class="notion-inline-code">UpdatedReadyReplicas</code> 表示处于最新版本而且满足 <code class="notion-inline-code">ReadyReplicas</code> 的 Pod。</div><div class="notion-text notion-block-6f8e0b9c54fa41a9aa63ac1bd09d13d5">5.<code class="notion-inline-code">ExpectedUpdatedReplicas</code> 等于 <code class="notion-inline-code">Replicas</code> - <code class="notion-inline-code">partition</code> (<code class="notion-inline-code">partition</code> 表示期望保留老版本 <code class="notion-inline-code">Pod</code> 的个数) </div><div class="notion-text notion-block-8a1a057d35804abe96bb82b2928a2819">最终协调后的 <code class="notion-inline-code">Status</code> 如下：</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-yaml">status:
  availableReplicas: 5
  collisionCount: 0
  currentRevision: sample-66bf7df478
  expectedUpdatedReplicas: 5
  labelSelector: app=sample
  observedGeneration: 1
  readyReplicas: 5
  replicas: 5
  updateRevision: sample-66bf7df478
  updatedReadyReplicas: 5
  updatedReplicas: 5</code></pre><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-3495ad61e9de4c3e9815be9f9925e543" data-id="3495ad61e9de4c3e9815be9f9925e543"><span><div id="3495ad61e9de4c3e9815be9f9925e543" class="notion-header-anchor"></div><a class="notion-hash-link" href="#3495ad61e9de4c3e9815be9f9925e543" title="新版本发布"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">新版本发布</span></span></h3><div class="notion-text notion-block-7dbad826e7864438bc96c4218086b8fe">随着业务需求的更新，企业很快迭代出了一个新版本要部署，构建打包好镜像之后，准备向集群下发新版本的 <code class="notion-inline-code">CloneSet</code> ：我们除了更改了服务镜像，还新增了2个更新策略，<code class="notion-inline-code">partition: 3</code> 表示我们会保留 3 个老版本的 Pod，<code class="notion-inline-code">maxSurge: 2</code> 表示允许控制器一下子扩出超过 <code class="notion-inline-code">replicas</code> 个数的 Pod。</div><blockquote class="notion-quote notion-block-e20be74a35cf4a47a96779fd0db95165"><div>解释这样配置的原因</div></blockquote><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-yaml">apiVersion: apps.kruise.io/v1alpha1
kind: CloneSet
metadata:
  labels:
    app: sample
  name: sample
  namespace: default
spec:
  minReadySeconds: 10
  # 设置更新策略
  updateStrategy:
      # 保留旧版本 Pod 的数量或百分比
      partition: 3
      # 控制最多能扩出来超过 replicas 的 Pod 数量
      maxSurge: 2
  replicas: 5
  selector:
    matchLabels:
      app: sample
  template:
    metadata:
      labels:
        app: sample
    spec:
      containers:
      - image: nginx:1.23-alpine
        name: nginx</code></pre><div class="notion-text notion-block-418745dffc3f4d9ba5e3845bd587721d">复制👆🏻的 <code class="notion-inline-code">CloneSet</code> 并更新到集群中。</div><pre class="notion-code"><div class="notion-code-copy"><div class="notion-code-copy-button"><svg fill="currentColor" viewBox="0 0 16 16" width="1em" version="1.1"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg></div></div><code class="language-yaml">➜  pbpaste | kubectl apply -f -
cloneset.apps.kruise.io/sample configured</code></pre><h4 class="notion-h notion-h3 notion-h-indent-2 notion-block-0f63db43fa384d9b83dfd40186df6b95" data-id="0f63db43fa384d9b83dfd40186df6b95"><span><div id="0f63db43fa384d9b83dfd40186df6b95" class="notion-header-anchor"></div><a class="notion-hash-link" href="#0f63db43fa384d9b83dfd40186df6b95" title="更新后的首次协调："><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">更新后的首次协调：</span></span></h4><div class="notion-blank notion-block-a7435a378a8f4f959603833c69b9c78d"> </div><div class="notion-text notion-block-4ff93a40d1aa45e8b0bddded02265b16">此时如果直接删除ToDelete的pod那么不可以的个数就会超过maxUnavailable，不符合需求，所以先计算出来在满足条件下要扩出来的实例个数</div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-aa9d57bc607b4f7081d1d3b18316604a" data-id="aa9d57bc607b4f7081d1d3b18316604a"><span><div id="aa9d57bc607b4f7081d1d3b18316604a" class="notion-header-anchor"></div><a class="notion-hash-link" href="#aa9d57bc607b4f7081d1d3b18316604a" title="Tricks"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Tricks</span></span></h2><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-7d02e5db9ac845ab927c1a65bd55928a" data-id="7d02e5db9ac845ab927c1a65bd55928a"><span><div id="7d02e5db9ac845ab927c1a65bd55928a" class="notion-header-anchor"></div><a class="notion-hash-link" href="#7d02e5db9ac845ab927c1a65bd55928a" title="为什么我控制器性能这么低？调调QPS？"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">为什么我控制器性能这么低？调调QPS？</span></span></h3><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-bb4819391fe94e8d944d9a1d6f420ec7" data-id="bb4819391fe94e8d944d9a1d6f420ec7"><span><div id="bb4819391fe94e8d944d9a1d6f420ec7" class="notion-header-anchor"></div><a class="notion-hash-link" href="#bb4819391fe94e8d944d9a1d6f420ec7" title="Debug小技巧，配置UserAgent"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Debug小技巧，配置UserAgent</span></span></h3><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-4595f50149d2434d8e21d68e834d7d58" data-id="4595f50149d2434d8e21d68e834d7d58"><span><div id="4595f50149d2434d8e21d68e834d7d58" class="notion-header-anchor"></div><a class="notion-hash-link" href="#4595f50149d2434d8e21d68e834d7d58" title="List一次开销这么大"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">List一次开销这么大</span></span></h3><blockquote class="notion-quote notion-block-888a3a2d52674ccf8983341a8c24a61b"><div>ResourceVersion=0</div></blockquote><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-784cac5af0b846a8854e7da24eb3d235" data-id="784cac5af0b846a8854e7da24eb3d235"><span><div id="784cac5af0b846a8854e7da24eb3d235" class="notion-header-anchor"></div><a class="notion-hash-link" href="#784cac5af0b846a8854e7da24eb3d235" title="序列化协议尽量用 PB"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">序列化协议尽量用 PB</span></span></h3><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-90270dae71ac467f9925382e246556a6" href="https://arthurchiao.art/blog/k8s-reliability-list-data-zh/"><div><div class="notion-bookmark-title">arthurchiao.art</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-text">https://arthurchiao.art/blog/k8s-reliability-list-data-zh/</div></div></div></a></div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-b9534147b53a44d290a4a970701b365c" data-id="b9534147b53a44d290a4a970701b365c"><span><div id="b9534147b53a44d290a4a970701b365c" class="notion-header-anchor"></div><a class="notion-hash-link" href="#b9534147b53a44d290a4a970701b365c" title="优先使用 Patch 接口"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">优先使用 Patch 接口</span></span></h3><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-cbbf420bff974d8891231a2a4c69bdae" data-id="cbbf420bff974d8891231a2a4c69bdae"><span><div id="cbbf420bff974d8891231a2a4c69bdae" class="notion-header-anchor"></div><a class="notion-hash-link" href="#cbbf420bff974d8891231a2a4c69bdae" title="Indexer同步延迟"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Indexer同步延迟</span></span></h3><blockquote class="notion-quote notion-block-590ccfec2c4e4779aad1f537290f686d"><div><code class="notion-inline-code">pkg/controller/controller_utils.go#ControllerExpectationsInterface</code></div></blockquote><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-3624b9dfbd7341bba2ee29b970409546" data-id="3624b9dfbd7341bba2ee29b970409546"><span><div id="3624b9dfbd7341bba2ee29b970409546" class="notion-header-anchor"></div><a class="notion-hash-link" href="#3624b9dfbd7341bba2ee29b970409546" title="加索引很有必要"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">加索引很有必要</span></span></h3><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-7c533cb2e98e425e8bfe53468bc6a5cf" data-id="7c533cb2e98e425e8bfe53468bc6a5cf"><span><div id="7c533cb2e98e425e8bfe53468bc6a5cf" class="notion-header-anchor"></div><a class="notion-hash-link" href="#7c533cb2e98e425e8bfe53468bc6a5cf" title="避免无脑DeepCopy导致OOM"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">避免无脑DeepCopy导致OOM</span></span></h3><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-ce498cf31d64405381e896830594790d" data-id="ce498cf31d64405381e896830594790d"><span><div id="ce498cf31d64405381e896830594790d" class="notion-header-anchor"></div><a class="notion-hash-link" href="#ce498cf31d64405381e896830594790d" title="Merge Patch,Strategic Merge Patch,Three Way Merge Patch"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Merge Patch,Strategic Merge Patch,Three Way Merge Patch</span></span></h3><div class="notion-text notion-block-0149ff293bd946848467f07e7b702ce3">你在做 Patch 的时候，最佳实践是把 original 的 UID 填在 patch 里。因为 API server 的 key-value store 是以“namespace + name”作为 key 的。在任意一个时间，这个组合都是唯一的。但是如果把时间这条轴加进来的话，比如你有一个 pod，删除后过了一会儿，又在同一个 namespace 下建了同名的 pod，但是把所有的 spec 都改掉了，那么 controller 旧的 patch 可能会被应用到这个新建的 pod 上，这样就会有 bug 了。如果在 patch 里加入 uid 的话，一旦发生刚才所说的情况，apiserver 会以为你是要修改 uid，这个是不允许的，所以这个 patch 就会 fail 掉，防止了 bug。</div><div class="notion-blank notion-block-efceaadb3b944069bd632dfa995c883c"> </div><div class="notion-text notion-block-8f0579ad8d7d447a856b815dd74f5281">resourece version 是 kubernetes 里面一个 logical clock，用作 optimistic concurrency。如果没有设置 resourceversion，api-server 收到请求后会从 etcd 读出最新的值。但设为 0 的话，APIserver 就会从 local 的 cache 里面把值读取出来，cache 的值可能会有一定的延迟。这样可以减轻 APIserver 和 etcd 后端的压力。现在是用得比较多的是 kubelet，经常要 get node status，但是不需要最新的 node status，如果集群很大，就能够省不少 cpu/memory 的开销。如果 resource version 设成非常大的值，get request 会在 api-server 挂起，没有响应的话会 time-out。</div><div class="notion-blank notion-block-cbb520cb667640af8388cb3f6b952769"> </div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-9a2dbaca4c39413c8321d666da709ce3" href="https://www.jianshu.com/p/4b881e340c65"><div><div class="notion-bookmark-title">www.jianshu.com</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><img src="https://www.notion.so/image/https%3A%2F%2Fwww.jianshu.com%2Ffavicon.ico?table=block&amp;id=9a2dbaca-4c39-413c-8321-d666da709ce3&amp;cache=v2" alt="www.jianshu.com" loading="lazy" decoding="async"/></div><div class="notion-bookmark-link-text">https://www.jianshu.com/p/4b881e340c65</div></div></div></a></div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-b5c9ba0c3fee43b690d6162d457c0ff6" data-id="b5c9ba0c3fee43b690d6162d457c0ff6"><span><div id="b5c9ba0c3fee43b690d6162d457c0ff6" class="notion-header-anchor"></div><a class="notion-hash-link" href="#b5c9ba0c3fee43b690d6162d457c0ff6" title="总结"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">总结</span></span></h2><div class="notion-blank notion-block-6c4a31d7b2bc4d79aeb11f5ae134a9d5"> </div><ol start="1" class="notion-list notion-list-numbered notion-block-18734b221eac4bf28957b808423f6a9e"><li> maxsurge 2 <code class="notion-inline-code">maxUnavailable (在replica的前提能忍受多少个)</code></li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-2324cff0767e4a8687c6306b3e794f78"><li>maxsurge 2 <code class="notion-inline-code">scaleMaxUnavailable（全局能忍受多少个不可用）</code></li></ol><ol start="3" class="notion-list notion-list-numbered notion-block-3a8a10e71a0640dab5fa28f8bf3ef7fe"><li>maxsurge + <code class="notion-inline-code">maxUnavailable</code> 发布窗口</li></ol></article><aside class="notion-aside"><div class="notion-aside-table-of-contents"><div class="notion-aside-table-of-contents-header">Table of Contents</div><nav class="notion-table-of-contents"><a href="#5694cca3b1b645b188e8d4de80521381" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">CloneSet Controller </span></a><a href="#50b5c20c889e4f67bdb8209ee0ff09af" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">初始版本发布</span></a><a href="#ced9d1e67ffd495db13808c14fb74cb8" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-2"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:32px">首次协调：创建实例</span></a><a href="#a1f006e45eb54329a1847ea0527a2d17" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-2"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:32px">后续协调：状态更新</span></a><a href="#3495ad61e9de4c3e9815be9f9925e543" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">新版本发布</span></a><a href="#0f63db43fa384d9b83dfd40186df6b95" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-2"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:32px">更新后的首次协调：</span></a><a href="#aa9d57bc607b4f7081d1d3b18316604a" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">Tricks</span></a><a href="#7d02e5db9ac845ab927c1a65bd55928a" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">为什么我控制器性能这么低？调调QPS？</span></a><a href="#bb4819391fe94e8d944d9a1d6f420ec7" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">Debug小技巧，配置UserAgent</span></a><a href="#4595f50149d2434d8e21d68e834d7d58" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">List一次开销这么大</span></a><a href="#784cac5af0b846a8854e7da24eb3d235" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">序列化协议尽量用 PB</span></a><a href="#b9534147b53a44d290a4a970701b365c" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">优先使用 Patch 接口</span></a><a href="#cbbf420bff974d8891231a2a4c69bdae" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">Indexer同步延迟</span></a><a href="#3624b9dfbd7341bba2ee29b970409546" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">加索引很有必要</span></a><a href="#7c533cb2e98e425e8bfe53468bc6a5cf" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">避免无脑DeepCopy导致OOM</span></a><a href="#ce498cf31d64405381e896830594790d" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-1"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:16px">Merge Patch,Strategic Merge Patch,Three Way Merge Patch</span></a><a href="#b5c9ba0c3fee43b690d6162d457c0ff6" class="notion-table-of-contents-item notion-table-of-contents-item-indent-level-0"><span class="notion-table-of-contents-item-body" style="display:inline-block;margin-left:0">总结</span></a></nav></div></aside></div><div class="styles_comments__YEupF"><div><p>Loading Comments...</p></div></div></main><footer class="styles_footer__RBpyk"><div class="styles_copyright__nhL_k">Copyright 2022 <!-- -->yangsoon</div><div class="styles_settings__GyEhi"></div><div class="styles_social__ptL3p"><a class="styles_twitter__3YoqL" href="https://twitter.com/yangsoonlx" title="Twitter @yangsoonlx" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a class="styles_zhihu__Z7IC7" href="https://zhihu.com/people/yangsoon" title="Zhihu @yangsoon" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13H170.54zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82v170.31zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62v.01zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2l19.23 14.43zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78l.03-.01z"></path></svg></a><a class="styles_github__0JN7a" href="https://github.com/yangsoon" title="GitHub @yangsoon" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div></footer></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"site":{"domain":"yangsoon.github.io","name":"YangSoon","rootNotionPageId":"72a669717cf642c2a2524439d99d8f44","rootNotionSpaceId":null,"description":"YangSoon, Cloud Native Developer"},"recordMap":{"block":{"b80b3335-c73f-4e47-a39b-3021b4dc650a":{"role":"reader","value":{"id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","version":992,"type":"page","properties":{"title":[["OpenKruise Source Reading"]]},"content":["818d2d4a-c5fa-4c44-9d88-03aca9d0525d","3cee5624-8b26-4f58-a4d1-cb7ee481bdaa","5694cca3-b1b6-45b1-88e8-d4de80521381","2a6e276d-26ee-48c7-8371-0e8249d02020","57db10fc-65c9-4460-8cf6-d79962bbe302","f79e6f2b-f2b6-4948-acc2-b233fad665dc","65e179e4-0023-413e-9c60-f4dcc27c5904","deb7dcd3-02af-442a-9d0d-6af3ff24e44a","10574ef4-bcf3-4abe-883b-a73f529e8035","58a9b00d-42b8-4479-97fe-ad7d8a1522d7","50b5c20c-889e-4f67-bdb8-209ee0ff09af","2726ba8d-ce86-434e-a2e0-3c0037390496","47a227bf-dd39-47b4-956e-78164af91570","b2ec5577-bc4f-4a73-9577-f771fb80fde2","608f4832-9466-4fd2-a732-6d340008045e","ced9d1e6-7ffd-495d-b138-08c14fb74cb8","5c34e756-5f47-43b0-940f-6ba3cff73f27","cce9ff9b-03c9-46e4-ac00-4d240e40f297","6168ae51-1ba9-4ca9-a358-479181e261e5","4ac0543a-37ff-407e-8686-24c55e756f6f","4cd7e02a-6a9f-456f-a169-017683a273ee","e49508e3-8f67-40c7-ab10-6149b415fde7","8f02f025-8c43-470e-a6f8-bb1745436328","9a1b4cb0-cbf6-4da1-a54d-e7aa8716e320","2c3d0869-05e5-4c20-96f6-05ad13698bbc","c0b99942-c97e-4546-bac7-c750f3de5ddc","804be967-0edc-4df1-abd9-51f7ecaf62e0","2e63048e-4a36-4378-88b3-bf0af4f9f881","b1d7ccf8-e12f-46a8-acae-54f690aaeee1","460e0e17-fbdc-408a-be8d-36b64c0550a1","d5024c24-c59a-4934-a1eb-1088b35a905d","3ee4c0b3-77b1-47ad-aff9-e3d975c3626a","80c65c81-cec2-4733-b8ef-e4a87f56586e","9c296925-db55-483d-b74c-b7e9d24588b3","04fe8283-b971-4e06-968b-1447b0895402","3057a293-52cc-4c3d-842b-781f9f4c6a6d","ed71575c-5e86-484e-a68b-36dddef95faa","a1f006e4-5eb5-4329-a184-7ea0527a2d17","8e50fabb-3763-4dc7-abce-e151a4bd62ac","82f36f20-9777-4c51-af8a-21464a465cbd","1b343edb-2a73-4b99-b15d-ec809ba049e5","69bc48ca-162d-4664-a56c-9a579286f806","9837a3f7-4374-4a51-a796-6f06e34bf80a","b5d8bf0e-135e-492d-aa20-e2a6edfc2f2a","690d4883-c572-47f1-82ae-7f1cc277d375","c92f9962-6817-4fc3-98db-224eb7965ba7","febd1775-c626-4ba5-b9e8-b0db1624205c","6f8e0b9c-54fa-41a9-aa63-ac1bd09d13d5","8a1a057d-3580-4abe-96bb-82b2928a2819","db4acd88-30f5-4bf2-ab16-b8422f763087","3495ad61-e9de-4c3e-9815-be9f9925e543","7dbad826-e786-4438-bc96-c4218086b8fe","e20be74a-35cf-4a47-a967-79fd0db95165","798e5ee5-6c53-41a9-9cc9-6c943a79c4ec","418745df-fc3f-4d9b-a5e3-845bd587721d","8fefee75-36bf-49eb-815b-b5e2e507e43d","0f63db43-fa38-4d9b-83df-d40186df6b95","a7435a37-8a8f-4f95-9603-833c69b9c78d","4ff93a40-d1aa-45e8-b0bd-dded02265b16","aa9d57bc-607b-4f70-81d1-d3b18316604a","7d02e5db-9ac8-45ab-927c-1a65bd55928a","bb481939-1fe9-4e8d-944d-9a1d6f420ec7","4595f501-49d2-434d-8e21-d68e834d7d58","888a3a2d-5267-4ccf-8983-341a8c24a61b","784cac5a-f0b8-46a8-854e-7da24eb3d235","90270dae-71ac-467f-9925-382e246556a6","b9534147-b53a-44d2-90a4-a970701b365c","cbbf420b-ff97-4d88-9123-1a2a4c69bdae","590ccfec-2c4e-4779-aad1-f537290f686d","3624b9df-bd73-41bb-a2ee-29b970409546","7c533cb2-e98e-425e-8bfe-53468bc6a5cf","ce498cf3-1d64-4053-81e8-96830594790d","0149ff29-3bd9-4684-8467-f07e7b702ce3","efceaadb-3b94-4069-bd63-2dfa995c883c","8f0579ad-8d7d-447a-856b-815dd74f5281","cbb520cb-6676-40af-8388-cb3f6b952769","9a2dbaca-4c39-413c-8321-d666da709ce3","b5c9ba0c-3fee-43b6-90d6-162d457c0ff6","6c4a31d7-b2bc-4d79-aeb1-1f5ae134a9d5","18734b22-1eac-4bf2-8957-b808423f6a9e","2324cff0-767e-4a86-87c6-306b3e794f78","3a8a10e7-1a06-40da-b5fa-28f8bf3ef7fe"],"format":{"page_icon":"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/24a9e733-94b5-42f3-82f7-fbdb0d6f78df/openkruise-logo-bg.jpeg","page_full_width":false,"page_small_text":true,"page_cover_position":0.5},"created_time":1660962056016,"last_edited_time":1662461820000,"parent_id":"72a66971-7cf6-42c2-a252-4439d99d8f44","parent_table":"block","alive":true,"file_ids":["7a5c8578-8ea1-484b-a910-3b06dad80e5a","d8487faa-3d0c-45aa-b1ee-c4013cb7c26e","61c2707f-6238-43cf-926e-5ebb9d18c99d","e89c9af9-e992-4b13-bf3d-43d3a7d52c35","ce30d7a5-32b7-4f47-b9d4-604099144141","7da1e3f7-97fb-4ed6-9bac-cf44908b7a0c","8ff32e32-c567-44d9-95c0-e0117b073da4","15a4e4d2-a4ef-4768-a771-2d661990f75a","24a9e733-94b5-42f3-82f7-fbdb0d6f78df","f22c59c4-ebaa-4ee5-9064-c8d000ed269e"],"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"72a66971-7cf6-42c2-a252-4439d99d8f44":{"role":"reader","value":{"id":"72a66971-7cf6-42c2-a252-4439d99d8f44","version":406,"type":"page","properties":{"title":[["yangsoon ‘s blog"]]},"content":["8a139bd3-c29e-4248-b950-43841f1b0076","ceb8c970-ebd0-4bb1-bd23-c481ed7fefab","b80b3335-c73f-4e47-a39b-3021b4dc650a","02130a54-428f-4e4b-861c-dcbed7945c3b","020410cb-b4a6-4c00-921d-9145fcf35569","091a74ac-4142-4f28-ba1d-5c9810ccc648","0648cf9f-653b-4a40-8c78-52e3a3add115","46b5fd4b-3050-41cb-90ba-45cf6db1e56a","1807cc1c-60f4-47ca-8eb7-99bbef34b28b","1d187551-eeba-418f-a731-1c36497feb57","3ef701ce-2de7-48a4-bb64-2bd45cae827a","52395b31-1471-4332-8b63-bcf6a19b22bf"],"format":{"page_icon":"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/37907dd5-3c76-4966-a419-daa027a84972/IMG_2189.jpg","page_full_width":false,"page_small_text":false,"copied_from_pointer":{"id":"bd32b787-e471-49f3-8941-174a9c6846b6","table":"block","spaceId":"bb9288f4-efb5-417f-bf44-1a79fa04feb1"}},"permissions":[{"role":"editor","type":"user_permission","user_id":"d1805983-7869-451d-bf8b-64135a5d4ee7"},{"role":"reader","type":"public_permission","added_timestamp":1660963691744,"allow_duplicate":false}],"created_time":1660961589760,"last_edited_time":1666534560000,"parent_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6","parent_table":"space","alive":true,"copied_from":"bd32b787-e471-49f3-8941-174a9c6846b6","file_ids":["63e89fe9-f5cd-4414-be0e-53d91aa54fc3","37907dd5-3c76-4966-a419-daa027a84972"],"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"818d2d4a-c5fa-4c44-9d88-03aca9d0525d":{"role":"reader","value":{"id":"818d2d4a-c5fa-4c44-9d88-03aca9d0525d","version":438,"type":"text","properties":{"title":[["OpenKruise 是一个基于 Kubernetes 的扩展套件，主要聚焦于云原生应用的自动化，比如部署、发布、运维以及可用性保护"],["。",[["i"]]],["OpenKruise提供了大量的增强版本的工作负载，不仅支持类似 k8s 原生工作负载的基础功能，还提供了原地升级、可配置扩缩容/发布测试等。"]]},"created_time":1660965780000,"last_edited_time":1660981200000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3cee5624-8b26-4f58-a4d1-cb7ee481bdaa":{"role":"reader","value":{"id":"3cee5624-8b26-4f58-a4d1-cb7ee481bdaa","version":1362,"type":"text","properties":{"title":[["OpenKruise 由阿里云开源，已经在阿里内部经过了大量的生产实践检验，个人认为是阿里云开源的一个非常技术硬核的项目，对于想学习编写控制器的同学来说可以学到更贴近”云原生”的写法。还能学到控制器在大规模k8s下性能优化的小技巧。"]]},"created_time":1660981200000,"last_edited_time":1661129160000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5694cca3-b1b6-45b1-88e8-d4de80521381":{"role":"reader","value":{"id":"5694cca3-b1b6-45b1-88e8-d4de80521381","version":80,"type":"header","properties":{"title":[["CloneSet Controller "]]},"created_time":1660981797910,"last_edited_time":1660982100000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2a6e276d-26ee-48c7-8371-0e8249d02020":{"role":"reader","value":{"id":"2a6e276d-26ee-48c7-8371-0e8249d02020","version":43,"type":"text","properties":{"title":[["CloneSet",[["c"]]],[" 控制器提供了高效管理无状态应用的能力，它可以对标原生的 "],["Deployment",[["c"]]],["\n，但 "],["CloneSet",[["c"]]],[" 提供了很多增强功能："]]},"created_time":1660981920000,"last_edited_time":1660982640000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"57db10fc-65c9-4460-8cf6-d79962bbe302":{"role":"reader","value":{"id":"57db10fc-65c9-4460-8cf6-d79962bbe302","version":80,"type":"numbered_list","properties":{"title":[["更加强大的扩缩容能力"]]},"created_time":1660982640000,"last_edited_time":1660982640000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"f79e6f2b-f2b6-4948-acc2-b233fad665dc":{"role":"reader","value":{"id":"f79e6f2b-f2b6-4948-acc2-b233fad665dc","version":84,"type":"numbered_list","properties":{"title":[["更多可配置化的升级策略"]]},"created_time":1660982640000,"last_edited_time":1660982700000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"65e179e4-0023-413e-9c60-f4dcc27c5904":{"role":"reader","value":{"id":"65e179e4-0023-413e-9c60-f4dcc27c5904","version":72,"type":"numbered_list","properties":{"title":[["配合外部组件管理 Pod 的生命周期"]]},"created_time":1660982700000,"last_edited_time":1660982700000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"deb7dcd3-02af-442a-9d0d-6af3ff24e44a":{"role":"reader","value":{"id":"deb7dcd3-02af-442a-9d0d-6af3ff24e44a","version":125,"type":"text","properties":{"title":[["想要了解 "],["CloneSet",[["c"]]],[" 的更多用法可以参考官方文档："]]},"created_time":1660982700000,"last_edited_time":1660982760000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"10574ef4-bcf3-4abe-883b-a73f529e8035":{"role":"reader","value":{"id":"10574ef4-bcf3-4abe-883b-a73f529e8035","version":8,"type":"bookmark","properties":{"link":[["https://openkruise.io/zh/docs/user-manuals/cloneset"]],"title":[["CloneSet | OpenKruise"]],"description":[["CloneSet 控制器提供了高效管理无状态应用的能力，它可以对标原生的 Deployment，但 CloneSet 提供了很多增强功能。 按照 Kruise 的 命名规范，CloneSet 是一个直接管理 Pod 的 Set 类型 workload。 一个简单的 CloneSet yaml 文件如下： CloneSet 允许用户配置 PVC 模板 volumeClaimTemplates，用来给每个 Pod 生成独享的 PVC，这是 Deployment 所不支持的。 如果用户没有指定这个模板，CloneSet 会创建不带 PVC 的 Pod。 一些注意点： 每个被自动创建的 PVC 会有一个 ownerReference 指向 CloneSet，因此 CloneSet 被删除时，它创建的所有 Pod 和 PVC 都会被删除。 每个被 CloneSet 创建的"]]},"format":{"bookmark_icon":"https://openkruise.io/zh/img/openkruise.ico","bookmark_cover":"https://openkruise.io/zh/assets/images/cloneset-lifecycle-b97d746b37527b0cb23eab4fcc7cef39.png"},"created_time":1660982700000,"last_edited_time":1660982700000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"58a9b00d-42b8-4479-97fe-ad7d8a1522d7":{"role":"reader","value":{"id":"58a9b00d-42b8-4479-97fe-ad7d8a1522d7","version":376,"type":"text","properties":{"title":[["本节从多个发布场景出发配合 "],["CloneSet Controller",[["c"]]],[" 源码来帮你梳理控制器的执行流程和逻辑。控制器的执行入口在: "],["pkg/controller/cloneset/cloneset_controller.go#doReconcile",[["c"]]],["。"]]},"created_time":1660982760000,"last_edited_time":1661074680000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"50b5c20c-889e-4f67-bdb8-209ee0ff09af":{"role":"reader","value":{"id":"50b5c20c-889e-4f67-bdb8-209ee0ff09af","version":32,"type":"sub_header","properties":{"title":[["初始版本发布"]]},"created_time":1660983013817,"last_edited_time":1660983000000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2726ba8d-ce86-434e-a2e0-3c0037390496":{"role":"reader","value":{"id":"2726ba8d-ce86-434e-a2e0-3c0037390496","version":259,"type":"text","properties":{"title":[["该场景是企业发布服务的第一个版本，在这个场景下 CloneSet 控制器的执行流程和步骤都比较简单。首先，我们在自己的k8s集群中安装好 OpenKruise，具体安装方式请参考"],["官方文档 ",[["a","https://openkruise.io/zh/docs/installation/"]]],["。"]]},"created_time":1660983000000,"last_edited_time":1660984740000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"47a227bf-dd39-47b4-956e-78164af91570":{"role":"reader","value":{"id":"47a227bf-dd39-47b4-956e-78164af91570","version":20,"type":"code","properties":{"title":[["apiVersion: apps.kruise.io/v1alpha1\nkind: CloneSet\nmetadata:\n  labels:\n    app: sample\n  name: sample\nspec:\n  replicas: 5\n  selector:\n    matchLabels:\n      app: sample\n  template:\n    metadata:\n      labels:\n        app: sample\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.22-alpine"]],"language":[["YAML"]]},"created_time":1660983713534,"last_edited_time":1661175420000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b2ec5577-bc4f-4a73-9577-f771fb80fde2":{"role":"reader","value":{"id":"b2ec5577-bc4f-4a73-9577-f771fb80fde2","version":176,"type":"text","properties":{"title":[["复制上面的 CloneSet 对象并创建到集群中。"]]},"created_time":1660984020000,"last_edited_time":1660984740000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"608f4832-9466-4fd2-a732-6d340008045e":{"role":"reader","value":{"id":"608f4832-9466-4fd2-a732-6d340008045e","version":45,"type":"code","properties":{"title":[["➜  pbpaste | kubectl apply -f -\ncloneset.apps.kruise.io/sample created\n➜  kubectl get cloneset\nNAME     DESIRED   UPDATED   UPDATED_READY   READY   TOTAL   AGE\nsample   5                                                   18s"]],"language":[["Bash"]]},"created_time":1660984082835,"last_edited_time":1660984740000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ced9d1e6-7ffd-495d-b138-08c14fb74cb8":{"role":"reader","value":{"id":"ced9d1e6-7ffd-495d-b138-08c14fb74cb8","version":86,"type":"sub_sub_header","properties":{"title":[["首次协调：创建实例"]]},"created_time":1661074832819,"last_edited_time":1661080680000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"5c34e756-5f47-43b0-940f-6ba3cff73f27":{"role":"reader","value":{"id":"5c34e756-5f47-43b0-940f-6ba3cff73f27","version":9,"type":"image","properties":{"size":[["595.2KB"]],"title":[["Untitled"]],"source":[["https://s3-us-west-2.amazonaws.com/secure.notion-static.com/25951791-eca4-44e6-bb8d-a3d35df0e1cc/Untitled.png"]]},"format":{"block_width":3392,"display_source":"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/25951791-eca4-44e6-bb8d-a3d35df0e1cc/Untitled.png","block_full_width":false,"block_page_width":true,"block_aspect_ratio":0.5595518867924528,"block_preserve_scale":true},"created_time":1661264820000,"last_edited_time":1661264820000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"file_ids":["25951791-eca4-44e6-bb8d-a3d35df0e1cc"],"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cce9ff9b-03c9-46e4-ac00-4d240e40f297":{"role":"reader","value":{"id":"cce9ff9b-03c9-46e4-ac00-4d240e40f297","version":3,"type":"text","properties":{"title":[["1."],["获取待处理的 ",[["b"]]],["CloneSet",[["c"]]],[" 对象",[["b"]]],["：控制器 list\u0026watch k8s集群中 "],["CloneSet",[["c"]]],[" 资源的变化，当监听到有新的 CloneSet 创建出来，CloneSet Controller 开始执行 "],["doReconcile",[["c"]]],[" 函数中的逻辑。控制器，首先会使用 Client 获取到要处理的 CloneSet 对象。"]]},"created_time":1660986420000,"last_edited_time":1661074800000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"6168ae51-1ba9-4ca9-a358-479181e261e5":{"role":"reader","value":{"id":"6168ae51-1ba9-4ca9-a358-479181e261e5","version":6,"type":"code","properties":{"title":[["instance := \u0026appsv1alpha1.CloneSet{}\nerr := r.Get(context.TODO(), request.NamespacedName, instance)"]],"language":[["Go"]]},"created_time":1660987783197,"last_edited_time":1660987740000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4ac0543a-37ff-407e-8686-24c55e756f6f":{"role":"reader","value":{"id":"4ac0543a-37ff-407e-8686-24c55e756f6f","version":823,"type":"text","properties":{"title":[["2."],["初始化 ",[["b"]]],["Control",[["c"]]],[" 对象",[["b"]]],["： "],["Control",[["c"]]],[" ",[["b"]]],["是抽象出的一个通用的接口，可以看到这个接口实现一些计算Revision、扩缩容、Pod 更新相关的操作。不过这里创建出的 "],["Control",[["c"]]],[" 对象，貌似用处不大，在其他执行函数中，会经常见到这个对象被创建出来，基本上是需要就创建。"]]},"created_time":1660986960000,"last_edited_time":1661054460000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4cd7e02a-6a9f-456f-a169-017683a273ee":{"role":"reader","value":{"id":"4cd7e02a-6a9f-456f-a169-017683a273ee","version":255,"type":"text","properties":{"title":[["3."],["获取 ",[["b"]]],["CloneSet",[["c"]]],[" 所管控的资源",[["b"]]],["：控制器获取所有 "],["CloneSet",[["c"]]],[" 管控活跃的 Pod 和 PVC。"]]},"created_time":1660987200000,"last_edited_time":1661054460000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e49508e3-8f67-40c7-ab10-6149b415fde7":{"role":"reader","value":{"id":"e49508e3-8f67-40c7-ab10-6149b415fde7","version":7,"type":"code","properties":{"title":[["// list all active Pods and PVCs belongs to cs\nfilteredPods, filteredPVCs, err := r.getOwnedResource(instance)"]],"language":[["Go"]]},"created_time":1660988042204,"last_edited_time":1660988040000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8f02f025-8c43-470e-a6f8-bb1745436328":{"role":"reader","value":{"id":"8f02f025-8c43-470e-a6f8-bb1745436328","version":431,"type":"text","properties":{"title":[["这里活跃的 Pod 是指：没有被删除的，并且 "],["Pod.Status.Phase",[["c"]]],[" 不处于 "],["Succeeded",[["c"]]],[" 和 "],["Failed",[["c"]]],[" 状态的Pod集合；活跃的 PVC 是指没有被删除的 PVC 集合。"]]},"created_time":1660987980000,"last_edited_time":1660993440000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9a1b4cb0-cbf6-4da1-a54d-e7aa8716e320":{"role":"reader","value":{"id":"9a1b4cb0-cbf6-4da1-a54d-e7aa8716e320","version":389,"type":"text","properties":{"title":[["4."],["过滤有多个管控 Owner 的 ",[["b"]]],["Pod",[["c"]]],["：这一步会过滤掉不满足 CloneSet selector 筛选条件和一些有多个Owner的Pod，同时会释放掉CloneSet对这些有多个Owner的Pod的管理权限。"]]},"created_time":1660993440000,"last_edited_time":1661003880000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2c3d0869-05e5-4c20-96f6-05ad13698bbc":{"role":"reader","value":{"id":"2c3d0869-05e5-4c20-96f6-05ad13698bbc","version":1142,"type":"text","properties":{"title":[["5."],["获取 ",[["b"]]],["CloneSet",[["c"]]],[" 当前的 ",[["b"]]],["Revision"],[" 和 计算待更新的下个版本的 ",[["b"]]],["Revision：当前场景比较简单，"],["CloneSet",[["c"]]],[" 没有历史版本，只负责创建存储当前 "],["CloneSet",[["c"]]],[" 快照信息的 "],["ControlllerRevision",[["c"]]],["即可。这里会使用第2步创建的 Control 对象生成 Revision模板存储到"],["ControlllerRevision",[["c"]]],[" 对象的 Data 字段中， "],["ControlllerRevision",[["c"]]],[" 的名字由Data的Hash值生成。最终返回的 currentRevision 和 updateRevision 均指向这个 "],["ControlllerRevision",[["c"]]],[" 对象。"]]},"created_time":1660987800000,"last_edited_time":1661004480000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c0b99942-c97e-4546-bac7-c750f3de5ddc":{"role":"reader","value":{"id":"c0b99942-c97e-4546-bac7-c750f3de5ddc","version":24,"type":"code","properties":{"title":[["func (c *commonControl) SetRevisionTemplate(revisionSpec map[string]interface{}, \n\ttemplate map[string]interface{}) {\n\trevisionSpec[\"template\"] = template\n\ttemplate[\"$patch\"] = \"replace\"\n}"]],"language":[["Go"]]},"created_time":1661003008301,"last_edited_time":1661003040000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"804be967-0edc-4df1-abd9-51f7ecaf62e0":{"role":"reader","value":{"id":"804be967-0edc-4df1-abd9-51f7ecaf62e0","version":183,"type":"text","properties":{"title":[["其中，SetRevisionTemplate 函数会给 "],["cloneSet.Spec.Template",[["c"]]],[" 字段新增一个 "],["$patch:replace",[["c"]]],[" 键值对。后面我们会提到为什么要新增这个字段，最后生成的 "],["ControllerRevision",[["c"]]],[" 对象如下："]]},"created_time":1661003940000,"last_edited_time":1661061720000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2e63048e-4a36-4378-88b3-bf0af4f9f881":{"role":"reader","value":{"id":"2e63048e-4a36-4378-88b3-bf0af4f9f881","version":51,"type":"code","properties":{"title":[["apiVersion: apps/v1\nkind: ControllerRevision\nmetadata:\n  labels:\n    app: sample\n    "],["controller.kubernetes.io/hash: 66bf7df478",[["b"]]],["\n  name: "],["sample-66bf7df478",[["b"]]],["\n  ownerReferences:\n  - apiVersion: apps.kruise.io/v1alpha1\n    kind: CloneSet\n    name: sample\ndata:\n  spec:\n    template:\n      "],["$patch: replace",[["b"]]],["\n      metadata:\n        creationTimestamp: null\n        labels:\n          app: sample\n      spec:\n        containers:\n        - image: nginx:1.22-alpine\n          name: nginx\n          resources: {}\nrevision:"],[" 1",[["b"]]]],"language":[["YAML"]]},"created_time":1661004976395,"last_edited_time":1661263920000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b1d7ccf8-e12f-46a8-acae-54f690aaeee1":{"role":"reader","value":{"id":"b1d7ccf8-e12f-46a8-acae-54f690aaeee1","version":3,"type":"quote","properties":{"title":[["ControllerRevision 实现了状态数据的不可变快照，APIServer 将拒绝所有尝试改变 data 字段的请求。 但是，可以删除 ControllerRevisions。  DaemonSet 和 StatefulSet 控制器都使用它来进行更新和回滚。"]]},"created_time":1661003267094,"last_edited_time":1661061060000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"460e0e17-fbdc-408a-be8d-36b64c0550a1":{"role":"reader","value":{"id":"460e0e17-fbdc-408a-be8d-36b64c0550a1","version":1696,"type":"text","properties":{"title":[["6."],["创建",[["b"]]],[" "],["Pods",[["c"]]],[" ：在 "],["初始版本发布 ",[["b"]]],["场景下 "],["r.syncCloneSet",[["c"]]],[" 的操作会比较简单，在涉及版本升级的场景时，我们再详细分析这部分。这里涉及的操作有：先计算需要扩容的个数这里就等于"],["Spec.Replicas",[["c"]]],[",在真正把初始版本的 Pod 创建到集群前，会把扩容创建的Pod信息记录到 "],["realScaleExpectations",[["c"]]],[" 对象中，后调用 "],["DoItSlowly",[["c"]]],[" 方法分批并发创建 Pod，如果创建Pod失败，会把创建失败的 Pod 从 "],["realScaleExpectations",[["c"]]],[" 对象中移除。"],["realScaleExpectations",[["c"]]],[" 是用来解决 Indexer 同步延迟导致控制器可能会扩容出错误个数Pod 的问题，详细的讲解在 "],["Tricks",[["a","https://yangsoon.github.io/openkruise-source-reading#cbbf420bff974d8891231a2a4c69bdae"]]],[" 部分，感兴趣可以跳转到这一节阅读。"]]},"format":{"list_start_index":6},"created_time":1661015040000,"last_edited_time":1661265060000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"d5024c24-c59a-4934-a1eb-1088b35a905d":{"role":"reader","value":{"id":"d5024c24-c59a-4934-a1eb-1088b35a905d","version":1217,"type":"text","properties":{"title":[["简单解释一下, 控制器获取 k8s资源数据是直接访问本地缓存(Indexer)，但是 Indexer的数据同步因为网络等问题会出现延迟的情况，导致在第三步获取管控资源（Pod、PVC）的时候会出现不一致的问题，容易导致控制器后续处理的时候会创建出多余的 Pod，为了解决这个问题就加入了一个临时缓存，如上图所示，当Informar监听到Pod创建的事件就会调用 "],["ObserveScale",[["c"]]],[" 函数把之前记录的Pod信息去掉。"]]},"created_time":1661265120000,"last_edited_time":1661265720000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3ee4c0b3-77b1-47ad-aff9-e3d975c3626a":{"role":"reader","value":{"id":"3ee4c0b3-77b1-47ad-aff9-e3d975c3626a","version":73,"type":"code","properties":{"title":[["// pkg/controller/cloneset/cloneset_controller.go:#add\n// add adds a new Controller to mgr with r as the reconcile.Reconciler\nfunc add(mgr manager.Manager, r reconcile.Reconciler) error {\n\t...\n\t// Watch for changes to Pod\n\terr = c.Watch(\u0026source.Kind{Type: \u0026v1.Pod{}}, \u0026podEventHandler{Reader: mgr.GetCache()})\n\tif err != nil {\n\t\treturn err\n\t}\n\t...\n}\n\n// pkg/controller/cloneset/cloneset_event_handler.go:#Create\nfunc (e *podEventHandler) Create(evt event.CreateEvent, q workqueue.RateLimitingInterface) {\n\t...\n\t// If it has a ControllerRef, that's all that matters.\n\tif controllerRef := metav1.GetControllerOf(pod); controllerRef != nil {\n\t\treq := resolveControllerRef(pod.Namespace, controllerRef)\n\t\tif req == nil {\n\t\t\treturn\n\t\t}\n\t\tklog.V(4).Infof(\"Pod %s/%s created, owner: %s\", pod.Namespace, pod.Name, req.Name)\n\t\tclonesetutils.ScaleExpectations.ObserveScale(req.String(), expectations.Create, pod.Name)\n\t\tq.Add(*req)\n\t\treturn\n\t}\n\t...\n}"]],"language":[["Go"]]},"created_time":1661265781190,"last_edited_time":1661265840000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"80c65c81-cec2-4733-b8ef-e4a87f56586e":{"role":"reader","value":{"id":"80c65c81-cec2-4733-b8ef-e4a87f56586e","version":233,"type":"text","properties":{"title":[["在控制器每次协调的时候，会调用"],["SatisfiedExpectations",[["c"]]],[" 来判断是不是读到了脏数据，如果数据没有及时更新就直接返回把事件重新入队，直到数据更新。"]]},"created_time":1661265720000,"last_edited_time":1661306820000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9c296925-db55-483d-b74c-b7e9d24588b3":{"role":"reader","value":{"id":"9c296925-db55-483d-b74c-b7e9d24588b3","version":14,"type":"code","properties":{"title":[["// If scaling expectations have not satisfied yet, just skip this reconcile.\nif scaleSatisfied, unsatisfiedDuration, scaleDirtyPods := clonesetutils.ScaleExpectations.SatisfiedExpectations(request.String()); !scaleSatisfied {\n\tif unsatisfiedDuration \u003e= expectations.ExpectationTimeout {\n\t\tklog.Warningf(\"Expectation unsatisfied overtime for %v, scaleDirtyPods=%v, overtime=%v\", request.String(), scaleDirtyPods, unsatisfiedDuration)\n\t\treturn reconcile.Result{}, nil\n\t}\n\tklog.V(4).Infof(\"Not satisfied scale for %v, scaleDirtyPods=%v\", request.String(), scaleDirtyPods)\n\treturn reconcile.Result{RequeueAfter: expectations.ExpectationTimeout - unsatisfiedDuration}, nil\n}"]],"language":[["Go"]]},"created_time":1661266001762,"last_edited_time":1661265960000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"04fe8283-b971-4e06-968b-1447b0895402":{"role":"reader","value":{"id":"04fe8283-b971-4e06-968b-1447b0895402","version":59,"type":"text","properties":{"title":[["7."],["更新",[["b"]]],["CloneSet Status",[["c"]]],[" ：第一次协调，仅仅记录少量的信息到 "],["Status",[["c"]]],["字段中，等到控制器获取到 Pod 状态更新的事件之后的后续协调会继续更新 Status 字段。"]]},"created_time":1661063640000,"last_edited_time":1661074680000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3057a293-52cc-4c3d-842b-781f9f4c6a6d":{"role":"reader","value":{"id":"3057a293-52cc-4c3d-842b-781f9f4c6a6d","version":13,"type":"code","properties":{"title":[["status:\n  availableReplicas: 0\n  collisionCount: 0\n  currentRevision: sample-66bf7df478\n  expectedUpdatedReplicas: 5\n  labelSelector: app=sample\n  observedGeneration: 1\n  readyReplicas: 0\n  replicas: 0\n  updateRevision: sample-66bf7df478\n  updatedReadyReplicas: 0\n  updatedReplicas: 0"]],"language":[["YAML"]]},"created_time":1661074152880,"last_edited_time":1661178900000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ed71575c-5e86-484e-a68b-36dddef95faa":{"role":"reader","value":{"id":"ed71575c-5e86-484e-a68b-36dddef95faa","version":223,"type":"text","properties":{"title":[["8"],[".执行一些垃圾回收的操作",[["b"]]],[": 这一步会清理一些历史 "],["ControlllerRevison",[["c"]]],[" 对象，减轻 etcd负担。"]]},"created_time":1661063760000,"last_edited_time":1661064000000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a1f006e4-5eb5-4329-a184-7ea0527a2d17":{"role":"reader","value":{"id":"a1f006e4-5eb5-4329-a184-7ea0527a2d17","version":76,"type":"sub_sub_header","properties":{"title":[["后续协调：状态更新"]]},"created_time":1661077953234,"last_edited_time":1661078460000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8e50fabb-3763-4dc7-abce-e151a4bd62ac":{"role":"reader","value":{"id":"8e50fabb-3763-4dc7-abce-e151a4bd62ac","version":351,"type":"text","properties":{"title":[["从函数 "],["pkg/controller/cloneset/cloneset_controller.go#add",[["c"]]],[" ，可以看到控制器会监听所有 CloneSet、Pod和PVC资源的变化，当CloneSet创建出的Pod资源状态更新的时候，都会触发控制器继续协调更新实例状态。"]]},"created_time":1661078700000,"last_edited_time":1661079000000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"82f36f20-9777-4c51-af8a-21464a465cbd":{"role":"reader","value":{"id":"82f36f20-9777-4c51-af8a-21464a465cbd","version":13,"type":"code","properties":{"title":[["func add(mgr manager.Manager, r reconcile.Reconciler) error {\n\t...\n\t// Watch for changes to CloneSet\n\terr = c.Watch(\u0026source.Kind{Type: \u0026appsv1alpha1.CloneSet{}}, \u0026handler.EnqueueRequestForObject{}, predicate.Funcs{\n\t\tUpdateFunc: func(e event.UpdateEvent) bool {\n\t\t\toldCS := e.ObjectOld.(*appsv1alpha1.CloneSet)\n\t\t\tnewCS := e.ObjectNew.(*appsv1alpha1.CloneSet)\n\t\t\tif *oldCS.Spec.Replicas != *newCS.Spec.Replicas {\n\t\t\t\tklog.V(4).Infof(\"Observed updated replicas for CloneSet: %s/%s, %d-\u003e%d\",\n\t\t\t\t\tnewCS.Namespace, newCS.Name, *oldCS.Spec.Replicas, *newCS.Spec.Replicas)\n\t\t\t}\n\t\t\treturn true\n\t\t},\n\t})\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t// Watch for changes to Pod\n\terr = c.Watch(\u0026source.Kind{Type: \u0026v1.Pod{}}, \u0026podEventHandler{Reader: mgr.GetCache()})\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t// Watch for changes to PVC, just ensure cache updated\n\terr = c.Watch(\u0026source.Kind{Type: \u0026v1.PersistentVolumeClaim{}}, \u0026pvcEventHandler{})\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}"]],"language":[["Go"]]},"created_time":1661078682164,"last_edited_time":1661078640000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"1b343edb-2a73-4b99-b15d-ec809ba049e5":{"role":"reader","value":{"id":"1b343edb-2a73-4b99-b15d-ec809ba049e5","version":418,"type":"text","properties":{"title":[["每次协调的执行逻辑和首次协调的执行流程大致相似，主要的处理逻辑在函数"],["pkg/controller/cloneset/cloneset_status.go#calculateStatus",[["c"]]],[" 中。"]]},"created_time":1661079000000,"last_edited_time":1661095260000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"69bc48ca-162d-4664-a56c-9a579286f806":{"role":"reader","value":{"id":"69bc48ca-162d-4664-a56c-9a579286f806","version":350,"type":"text","properties":{"title":[["我们主要看下 "],["Status",[["c"]]],[" 字段中和 Replicas 相关数值的计算。"]]},"created_time":1661094420000,"last_edited_time":1661094780000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9837a3f7-4374-4a51-a796-6f06e34bf80a":{"role":"reader","value":{"id":"9837a3f7-4374-4a51-a796-6f06e34bf80a","version":24,"type":"text","properties":{"title":[["1.符合"],["ReadyReplicas",[["c"]]],[" 条件的 Pod 需要满足  "],["InPlaceUpdateReady",[["c"]]],[" ",[["i"]]],["和 "],["PodReady",[["c"]]],[" 这2个 Condition 的状态为 "],["True",[["c"]]],[" ,并且 "],["Pod",[["c"]]],[" 的 "],["Phase",[["c"]]],[" 处于 "],["Running",[["c"]]],[" 状态。"]]},"created_time":1661094780000,"last_edited_time":1661095380000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b5d8bf0e-135e-492d-aa20-e2a6edfc2f2a":{"role":"reader","value":{"id":"b5d8bf0e-135e-492d-aa20-e2a6edfc2f2a","version":597,"type":"text","properties":{"title":[["2."],["AvailableReplicas",[["c"]]],[" 的要求比 "],["ReadyReplicas",[["c"]]],[" 更严格一些，除了满足 "],["ReadyReplicas",[["c"]]],[" 的条件，还需要 Pod 的生命周期状态为 "],["Normal",[["c"]]],[" ("],["CloneSet",[["c"]]],["生命周期相关的内容会在后面介绍)。除此之外，Pod 的 Condition 转变到 "],["PodReady",[["c"]]],[" 的时间要超过在 "],["CloneSet",[["c"]]],[" 中设置的 "],["minReadSeconds",[["c"]]],[" 。"]]},"created_time":1661094780000,"last_edited_time":1661095380000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"690d4883-c572-47f1-82ae-7f1cc277d375":{"role":"reader","value":{"id":"690d4883-c572-47f1-82ae-7f1cc277d375","version":10,"type":"image","properties":{"size":[["131.9KB"]],"title":[["Untitled"]],"source":[["https://s3-us-west-2.amazonaws.com/secure.notion-static.com/fd9e6893-05b1-4c0f-8e96-043193f57138/Untitled.png"]]},"format":{"block_width":1422,"display_source":"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/fd9e6893-05b1-4c0f-8e96-043193f57138/Untitled.png","block_full_width":false,"block_page_width":true,"block_aspect_ratio":0.4767932489451477,"block_preserve_scale":true},"created_time":1661094420000,"last_edited_time":1661094420000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"file_ids":["fd9e6893-05b1-4c0f-8e96-043193f57138"],"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"c92f9962-6817-4fc3-98db-224eb7965ba7":{"role":"reader","value":{"id":"c92f9962-6817-4fc3-98db-224eb7965ba7","version":105,"type":"text","properties":{"title":[["3."],["UpdatedReplicas",[["c"]]],[" 等于处于最新版本的 Pod 。"]]},"format":{"list_start_index":3},"created_time":1661095080000,"last_edited_time":1661095380000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"febd1775-c626-4ba5-b9e8-b0db1624205c":{"role":"reader","value":{"id":"febd1775-c626-4ba5-b9e8-b0db1624205c","version":83,"type":"text","properties":{"title":[["4."],["UpdatedReadyReplicas",[["c"]]],[" 表示处于最新版本而且满足 "],["ReadyReplicas",[["c"]]],[" 的 Pod。"]]},"created_time":1661095080000,"last_edited_time":1661095440000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"6f8e0b9c-54fa-41a9-aa63-ac1bd09d13d5":{"role":"reader","value":{"id":"6f8e0b9c-54fa-41a9-aa63-ac1bd09d13d5","version":121,"type":"text","properties":{"title":[["5."],["ExpectedUpdatedReplicas",[["c"]]],[" 等于 "],["Replicas",[["c"]]],[" - "],["partition",[["c"]]],[" ("],["partition",[["c"]]],[" 表示期望保留老版本 "],["Pod",[["c"]]],[" 的个数) "]]},"created_time":1661095140000,"last_edited_time":1661095440000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8a1a057d-3580-4abe-96bb-82b2928a2819":{"role":"reader","value":{"id":"8a1a057d-3580-4abe-96bb-82b2928a2819","version":106,"type":"text","properties":{"title":[["最终协调后的 "],["Status",[["c"]]],[" 如下："]]},"created_time":1661094540000,"last_edited_time":1661095260000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"db4acd88-30f5-4bf2-ab16-b8422f763087":{"role":"reader","value":{"id":"db4acd88-30f5-4bf2-ab16-b8422f763087","version":22,"type":"code","properties":{"title":[["status:\n  availableReplicas: 5\n  collisionCount: 0\n  currentRevision: sample-66bf7df478\n  expectedUpdatedReplicas: 5\n  labelSelector: app=sample\n  observedGeneration: 1\n  readyReplicas: 5\n  replicas: 5\n  updateRevision: sample-66bf7df478\n  updatedReadyReplicas: 5\n  updatedReplicas: 5"]],"language":[["YAML"]]},"created_time":1661079230760,"last_edited_time":1661178900000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3495ad61-e9de-4c3e-9815-be9f9925e543":{"role":"reader","value":{"id":"3495ad61-e9de-4c3e-9815-be9f9925e543","version":42,"type":"sub_header","properties":{"title":[["新版本发布"]]},"created_time":1661096008606,"last_edited_time":1661174940000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7dbad826-e786-4438-bc96-c4218086b8fe":{"role":"reader","value":{"id":"7dbad826-e786-4438-bc96-c4218086b8fe","version":657,"type":"text","properties":{"title":[["随着业务需求的更新，企业很快迭代出了一个新版本要部署，构建打包好镜像之后，准备向集群下发新版本的 "],["CloneSet",[["c"]]],[" ：我们除了更改了服务镜像，还新增了2个更新策略，"],["partition: 3",[["c"]]],[" 表示我们会保留 3 个老版本的 Pod，"],["maxSurge: 2",[["c"]]],[" 表示允许控制器一下子扩出超过 "],["replicas",[["c"]]],[" 个数的 Pod。"]]},"created_time":1661175240000,"last_edited_time":1661266920000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"e20be74a-35cf-4a47-a967-79fd0db95165":{"role":"reader","value":{"id":"e20be74a-35cf-4a47-a967-79fd0db95165","version":37,"type":"quote","properties":{"title":[["解释这样配置的原因"]]},"created_time":1661178206100,"last_edited_time":1661178180000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"798e5ee5-6c53-41a9-9cc9-6c943a79c4ec":{"role":"reader","value":{"id":"798e5ee5-6c53-41a9-9cc9-6c943a79c4ec","version":121,"type":"code","properties":{"title":[["apiVersion: apps.kruise.io/v1alpha1\nkind: CloneSet\nmetadata:\n  labels:\n    app: sample\n  name: sample\n  namespace: default\nspec:\n  minReadySeconds: 10\n  # 设置更新策略\n  updateStrategy:\n      # 保留旧版本 Pod 的数量或百分比\n      partition: 3\n      # 控制最多能扩出来超过 replicas 的 Pod 数量\n      maxSurge: 2\n  replicas: 5\n  selector:\n    matchLabels:\n      app: sample\n  template:\n    metadata:\n      labels:\n        app: sample\n    spec:\n      containers:\n      - image: nginx:1.23-alpine\n        name: nginx"]],"language":[["YAML"]]},"created_time":1661175302803,"last_edited_time":1661178120000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"418745df-fc3f-4d9b-a5e3-845bd587721d":{"role":"reader","value":{"id":"418745df-fc3f-4d9b-a5e3-845bd587721d","version":140,"type":"text","properties":{"title":[["复制👆🏻的 "],["CloneSet",[["c"]]],[" 并更新到集群中。"]]},"created_time":1661175600000,"last_edited_time":1661177580000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8fefee75-36bf-49eb-815b-b5e2e507e43d":{"role":"reader","value":{"id":"8fefee75-36bf-49eb-815b-b5e2e507e43d","version":12,"type":"code","properties":{"title":[["➜  pbpaste | kubectl apply -f -\ncloneset.apps.kruise.io/sample configured"]],"language":[["YAML"]]},"created_time":1661177567703,"last_edited_time":1661177880000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0f63db43-fa38-4d9b-83df-d40186df6b95":{"role":"reader","value":{"id":"0f63db43-fa38-4d9b-83df-d40186df6b95","version":91,"type":"sub_sub_header","properties":{"title":[["更新后的首次协调："]]},"created_time":1661177909111,"last_edited_time":1661177940000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"a7435a37-8a8f-4f95-9603-833c69b9c78d":{"role":"reader","value":{"id":"a7435a37-8a8f-4f95-9603-833c69b9c78d","version":6,"type":"text","created_time":1661869879957,"last_edited_time":1661869860000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4ff93a40-d1aa-45e8-b0bd-dded02265b16":{"role":"reader","value":{"id":"4ff93a40-d1aa-45e8-b0bd-dded02265b16","version":314,"type":"text","properties":{"title":[["此时如果直接删除ToDelete的pod那么不可以的个数就会超过maxUnavailable，不符合需求，所以先计算出来在满足条件下要扩出来的实例个数"]]},"created_time":1661177940000,"last_edited_time":1661439480000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"aa9d57bc-607b-4f70-81d1-d3b18316604a":{"role":"reader","value":{"id":"aa9d57bc-607b-4f70-81d1-d3b18316604a","version":3,"type":"header","properties":{"title":[["Tricks"]]},"created_time":1660987842429,"last_edited_time":1661177880000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7d02e5db-9ac8-45ab-927c-1a65bd55928a":{"role":"reader","value":{"id":"7d02e5db-9ac8-45ab-927c-1a65bd55928a","version":74,"type":"sub_header","properties":{"title":[["为什么我控制器性能这么低？调调QPS？"]]},"created_time":1661262038160,"last_edited_time":1661266260000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"bb481939-1fe9-4e8d-944d-9a1d6f420ec7":{"role":"reader","value":{"id":"bb481939-1fe9-4e8d-944d-9a1d6f420ec7","version":115,"type":"sub_header","properties":{"title":[["Debug小技巧，配置UserAgent"]]},"created_time":1661262120126,"last_edited_time":1661266260000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"4595f501-49d2-434d-8e21-d68e834d7d58":{"role":"reader","value":{"id":"4595f501-49d2-434d-8e21-d68e834d7d58","version":82,"type":"sub_header","properties":{"title":[["List一次开销这么大"]]},"created_time":1661261610774,"last_edited_time":1661267880000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"888a3a2d-5267-4ccf-8983-341a8c24a61b":{"role":"reader","value":{"id":"888a3a2d-5267-4ccf-8983-341a8c24a61b","version":23,"type":"quote","properties":{"title":[["ResourceVersion=0"]]},"created_time":1661261622438,"last_edited_time":1661261640000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"784cac5a-f0b8-46a8-854e-7da24eb3d235":{"role":"reader","value":{"id":"784cac5a-f0b8-46a8-854e-7da24eb3d235","version":191,"type":"sub_header","properties":{"title":[["序列化协议尽量用 PB"]]},"created_time":1661261938748,"last_edited_time":1661267880000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"90270dae-71ac-467f-9925-382e246556a6":{"role":"reader","value":{"id":"90270dae-71ac-467f-9925-382e246556a6","version":8,"type":"bookmark","properties":{"link":[["https://arthurchiao.art/blog/k8s-reliability-list-data-zh/"]]},"created_time":1662383580000,"last_edited_time":1662383580000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b9534147-b53a-44d2-90a4-a970701b365c":{"role":"reader","value":{"id":"b9534147-b53a-44d2-90a4-a970701b365c","version":57,"type":"sub_header","properties":{"title":[["优先使用 Patch 接口"]]},"created_time":1661261975830,"last_edited_time":1661267400000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cbbf420b-ff97-4d88-9123-1a2a4c69bdae":{"role":"reader","value":{"id":"cbbf420b-ff97-4d88-9123-1a2a4c69bdae","version":61,"type":"sub_header","properties":{"title":[["Indexer同步延迟"]]},"created_time":1661261677977,"last_edited_time":1661261700000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"590ccfec-2c4e-4779-aad1-f537290f686d":{"role":"reader","value":{"id":"590ccfec-2c4e-4779-aad1-f537290f686d","version":68,"type":"quote","properties":{"title":[["pkg/controller/controller_utils.go#ControllerExpectationsInterface",[["c"]]]]},"created_time":1661261712989,"last_edited_time":1661264160000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3624b9df-bd73-41bb-a2ee-29b970409546":{"role":"reader","value":{"id":"3624b9df-bd73-41bb-a2ee-29b970409546","version":167,"type":"sub_header","properties":{"title":[["加索引很有必要"]]},"created_time":1661261581603,"last_edited_time":1661267880000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"7c533cb2-e98e-425e-8bfe-53468bc6a5cf":{"role":"reader","value":{"id":"7c533cb2-e98e-425e-8bfe-53468bc6a5cf","version":134,"type":"sub_header","properties":{"title":[["避免无脑DeepCopy导致OOM"]]},"created_time":1661261759323,"last_edited_time":1661267940000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"ce498cf3-1d64-4053-81e8-96830594790d":{"role":"reader","value":{"id":"ce498cf3-1d64-4053-81e8-96830594790d","version":147,"type":"sub_header","properties":{"title":[["Merge Patch,Strategic Merge Patch,Three Way Merge Patch"]]},"created_time":1661267114737,"last_edited_time":1661267940000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"0149ff29-3bd9-4684-8467-f07e7b702ce3":{"role":"reader","value":{"id":"0149ff29-3bd9-4684-8467-f07e7b702ce3","version":43,"type":"text","properties":{"title":[["你在做 Patch 的时候，最佳实践是把 original 的 UID 填在 patch 里。因为 API server 的 key-value store 是以“namespace + name”作为 key 的。在任意一个时间，这个组合都是唯一的。但是如果把时间这条轴加进来的话，比如你有一个 pod，删除后过了一会儿，又在同一个 namespace 下建了同名的 pod，但是把所有的 spec 都改掉了，那么 controller 旧的 patch 可能会被应用到这个新建的 pod 上，这样就会有 bug 了。如果在 patch 里加入 uid 的话，一旦发生刚才所说的情况，apiserver 会以为你是要修改 uid，这个是不允许的，所以这个 patch 就会 fail 掉，防止了 bug。"]]},"created_time":1661306810384,"last_edited_time":1662461220000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"efceaadb-3b94-4069-bd63-2dfa995c883c":{"role":"reader","value":{"id":"efceaadb-3b94-4069-bd63-2dfa995c883c","version":5,"type":"text","created_time":1662461580000,"last_edited_time":1662461580000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"8f0579ad-8d7d-447a-856b-815dd74f5281":{"role":"reader","value":{"id":"8f0579ad-8d7d-447a-856b-815dd74f5281","version":3,"type":"text","properties":{"title":[["resourece version 是 kubernetes 里面一个 logical clock，用作 optimistic concurrency。如果没有设置 resourceversion，api-server 收到请求后会从 etcd 读出最新的值。但设为 0 的话，APIserver 就会从 local 的 cache 里面把值读取出来，cache 的值可能会有一定的延迟。这样可以减轻 APIserver 和 etcd 后端的压力。现在是用得比较多的是 kubelet，经常要 get node status，但是不需要最新的 node status，如果集群很大，就能够省不少 cpu/memory 的开销。如果 resource version 设成非常大的值，get request 会在 api-server 挂起，没有响应的话会 time-out。"]]},"created_time":1662461581129,"last_edited_time":1662461580000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"cbb520cb-6676-40af-8388-cb3f6b952769":{"role":"reader","value":{"id":"cbb520cb-6676-40af-8388-cb3f6b952769","version":5,"type":"text","created_time":1662461820000,"last_edited_time":1662461820000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"9a2dbaca-4c39-413c-8321-d666da709ce3":{"role":"reader","value":{"id":"9a2dbaca-4c39-413c-8321-d666da709ce3","version":8,"type":"bookmark","properties":{"link":[["https://www.jianshu.com/p/4b881e340c65"]]},"format":{"bookmark_icon":"https://www.jianshu.com/favicon.ico"},"created_time":1662461820000,"last_edited_time":1662461820000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"b5c9ba0c-3fee-43b6-90d6-162d457c0ff6":{"role":"reader","value":{"id":"b5c9ba0c-3fee-43b6-90d6-162d457c0ff6","version":10,"type":"header","properties":{"title":[["总结"]]},"created_time":1660982151384,"last_edited_time":1661267400000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"6c4a31d7-b2bc-4d79-aeb1-1f5ae134a9d5":{"role":"reader","value":{"id":"6c4a31d7-b2bc-4d79-aeb1-1f5ae134a9d5","version":5,"type":"text","created_time":1662128700000,"last_edited_time":1662128700000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"18734b22-1eac-4bf2-8957-b808423f6a9e":{"role":"reader","value":{"id":"18734b22-1eac-4bf2-8957-b808423f6a9e","version":193,"type":"numbered_list","properties":{"title":[[" maxsurge 2 "],["maxUnavailable (在replica的前提能忍受多少个)",[["c"]]]]},"created_time":1662128700000,"last_edited_time":1662128820000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"2324cff0-767e-4a86-87c6-306b3e794f78":{"role":"reader","value":{"id":"2324cff0-767e-4a86-87c6-306b3e794f78","version":76,"type":"numbered_list","properties":{"title":[["maxsurge 2 "],["scaleMaxUnavailable（全局能忍受多少个不可用）",[["c"]]]]},"created_time":1662128760000,"last_edited_time":1662130140000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"3a8a10e7-1a06-40da-b5fa-28f8bf3ef7fe":{"role":"reader","value":{"id":"3a8a10e7-1a06-40da-b5fa-28f8bf3ef7fe","version":37,"type":"numbered_list","properties":{"title":[["maxsurge + "],["maxUnavailable",[["c"]]],[" 发布窗口"]]},"created_time":1662130140000,"last_edited_time":1662130140000,"parent_id":"b80b3335-c73f-4e47-a39b-3021b4dc650a","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"dd2baae1-8900-4073-854b-bdde392d5b36":{"role":"reader","value":{"id":"dd2baae1-8900-4073-854b-bdde392d5b36","version":32,"type":"page","properties":{"title":[["About"]]},"content":["36cdda23-4789-4ff5-8d18-99142f89bec4","770dde4e-b74e-4848-8b48-8b1ce3c111ea","2ca1f27b-da43-46f8-b8c0-ef3e05e583d9"],"permissions":[{"role":"editor","type":"user_permission","user_id":"d1805983-7869-451d-bf8b-64135a5d4ee7"},{"role":"reader","type":"public_permission","added_timestamp":1666532032810}],"created_time":1666531980000,"last_edited_time":1666534500000,"parent_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6","parent_table":"space","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}},"36cdda23-4789-4ff5-8d18-99142f89bec4":{"role":"reader","value":{"id":"36cdda23-4789-4ff5-8d18-99142f89bec4","version":2,"type":"sub_header","properties":{"title":[["Contact Me"]]},"created_time":1666532023649,"last_edited_time":1666531980000,"parent_id":"dd2baae1-8900-4073-854b-bdde392d5b36","parent_table":"block","alive":true,"created_by_table":"notion_user","created_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","last_edited_by_table":"notion_user","last_edited_by_id":"d1805983-7869-451d-bf8b-64135a5d4ee7","space_id":"fe0e4127-6cf7-4d6d-8491-aa23773532f6"}}},"collection":{},"collection_view":{},"notion_user":{},"collection_query":{},"signed_urls":{"5c34e756-5f47-43b0-940f-6ba3cff73f27":"https://s3.us-west-2.amazonaws.com/secure.notion-static.com/25951791-eca4-44e6-bb8d-a3d35df0e1cc/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Content-Sha256=UNSIGNED-PAYLOAD\u0026X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20221023%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20221023T152543Z\u0026X-Amz-Expires=86400\u0026X-Amz-Signature=a59df04ddaec09329641313d993f33d8f52cd3d63c3c77c524c01244531cddfe\u0026X-Amz-SignedHeaders=host\u0026x-id=GetObject","690d4883-c572-47f1-82ae-7f1cc277d375":"https://s3.us-west-2.amazonaws.com/secure.notion-static.com/fd9e6893-05b1-4c0f-8e96-043193f57138/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Content-Sha256=UNSIGNED-PAYLOAD\u0026X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20221023%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20221023T152543Z\u0026X-Amz-Expires=86400\u0026X-Amz-Signature=05dfb1a06d5baa829f1cfb5fbc9afba8b31fde16069ccd8afe4f04642dcc6743\u0026X-Amz-SignedHeaders=host\u0026x-id=GetObject"},"preview_images":{"notion.so/image/s3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F24a9e733-94b5-42f3-82f7-fbdb0d6f78df%2Fopenkruise-logo-bg.jpeg":{"originalWidth":540,"originalHeight":540,"dataURIBase64":"data:image/webp;base64,UklGRmwAAABXRUJQVlA4IGAAAACQAgCdASoQABAABUB8JbACdH8G6AmloEmfqCZIgAD+8eBipjr5mEcjW+17mJYB4C2JhfbmT0VAymPlGqjuZc7moQ/ip8B0lm34TDmRkQt84+ZlH9PWuZY5HwcXlkU9AAA="},"notion.so/image/s3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F37907dd5-3c76-4966-a419-daa027a84972%2FIMG_2189.jpg":{"originalWidth":688,"originalHeight":689,"dataURIBase64":"data:image/webp;base64,UklGRmoAAABXRUJQVlA4IF4AAABQAgCdASoQABAABUB8JbACdH8AF6kqWZq7wgAA/tFZccfpD5SaLC06Ab1xNlhuQgaC2peDlG2wJ+PIWe8AtNjEYYN+9hybVKfEbmvVGYOWRzw8xmakIGSWE0zkkYAA"},"notion.so/image/openkruise.io%2Fzh%2Fassets%2Fimages%2Fcloneset-lifecycle-b97d746b37527b0cb23eab4fcc7cef39.png":{"originalWidth":2000,"originalHeight":1376,"dataURIBase64":"data:image/webp;base64,UklGRk4AAABXRUJQVlA4IEIAAACQAQCdASoQAAsABUB8JYgAAp04DAAA/useL8JM95pKwiEWPr8xm0fvVLPraEeRDQpExREcG2G7LRqBvgeZSGYAAAA="},"notion.so/image/openkruise.io%2Fzh%2Fimg%2Fopenkruise.ico":null,"s3.us-west-2.amazonaws.com/secure.notion-static.com/25951791-eca4-44e6-bb8d-a3d35df0e1cc/Untitled.png":{"originalWidth":3392,"originalHeight":1898,"dataURIBase64":"data:image/webp;base64,UklGRsAAAABXRUJQVlA4WAoAAAAQAAAADwAACAAAQUxQSFEAAAARL6CQbQQ4NKH7EC4igi8TWMW2EydBQRb4b1kUZOogVQDPvxlERPSfYJKm2o6R0LBwetIuMmu3XgiYf81Kvbsqs3bbQGPr/QDr7dd9QIwNrAMAVlA4IEgAAACwAQCdASoQAAkABUB8JaACdAD5URQAAP636O8ND+RDj7l8nBaidBIBRTyJOP6tdmcbw3oOuxZR7dD5oULRcx/EATwXHN/AAAA="},"s3.us-west-2.amazonaws.com/secure.notion-static.com/fd9e6893-05b1-4c0f-8e96-043193f57138/Untitled.png":{"originalWidth":1422,"originalHeight":678,"dataURIBase64":"data:image/webp;base64,UklGRpQAAABXRUJQVlA4WAoAAAAQAAAADwAABgAAQUxQSDYAAAARL0AmbZuslrJ736wsIoK6BwratpF2H4AyOBXBSSVwJMqfzL0MIvo/AQDSkGS7Ti/bH5K5SwJWUDggOAAAAPABAJ0BKhAABwAFQHwloALsAR+TP+R8gAD+1QtnRDOd3CzMAl7tguoP3dJc87AWEHpMJjFAhAAA"},"notion.so/image/jianshu.com%2Ffavicon.ico":null}},"pageId":"b80b3335-c73f-4e47-a39b-3021b4dc650a"},"__N_SSG":true},"page":"/[pageId]","query":{"pageId":"openkruise-source-reading"},"buildId":"PSg0Acersh2oVT5QAnXcP","isFallback":false,"dynamicIds":[3358],"gsp":true,"scriptLoader":[]}</script></body></html>